const testRuntime = typeof globalThis.Bun !== "undefined"
    ? await import("bun:test")
    : await import("@jest/globals");

const { describe, test, expect } = testRuntime;
import fs from "node:fs/promises";
import os from "node:os";
import path from "node:path";
import { extractFileDocumentation } from "../../scripts/docs/docgen-lib.mjs";

async function makeTempRoot() {
    const tmpRoot = await fs.mkdtemp(path.join(os.tmpdir(), "litegraph-docgen-comments-"));
    await fs.mkdir(path.join(tmpRoot, "src"), { recursive: true });
    return tmpRoot;
}

describe("docgen comment binding", () => {
    test("prefers JSDoc, then plain comments, then AUTO fallback", async () => {
        const rootDir = await makeTempRoot();
        const mainFile = path.join(rootDir, "src/comments.js");

        await fs.writeFile(mainFile, [
            "/**",
            " * 这是 JSDoc 注释",
            " */",
            "export function fromJsdoc() {",
            "    return true;",
            "}",
            "",
            "/* 这是普通注释 */",
            "export const fromPlainComment = 1;",
            "",
            "export const fromAuto = 2;",
        ].join("\n"), "utf8");

        const doc = await extractFileDocumentation({
            sourceAbsPath: mainFile,
            sourceRelPath: "src/comments.js",
            rootDir,
            snippetOptions: { minLines: 6, maxLines: 20 },
            parseCache: new Map(),
        });

        const fromJsdoc = doc.items.find((item) => item.exportedName === "fromJsdoc");
        const fromPlain = doc.items.find((item) => item.exportedName === "fromPlainComment");
        const fromAuto = doc.items.find((item) => item.exportedName === "fromAuto");

        expect(fromJsdoc.descriptionSource).toBe("comment");
        expect(fromJsdoc.description).toContain("这是 JSDoc 注释");

        expect(fromPlain.descriptionSource).toBe("comment");
        expect(fromPlain.description).toContain("这是普通注释");

        expect(fromAuto.descriptionSource).toBe("auto");
        expect(fromAuto.autoGenerated).toBe(true);
        expect(fromAuto.description.startsWith("[AUTO]")).toBe(true);
    });
});
