var Ht=Object.defineProperty,Dt=o=>{throw TypeError(o)},Vt=(o,t,r)=>t in o?Ht(o,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[t]=r,g=(o,t,r)=>Vt(o,typeof t!="symbol"?t+"":t,r),Xt=(o,t,r)=>t.has(o)||Dt("Cannot "+r),St=(o,t,r)=>t.has(o)?Dt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(o):t.set(o,r),ot=(o,t,r)=>(Xt(o,t,"access private method"),r);class LLink{constructor(t,r,s,a,l,h){this.id=t,this.type=r,this.origin_id=s,this.origin_slot=a,this.target_id=l,this.target_slot=h,this._data=null,this._pos=new Float32Array(2)}configure(t){t.constructor===Array?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot)}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}const we=class ai{constructor(t){var r;(r=LiteGraph.log)==null||r.call(LiteGraph,"Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}getSupportedTypes(){var t;return(t=this.supported_types)!=null?t:ai.supported_types}clear(){var t;this.stop(),this.status=ai.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,(t=this._nodes)==null||t.forEach(r=>{var s;(s=r.onRemoved)==null||s.call(r)}),this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.configApplyDefaults(),this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.history={actionHistory:[],actionHistoryVersions:[],actionHistoryPtr:0},this.nodes_executing=[],this.nodes_actioning=[],this.node_ancestorsCalculated=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")}configApply(t){this.config=Object.assign(this.config,t)}configApplyDefaults(){var t=LiteGraph.graphDefaultConfig;this.configApply(t)}attachCanvas(t){var r;if(!t instanceof LiteGraph.LGraphCanvas)throw new Error("attachCanvas expects a LiteGraph.LGraphCanvas instance");t.graph&&t.graph!=this&&t.graph.detachCanvas(t),t.graph=this,(r=this.list_of_graphcanvas)!=null||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)}detachCanvas(t){if(this.list_of_graphcanvas){var r=this.list_of_graphcanvas.indexOf(t);r!=-1&&(t.graph=null,this.list_of_graphcanvas.splice(r,1))}}start(t=0){var r;if(this.status===ai.STATUS_RUNNING)return;this.status=ai.STATUS_RUNNING,(r=this.onPlayEvent)==null||r.call(this),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime;const s=()=>{var a,l;this.execution_timer_id===-1&&(window.requestAnimationFrame(s),(a=this.onBeforeStep)==null||a.call(this),this.runStep(1,!this.catch_errors),(l=this.onAfterStep)==null||l.call(this))};t===0&&typeof window=="object"&&window.requestAnimationFrame?(this.execution_timer_id=-1,s()):this.execution_timer_id=setInterval(()=>{var a,l;(a=this.onBeforeStep)==null||a.call(this),this.runStep(1,!this.catch_errors),(l=this.onAfterStep)==null||l.call(this)},t)}stop(){var t;this.status!=ai.STATUS_STOPPED&&(this.status=ai.STATUS_STOPPED,(t=this.onStopEvent)==null||t.call(this),this.execution_timer_id!=null&&(this.execution_timer_id!=-1&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}runStep(t=1,r,s){var a,l,h,u,c,_,d=LiteGraph.getTime();this.globaltime=.001*(d-this.starttime);var f=(a=this._nodes_executable)!=null?a:this._nodes;if(f){if(s||(s=f.length),r){for(let T=0;T<t;T++)f.forEach(L=>{var G,I;LiteGraph.use_deferred_actions&&(G=L._waiting_actions)!=null&&G.length&&L.executePendingActions(),L.mode===LiteGraph.ALWAYS&&((I=L.doExecute)==null||I.call(L))}),this.fixedtime+=this.fixedtime_lapse,(l=this.onExecuteStep)==null||l.call(this);(h=this.onAfterExecute)==null||h.call(this)}else try{for(let T=0;T<t;T++)f.forEach(L=>{var G,I;LiteGraph.use_deferred_actions&&(G=L._waiting_actions)!=null&&G.length&&L.executePendingActions(),L.mode===LiteGraph.ALWAYS&&((I=L.doExecute)==null||I.call(L))}),this.fixedtime+=this.fixedtime_lapse,(u=this.onExecuteStep)==null||u.call(this);(c=this.onAfterExecute)==null||c.call(this),this.errors_in_execution=!1}catch(T){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw T;(_=LiteGraph.log)==null||_.call(LiteGraph,`Error during execution: ${T}`),this.stop()}var m=LiteGraph.getTime(),b=m-d;b==0&&(b=1),this.execution_time=.001*b,this.globaltime+=.001*b,this.iteration+=1,this.elapsed_time=(m-this.last_update_time)*.001,this.last_update_time=m,this.nodes_executing=[],this.nodes_actioning=[],this.node_ancestorsCalculated=[],this.nodes_executedAction=[]}}updateExecutionOrder(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var t=0;t<this._nodes_in_order.length;++t)this._nodes_in_order[t].onExecute&&this._nodes_executable.push(this._nodes_in_order[t])}computeExecutionOrder(t,r){var s,a=[],l=[],h={},u={},c={};for(let T=0,L=this._nodes.length;T<L;++T){let G=this._nodes[T];if(!(t&&!G.onExecute)){h[G.id]=G;var _=0;if(G.inputs)for(var d=0,f=G.inputs.length;d<f;d++)G.inputs[d]&&G.inputs[d].link!=null&&(_+=1);_==0?(l.push(G),r&&(G._level=1)):(r&&(G._level=0),c[G.id]=_)}}for(;l.length!=0;){var m=l.shift();if(a.push(m),delete h[m.id],!!m.outputs)for(let T=0;T<m.outputs.length;T++){let L=m.outputs[T];if(!(L==null||L.links==null||L.links.length==0))for(let G=0;G<L.links.length;G++){let I=L.links[G],O=this.links[I];if(!O||u[O.id])continue;let E=this.getNodeById(O.target_id);if(E==null){u[O.id]=!0;continue}r&&(!E._level||E._level<=m._level)&&(E._level=m._level+1),u[O.id]=!0,c[E.id]-=1,c[E.id]==0&&l.push(E)}}}for(let T in h)a.push(h[T]);a.length!=this._nodes.length&&LiteGraph.debug&&((s=LiteGraph.warn)==null||s.call(LiteGraph,"something went wrong, nodes missing"));var b=a.length;for(let T=0;T<b;++T)a[T].order=T;a=a.sort((T,L)=>{let G=T.constructor.priority||T.priority||0,I=L.constructor.priority||L.priority||0;return G==I?T.order-L.order:G-I});for(let T=0;T<b;++T)a[T].order=T;return a}getAncestors(t,r={}){for(var s={modesSkip:[],modesOnly:[],typesSkip:[],typesOnly:[]},a=Object.assign(s,r),l=[],h=[],u=[t],c={};u.length;){var _=u.shift();if(_&&!c[_.id]){if(c[_.id]=!0,_.id!=t.id){if(a.modesSkip&&a.modesSkip.length&&a.modesSkip.indexOf(_.mode)!=-1||a.modesOnly&&a.modesOnly.length&&a.modesOnly.indexOf(_.mode)==-1)continue;h.indexOf(_.id)==-1&&(l.push(_),h.push(_.id))}if(_.inputs)for(var d=0;d<_.inputs.length;++d){var f=_.getInputNode(d);if(f){var m=_.inputs[d].type;a.typesSkip&&a.typesSkip.length&&a.typesSkip.indexOf(m)!=-1||a.typesOnly&&a.typesOnly.length&&a.typesOnly.indexOf(f.mode)==-1||h.indexOf(f.id)==-1&&(c[f.id]||u.push(f))}}}}return l.sort((b,T)=>b.order-T.order),l}arrange(t=100,r){var s;const a=this.computeExecutionOrder(!1,!0),l=[];for(let u=0;u<a.length;++u){const c=a[u],_=c._level||1;(s=l[_])!=null||(l[_]=[]),l[_].push(c)}let h=t;for(let u=0;u<l.length;++u){const c=l[u];if(!c)continue;let _=100,d=t+LiteGraph.NODE_TITLE_HEIGHT;for(let f=0;f<c.length;++f){const m=c[f];m.pos[0]=r==LiteGraph.VERTICAL_LAYOUT?d:h,m.pos[1]=r==LiteGraph.VERTICAL_LAYOUT?h:d;const b=r==LiteGraph.VERTICAL_LAYOUT?1:0;m.size[b]>_&&(_=m.size[b]);const T=r==LiteGraph.VERTICAL_LAYOUT?0:1;d+=m.size[T]+t+LiteGraph.NODE_TITLE_HEIGHT}h+=_+t}this.setDirtyCanvas(!0,!0)}getTime(){return this.globaltime}getFixedTime(){return this.fixedtime}getElapsedTime(){return this.elapsed_time}sendEventToAllNodes(t,r,s=LiteGraph.ALWAYS){var a=this._nodes_in_order?this._nodes_in_order:this._nodes;if(a)for(let l=0,h=a.length;l<h;++l){const u=a[l];if(u.constructor===LiteGraph.Subgraph&&t!=="onExecute"){u.mode==s&&u.sendEventToAllNodes(t,r,s);continue}!u[t]||u.mode!==s||(r===void 0?u[t]():Array.isArray(r)?u[t].apply(u,r):u[t](r))}}sendActionToCanvas(t,r){if(this.list_of_graphcanvas)for(const s of this.list_of_graphcanvas)s[t]&&r&&s[t](...r)}add(t,r,s={}){var a,l,h,u={doProcessChange:!0,doCalcSize:!0},c=Object.assign(u,s);if(t){if(t.constructor===LiteGraph.LGraphGroup){this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,this.onGraphChanged({action:"groupAdd",doSave:c.doProcessChange});return}if(t.id!=-1&&this._nodes_by_id[t.id]!=null&&((a=LiteGraph.warn)==null||a.call(LiteGraph,"LiteGraph: there is already a node with this ID, changing it"),LiteGraph.use_uuids?t.id=LiteGraph.uuidv4():t.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw new Error("LiteGraph: max number of nodes in a graph reached");return LiteGraph.use_uuids?(t.id==null||t.id==-1)&&(t.id=LiteGraph.uuidv4()):t.id==null||t.id==-1?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),t.graph=this,this.onGraphChanged({action:"nodeAdd",doSave:c.doProcessChange}),this._nodes.push(t),this._nodes_by_id[t.id]=t,(l=t.onAdded)==null||l.call(t,this),this.config.align_to_grid&&t.alignToGrid(),r||this.updateExecutionOrder(),(h=this.onNodeAdded)==null||h.call(this,t),c.doCalcSize&&t.setSize(t.computeSize()),this.setDirtyCanvas(!0),this.change(),t}}remove(t){var r,s;if(t.constructor===LiteGraph.LGraphGroup){var a=this._groups.indexOf(t);a!=-1&&this._groups.splice(a,1),t.graph=null,this.onGraphChanged({action:"groupRemove"}),this.setDirtyCanvas(!0,!0),this.change();return}if(this._nodes_by_id[t.id]!=null&&!t.ignore_remove){if(t.inputs)for(let h=0;h<t.inputs.length;h++)t.inputs[h].link!=null&&t.disconnectInput(h,{doProcessChange:!1});if(t.outputs)for(let h=0;h<t.outputs.length;h++){let u=t.outputs[h];u.links!=null&&u.links.length&&t.disconnectOutput(h,!1,{doProcessChange:!1})}if((r=t.onRemoved)==null||r.call(t),t.graph=null,this.onGraphChanged({action:"nodeRemove"}),this.list_of_graphcanvas)for(let h=0;h<this.list_of_graphcanvas.length;++h){let u=this.list_of_graphcanvas[h];u.selected_nodes[t.id]&&delete u.selected_nodes[t.id],u.node_dragged==t&&(u.node_dragged=null)}var l=this._nodes.indexOf(t);l!=-1&&this._nodes.splice(l,1),delete this._nodes_by_id[t.id],(s=this.onNodeRemoved)==null||s.call(this,t),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.change(),this.updateExecutionOrder()}}getNodeById(t){return t==null?null:this._nodes_by_id[t]}findNodesByClass(t,r=[]){return r=this._nodes.filter(s=>s.constructor===t),r}findNodesByType(t,r=[]){const s=t.toLowerCase();return r=this._nodes.filter(a=>a.type.toLowerCase()===s),r}findNodeByTitle(t){var r;return(r=this._nodes.find(s=>s.title===t))!=null?r:null}findNodesByTitle(t){return this._nodes.filter(r=>r.title===t)}getNodeOnPos(t,r,s=this._nodes,a=0){var l;return(l=s.reverse().find(h=>h.isPointInside(t,r,a)))!=null?l:null}getGroupOnPos(t,r){var s;return(s=this._groups.find(a=>a.isPointInside(t,r,2,!0)))!=null?s:null}checkNodeTypes(){for(var t,r=0;r<this._nodes.length;r++){var s=this._nodes[r],a=LiteGraph.registered_node_types[s.type];if(s.constructor!=a){LiteGraph.debug&&((t=LiteGraph.log)==null||t.call(LiteGraph,`node being replaced by newer version: ${s.type}`));var l=LiteGraph.createNode(s.type);this._nodes[r]=l,l.configure(s.serialize()),l.graph=this,this._nodes_by_id[l.id]=l,s.inputs&&(l.inputs=s.inputs.concat()),s.outputs&&(l.outputs=s.outputs.concat())}}this.updateExecutionOrder()}onAction(t,r,s){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);for(var a=0;a<this._input_nodes.length;++a){var l=this._input_nodes[a];if(l.properties.name==t){l.actionDo(t,r,s);break}}}trigger(t,r){var s;(s=this.onTrigger)==null||s.call(this,t,r)}addInput(t,r,s){var a,l,h=this.inputs[t];h||(this.beforeChange(),this.inputs[t]={name:t,type:r,value:s},this.onGraphChanged({action:"addInput"}),this.afterChange(),(a=this.onInputAdded)==null||a.call(this,t,r),(l=this.onInputsOutputsChange)==null||l.call(this))}setInputData(t,r){var s=this.inputs[t];s&&(s.value=r)}getInputData(t){var r=this.inputs[t];return r?r.value:null}renameInput(t,r){var s,a,l;if(r!=t){if(!this.inputs[t])return!1;if(this.inputs[r])return(s=LiteGraph.error)==null||s.call(LiteGraph,"there is already one input with that name"),!1;this.inputs[r]=this.inputs[t],delete this.inputs[t],this.onGraphChanged({action:"renameInput"}),(a=this.onInputRenamed)==null||a.call(this,t,r),(l=this.onInputsOutputsChange)==null||l.call(this)}}changeInputType(t,r){var s;if(!this.inputs[t])return!1;this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()==String(r).toLowerCase()||(this.inputs[t].type=r,this.onGraphChanged({action:"changeInputType"}),(s=this.onInputTypeChanged)==null||s.call(this,t,r))}removeInput(t){var r,s;return this.inputs[t]?(delete this.inputs[t],this.onGraphChanged({action:"graphRemoveInput"}),(r=this.onInputRemoved)==null||r.call(this,t),(s=this.onInputsOutputsChange)==null||s.call(this),!0):!1}addOutput(t,r,s){var a,l;this.outputs[t]={name:t,type:r,value:s},this.onGraphChanged({action:"addOutput"}),(a=this.onOutputAdded)==null||a.call(this,t,r),(l=this.onInputsOutputsChange)==null||l.call(this)}setOutputData(t,r){var s=this.outputs[t];s&&(s.value=r)}getOutputData(t){var r=this.outputs[t];return r?r.value:null}renameOutput(t,r){var s,a,l;if(!this.outputs[t])return!1;if(this.outputs[r])return(s=LiteGraph.error)==null||s.call(LiteGraph,"there is already one output with that name"),!1;this.outputs[r]=this.outputs[t],delete this.outputs[t],this._version++,(a=this.onOutputRenamed)==null||a.call(this,t,r),(l=this.onInputsOutputsChange)==null||l.call(this)}changeOutputType(t,r){var s;if(!this.outputs[t])return!1;this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()==String(r).toLowerCase()||(this.outputs[t].type=r,this.onGraphChanged({action:"changeOutputType"}),(s=this.onOutputTypeChanged)==null||s.call(this,t,r))}removeOutput(t){var r,s;return this.outputs[t]?(delete this.outputs[t],this.onGraphChanged({action:"removeOutput"}),(r=this.onOutputRemoved)==null||r.call(this,t),(s=this.onInputsOutputsChange)==null||s.call(this),!0):!1}triggerInput(t,r){for(var s=this.findNodesByTitle(t),a=0;a<s.length;++a)s[a].onTrigger(r)}setCallback(t,r){for(var s=this.findNodesByTitle(t),a=0;a<s.length;++a)s[a].setTrigger(r)}beforeChange(t){var r;(r=this.onBeforeChange)==null||r.call(this,this,t),this.sendActionToCanvas("onBeforeChange",this)}afterChange(t){var r;(r=this.onAfterChange)==null||r.call(this,this,t),this.sendActionToCanvas("onAfterChange",this)}connectionChange(t){var r;this.updateExecutionOrder(),(r=this.onConnectionChange)==null||r.call(this,t),this.onGraphChanged({action:"connectionChange",doSave:!1}),this.sendActionToCanvas("onConnectionChange")}isLive(){if(!this.list_of_graphcanvas)return!1;for(var t=0;t<this.list_of_graphcanvas.length;++t){var r=this.list_of_graphcanvas[t];if(r.live_mode)return!0}return!1}clearTriggeredSlots(){for(var t in this.links){var r=this.links[t];r&&r._last_time&&(r._last_time=0)}}change(){var t,r;(t=LiteGraph.log)==null||t.call(LiteGraph,"Graph visually changed"),this.sendActionToCanvas("setDirty",[!0,!0]),(r=this.on_change)==null||r.call(this,this)}setDirtyCanvas(t,r){this.sendActionToCanvas("setDirty",[t,r])}removeLink(t){var r=this.links[t];if(r){var s=this.getNodeById(r.target_id);s&&(this.beforeChange(),s.disconnectInput(r.target_slot),this.afterChange())}}serialize(){var t,r;const s=this._nodes.map(f=>f.serialize());var a=[];for(var l in this.links){var h=this.links[l];if(!h.serialize){(t=LiteGraph.warn)==null||t.call(LiteGraph,"weird LLink bug, link info is not a LLink but a regular object");var u=new LiteGraph.LLink;for(var c in h)u[c]=h[c];this.links[l]=u,h=u}a.push(h.serialize())}const _=this._groups.map(f=>f.serialize());var d={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:s,links:a,groups:_,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return(r=this.onSerialize)==null||r.call(this,d),d}configure(t,r){var s,a,l,h,u;if(t){r||this.clear();var c=t.nodes;if(t.links&&t.links.constructor===Array){for(var _=[],d=0;d<t.links.length;++d){var f=t.links[d];if(!f){(s=LiteGraph.warn)==null||s.call(LiteGraph,"serialized graph link data contains errors, skipping.");continue}var m=new LiteGraph.LLink;m.configure(f),_[m.id]=m}t.links=_}for(let G in t)["nodes","groups"].includes(G)||(this[G]=t[G]);var b=!1;if(this._nodes=[],c){for(let G=0,I=c.length;G<I;++G){var T=c[G],L=LiteGraph.createNode(T.type,T.title);L||((a=LiteGraph.log)==null||a.call(LiteGraph,`Node not found or has errors: ${T.type}`),L=new LiteGraph.LGraphNode,L.last_serialization=T,L.has_errors=!0,b=!0),L.id=T.id,this.add(L,!0,{doProcessChange:!1})}c.forEach(G=>{const I=this.getNodeById(G.id);I==null||I.configure(G)})}return this._groups.length=0,t.groups&&t.groups.forEach(G=>{const I=new LiteGraph.LGraphGroup;I.configure(G),this.add(I,!0,{doProcessChange:!1})}),this.updateExecutionOrder(),this.extra=(l=t.extra)!=null?l:{},(h=this.onConfigure)==null||h.call(this,t),t._version?(u=LiteGraph.debug)==null||u.call(LiteGraph,"skip onGraphChanged when configure passing version too!"):this.onGraphChanged({action:"graphConfigure",doSave:!1}),this.setDirtyCanvas(!0,!0),b}}load(t,r){var s=this;if(t.constructor===File||t.constructor===Blob){var a=new FileReader;a.addEventListener("load",h=>{var u=JSON.parse(h.target.result);s.configure(u),r==null||r()}),a.readAsText(t);return}var l=new XMLHttpRequest;l.open("GET",t,!0),l.send(null),l.onload=h=>{var u;if(l.status!==200){(u=LiteGraph.error)==null||u.call(LiteGraph,"Error loading graph:",l.status,l.response);return}var c=JSON.parse(l.response);s.configure(c),r==null||r()},l.onerror=h=>{var u;(u=LiteGraph.error)==null||u.call(LiteGraph,"Error loading graph:",h)}}onGraphSaved(t={}){var r={};Object.assign(r,t),this.savedVersion=this._version}onGraphLoaded(t={}){var r={};Object.assign(r,t),this.savedVersion=this._version}onGraphChanged(t={}){var r,s,a,l,h,u,c={action:"",doSave:!0,doSaveGraph:!0},_=Object.assign(c,t);if(this._version++,_.action?(r=LiteGraph.debug)==null||r.call(LiteGraph,"Graph change",_.action):(s=LiteGraph.debug)==null||s.call(LiteGraph,"Graph change, no action",_),_.doSave&&LiteGraph.actionHistory_enabled){(a=LiteGraph.debug)==null||a.call(LiteGraph,"onGraphChanged SAVE :: "+_.action);var d={actionName:_.action};_.doSaveGraph&&(d=Object.assign(d,{graphSave:this.serialize()}));for(var f=this.history;f.actionHistoryPtr<f.actionHistoryVersions.length-1;)(l=LiteGraph.debug)==null||l.call(LiteGraph,"popping: gone back? "+(f.actionHistoryPtr+" < "+(f.actionHistoryVersions.length-1))),f.actionHistoryVersions.pop();if(f.actionHistoryVersions.length>=LiteGraph.actionHistoryMaxSave){var m=f.actionHistoryVersions.shift();(h=LiteGraph.debug)==null||h.call(LiteGraph,"maximum saves reached: "+f.actionHistoryVersions.length+", remove older: "+m),f.actionHistory[m]=!1}f.actionHistoryPtr=f.actionHistoryVersions.length,f.actionHistoryVersions.push(f.actionHistoryPtr),f.actionHistory[f.actionHistoryPtr]=d,(u=LiteGraph.debug)==null||u.call(LiteGraph,"history saved: "+f.actionHistoryPtr,d.actionName)}}actionHistoryBack(t={}){var r,s,a,l,h,u={};Object.assign(u,t);var c=this.history;return c.actionHistoryPtr!=null&&c.actionHistoryPtr>=0?(c.actionHistoryPtr--,(r=LiteGraph.debug)==null||r.call(LiteGraph,"history step back: "+c.actionHistoryPtr),this.actionHistoryLoad({iVersion:c.actionHistoryPtr})?((a=LiteGraph.debug)==null||a.call(LiteGraph,"history loaded back: "+c.actionHistoryPtr),(l=LiteGraph.debug)==null||l.call(LiteGraph,this.history),!0):((s=LiteGraph.warn)==null||s.call(LiteGraph,"historyLoad failed, restore pointer? "+c.actionHistoryPtr),c.actionHistoryPtr++,!1)):((h=LiteGraph.debug)==null||h.call(LiteGraph,"history is already at older state"),!1)}actionHistoryForward(t={}){var r,s,a,l,h={};Object.assign(h,t);var u=this.history;return u.actionHistoryPtr<u.actionHistoryVersions.length?(u.actionHistoryPtr++,(r=LiteGraph.debug)==null||r.call(LiteGraph,"history step forward: "+u.actionHistoryPtr),this.actionHistoryLoad({iVersion:u.actionHistoryPtr})?((a=LiteGraph.debug)==null||a.call(LiteGraph,"history loaded forward: "+u.actionHistoryPtr),!0):((s=LiteGraph.warn)==null||s.call(LiteGraph,"historyLoad failed, restore pointer? "+u.actionHistoryPtr),u.actionHistoryPtr--,!1)):((l=LiteGraph.debug)==null||l.call(LiteGraph,"history is already at newer state"),!1)}actionHistoryLoad(t={}){var r,s={iVersion:!1,backStep:!1},a=Object.assign(s,t),l=this.history;if(l.actionHistory[a.iVersion]&&l.actionHistory[a.iVersion].graphSave){var h=JSON.stringify(this.history);return this.configure(l.actionHistory[a.iVersion].graphSave),this.history=JSON.parse(h),(r=LiteGraph.debug)==null||r.call(LiteGraph,"history loaded: "+a.iVersion,l.actionHistory[a.iVersion].actionName),!0}else return!1}};g(we,"supported_types",["number","string","boolean"]),g(we,"STATUS_STOPPED",1),g(we,"STATUS_RUNNING",2);let LGraph=we;class LGraphNode{constructor(t="Unnamed"){this.title=t,this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}}set pos(t){var r;!t||t.length<2||((r=this._pos)!=null||(this._pos=new Float32Array(10,10)),this._pos[0]=t[0],this._pos[1]=t[1])}get pos(){return this._pos}configure(t){var r,s,a,l,h;Object.entries(t).forEach(([u,c])=>{var _;if(u==="properties"){for(var d in c)this.properties[d]=c[d],(_=this.onPropertyChanged)==null||_.call(this,d,c[d]);return}c!==null&&(typeof c=="object"?this[u]&&this[u].configure?this[u].configure(c):this[u]=LiteGraph.cloneObject(c,this[u]):this[u]=c)}),t.title||(this.title=this.constructor.title),(r=this.inputs)==null||r.forEach((u,c)=>{var _,d;if(!u.link)return;const f=this.graph?this.graph.links[u.link]:null;(_=this.onConnectionsChange)==null||_.call(this,LiteGraph.INPUT,c,!0,f,u),(d=this.onInputAdded)==null||d.call(this,u)}),(s=this.outputs)==null||s.forEach((u,c)=>{var _;u.links&&(u.links.forEach(()=>{var d;const f=this.graph;(d=this.onConnectionsChange)==null||d.call(this,LiteGraph.OUTPUT,c,!0,f,u)}),(_=this.onOutputAdded)==null||_.call(this,u))}),this.widgets&&(this.widgets.forEach(u=>{u&&u.options&&u.options.property&&this.properties[u.options.property]!==void 0&&(u.value=JSON.parse(JSON.stringify(this.properties[u.options.property])))}),(a=t.widgets_values)==null||a.forEach((u,c)=>{this.widgets[c]&&(this.widgets[c].value=u)})),(l=this.onConfigure)==null||l.call(this,t),(h=this.graph)==null||h.onGraphChanged({action:"nodeConfigure",doSave:!1})}serialize(){var t,r,s,a={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};return this.constructor===LGraphNode&&this.last_serialization?this.last_serialization:(this.inputs&&(a.inputs=LiteGraph.cloneObject(this.inputs)),this.outputs&&(this.outputs.forEach(l=>{delete l._data}),a.outputs=LiteGraph.cloneObject(this.outputs)),this.title&&this.title!=this.constructor.title&&(a.title=this.title),this.properties&&(a.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets&&(a.widgets_values=this.widgets.map(l=>{var h;return(h=l==null?void 0:l.value)!=null?h:null})),(t=a.type)!=null||(a.type=this.constructor.type),this.color&&(a.color=this.color),this.bgcolor&&(a.bgcolor=this.bgcolor),this.boxcolor&&(a.boxcolor=this.boxcolor),this.shape&&(a.shape=this.shape),(r=this.onSerialize)!=null&&r.call(this,a)&&((s=LiteGraph.warn)==null||s.call(LiteGraph,"node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter")),a)}clone(){var t,r,s=LiteGraph.createNode(this.type);if(!s)return null;var a=LiteGraph.cloneObject(this.serialize());return(t=a.inputs)==null||t.forEach(l=>{l.link=null}),(r=a.outputs)==null||r.forEach(l=>{l.links&&(l.links.length=0)}),delete a.id,LiteGraph.use_uuids&&(a.id=LiteGraph.uuidv4()),s.configure(a),s}toString(){return JSON.stringify(this.serialize())}getTitle(){var t;return(t=this.title)!=null?t:this.constructor.title}setProperty(t,r){var s,a;if(this.properties||(this.properties={}),r===this.properties[t])return;const l=this.properties[t];this.properties[t]=r,((s=this.onPropertyChanged)==null?void 0:s.call(this,t,r,l))===!1&&(this.properties[t]=l);const h=(a=this.widgets)==null?void 0:a.find(u=>{var c;return u&&((c=u.options)==null?void 0:c.property)===t});h&&(h.value=r)}setOutputData(t,r){var s;if(this.outputs){if((t==null?void 0:t.constructor)===String)t=this.findOutputSlot(t);else if(t==-1||t>=this.outputs.length)return;var a=this.outputs[t];a&&(a._data=r,(s=this.outputs[t].links)==null||s.forEach(l=>{const h=this.graph.links[l];h&&(h.data=r)}))}}setOutputDataType(t,r){var s,a;if(this.outputs&&!(t==-1||t>=this.outputs.length)){var l=this.outputs[t];l&&(l.type=r,(a=(s=this.outputs[t])==null?void 0:s.links)==null||a.forEach(h=>{this.graph.links[h]&&(this.graph.links[h].type=r)}))}}getInputData(t,r,s){var a;if(this.inputs&&!(t>=this.inputs.length||this.inputs[t].link==null)){var l=this.inputs[t].link,h=this.graph.links[l];if(!h)return null;if(!r)return h.data;var u=this.graph.getNodeById(h.origin_id);if(!u)return h.data;if(s){var c=this.id+"_getInputData_forced_"+Math.floor(Math.random()*9999),_={action:c,options:{action_call:c}};this.refreshAncestors(_)}return u.updateOutputData?u.updateOutputData(h.origin_slot):(a=u.doExecute)==null||a.call(u),h.data}}getInputDataType(t){if(!this.inputs||t>=this.inputs.length||this.inputs[t].link==null)return null;var r=this.inputs[t].link,s=this.graph.links[r];if(!s)return null;var a=this.graph.getNodeById(s.origin_id);if(!a)return s.type;var l=a.outputs[s.origin_slot];return l?l.type:null}getInputDataByName(t,r){var s=this.findInputSlot(t);return s==-1?null:this.getInputData(s,r)}isInputConnected(t){return this.inputs?t<this.inputs.length&&this.inputs[t].link!=null:!1}getInputInfo(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null}getInputLink(t){if(!this.inputs)return null;if(t<this.inputs.length){var r=this.inputs[t];return this.graph.links[r.link]}return null}getInputNode(t){if(!this.inputs||t>=this.inputs.length)return null;var r=this.inputs[t];if(!r||r.link===null)return null;var s=this.graph.links[r.link];return s?this.graph.getNodeById(s.origin_id):null}getInputOrProperty(t){if(this.inputs)for(var r=0,s=this.inputs.length;r<s;++r){var a=this.inputs[r];if(t==a.name&&a.link!=null){var l=this.graph.links[a.link];if(l)return l.data}}return this.properties?this.properties[t]:null}getOutputData(t){if(!this.outputs||t>=this.outputs.length)return null;var r=this.outputs[t];return r._data}getOutputInfo(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null}isOutputConnected(t){return this.outputs?t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length:!1}isAnyOutputConnected(){return this.outputs?this.outputs.some(t=>t.links&&t.links.length):!1}getOutputNodes(t){if(!this.outputs||t>=this.outputs.length)return null;const r=this.outputs[t];return!r.links||r.links.length===0?null:r.links.map(s=>this.graph.links[s]).filter(s=>s).map(s=>this.graph.getNodeById(s.target_id)).filter(s=>s)}addOnTriggerInput(){var t=this.findInputSlot("onTrigger");return t==-1?(this.addInput("onTrigger",LiteGraph.EVENT,{removable:!0,nameLocked:!0}),this.findInputSlot("onTrigger")):t}addOnExecutedOutput(){var t=this.findOutputSlot("onExecuted");return t==-1?(this.addOutput("onExecuted",LiteGraph.ACTION,{removable:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")):t}onAfterExecuteNode(t,r){var s,a=this.findOutputSlot("onExecuted");a!=-1&&((s=LiteGraph.debug)==null||s.call(LiteGraph,this.id+":"+this.order+" triggering slot onAfterExecute",t,r),this.triggerSlot(a,t,null,r))}changeMode(t){switch(t){case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.ON_EVENT:break;case LiteGraph.NEVER:break;case LiteGraph.ALWAYS:break;case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=t,!0}executePendingActions(){!this._waiting_actions||!this._waiting_actions.length||(this._waiting_actions.forEach(t=>{this.onAction(t[0],t[1],t[2],t[3],t[4])}),this._waiting_actions.length=0)}doExecute(t,r={}){var s,a,l,h,u;if(this.onExecute){if((s=r.action_call)!=null||(r.action_call=`${this.id}_exec_${Math.floor(Math.random()*9999)}`),this.graph.nodes_executing&&this.graph.nodes_executing[this.id]){(a=LiteGraph.debug)==null||a.call(LiteGraph,"NODE already executing! Prevent! "+this.id+":"+this.order);return}if(LiteGraph.ensureNodeSingleExecution&&this.exec_version&&this.exec_version>=this.graph.iteration&&this.exec_version!==void 0){(l=LiteGraph.debug)==null||l.call(LiteGraph,"!! NODE already EXECUTED THIS STEP !! "+this.exec_version);return}if(LiteGraph.ensureUniqueExecutionAndActionCall&&this.graph.nodes_executedAction[this.id]&&r&&r.action_call&&this.graph.nodes_executedAction[this.id]==r.action_call){(h=LiteGraph.debug)==null||h.call(LiteGraph,"!! NODE already ACTION THIS STEP !! "+r.action_call);return}this.graph.nodes_executing[this.id]=!0,this.onExecute(t,r),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,r&&r.action_call&&(this.action_call=r.action_call,this.graph.nodes_executedAction[this.id]=r.action_call)}this.execute_triggered=2,(u=this.onAfterExecuteNode)==null||u.call(this,t,r)}execute(t,r={}){return this.doExecute(t,r)}actionDo(t,r,s={},a){var l,h,u,c;if(this.onAction){if((l=s.action_call)!=null||(s.action_call=`${this.id}_${t||"action"}_${Math.floor(Math.random()*9999)}`),LiteGraph.ensureNodeSingleAction&&this.graph.nodes_actioning&&this.graph.nodes_actioning[this.id]==s.action_call)return;if((h=LiteGraph.debug)==null||h.call(LiteGraph,"CheckActioned ? "+this.id+":"+this.order+" :: "+this.action_call),LiteGraph.ensureUniqueExecutionAndActionCall&&this.graph.nodes_executedAction[this.id]&&s&&s.action_call&&this.graph.nodes_executedAction[this.id]==s.action_call){(u=LiteGraph.debug)==null||u.call(LiteGraph,"!! NODE already ACTION THIS STEP !! "+s.action_call),\u00E7;return}this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,r,s,a),this.graph.nodes_actioning[this.id]=!1,s&&s.action_call&&(this.action_call=s.action_call,this.graph.nodes_executedAction[this.id]=s.action_call)}this.action_triggered=2,(c=this.onAfterExecuteNode)==null||c.call(this,r,s)}trigger(t,r,s){!this.outputs||this.outputs.length===0||(this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime()),this.outputs.forEach((a,l)=>{a&&a.type===LiteGraph.EVENT&&(!t||a.name===t)&&this.triggerSlot(l,r,null,s)}))}triggerSlot(t,r,s,a={}){var l,h,u,c;if(this.outputs){if(t==null){(l=LiteGraph.error)==null||l.call(LiteGraph,"triggerSlot","slot must be a number");return}t.constructor!==Number&&((h=LiteGraph.warn)==null||h.call(LiteGraph,"triggerSlot","slot must be a number, use node.trigger('name') if you want to use a string"));var _=this.outputs[t];if(_){var d=_.links;if(!(!d||!d.length)&&!(this.graph&&this.graph.ancestorsCall)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var f=0;f<d.length;++f){var m=d[f];if(!(s!=null&&s!=m)){var b=this.graph.links[d[f]];if(b){b._last_time=LiteGraph.getTime();var T=this.graph.getNodeById(b.target_id);if(T){if(T.mode===LiteGraph.ON_TRIGGER)a.action_call||(a.action_call=`${this.id}_trigg_${Math.floor(Math.random()*9999)}`),LiteGraph.refreshAncestorsOnTriggers&&T.refreshAncestors({action:"trigger",param:r,options:a}),T.onExecute&&T.doExecute(r,a);else if(T.onAction){a.action_call||(a.action_call=`${this.id}_act_${Math.floor(Math.random()*9999)}`);let L=T.inputs[b.target_slot];(u=LiteGraph.debug)==null||u.call(LiteGraph,"triggerSlot","will call onACTION: "+this.id+":"+this.order+" :: "+L.name),LiteGraph.refreshAncestorsOnActions&&T.refreshAncestors({action:L.name,param:r,options:a}),LiteGraph.use_deferred_actions&&T.onExecute?((c=T._waiting_actions)!=null||(T._waiting_actions=[]),T._waiting_actions.push([L.name,r,a,b.target_slot])):T.actionDo(L.name,r,a,b.target_slot)}}}}}}}}}clearTriggeredSlot(t,r){!this.outputs||!this.outputs[t]||!this.outputs[t].links||this.outputs[t].links.forEach(s=>{if(r!==null&&r!==s)return;const a=this.graph.links[s];a&&(a._last_time=0)})}setSize(t){var r;this.size=t,(r=this.onResize)==null||r.call(this,this.size)}addProperty(t,r,s,a){var l,h;const u={name:t,type:s,default_value:r,...a};return this.properties_info=(l=this.properties_info)!=null?l:[],this.properties_info.push(u),this.properties=(h=this.properties)!=null?h:{},this.properties[t]=r,u}addInput(t,r,s){return this.addSlot(t,r,s,!0)}addOutput(t,r,s){return this.addSlot(t,r,s,!1)}addSlot(t,r,s,a){var l,h,u,c;const _=a?{name:t,type:r,link:null,...s}:{name:t,type:r,links:null,...s};return a?(this.inputs=(l=this.inputs)!=null?l:[],this.inputs.push(_),(h=this.onInputAdded)==null||h.call(this,_),LiteGraph.registerNodeAndSlotType(this,r)):(this.outputs=(u=this.outputs)!=null?u:[],this.outputs.push(_),(c=this.onOutputAdded)==null||c.call(this,_),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,r,!0)),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),_}addInputs(t){this.addSlots(t,!0)}addOutputs(t){this.addSlots(t,!1)}addSlots(t,r){var s;typeof t=="string"&&(t=[t]),t.forEach(a=>{var l,h,u,c,_,d;const f=r?{name:a[0],type:a[1],link:null,...(l=a[2])!=null?l:{}}:{name:a[0],type:a[1],links:null,...(h=a[2])!=null?h:{}};r?(this.inputs=(u=this.inputs)!=null?u:[],this.inputs.push(f),(c=this.onInputAdded)==null||c.call(this,f),LiteGraph.registerNodeAndSlotType(this,a[1])):(this.outputs=(_=this.outputs)!=null?_:[],this.outputs.push(f),(d=this.onOutputAdded)==null||d.call(this,f),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,a[1],!0))}),this.setSize(this.computeSize()),(s=this.setDirtyCanvas)==null||s.call(this,!0,!0)}removeInput(t){var r;this.disconnectInput(t);const s=this.inputs.splice(t,1)[0];this.inputs.slice(t).filter(a=>!!a).forEach(a=>{const l=this.graph.links[a.link];l!=null&&l.target_slot&&l.target_slot--}),this.setSize(this.computeSize()),(r=this.onInputRemoved)==null||r.call(this,t,s),this.setDirtyCanvas(!0,!0)}removeOutput(t){var r;this.disconnectOutput(t),this.outputs=this.outputs.filter((s,a)=>a!==t),this.outputs.slice(t).forEach(s=>{!s||!s.links||s.links.forEach(a=>{const l=this.graph.links[a];l&&(l.origin_slot-=1)})}),this.setSize(this.computeSize()),(r=this.onOutputRemoved)==null||r.call(this,t),this.setDirtyCanvas(!0,!0)}addConnection(t,r,s,a){var l={name:t,type:r,pos:s,direction:a,links:null};return this.connections.push(l),l}computeSize(t){if(this.constructor.size)return this.constructor.size.concat();var r=t||new Float32Array([0,0]),s=LiteGraph.NODE_TEXT_SIZE;const a=m=>m?s*m.length*.6:0;var l=a(this.title),h=0,u=0;this.inputs&&(h=this.inputs.reduce((m,b)=>{const T=b.label||b.name||"",L=a(T);return Math.max(m,L)},0)),this.outputs&&(u=this.outputs.reduce((m,b)=>{const T=b.label||b.name||"",L=a(T);return Math.max(m,L)},0)),r[0]=Math.max(h+u+10,l),r[0]=Math.max(r[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(r[0]=Math.max(r[0],LiteGraph.NODE_WIDTH*1.5));const c=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1,1)*LiteGraph.NODE_SLOT_HEIGHT;r[1]=c+(this.constructor.slot_start_y||0);let _=0;if(this.widgets&&this.widgets.length){for(var d=0,f=this.widgets.length;d<f;++d)this.widgets[d].computeSize?_+=this.widgets[d].computeSize(r[0])[1]+4:_+=LiteGraph.NODE_WIDGET_HEIGHT+4;_+=8}return this.widgets_up?r[1]=Math.max(r[1],_):this.widgets_start_y!=null?r[1]=Math.max(r[1],_+this.widgets_start_y):r[1]+=_,this.constructor.min_height&&r[1]<this.constructor.min_height&&(r[1]=this.constructor.min_height),r[1]+=6,r}getPropertyInfo(t){var r=null;if(this.properties_info){for(var s=0;s<this.properties_info.length;++s)if(this.properties_info[s].name==t){r=this.properties_info[s];break}}return this.constructor[`@${t}`]&&(r=this.constructor[`@${t}`]),this.constructor.widgets_info&&this.constructor.widgets_info[t]&&(r=this.constructor.widgets_info[t]),!r&&this.onGetPropertyInfo&&(r=this.onGetPropertyInfo(t)),r||(r={}),r.type||(r.type=typeof this.properties[t]),r.widget=="combo"&&(r.type="enum"),r}addWidget(t,r,s,a,l){var h,u,c;(h=this.widgets)!=null||(this.widgets=[]),!l&&a&&a.constructor===Object&&(l=a,a=null),l&&l.constructor===String&&(l={property:l}),a&&a.constructor===String&&(l!=null||(l={}),l.property=a,a=null),a&&a.constructor!==Function&&((u=LiteGraph.warn)==null||u.call(LiteGraph,"addWidget: callback must be a function"),a=null);var _={type:t.toLowerCase(),name:r,value:s,callback:a,options:l||{}};if(_.options.y!==void 0&&(_.y=_.options.y),!a&&!_.options.callback&&!_.options.property&&((c=LiteGraph.warn)==null||c.call(LiteGraph,"LiteGraph addWidget(...) without a callback or property assigned")),t=="combo"&&!_.options.values)throw Error("LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }");return this.widgets.push(_),this.setSize(this.computeSize()),_}addCustomWidget(t){var r;return(r=this.widgets)!=null||(this.widgets=[]),this.widgets.push(t),t}getBounding(t=new Float32Array(4),r){const s=this.pos,a=this.flags.collapsed,l=this.size;let h=0,u=1,c=0,_=0;return r&&(h=4,u=6+h,c=4,_=5+c),t[0]=s[0]-h,t[1]=s[1]-LiteGraph.NODE_TITLE_HEIGHT-c,t[2]=a?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+u:l[0]+u,t[3]=a?LiteGraph.NODE_TITLE_HEIGHT+_:l[1]+LiteGraph.NODE_TITLE_HEIGHT+_,this.onBounding&&this.onBounding(t),t}isPointInside(t,r,s=0,a){var l=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(a&&(l=0),this.flags&&this.flags.collapsed){if(LiteGraph.isInsideRectangle(t,r,this.pos[0]-s,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-s,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*s,LiteGraph.NODE_TITLE_HEIGHT+2*s))return!0}else if(this.pos[0]-4-s<t&&this.pos[0]+this.size[0]+4+s>t&&this.pos[1]-l-s<r&&this.pos[1]+this.size[1]+s>r)return!0;return!1}getSlotInPosition(t,r){var s=new Float32Array(2);if(this.inputs)for(let a=0,l=this.inputs.length;a<l;++a){let h=this.inputs[a];if(this.getConnectionPos(!0,a,s),LiteGraph.isInsideRectangle(t,r,s[0]-10,s[1]-5,20,10))return{input:h,slot:a,link_pos:s}}if(this.outputs)for(let a=0,l=this.outputs.length;a<l;++a){let h=this.outputs[a];if(this.getConnectionPos(!1,a,s),LiteGraph.isInsideRectangle(t,r,s[0]-10,s[1]-5,20,10))return{output:h,slot:a,link_pos:s}}return null}findInputSlot(t,r){if(!this.inputs)return-1;for(var s=0,a=this.inputs.length;s<a;++s)if(t==this.inputs[s].name)return r?this.inputs[s]:s;return-1}findOutputSlot(t,r=!1){if(!this.outputs)return-1;for(var s=0,a=this.outputs.length;s<a;++s)if(t==this.outputs[s].name)return r?this.outputs[s]:s;return-1}findInputSlotFree(t={}){var r={returnObj:!1,typesNotAccepted:[]},s=Object.assign(r,t);if(!this.inputs)return-1;for(var a=0,l=this.inputs.length;a<l;++a)if(!(this.inputs[a].link&&this.inputs[a].link!=null)&&!(s.typesNotAccepted&&s.typesNotAccepted.includes&&s.typesNotAccepted.includes(this.inputs[a].type)))return s.returnObj?this.inputs[a]:a;return-1}findOutputSlotFree(t={}){var r={returnObj:!1,typesNotAccepted:[]},s=Object.assign(r,t);if(!this.outputs)return-1;for(let a=0,l=this.outputs.length;a<l;++a)if(!(this.outputs[a].links&&this.outputs[a].links!=null)&&!(s.typesNotAccepted&&s.typesNotAccepted.includes&&s.typesNotAccepted.includes(this.outputs[a].type)))return s.returnObj?this.outputs[a]:a;return-1}findInputSlotByType(t,r,s,a){return this.findSlotByType(!0,t,r,s,a)}findOutputSlotByType(t,r,s,a){return this.findSlotByType(!1,t,r,s,a)}findSlotByType(t=!1,r,s=!1,a=!1,l=!1){var h=t?this.inputs:this.outputs;if(!h)return-1;(r==""||r=="*")&&(r=0);for(let u=0,c=h.length;u<c;++u){let _=(r+"").toLowerCase().split(","),d=h[u].type=="0"||h[u].type=="*"?"0":h[u].type;d=(d+"").toLowerCase().split(",");for(let f=0;f<_.length;f++)for(let m=0;m<d.length;m++)if(_[f]=="_event_"&&(_[f]=LiteGraph.EVENT),d[f]=="_event_"&&(d[f]=LiteGraph.EVENT),_[f]=="*"&&(_[f]=0),d[f]=="*"&&(d[f]=0),_[f]==d[m]){if(a&&h[u].links&&h[u].links!==null)continue;return s?h[u]:u}}if(a&&!l)for(let u=0,c=h.length;u<c;++u){let _=(r+"").toLowerCase().split(","),d=h[u].type=="0"||h[u].type=="*"?"0":h[u].type;d=(d+"").toLowerCase().split(",");for(let f=0;f<_.length;f++)for(let m=0;m<d.length;m++)if(_[f]=="*"&&(_[f]=0),d[f]=="*"&&(d[f]=0),_[f]==d[m])return s?h[u]:u}return-1}connectByType(t,r,s="*",a={}){var l,h,u,c,_,d={createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},f=Object.assign(d,a);r&&r.constructor===Number&&(r=this.graph.getNodeById(r));var m=r.findInputSlotByType(s,!1,!0);return m>=0&&m!==null?((l=LiteGraph.debug)==null||l.call(LiteGraph,"CONNbyTYPE type "+s+" for "+m),this.connect(t,r,m)):f.createEventInCase&&s==LiteGraph.EVENT?((h=LiteGraph.debug)==null||h.call(LiteGraph,"connect WILL CREATE THE onTrigger "+s+" to "+r),this.connect(t,r,-1)):f.generalTypeInCase&&(m=r.findInputSlotByType(0,!1,!0,!0),(u=LiteGraph.debug)==null||u.call(LiteGraph,"connect TO a general type (*, 0), if not found the specific type ",s," to ",r,"RES_SLOT:",m),m>=0)?this.connect(t,r,m):f.firstFreeIfOutputGeneralInCase&&(s==0||s=="*"||s=="")&&(m=r.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}),(c=LiteGraph.debug)==null||c.call(LiteGraph,"connect TO TheFirstFREE ",s," to ",r,"RES_SLOT:",m),m>=0)?this.connect(t,r,m):((_=LiteGraph.debug)==null||_.call(LiteGraph,"no way to connect type: ",s," to targetNODE ",r),null)}connectByTypeOutput(t,r,s="*",a={}){var l,h,u,c={createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},_=Object.assign(c,a);r&&r.constructor===Number&&(r=this.graph.getNodeById(r));var d=r.findOutputSlotByType(s,!1,!0);return d>=0&&d!==null?((l=LiteGraph.debug)==null||l.call(LiteGraph,"CONNbyTYPE OUT! type "+s+" for "+d),r.connect(d,this,t)):_.generalTypeInCase&&(d=r.findOutputSlotByType(0,!1,!0,!0),d>=0)?r.connect(d,this,t):_.createEventInCase&&s==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots?(d=r.addOnExecutedOutput(),r.connect(d,this,t)):_.firstFreeIfInputGeneralInCase&&(s==0||s=="*"||s==""||s=="undefined")&&(d=r.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}),d>=0)?r.connect(d,this,t):((h=LiteGraph.debug)==null||h.call(LiteGraph,"no way to connect byOUT type: ",s," to sourceNODE ",r),(u=LiteGraph.log)==null||u.call(LiteGraph,"type OUT! "+s+" not found or not free?"),null)}connect(t,r,s=0){var a,l,h,u,c,_,d,f,m,b,T,L,G,I;if(!this.graph)return(a=LiteGraph.log)==null||a.call(LiteGraph,"Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(t.constructor===String){if(t=this.findOutputSlot(t),t==-1)return(l=LiteGraph.log)==null||l.call(LiteGraph,`Connect: Error, no slot of name ${t}`),null}else if(!this.outputs||t>=this.outputs.length)return(h=LiteGraph.log)==null||h.call(LiteGraph,"Connect: Error, slot number not found"),null;if(r&&r.constructor===Number&&(r=this.graph.getNodeById(r)),!r)throw new Error("target node is null");if(r==this)return null;if(s.constructor===String){if(s=r.findInputSlot(s),s==-1)return(u=LiteGraph.log)==null||u.call(LiteGraph,`Connect: Error, no slot of name ${s}`),null}else if(s===LiteGraph.EVENT)if(LiteGraph.do_add_triggers_slots)r.changeMode(LiteGraph.ON_TRIGGER),s=r.findInputSlot("onTrigger");else return null;else if(!r.inputs||s>=r.inputs.length)return(c=LiteGraph.log)==null||c.call(LiteGraph,"Connect: Error, slot number not found"),null;var O=!1,E=r.inputs[s],D=null,N=this.outputs[t];if(!this.outputs[t])return(_=LiteGraph.log)==null||_.call(LiteGraph,"Invalid slot passed: ",t,this.outputs),null;if(r.onBeforeConnectInput&&(s=r.onBeforeConnectInput(r)),((d=this.onConnectOutput)==null?void 0:d.call(this,t,E.type,E,r,s))===!1)return null;if(s===!1||s===null||!LiteGraph.isValidConnection(N.type,E.type))return this.setDirtyCanvas(!1,!0),O&&this.graph.connectionChange(this,D),null;if((f=LiteGraph.debug)==null||f.call(LiteGraph,"DBG targetSlot",s),((m=r.onConnectInput)==null?void 0:m.call(r,s,N.type,N,this,t))===!1||((b=this.onConnectOutput)==null?void 0:b.call(this,t,E.type,E,r,s))===!1)return null;r.inputs[s]&&r.inputs[s].link!=null&&(this.graph.beforeChange(),r.disconnectInput(s,{doProcessChange:!1}),O=!0),(T=N.links)!=null&&T.length&&N.type===LiteGraph.EVENT&&(LiteGraph.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(t,!1,{doProcessChange:!1}),O=!0));var C;return LiteGraph.use_uuids?C=LiteGraph.uuidv4():C=++this.graph.last_link_id,D=new LiteGraph.LLink(C,E.type||N.type,this.id,t,r.id,s),this.graph.links[D.id]=D,N.links==null&&(N.links=[]),N.links.push(D.id),typeof r.inputs[s]=="undefined"&&((L=LiteGraph.warn)==null||L.call(LiteGraph,"FIXME error, target_slot does not exists on target_node",r,s)),r.inputs[s].link=D.id,(G=this.onConnectionsChange)==null||G.call(this,LiteGraph.OUTPUT,t,!0,D,N),(I=r.onConnectionsChange)==null||I.call(r,LiteGraph.INPUT,s,!0,D,E),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,r,s,this,t),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t,r,s)),this.graph.onGraphChanged({action:"connect"}),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,D),D}disconnectOutput(t,r,s={}){var a,l,h,u,c,_,d={doProcessChange:!0},f=Object.assign(d,s);if(t.constructor===String){if(t=this.findOutputSlot(t),t==-1)return(a=LiteGraph.log)==null||a.call(LiteGraph,`Connect: Error, no slot of name ${t}`),!1}else if(!this.outputs||t>=this.outputs.length)return(l=LiteGraph.log)==null||l.call(LiteGraph,"Connect: Error, slot number not found"),!1;var m=this.outputs[t];if(!m||!m.links||m.links.length==0)return!1;if(r){if(r.constructor===Number&&(r=this.graph.getNodeById(r)),!r)throw new Error("Target Node not found");for(let T=0,L=m.links.length;T<L;T++){let G=m.links[T],I=this.graph.links[G];if(I.target_id==r.id){m.links.splice(T,1);var b=r.inputs[I.target_slot];b.link=null,delete this.graph.links[G],(h=this.graph)==null||h.onGraphChanged({action:"disconnectOutput",doSave:f.doProcessChange}),(u=r.onConnectionsChange)==null||u.call(r,LiteGraph.INPUT,I.target_slot,!1,I,b),(c=this.onConnectionsChange)==null||c.call(this,LiteGraph.OUTPUT,t,!1,I,m),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,r,I.target_slot));break}}}else{for(let T=0,L=m.links.length;T<L;T++){let G=m.links[T],I=this.graph.links[G];I&&(r=this.graph.getNodeById(I.target_id),b=null,(_=this.graph)==null||_.onGraphChanged({action:"disconnectOutput",doSave:f.doProcessChange}),r&&(b=r.inputs[I.target_slot],b.link=null,r.onConnectionsChange&&r.onConnectionsChange(LiteGraph.INPUT,I.target_slot,!1,I,b),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,r,I.target_slot)),delete this.graph.links[G],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!1,I,m),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,r,I.target_slot)))}m.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}disconnectInput(t,r={}){var s,a,l,h={doProcessChange:!0},u=Object.assign(h,r);if(t.constructor===String){if(t=this.findInputSlot(t),t==-1)return(s=LiteGraph.log)==null||s.call(LiteGraph,`Connect: Error, no slot of name ${t}`),!1}else if(!this.inputs||t>=this.inputs.length)return(a=LiteGraph.log)==null||a.call(LiteGraph,"Connect: Error, slot number not found"),!1;var c=this.inputs[t];if(!c)return!1;var _=this.inputs[t].link;if(_!=null){this.inputs[t].link=null;var d=this.graph.links[_];if(d){var f=this.graph.getNodeById(d.origin_id);if(!f)return!1;var m=f.outputs[d.origin_slot];if(!m||!m.links||m.links.length==0)return!1;for(var b=0,T=m.links.length;b<T;b++)if(m.links[b]==_){m.links.splice(b,1);break}delete this.graph.links[_],(l=this.graph)==null||l.onGraphChanged({action:"disconnectInput",doSave:u.doProcessChange}),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,t,!1,d,c),f.onConnectionsChange&&f.onConnectionsChange(LiteGraph.OUTPUT,b,!1,d,m),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,f,b),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}getConnectionPos(t,r,s=new Float32Array(2)){var a=0;t&&this.inputs&&(a=this.inputs.length),!t&&this.outputs&&(a=this.outputs.length);var l=LiteGraph.NODE_SLOT_HEIGHT*.5;if(this.flags.collapsed){var h=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return this.horizontal?(s[0]=this.pos[0]+h*.5,t?s[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:s[1]=this.pos[1]):(t?s[0]=this.pos[0]:s[0]=this.pos[0]+h,s[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT*.5),s}return t&&r==-1?(s[0]=this.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*.5,s[1]=this.pos[1]+LiteGraph.NODE_TITLE_HEIGHT*.5,s):t&&a>r&&this.inputs[r].pos?(s[0]=this.pos[0]+this.inputs[r].pos[0],s[1]=this.pos[1]+this.inputs[r].pos[1],s):!t&&a>r&&this.outputs[r].pos?(s[0]=this.pos[0]+this.outputs[r].pos[0],s[1]=this.pos[1]+this.outputs[r].pos[1],s):this.horizontal?(s[0]=this.pos[0]+(r+.5)*(this.size[0]/a),t?s[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:s[1]=this.pos[1]+this.size[1],s):(t?s[0]=this.pos[0]+l:s[0]=this.pos[0]+this.size[0]+1-l,s[1]=this.pos[1]+(r+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),s)}alignToGrid(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)}trace(t){var r,s,a,l;this.console||(this.console=[]),(s=(r=this.console).push)==null||s.call(r,t),this.console.length>LGraphNode.MAX_CONSOLE&&((l=(a=this.console).shift)==null||l.call(a)),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,t)}setDirtyCanvas(t,r){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,r])}loadImage(t){var r=new Image;r.src=LiteGraph.node_images_path+t,r.ready=!1;var s=this;return r.onload=function(){this.ready=!0,s.setDirtyCanvas(!0)},r}captureInput(t){if(!(!this.graph||!this.graph.list_of_graphcanvas))for(var r=this.graph.list_of_graphcanvas,s=0;s<r.length;++s){var a=r[s];!t&&a.node_capturing_input!=this||(a.node_capturing_input=t?this:null)}}collapse(t){this.graph.onGraphChanged({action:"collapse"}),!(this.constructor.collapsable===!1&&!t)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))}pin(t){this.graph.onGraphChanged({action:"pin"}),t===void 0?this.flags.pinned=!this.flags.pinned:this.flags.pinned=t}localToScreen(t,r,s){return[(t+this.pos[0])*s.scale+s.offset[0],(r+this.pos[1])*s.scale+s.offset[1]]}refreshAncestors(t={}){var r={action:"",param:null,options:null,passParam:!0},s=Object.assign(r,t);if(this.inputs&&!(LiteGraph.preventAncestorRecalculation&&this.graph.node_ancestorsCalculated&&this.graph.node_ancestorsCalculated[this.id])){(!s.action||s.action=="")&&(s.action=this.id+"_ancestors"),(!s.param||s.param=="")&&(s.param=this.id+"_ancestors"),s.options||(s.options={}),s.options=Object.assign({action_call:s.action},s.options),this.graph.ancestorsCall=!0;var a={modesSkip:[LiteGraph.NEVER,LiteGraph.ON_EVENT,LiteGraph.ON_TRIGGER],modesOnly:[LiteGraph.ALWAYS,LiteGraph.ON_REQUEST],typesSkip:[LiteGraph.ACTION],typesOnly:[]},l=this.graph.getAncestors(this,a);for(iN in l)l[iN].doExecute(s.param,s.options),this.graph.node_ancestorsCalculated[l[iN].id]=!0;return this.graph.ancestorsCall=!1,this.graph.node_ancestorsCalculated[this.id]=!0,!0}}}class LGraphGroup{constructor(t="Group"){g(this,"isPointInside",LiteGraph.LGraphNode.prototype.isPointInside),g(this,"setDirtyCanvas",LiteGraph.LGraphNode.prototype.setDirtyCanvas);var r,s;this.title=t,this.font_size=24,this.color=(s=(r=LiteGraph.LGraphCanvas.node_colors.pale_blue)==null?void 0:r.groupcolor)!=null?s:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null}set pos(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])}get pos(){return this._pos}set size(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))}get size(){return this._size}configure(t){this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,t.font_size&&(this.font_size=t.font_size)}serialize(){var t=this._bounding;return{title:this.title,bounding:t.map(r=>Math.round(r)),color:this.color,font_size:this.font_size}}move(t,r,s){var a,l;isNaN(t)&&((a=console.error)==null||a.call(console,"LGraphGroup.move() deltax NaN")),isNaN(r)&&((l=console.error)==null||l.call(console,"LGraphGroup.move() deltay NaN")),this._pos[0]+=t,this._pos[1]+=r,!s&&this._nodes.forEach(h=>{h.pos[0]+=t,h.pos[1]+=r})}recomputeInsideNodes(){this._nodes.length=0;var t=this.graph._nodes,r=new Float32Array(4);this._nodes=t.filter(s=>(s.getBounding(r),LiteGraph.overlapBounding(this._bounding,r)))}}const _LGraphCanvas=class __LGraphCanvas{constructor(o,t,r){g(this,"processMouseWheel",s=>{if(!(!this.graph||!this.allow_dragcanvas)){var a=s.wheelDeltaY!=null?s.wheelDeltaY:s.detail*-60;this.adjustMouseEvent(s);var l=s.clientX,h=s.clientY,u=!this.viewport||this.viewport&&l>=this.viewport[0]&&l<this.viewport[0]+this.viewport[2]&&h>=this.viewport[1]&&h<this.viewport[1]+this.viewport[3];if(u){var c=this.ds.scale;return c*=Math.pow(1.1,a*.01),this.ds.changeScale(c,[s.clientX,s.clientY]),this.graph.change(),s.preventDefault(),!1}}}),g(this,"processKey",s=>{var a,l,h,u,c;if(this.graph){var _=!1;if(s.target.localName!="input"){if(s.type=="keydown"){if(s.keyCode==32&&(this.dragging_canvas=!0,_=!0),s.keyCode==27&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),_=!0),s.keyCode==65&&s.ctrlKey&&(this.selectNodes(),_=!0),s.keyCode===67&&(s.metaKey||s.ctrlKey)&&!s.shiftKey&&this.selected_nodes&&(this.copyToClipboard(),_=!0),s.keyCode===86&&(s.metaKey||s.ctrlKey)&&this.pasteFromClipboard(s.shiftKey),(s.keyCode==46||LiteGraph.backspace_delete&&s.keyCode==8)&&s.target.localName!="input"&&s.target.localName!="textarea"&&(this.deleteSelectedNodes(),_=!0),LiteGraph.actionHistory_enabled&&(s.keyCode==89&&s.ctrlKey||s.keyCode==90&&s.ctrlKey&&s.shiftKey?this.graph.actionHistoryForward():s.keyCode==90&&s.ctrlKey&&this.graph.actionHistoryBack()),(a=LiteGraph.debug)==null||a.call(LiteGraph,"Canvas keydown "+s.keyCode),this.selected_nodes)for(let d in this.selected_nodes)(h=(l=this.selected_nodes[d]).onKeyDown)==null||h.call(l,s)}else if(s.type=="keyup"&&(s.keyCode==32&&(this.dragging_canvas=!1),this.selected_nodes))for(let d in this.selected_nodes)(c=(u=this.selected_nodes[d]).onKeyUp)==null||c.call(u,s);if(this.graph.change(),_)return s.preventDefault(),s.stopImmediatePropagation(),!1}}}),g(this,"processDrop",s=>{s.preventDefault(),this.adjustMouseEvent(s);var a=s.clientX,l=s.clientY,h=!this.viewport||this.viewport&&a>=this.viewport[0]&&a<this.viewport[0]+this.viewport[2]&&l>=this.viewport[1]&&l<this.viewport[1]+this.viewport[3];if(h){a=s.localX,l=s.localY;var h=!this.viewport||this.viewport&&a>=this.viewport[0]&&a<this.viewport[0]+this.viewport[2]&&l>=this.viewport[1]&&l<this.viewport[1]+this.viewport[3];if(h){var u=[s.canvasX,s.canvasY],c=this.graph?this.graph.getNodeOnPos(u[0],u[1]):null;if(!c){var _=null;this.onDropItem&&(_=this.onDropItem(event)),_||this.checkDropItem(s);return}if(c.onDropFile||c.onDropData){var d=s.dataTransfer.files;if(d&&d.length)for(let G=0;G<d.length;G++){var f=s.dataTransfer.files[0],m=f.name;if(c.onDropFile&&c.onDropFile(f),c.onDropData){var b=new FileReader;b.onload=function(I){var O=I.target.result;c.onDropData(O,m,f)};var T=f.type.split("/")[0];T=="text"||T==""?b.readAsText(f):T=="image"?b.readAsDataURL(f):b.readAsArrayBuffer(f)}}}return c.onDropItem&&c.onDropItem(event)?!0:this.onDropItem?this.onDropItem(event):!1}}}),r!=null||(r={skip_render:!1,autoresize:!1,clip_all_nodes:!1}),this.options=r,this.background_image=__LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,o&&o.constructor===String&&(o=document.querySelector(o)),this.ds=new LiteGraph.DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=`${LiteGraph.NODE_TEXT_SIZE}px Arial`,this.inner_text_font=`normal ${LiteGraph.NODE_SUBTEXT_SIZE}px Arial`,this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.move_destination_link_without_shift=!1,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!0,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.free_resize=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.autoresize=r.autoresize,this.skip_render=r.skip_render,this.clip_all_nodes=r.clip_all_nodes,this.free_resize=r.free_resize,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=r.viewport||null,this.low_quality_rendering_threshold=5,t==null||t.attachCanvas(this),this.setCanvas(o,r.skip_events),this.clear(),!this.skip_render&&!r.skip_render&&this.startRendering()}clear(){var o;this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.low_quality_rendering_counter=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),(o=this.onClear)==null||o.call(this)}setGraph(o,t){var r;if(this.graph!=o){if(t||this.clear(),!o){(r=this.graph)==null||r.detachCanvas(this);return}o.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)}}getTopGraph(){return this._graph_stack.length?this._graph_stack[0]:this.graph}openSubgraph(o){if(!o)throw new Error("graph cannot be null");if(this.graph==o)throw new Error("graph cannot be the same");this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),o.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)}closeSubgraph(){if(!(!this._graph_stack||this._graph_stack.length==0)){var o=this.graph._subgraph_node,t=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},t.attachCanvas(this),this.setDirty(!0,!0),o&&(this.centerOnNode(o),this.selectNodes([o])),this.ds.offset=[0,0],this.ds.scale=1}}getCurrentGraph(){return this.graph}setCanvas(o,t){var r;if(o&&o.constructor===String&&(o=document.getElementById(o),!o))throw new Error("Error creating LiteGraph canvas: Canvas not found");if(o!==this.canvas&&(!o&&this.canvas&&(t||this.unbindEvents()),this.canvas=o,this.ds.element=o,!!o)){if(o.className+=" lgraphcanvas",o.data=this,o.tabindex="1",this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,o.getContext==null)throw o.localName!="canvas"?new Error("Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+o.localName):new Error("This browser doesn't support Canvas");var s=this.ctx=o.getContext("2d");s==null&&(o.webgl_enabled||(r=LiteGraph.info)==null||r.call(LiteGraph,"This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),t||this.bindEvents()}}_doNothing(o){return o.preventDefault(),!1}_doReturnTrue(o){return o.preventDefault(),!0}bindEvents(){var o;if(this._events_binded){(o=LiteGraph.warn)==null||o.call(LiteGraph,"LGraphCanvas: events already binded");return}this._events_binded=!0;var t=this.canvas,r=this.getCanvasWindow(),s=r.document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),t.addEventListener("pointerdown",this._mousedown_callback,!0),t.addEventListener("pointermove",this._mousemove_callback),t.addEventListener("pointerup",this._mouseup_callback,!0),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("wheel",this.processMouseWheel),t.addEventListener("keydown",this.processKey),s.addEventListener("keyup",this.processKey),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this.processDrop),t.addEventListener("dragenter",this._doReturnTrue,!1)}unbindEvents(){var o;if(!this._events_binded){(o=LiteGraph.warn)==null||o.call(LiteGraph,"LGraphCanvas: no events binded");return}this._events_binded=!1;var t=this.canvas,r=this.getCanvasWindow(),s=r.document;t.removeEventListener("pointerdown",this._mousedown_callback),t.removeEventListener("pointermove",this._mousemove_callback),t.removeEventListener("pointerup",this._mouseup_callback),t.removeEventListener("contextmenu",this._doNothing),t.removeEventListener("wheel",this.processMouseWheel),t.removeEventListener("keydown",this.processKey),s.removeEventListener("keyup",this.processKey),t.removeEventListener("dragover",this._doNothing,!1),t.removeEventListener("dragend",this._doNothing,!1),t.removeEventListener("drop",this.processDrop),t.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null}static getFileExtension(o){const t=new URL(o).pathname,r=t.lastIndexOf(".");return r===-1?"":t.slice(r+1).toLowerCase()}enableWebGL(){if(typeof GL=="undefined")throw new Error("litegl.js must be included to use a WebGL canvas");if(typeof enableWebGLCanvas=="undefined")throw new Error("webglCanvas.js must be included to use this feature");this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0}setDirty(o,t){o&&(this.dirty_canvas=!0),t&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){var o;if(!this.canvas)return window;var t=this.canvas.ownerDocument;return(o=t.defaultView)!=null?o:t.parentWindow}startRendering(){if(this.is_rendering)return;this.is_rendering=!0,o.call(this);function o(){this.pause_rendering||this.draw();var t=this.getCanvasWindow();this.is_rendering&&t.requestAnimationFrame(o.bind(this))}}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}processUserInputDown(o){var t,r;if(this.pointer_is_down&&o.isPrimary!==void 0&&!o.isPrimary?this.userInput_isNotPrimary=!0:this.userInput_isNotPrimary=!1,this.userInput_type=o.pointerType?o.pointerType:!1,this.userInput_id=o.pointerId?o.pointerId:!1,o.pointerType)switch(o.pointerType){case"mouse":break;case"pen":break;case"touch":break;default:(t=LiteGraph.log)==null||t.call(LiteGraph,"pointerType unknown "+ev.pointerType)}return o.button!==void 0&&(this.userInput_button=o.button,o.button),o.buttons!==void 0&&(this.userInput_button_s=o.buttons),this.userInput_touches=o.changedTouches!==void 0&&o.changedTouches.length!==void 0?o.changedTouches:!1,this.userInput_touches&&this.userInput_touches.length&&((r=LiteGraph.debug)==null||r.call(LiteGraph,"check multiTouches",o.changedTouches)),this.processMouseDown(o)}processMouseDown(o){var t,r,s,a,l,h,u,c,_;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){this.adjustMouseEvent(o);var d=this.getCanvasWindow();__LGraphCanvas.active_canvas=this;var f=o.clientX,m=o.clientY;(t=LiteGraph.log)==null||t.call(LiteGraph,"pointerevents: processMouseDown pointerId:"+o.pointerId+" which:"+o.which+" isPrimary:"+o.isPrimary+" :: x y "+f+" "+m,"previousClick",this.last_mouseclick,"diffTimeClick",this.last_mouseclick?LiteGraph.getTime()-this.last_mouseclick:"notlast"),this.ds.viewport=this.viewport;var b=!this.viewport||this.viewport&&f>=this.viewport[0]&&f<this.viewport[0]+this.viewport[2]&&m>=this.viewport[1]&&m<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(this.canvas.removeEventListener("pointermove",this._mousemove_callback),d.document.addEventListener("pointermove",this._mousemove_callback,!0),d.document.addEventListener("pointerup",this._mouseup_callback,!0)),!!b){var T=this.graph.getNodeOnPos(o.canvasX,o.canvasY,this.visible_nodes,5),L=!1,G=LiteGraph.getTime(),I=o.isPrimary===void 0||o.isPrimary,O=G-this.last_mouseclick<300&&I;if(this.mouse[0]=o.clientX,this.mouse[1]=o.clientY,this.graph_mouse[0]=o.canvasX,this.graph_mouse[1]=o.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&I?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.ContextMenu.closeAll(d),!((r=this.onMouse)!=null&&r.call(this,o))){if(o.which==1&&!this.userInput_isNotPrimary){if(o.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=o.canvasX,this.dragging_rectangle[1]=o.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,L=!0),LiteGraph.alt_drag_do_clone_nodes&&o.altKey&&T&&this.allow_interaction&&!L&&!this.read_only){let q=T,Z=T.clone();if(Z){if(Z.pos[0]+=5,Z.pos[1]+=5,this.graph.add(Z,!1,{doCalcSize:!1}),T=Z,LiteGraph.alt_shift_drag_connect_clone_with_input&&o.shiftKey&&q.inputs&&q.inputs.length)for(var E=0;E<q.inputs.length;++E){var D=q.inputs[E];if(!(!D||D.link==null)){var N=this.graph.links[D.link];if(N&&N.type!==LiteGraph.EVENT){var C;N.origin_id&&(C=this.graph.getNodeById(N.origin_id));var R=T;C&&R&&C.connect(N.origin_slot,R,N.target_slot)}}}L=!0,M||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=T),this.selected_nodes[T.id]||this.processNodeSelected(T,o))}}var S=!1;if(T&&(this.allow_interaction||T.flags.allow_interaction)&&!L&&!this.read_only){if(!this.live_mode&&!T.flags.pinned&&this.bringToFront(T),this.allow_interaction&&!this.connecting_node&&!T.flags.collapsed&&!this.live_mode)if(!L&&T.resizable!==!1&&LiteGraph.isInsideRectangle(o.canvasX,o.canvasY,T.pos[0]+T.size[0]-5,T.pos[1]+T.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=T,this.canvas.style.cursor="se-resize",L=!0;else{if(T.outputs)for(let q=0,Z=T.outputs.length;q<Z;++q){let K=T.outputs[q],Q=T.getConnectionPos(!1,q);if(LiteGraph.isInsideRectangle(o.canvasX,o.canvasY,Q[0]-15,Q[1]-10,30,20)){this.connecting_node=T,this.connecting_output=K,this.connecting_output.slot_index=q,this.connecting_pos=T.getConnectionPos(!1,q),this.connecting_slot=q,LiteGraph.shift_click_do_break_link_from&&o.shiftKey&&T.disconnectOutput(q),O?(s=T.onOutputDblClick)==null||s.call(T,q,o):(a=T.onOutputClick)==null||a.call(T,q,o),L=!0;break}}if(T.inputs)for(let q=0,Z=T.inputs.length;q<Z;++q){let K=T.inputs[q],Q=T.getConnectionPos(!0,q);if(LiteGraph.isInsideRectangle(o.canvasX,o.canvasY,Q[0]-15,Q[1]-10,30,20)){if(O?(l=T.onInputDblClick)==null||l.call(T,q,o):(h=T.onInputClick)==null||h.call(T,q,o),K.link!==null){var P=this.graph.links[K.link];LiteGraph.click_do_break_link_to&&(T.disconnectInput(q),this.dirty_bgcanvas=!0,L=!0),o.shiftKey&&(LiteGraph.click_do_break_link_to||T.disconnectInput(q),this.connecting_node=this.graph._nodes_by_id[P.origin_id],this.connecting_slot=P.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),this.dirty_bgcanvas=!0,L=!0)}L||(this.connecting_node=T,this.connecting_input=K,this.connecting_input.slot_index=q,this.connecting_pos=T.getConnectionPos(!0,q),this.connecting_slot=q,this.dirty_bgcanvas=!0,L=!0)}}}if(!L){var M=!1,A=[o.canvasX-T.pos[0],o.canvasY-T.pos[1]],B=this.processNodeWidgets(T,this.graph_mouse,o);B&&(M=!0,this.node_widget=[T,B]),this.allow_interaction&&O&&this.selected_nodes[T.id]&&((u=T.onDblClick)==null||u.call(T,o,A,this),this.processNodeDblClicked(T),M=!0),T.onMouseDown&&T.onMouseDown(o,A,this)?M=!0:(T.subgraph&&!T.skip_subgraph_button&&!T.flags.collapsed&&A[0]>T.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&A[1]<0&&setTimeout(()=>{this.openSubgraph(T.subgraph)},10),this.live_mode&&(S=!0,M=!0)),M?T.is_selected||this.processNodeSelected(T,o):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=T),this.processNodeSelected(T,o)),this.dirty_canvas=!0}}else if(!L){if(!this.read_only)for(let q=0;q<this.visible_links.length;++q){var $=this.visible_links[q],H=$._pos;if(!(!H||o.canvasX<H[0]-4||o.canvasX>H[0]+4||o.canvasY<H[1]-4||o.canvasY>H[1]+4)){this.showLinkMenu($,o),this.over_link_center=null;break}}if(this.selected_group=this.graph.getGroupOnPos(o.canvasX,o.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only){o.ctrlKey&&(this.dragging_rectangle=null);var F=LiteGraph.distance([o.canvasX,o.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]]);F*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()}O&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(o),o.preventDefault(),o.stopPropagation()),(c=LiteGraph.debug)==null||c.call(LiteGraph,"DEBUG canvas click is_double_click,this.allow_searchbox",O,this.allow_searchbox),S=!0}!L&&S&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else if(o.which==2)if(LiteGraph.middle_click_slot_add_default_node){if(T&&this.allow_interaction&&!L&&!this.read_only&&!this.connecting_node&&!T.flags.collapsed&&!this.live_mode){var W=!1,z=!1,U=!1;if(T.outputs)for(let q=0,Z=T.outputs.length;q<Z;++q){var V=T.outputs[q];let K=T.getConnectionPos(!1,q);if(LiteGraph.isInsideRectangle(o.canvasX,o.canvasY,K[0]-15,K[1]-10,30,20)){W=V,z=q,U=!0;break}}if(T.inputs)for(let q=0,Z=T.inputs.length;q<Z;++q){var D=T.inputs[q];let Q=T.getConnectionPos(!0,q);if(LiteGraph.isInsideRectangle(o.canvasX,o.canvasY,Q[0]-15,Q[1]-10,30,20)){W=D,z=q,U=!1;break}}if(W&&z!==!1){var X=.5-(z+1)/(U?T.outputs.length:T.inputs.length),J=T.getBounding(),pe=[U?J[0]+J[2]:J[0],o.canvasY-80];this.createDefaultNodeForSlot({nodeFrom:U?T:null,slotFrom:U?z:null,nodeTo:U?null:T,slotTo:U?null:z,position:pe,nodeType:"AUTO",posAdd:[U?30:-30,-X*130],posSizeFix:[U?0:-1,0]})}}}else!L&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else(o.which==3||LiteGraph.two_fingers_opens_menu&&this.userInput_isNotPrimary)&&this.allow_interaction&&!L&&!this.read_only&&(T&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[T.id]||o.shiftKey||o.ctrlKey||o.metaKey)?this.selected_nodes[T.id]||this.selectNodes([T],!0):this.selectNodes([T])),this.processContextMenu(T,o));return this.last_mouse[0]=o.clientX,this.last_mouse[1]=o.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!d.document.activeElement||d.document.activeElement.nodeName.toLowerCase()!="input"&&d.document.activeElement.nodeName.toLowerCase()!="textarea")&&o.preventDefault(),o.stopPropagation(),(_=this.onMouseDown)==null||_.call(this,o),!1}}}}processMouseMove(o){var t,r;if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){__LGraphCanvas.active_canvas=this,this.adjustMouseEvent(o);var s=[o.clientX,o.clientY];this.mouse[0]=s[0],this.mouse[1]=s[1];var a=[s[0]-this.last_mouse[0],s[1]-this.last_mouse[1]];if(this.last_mouse=s,this.graph_mouse[0]=o.canvasX,this.graph_mouse[1]=o.canvasY,this.block_click)return o.preventDefault(),!1;o.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,o,this.node_widget[1]),this.dirty_canvas=!0);var l=this.graph.getNodeOnPos(o.canvasX,o.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=o.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=o.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[o.canvasX-this.selected_group.pos[0],o.canvasY-this.selected_group.pos[1]];else{var h=a[0]/this.ds.scale,u=a[1]/this.ds.scale;this.selected_group.move(h,u,o.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=a[0]/this.ds.scale,this.ds.offset[1]+=a[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||l&&l.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(let b=0,T=this.graph._nodes.length;b<T;++b)this.graph._nodes[b].mouseOver&&l!=this.graph._nodes[b]&&(this.graph._nodes[b].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(o),this.node_over=null,this.dirty_canvas=!0);if(l){if(l.redraw_on_mouse&&(this.dirty_canvas=!0),l.mouseOver||(l.mouseOver=!0,this.node_over=l,this.dirty_canvas=!0,(t=l.onMouseEnter)==null||t.call(l,o)),(r=l.onMouseMove)==null||r.call(l,o,[o.canvasX-l.pos[0],o.canvasY-l.pos[1]],this),this.connecting_node){let b;if(this.connecting_output){if(b=this._highlight_input||[0,0],!this.isOverNodeBox(l,o.canvasX,o.canvasY)){let T=this.isOverNodeInput(l,o.canvasX,o.canvasY,b);if(T!=-1&&l.inputs[T]){let L=l.inputs[T].type;LiteGraph.isValidConnection(this.connecting_output.type,L)&&(this._highlight_input=b,this._highlight_input_slot=l.inputs[T])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input&&(b=this._highlight_output||[0,0],this.isOverNodeBox(l,o.canvasX,o.canvasY))){let T=this.isOverNodeOutput(l,o.canvasX,o.canvasY,b);if(T!=-1&&l.outputs[T]){let L=l.outputs[T].type;LiteGraph.isValidConnection(this.connecting_input.type,L)&&(this._highlight_output=b)}else this._highlight_output=null}}this.canvas&&(LiteGraph.isInsideRectangle(o.canvasX,o.canvasY,l.pos[0]+l.size[0]-5,l.pos[1]+l.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{var c=null;for(let b=0;b<this.visible_links.length;++b){var _=this.visible_links[b],d=_._pos;if(!(!d||o.canvasX<d[0]-4||o.canvasX>d[0]+4||o.canvasY<d[1]-4||o.canvasY>d[1]+4)){c=_;break}}c!=this.over_link_center&&(this.over_link_center=c,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=l&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(o,[o.canvasX-this.node_capturing_input.pos[0],o.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(let b in this.selected_nodes){let T=this.selected_nodes[b];T.pos[0]+=a[0]/this.ds.scale,T.pos[1]+=a[1]/this.ds.scale,T.is_selected||this.processNodeSelected(T,o)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var f=[o.canvasX-this.resizing_node.pos[0],o.canvasY-this.resizing_node.pos[1]],m=this.resizing_node.computeSize();f[0]=Math.max(m[0],f[0]),f[1]=Math.max(m[1],f[1]),this.resizing_node.setSize(f),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return o.preventDefault(),!1}}processMouseUp(o){var t,r=o.isPrimary===void 0||o.isPrimary;if(!r)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){var s=this.getCanvasWindow(),a=s.document;__LGraphCanvas.active_canvas=this,this.options.skip_events||(a.removeEventListener("pointermove",this._mousemove_callback,!0),this.canvas.addEventListener("pointermove",this._mousemove_callback,!0),a.removeEventListener("pointerup",this._mouseup_callback,!0)),this.adjustMouseEvent(o);var l=LiteGraph.getTime();if(o.click_time=l-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),o.which==1){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,o),this.node_widget=null,this.selected_group){var h=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),u=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(h,u,o.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}this.selected_group_resizing=!1;var c=this.graph.getNodeOnPos(o.canvasX,o.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var _=this.graph._nodes,d=new Float32Array(4),f=Math.abs(this.dragging_rectangle[2]),m=Math.abs(this.dragging_rectangle[3]),b=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-f:this.dragging_rectangle[0],T=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-m:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=b,this.dragging_rectangle[1]=T,this.dragging_rectangle[2]=f,this.dragging_rectangle[3]=m,!c||f>10&&m>10){var L=[];for(let E=0;E<_.length;++E){var G=_[E];G.getBounding(d),LiteGraph.overlapBounding(this.dragging_rectangle,d)&&L.push(G)}L.length&&this.selectNodes(L,o.shiftKey)}else this.selectNodes([c],o.shiftKey||o.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var I=this.connecting_output||this.connecting_input,O=I.type;if(c=this.graph.getNodeOnPos(o.canvasX,o.canvasY,this.visible_nodes),c){let E;this.connecting_output?(E=this.isOverNodeInput(c,o.canvasX,o.canvasY),E!=-1?this.connecting_node.connect(this.connecting_slot,c,E):this.connecting_node.connectByType(this.connecting_slot,c,O)):this.connecting_input&&(E=this.isOverNodeOutput(c,o.canvasX,o.canvasY),E!=-1?c.connect(E,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,c,O))}else LiteGraph.release_link_on_empty_shows_menu&&(o.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(o,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(o,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:o}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:o}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else this.resizing_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null):this.node_dragged?(c=this.node_dragged,c&&o.click_time<300&&LiteGraph.isInsideRectangle(o.canvasX,o.canvasY,c.pos[0],c.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&c.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),(t=this.onNodeMoved)==null||t.call(this,this.node_dragged),this.graph.onGraphChanged({action:"nodeDrag",doSave:!0}),this.graph.afterChange(this.node_dragged),this.node_dragged=null):(c=this.graph.getNodeOnPos(o.canvasX,o.canvasY,this.visible_nodes),!c&&o.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(o,[o.canvasX-this.node_over.pos[0],o.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(o,[o.canvasX-this.node_capturing_input.pos[0],o.canvasY-this.node_capturing_input.pos[1]]))}else o.which==2?(this.dirty_canvas=!0,this.dragging_canvas=!1):o.which==3&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return r&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),o.stopPropagation(),o.preventDefault(),!1}}isOverNodeBox(o,t,r){var s=LiteGraph.NODE_TITLE_HEIGHT;return!!LiteGraph.isInsideRectangle(t,r,o.pos[0]+2,o.pos[1]+2-s,s-4,s-4)}isOverNodeInput(o,t,r,s){if(o.inputs)for(let h=0,u=o.inputs.length;h<u;++h){var a=o.getConnectionPos(!0,h),l=!1;if(o.horizontal?l=LiteGraph.isInsideRectangle(t,r,a[0]-5,a[1]-10,10,20):l=LiteGraph.isInsideRectangle(t,r,a[0]-10,a[1]-5,40,10),l)return s&&(s[0]=a[0],s[1]=a[1]),h}return-1}isOverNodeOutput(o,t,r,s){if(o.outputs)for(let h=0,u=o.outputs.length;h<u;++h){var a=o.getConnectionPos(!1,h),l=!1;if(o.horizontal?l=LiteGraph.isInsideRectangle(t,r,a[0]-5,a[1]-10,10,20):l=LiteGraph.isInsideRectangle(t,r,a[0]-10,a[1]-5,40,10),l)return s&&(s[0]=a[0],s[1]=a[1]),h}return-1}copyToClipboard(){var o,t={nodes:[],links:[]},r=0,s=[];for(let _ in this.selected_nodes){let d=this.selected_nodes[_];d.clonable!==!1&&(d._relative_id=r,s.push(d),r+=1)}for(let _=0;_<s.length;++_){let d=s[_];if(d.clonable!==!1){var a=d.clone();if(!a){(o=LiteGraph.warn)==null||o.call(LiteGraph,"node type not found: "+d.type);continue}if(t.nodes.push(a.serialize()),d.inputs&&d.inputs.length)for(var l=0;l<d.inputs.length;++l){var h=d.inputs[l];if(!(!h||h.link==null)){var u=this.graph.links[h.link];if(u){var c=this.graph.getNodeById(u.origin_id);c&&t.links.push([c._relative_id,u.origin_slot,d._relative_id,u.target_slot,c.id])}}}}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))}pasteFromClipboard(o=!1){var t;if(!(!LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&o)){var r=localStorage.getItem("litegrapheditor_clipboard");if(r){this.graph.beforeChange();var s=JSON.parse(r),a=!1,l=!1;for(let T=0;T<s.nodes.length;++T)a?(a[0]>s.nodes[T].pos[0]&&(a[0]=s.nodes[T].pos[0],l[0]=T),a[1]>s.nodes[T].pos[1]&&(a[1]=s.nodes[T].pos[1],l[1]=T)):(a=[s.nodes[T].pos[0],s.nodes[T].pos[1]],l=[T,T]);var h=[];for(let T=0;T<s.nodes.length;++T){var u=s.nodes[T],c=LiteGraph.createNode(u.type);c&&(c.configure(u),c.pos[0]+=this.graph_mouse[0]-a[0],c.pos[1]+=this.graph_mouse[1]-a[1],this.graph.add(c,{doProcessChange:!1}),h.push(c))}for(let T=0;T<s.links.length;++T){var _=s.links[T],d=void 0,f=_[0];if(f!=null)d=h[f];else if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&o){var m=_[4];m&&(d=this.graph.getNodeById(m))}var b=h[_[2]];d&&b?d.connect(_[1],b,_[3]):(t=LiteGraph.warn)==null||t.call(LiteGraph,"Warning, nodes missing on pasting")}this.selectNodes(h),this.graph.onGraphChanged({action:"paste",doSave:!0}),this.graph.afterChange()}}}checkDropItem(o){var t;if(o.dataTransfer.files.length){var r=o.dataTransfer.files[0],s=__LGraphCanvas.getFileExtension(r.name).toLowerCase(),a=LiteGraph.node_types_by_file_extension[s];if(a){this.graph.beforeChange();var l=LiteGraph.createNode(a.type);l.pos=[o.canvasX,o.canvasY],this.graph.add(l,!1,{doProcessChange:!1}),(t=l.onDropFile)==null||t.call(l,r),this.graph.onGraphChanged({action:"fileDrop",doSave:!0}),this.graph.afterChange()}}}processNodeDblClicked(o){var t;this.onShowNodePanel?this.onShowNodePanel(o):this.showShowNodePanel(o),(t=this.onNodeDblClicked)==null||t.call(this,o),this.setDirty(!0)}processNodeSelected(o,t){var r;this.selectNode(o,t&&(t.shiftKey||t.ctrlKey||this.multi_select)),(r=this.onNodeSelected)==null||r.call(this,o)}selectNode(o,t){o==null?this.deselectAllNodes():this.selectNodes([o],t)}selectNodes(o,t){var r;t||this.deselectAllNodes(),o=o||this.graph._nodes,typeof o=="string"&&(o=[o]),Object.values(o).forEach(s=>{var a,l,h;if(s.is_selected){this.deselectNode(s);return}s.is_selected=!0,this.selected_nodes[s.id]=s,(a=s.onSelected)==null||a.call(s),(l=s.inputs)==null||l.forEach(u=>{this.highlighted_links[u.link]=!0}),(h=s.outputs)==null||h.forEach(u=>{var c;(c=u.links)==null||c.forEach(_=>{this.highlighted_links[_]=!0})})}),(r=this.onSelectionChange)==null||r.call(this,this.selected_nodes),this.setDirty(!0)}deselectNode(o){var t,r,s,a;o.is_selected&&((t=o.onDeselected)==null||t.call(o),o.is_selected=!1,(r=this.onNodeDeselected)==null||r.call(this,o),(s=o.inputs)==null||s.forEach(l=>{var h;(h=this.highlighted_links)==null||delete h[l.link]}),(a=o.outputs)==null||a.forEach(l=>{var h;(h=l.links)==null||h.forEach(u=>{var c;return(c=this.highlighted_links)==null?!0:delete c[u]})}))}deselectAllNodes(){var o,t;this.graph&&((o=this.graph._nodes)==null||o.forEach(r=>{var s,a;r.is_selected&&((s=r.onDeselected)==null||s.call(r),r.is_selected=!1,(a=this.onNodeDeselected)==null||a.call(this,r))}),this.selected_nodes={},this.current_node=null,this.highlighted_links={},(t=this.onSelectionChange)==null||t.call(this,this.selected_nodes),this.setDirty(!0))}deleteSelectedNodes(){this.graph.beforeChange();for(let l in this.selected_nodes){var o=this.selected_nodes[l];if(!o.block_delete){if(o.inputs&&o.inputs.length&&o.outputs&&o.outputs.length&&LiteGraph.isValidConnection(o.inputs[0].type,o.outputs[0].type)&&o.inputs[0].link&&o.outputs[0].links&&o.outputs[0].links.length){var t=o.graph.links[o.inputs[0].link],r=o.graph.links[o.outputs[0].links[0]],s=o.getInputNode(0),a=o.getOutputNodes(0)[0];s&&a&&s.connect(t.origin_slot,a,r.target_slot)}this.graph.remove(o),this.onNodeDeselected&&this.onNodeDeselected(o)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}centerOnNode(o){this.ds.offset[0]=-o.pos[0]-o.size[0]*.5+this.canvas.width*.5/this.ds.scale,this.ds.offset[1]=-o.pos[1]-o.size[1]*.5+this.canvas.height*.5/this.ds.scale,this.setDirty(!0,!0)}adjustMouseEvent(o){var t=0,r=0;if(this.canvas){var s=this.canvas.getBoundingClientRect();t=o.clientX-s.left,r=o.clientY-s.top}else t=o.clientX,r=o.clientY;this.last_mouse_position[0]=t,this.last_mouse_position[1]=r,o.canvasX=t/this.ds.scale-this.ds.offset[0],o.canvasY=r/this.ds.scale-this.ds.offset[1]}setZoom(o,t){this.ds.changeScale(o,t),this.dirty_canvas=!0,this.dirty_bgcanvas=!0}convertOffsetToCanvas(o,t){return this.ds.convertOffsetToCanvas(o,t)}convertCanvasToOffset(o,t){return this.ds.convertCanvasToOffset(o,t)}convertEventToCanvasOffset(o){var t=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([o.clientX-t.left,o.clientY-t.top])}bringToFront(o){var t=this.graph._nodes.indexOf(o);t!=-1&&(this.graph._nodes.splice(t,1),this.graph._nodes.push(o))}sendToBack(o){var t=this.graph._nodes.indexOf(o);t!=-1&&(this.graph._nodes.splice(t,1),this.graph._nodes.unshift(o))}computeVisibleNodes(o,t){var r=t||[];r.length=0,o=o||this.graph._nodes;for(var s=0,a=o.length;s<a;++s){var l=o[s];this.live_mode&&!l.onDrawBackground&&!l.onDrawForeground||LiteGraph.overlapBounding(this.visible_area,l.getBounding(temp,!0))&&r.push(l)}return r}draw(o,t){if(!(!this.canvas||this.canvas.width==0||this.canvas.height==0)){var r=LiteGraph.getTime();this.render_time=(r-this.last_draw_time)*.001,this.last_draw_time=r,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||t||this.always_render_background||this.graph&&this.graph._last_trigger_time&&r-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas();var s=this.dirty_canvas||o;if(s&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1,this.ds.scale<.7){if(s){var a=this.low_quality_rendering_threshold;const l=45;this.fps<l?(this.low_quality_rendering_counter+=l/this.fps,this.low_quality_rendering_counter=Math.min(this.low_quality_rendering_counter,2*a)):(this.low_quality_rendering_counter-=this.fps/l*.01,this.low_quality_rendering_counter=Math.max(this.low_quality_rendering_counter,0))}}else this.low_quality_rendering_counter=0}}drawFrontCanvas(){var o,t,r,s,a;this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var l=this.ctx;if(l){var h=this.canvas;l.start2D&&!this.viewport&&(l.start2D(),l.restore(),l.setTransform(1,0,0,1,0,0));var u=this.viewport||this.dirty_area;if(u&&(l.save(),l.beginPath(),l.rect(u[0],u[1],u[2],u[3]),l.clip()),this.clear_background&&(u?l.clearRect(u[0],u[1],u[2],u[3]):l.clearRect(0,0,h.width,h.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():l.drawImage(this.bgcanvas,0,0),(o=this.onRender)==null||o.call(this,h,l),this.show_info&&this.renderInfo(l,u?u[0]:0,u?u[1]:0),this.graph){l.save(),this.ds.toCanvasContext(l);var c=this.computeVisibleNodes(null,this.visible_nodes);for(let L=0;L<c.length;++L){let G=c[L];l.save(),l.translate(G.pos[0],G.pos[1]),this.drawNode(G,l),l.restore()}if(this.render_execution_order&&this.drawExecutionOrder(l),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(l)),this.connecting_pos!=null){l.lineWidth=this.connections_width;var _=null,d=this.connecting_output||this.connecting_input,f=d.type,m=d.dir;m==null&&(this.connecting_output?m=this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:m=this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT);var b=d.shape;switch(f){case LiteGraph.EVENT:case LiteGraph.ACTION:_=LiteGraph.EVENT_LINK_COLOR;break;default:_=LiteGraph.CONNECTING_LINK_COLOR}if(this.renderLink(l,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,_,m,LiteGraph.CENTER),l.beginPath(),f===LiteGraph.EVENT||f===LiteGraph.ACTION||b===LiteGraph.BOX_SHAPE?(l.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),l.fill(),l.beginPath(),l.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):b===LiteGraph.ARROW_SHAPE?(l.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),l.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),l.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),l.closePath()):(l.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,Math.PI*2),l.fill(),l.beginPath(),l.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,Math.PI*2)),l.fill(),l.fillStyle="#ffcc00",this._highlight_input){l.beginPath();var T=this._highlight_input_slot.shape;T===LiteGraph.ARROW_SHAPE?(l.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),l.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),l.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),l.closePath()):l.arc(this._highlight_input[0],this._highlight_input[1],6,0,Math.PI*2),l.fill()}this._highlight_output&&(l.beginPath(),T===LiteGraph.ARROW_SHAPE?(l.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),l.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),l.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),l.closePath()):l.arc(this._highlight_output[0],this._highlight_output[1],6,0,Math.PI*2),l.fill())}this.dragging_rectangle&&(l.strokeStyle="#FFF",l.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(l,this.over_link_center):(t=this.onDrawLinkTooltip)==null||t.call(this,l,null),(r=this.onDrawForeground)==null||r.call(this,l,this.visible_rect),l.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(l),(s=this.onDrawOverlay)==null||s.call(this,l),u&&l.restore(),(a=l.finish2D)==null||a.call(l)}}drawSubgraphPanel(o){var t,r=this.graph;if(r){var s=r._subgraph_node;if(!s){(t=LiteGraph.warn)==null||t.call(LiteGraph,"subgraph without subnode");return}this.drawSubgraphPanelLeft(r,s,o),this.drawSubgraphPanelRight(r,s,o)}}drawSubgraphPanelLeft(o,t,r){var s,a=t.inputs?t.inputs.length:0,l=200,h=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);if(r.fillStyle="#111",r.globalAlpha=.8,r.beginPath(),r.roundRect(10,10,l,(a+1)*h+50,[8]),r.fill(),r.globalAlpha=1,r.fillStyle="#888",r.font="14px Arial",r.textAlign="left",r.fillText("Graph Inputs",20,34),this.drawButton(l-20,20,20,20,"X","#151515")){this.closeSubgraph();return}var u=50;if(r.font="14px Arial",t.inputs)for(var c=0;c<t.inputs.length;++c){var _=t.inputs[c];if(!_.not_subgraph_input){if(this.drawButton(20,u+2,l-20,h-2)){var d=t.constructor.input_node_type||"graph/input";this.graph.beforeChange();var f=LiteGraph.createNode(d);f?(o.add(f,!1,{doProcessChange:!1}),this.block_click=!1,this.last_click_position=null,this.selectNodes([f]),this.node_dragged=f,this.dragging_canvas=!1,f.setProperty("name",_.name),f.setProperty("type",_.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):(s=LiteGraph.error)==null||s.call(LiteGraph,"graph input node not found:",d)}r.fillStyle="#9C9",r.beginPath(),r.arc(l-16,u+h*.5,5,0,2*Math.PI),r.fill(),r.fillStyle="#AAA",r.fillText(_.name,30,u+h*.75),r.fillStyle="#777",r.fillText(_.type,130,u+h*.75),u+=h}}this.drawButton(20,u+2,l-20,h-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(t)}drawSubgraphPanelRight(o,t,r){var s,a=t.outputs?t.outputs.length:0,l=this.bgcanvas.width,h=200,u=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);r.fillStyle="#111",r.globalAlpha=.8,r.beginPath(),r.roundRect(l-h-10,10,h,(a+1)*u+50,[8]),r.fill(),r.globalAlpha=1,r.fillStyle="#888",r.font="14px Arial",r.textAlign="left";const c="Graph Outputs";var _=r.measureText(c).width;if(r.fillText(c,l-_-20,34),this.drawButton(l-h,20,20,20,"X","#151515")){this.closeSubgraph();return}var d=50;if(r.font="14px Arial",t.outputs)for(var f=0;f<t.outputs.length;++f){var m=t.outputs[f];if(!m.not_subgraph_input){if(this.drawButton(l-h,d+2,h-20,u-2)){var b=t.constructor.output_node_type||"graph/output";this.graph.beforeChange();var T=LiteGraph.createNode(b);T?(o.add(T,!1,{doProcessChange:!1}),this.block_click=!1,this.last_click_position=null,this.selectNodes([T]),this.node_dragged=T,this.dragging_canvas=!1,T.setProperty("name",m.name),T.setProperty("type",m.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):(s=LiteGraph.error)==null||s.call(LiteGraph,"graph input node not found:",b)}r.fillStyle="#9C9",r.beginPath(),r.arc(l-h+16,d+u*.5,5,0,2*Math.PI),r.fill(),r.fillStyle="#AAA",r.fillText(m.name,l-h+30,d+u*.75),r.fillStyle="#777",r.fillText(m.type,l-h+130,d+u*.75),d+=u}}this.drawButton(l-h,d+2,h-20,u-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(t)}drawButton(o,t,r,s,a,l,h,u){var c=this.ctx;l=l||LiteGraph.NODE_DEFAULT_COLOR,h=h||"#555",u=u||LiteGraph.NODE_TEXT_COLOR;var _=this.ds.convertOffsetToCanvas(this.graph_mouse),d=LiteGraph.isInsideRectangle(_[0],_[1],o,t,r,s);if(_=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null,_){var f=this.canvas.getBoundingClientRect();_[0]-=f.left,_[1]-=f.top}var m=_&&LiteGraph.isInsideRectangle(_[0],_[1],o,t,r,s);c.fillStyle=d?h:l,m&&(c.fillStyle="#AAA"),c.beginPath(),c.roundRect(o,t,r,s,[4]),c.fill(),a!=null&&a.constructor==String&&(c.fillStyle=u,c.textAlign="center",c.font=(s*.65|0)+"px Arial",c.fillText(a,o+r*.5,t+s*.75),c.textAlign="left");var b=m&&!this.block_click;return m&&this.blockClick(),b}isAreaClicked(o,t,r,s,a){var l=this.last_click_position,h=l&&LiteGraph.isInsideRectangle(l[0],l[1],o,t,r,s),u=h&&!this.block_click;return h&&a&&this.blockClick(),u}renderInfo(o,t,r){t=t||10,r=r||this.canvas.height-80,o.save(),o.translate(t,r),o.font="10px Arial",o.fillStyle="#888",o.textAlign="left",this.graph?(o.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),o.fillText("I: "+this.graph.iteration,5,26),o.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),o.fillText("V: "+this.graph._version,5,52),o.fillText("FPS:"+this.fps.toFixed(2),5,65)):o.fillText("No graph selected",5,13),o.restore()}drawBackCanvas(){var o,t,r,s=this.bgcanvas;this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var a=this.bgctx;a.start&&a.start();var l=this.viewport||[0,0,a.canvas.width,a.canvas.height];if(this.clear_background&&a.clearRect(l[0],l[1],l[2],l[3]),this._graph_stack&&this._graph_stack.length){a.save();var h=this.graph._subgraph_node;a.strokeStyle=h.bgcolor,a.lineWidth=10,a.strokeRect(1,1,s.width-2,s.height-2),a.lineWidth=1,a.font="40px Arial",a.textAlign="center",a.fillStyle=h.bgcolor||"#AAA";let d="";this._graph_stack.slice(1).forEach((f,m)=>{d+=`${f._subgraph_node.getTitle()} ${m<this._graph_stack.length-2?">> ":""}`}),a.fillText(d+h.getTitle(),s.width*.5,40),a.restore()}var u=!1;if(this.onRenderBackground&&(u=this.onRenderBackground(s,a)),this.viewport||(a.restore(),a.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(a.save(),this.ds.toCanvasContext(a),this.ds.scale<1.5&&!u&&this.clear_background_color&&(a.fillStyle=this.clear_background_color,a.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!u){if(this.zoom_modify_alpha?a.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:a.globalAlpha=this.editor_alpha,a.imageSmoothingEnabled=a.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var c=this;this._bg_img.onload=function(){c.draw(!0,!0)}}var _=null;this._pattern==null&&this._bg_img.width>0?(_=a.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=_):_=this._pattern,_&&(a.fillStyle=_,a.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),a.fillStyle="transparent"),a.globalAlpha=1,a.imageSmoothingEnabled=a.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(s,a),(o=this.onDrawBackground)==null||o.call(this,a,this.visible_area),this.onBackgroundRender&&((t=LiteGraph.error)==null||t.call(LiteGraph,"WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(a.strokeStyle="#235",a.strokeRect(0,0,s.width,s.height)),this.render_connections_shadows?(a.shadowColor="#000",a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=6):a.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(a),a.shadowColor="rgba(0,0,0,0)",a.restore()}(r=a.finish)==null||r.call(a),this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(o,t){var r,s,a;this.current_node=o;var l=o.color||o.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,h=o.bgcolor||o.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR,u=this.ds.scale<.6;if(this.live_mode){o.flags.collapsed||(t.shadowColor="transparent",(r=o.onDrawForeground)==null||r.call(o,t,this,this.canvas));return}var c=this.editor_alpha;if(t.globalAlpha=c,this.render_shadows&&!u?(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,t.shadowOffsetX=2*this.ds.scale,t.shadowOffsetY=2*this.ds.scale,t.shadowBlur=3*this.ds.scale):t.shadowColor="transparent",!(o.flags.collapsed&&(s=o.onDrawCollapsed)!=null&&s.call(o,t,this))){var _=o._shape||LiteGraph.BOX_SHAPE,d=temp_vec2;temp_vec2.set(o.size);var f=o.horizontal;if(o.flags.collapsed){t.font=this.inner_text_font;var m=o.getTitle?o.getTitle():o.title;m!=null&&(o._collapsed_width=Math.min(o.size[0],t.measureText(m).width+LiteGraph.NODE_TITLE_HEIGHT*2),d[0]=o._collapsed_width,d[1]=0)}(o.clip_area||this.clip_all_nodes)&&(t.save(),t.beginPath(),_==LiteGraph.BOX_SHAPE?t.rect(0,0,d[0],d[1]):_==LiteGraph.ROUND_SHAPE?t.roundRect(0,0,d[0],d[1],[10]):_==LiteGraph.CIRCLE_SHAPE&&t.arc(d[0]*.5,d[1]*.5,d[0]*.5,0,Math.PI*2),t.clip()),o.has_errors&&(h="red"),this.drawNodeShape(o,t,d,l,h,o.is_selected,o.mouseOver),t.shadowColor="transparent",(a=o.onDrawForeground)==null||a.call(o,t,this,this.canvas),LiteGraph.show_node_tooltip&&o.mouseOver&&o.is_selected&&(!this.selected_nodes||Object.keys(this.selected_nodes).length<=1)&&this.drawNodeTooltip(t,o),t.textAlign=f?"center":"left",t.font=this.inner_text_font;var b=!this.lowQualityRenderingRequired(.6),T=this.connecting_output,L=this.connecting_input;t.lineWidth=1;var G=0,I=new Float32Array(2),O;if(o.flags.collapsed){if(this.render_collapsed_slots){var E=null,D=null;if(o.inputs)for(let R=0;R<o.inputs.length;R++){var N=o.inputs[R];if(N.link!=null){E=N;break}}if(o.outputs)for(let R=0;R<o.outputs.length;R++){var N=o.outputs[R];!N.links||!N.links.length||(D=N)}if(E){let R=0,S=LiteGraph.NODE_TITLE_HEIGHT*-.5;f&&(R=o._collapsed_width*.5,S=-LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#686",t.beginPath(),N.type===LiteGraph.EVENT||N.type===LiteGraph.ACTION||N.shape===LiteGraph.BOX_SHAPE?t.rect(R-7+.5,S-4,14,8):N.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(R+8,S),t.lineTo(R+-4,S-4),t.lineTo(R+-4,S+4),t.closePath()):t.arc(R,S,4,0,Math.PI*2),t.fill()}if(D){let R=o._collapsed_width,S=LiteGraph.NODE_TITLE_HEIGHT*-.5;f&&(R=o._collapsed_width*.5,S=0),t.fillStyle="#686",t.strokeStyle="black",t.beginPath(),N.type===LiteGraph.EVENT||N.type===LiteGraph.ACTION||N.shape===LiteGraph.BOX_SHAPE?t.rect(R-7+.5,S-4,14,8):N.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(R+6,S),t.lineTo(R-6,S-4),t.lineTo(R-6,S+4),t.closePath()):t.arc(R,S,4,0,Math.PI*2),t.fill()}}}else{if(o.inputs)for(let R=0;R<o.inputs.length;R++){let S=o.inputs[R],P=S.type,M=S.shape;t.globalAlpha=c,this.connecting_output&&!LiteGraph.isValidConnection(S.type,T.type)&&(t.globalAlpha=.4*c),t.fillStyle=S.link!=null?S.color_on||this.default_connection_color_byType[P]||this.default_connection_color.input_on:S.color_off||this.default_connection_color_byTypeOff[P]||this.default_connection_color_byType[P]||this.default_connection_color.input_off;let A=o.getConnectionPos(!0,R,I);if(A[0]-=o.pos[0],A[1]-=o.pos[1],G<A[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(G=A[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),t.beginPath(),P=="array"?M=LiteGraph.GRID_SHAPE:S.name=="onTrigger"||S.name=="onExecuted"?M=LiteGraph.ARROW_SHAPE:(P===LiteGraph.EVENT||P===LiteGraph.ACTION)&&(M=LiteGraph.BOX_SHAPE),O=!0,M===LiteGraph.BOX_SHAPE?f?t.rect(A[0]-5+.5,A[1]-8+.5,10,14):t.rect(A[0]-6+.5,A[1]-5+.5,14,10):M===LiteGraph.ARROW_SHAPE?(t.moveTo(A[0]+8,A[1]+.5),t.lineTo(A[0]-4,A[1]+6+.5),t.lineTo(A[0]-4,A[1]-6+.5),t.closePath()):M===LiteGraph.GRID_SHAPE?(t.rect(A[0]-4,A[1]-4,2,2),t.rect(A[0]-1,A[1]-4,2,2),t.rect(A[0]+2,A[1]-4,2,2),t.rect(A[0]-4,A[1]-1,2,2),t.rect(A[0]-1,A[1]-1,2,2),t.rect(A[0]+2,A[1]-1,2,2),t.rect(A[0]-4,A[1]+2,2,2),t.rect(A[0]-1,A[1]+2,2,2),t.rect(A[0]+2,A[1]+2,2,2),O=!1):u?t.rect(A[0]-4,A[1]-4,8,8):t.arc(A[0],A[1],4,0,Math.PI*2),t.fill(),b&&!(S.name=="onTrigger"||S.name=="onExecuted")){let B=S.label!=null?S.label:S.name;B&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,f||S.dir==LiteGraph.UP?t.fillText(B,A[0],A[1]-10):t.fillText(B,A[0]+10,A[1]+5))}}if(t.textAlign=f?"center":"right",t.strokeStyle="black",o.outputs)for(let R=0;R<o.outputs.length;R++){let S=o.outputs[R],P=S.type,M=S.shape;this.connecting_input&&!LiteGraph.isValidConnection(P,L.type)&&(t.globalAlpha=.4*c);let A=o.getConnectionPos(!1,R,I);if(A[0]-=o.pos[0],A[1]-=o.pos[1],G<A[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(G=A[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),t.fillStyle=S.links&&S.links.length?S.color_on||this.default_connection_color_byType[P]||this.default_connection_color.output_on:S.color_off||this.default_connection_color_byTypeOff[P]||this.default_connection_color_byType[P]||this.default_connection_color.output_off,t.beginPath(),P=="array"?M=LiteGraph.GRID_SHAPE:S.name=="onTrigger"||S.name=="onExecuted"?M=LiteGraph.ARROW_SHAPE:(P===LiteGraph.EVENT||P===LiteGraph.ACTION)&&(M=LiteGraph.BOX_SHAPE),O=!0,M===LiteGraph.BOX_SHAPE?f?t.rect(A[0]-5+.5,A[1]-8+.5,10,14):t.rect(A[0]-6+.5,A[1]-5+.5,14,10):M===LiteGraph.ARROW_SHAPE?(t.moveTo(A[0]+8,A[1]+.5),t.lineTo(A[0]-4,A[1]+6+.5),t.lineTo(A[0]-4,A[1]-6+.5),t.closePath()):M===LiteGraph.GRID_SHAPE?(t.rect(A[0]-4,A[1]-4,2,2),t.rect(A[0]-1,A[1]-4,2,2),t.rect(A[0]+2,A[1]-4,2,2),t.rect(A[0]-4,A[1]-1,2,2),t.rect(A[0]-1,A[1]-1,2,2),t.rect(A[0]+2,A[1]-1,2,2),t.rect(A[0]-4,A[1]+2,2,2),t.rect(A[0]-1,A[1]+2,2,2),t.rect(A[0]+2,A[1]+2,2,2),O=!1):u?t.rect(A[0]-4,A[1]-4,8,8):t.arc(A[0],A[1],4,0,Math.PI*2),t.fill(),!u&&O&&t.stroke(),b&&!(S.name=="onTrigger"||S.name=="onExecuted")){let B=S.label!=null?S.label:S.name;B&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,f||S.dir==LiteGraph.DOWN?t.fillText(B,A[0],A[1]-8):t.fillText(B,A[0]-10,A[1]+5))}}if(t.textAlign="left",t.globalAlpha=1,o.widgets){var C=G;(f||o.widgets_up)&&(C=2),o.widgets_start_y!=null&&(C=o.widgets_start_y),this.drawNodeWidgets(o,C,t,this.node_widget&&this.node_widget[0]==o?this.node_widget[1]:null)}}(o.clip_area||this.clip_all_nodes)&&t.restore(),t.globalAlpha=1}}drawNodeTooltip(o,t){var r;if(!t||!o){(r=LiteGraph.warn)==null||r.call(LiteGraph,"drawNodeTooltip: invalid node or ctx",t,o);return}var s=t.properties.tooltip!=null?t.properties.tooltip:"";if((!s||s=="")&&LiteGraph.show_node_tooltip_use_descr_property&&t.constructor.desc&&(s=t.constructor.desc),s=(s+"").trim(),!(!s||s=="")){var a=[0,-LiteGraph.NODE_TITLE_HEIGHT],l=t.flags.collapsed?[LiteGraph.NODE_COLLAPSED_WIDTH,LiteGraph.NODE_TITLE_HEIGHT]:t.size;o.font="14px Courier New",o.measureText(s);var h=Math.max(t.size[0],160)+20,u=t.ttip_oTMultiRet?t.ttip_oTMultiRet.height+15:21;o.globalAlpha=.7*this.editor_alpha,o.shadowColor=t.ttip_oTMultiRet?"black":"transparent",o.shadowOffsetX=2,o.shadowOffsetY=2,o.shadowBlur=3,o.fillStyle=t.ttip_oTMultiRet?"#454":"transparent",o.beginPath(),o.roundRect(a[0]-h*.5+l[0]/2,a[1]-15-u,h,u,[3]),o.moveTo(a[0]-10+l[0]/2,a[1]-15),o.lineTo(a[0]+10+l[0]/2,a[1]-15),o.lineTo(a[0]+l[0]/2,a[1]-5),o.fill(),o.shadowColor="transparent",o.textAlign="center",o.fillStyle=t.ttip_oTMultiRet?"#CEC":"transparent",o.globalAlpha=this.editor_alpha;var c=LiteGraph.canvasFillTextMultiline(o,s,a[0]+l[0]/2,a[1]-u,h,14);t.ttip_oTMultiRet=c,o.closePath()}}drawLinkTooltip(o,t){var r,s=t._pos;if(o.fillStyle="black",o.beginPath(),o.arc(s[0],s[1],3,0,Math.PI*2),o.fill(),t.data!=null&&!((r=this.onDrawLinkTooltip)!=null&&r.call(this,o,t,this))){var a=t.data,l=null;if(a.constructor===Number?l=a.toFixed(2):a.constructor===String?l='"'+a+'"':a.constructor===Boolean?l=String(a):a.toToolTip?l=a.toToolTip():l="["+a.constructor.name+"]",l!=null){l=l.substr(0,30),o.font="14px Courier New";var h=o.measureText(l),u=h.width+20,c=24;o.shadowColor="black",o.shadowOffsetX=2,o.shadowOffsetY=2,o.shadowBlur=3,o.fillStyle="#454",o.beginPath(),o.roundRect(s[0]-u*.5,s[1]-15-c,u,c,[3]),o.moveTo(s[0]-10,s[1]-15),o.lineTo(s[0]+10,s[1]-15),o.lineTo(s[0],s[1]-5),o.fill(),o.shadowColor="transparent",o.textAlign="center",o.fillStyle="#CEC",o.fillText(l,s[0],s[1]-15-c*.3)}}}drawNodeShape(o,t,r,s,a,l,h){var u;t.strokeStyle=s,t.fillStyle=a;var c=LiteGraph.NODE_TITLE_HEIGHT,_=this.lowQualityRenderingRequired(.5),d=o._shape||o.constructor.shape||LiteGraph.ROUND_SHAPE,f=o.constructor.title_mode,m=!0;f==LiteGraph.TRANSPARENT_TITLE||f==LiteGraph.NO_TITLE?m=!1:f==LiteGraph.AUTOHIDE_TITLE&&h&&(m=!0);var b=tmp_area;b[0]=0,b[1]=m?-c:0,b[2]=r[0]+1,b[3]=m?r[1]+c:r[1];var T=t.globalAlpha;if(t.beginPath(),d==LiteGraph.BOX_SHAPE||_?t.fillRect(b[0],b[1],b[2],b[3]):d==LiteGraph.ROUND_SHAPE||d==LiteGraph.CARD_SHAPE?t.roundRect(b[0],b[1],b[2],b[3],d==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):d==LiteGraph.CIRCLE_SHAPE&&t.arc(r[0]*.5,r[1]*.5,r[0]*.5,0,Math.PI*2),t.fill(),!o.flags.collapsed&&m&&(t.shadowColor="transparent",t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(0,-1,b[2],2)),t.shadowColor="transparent",(u=o.onDrawBackground)==null||u.call(o,t,this,this.canvas,this.graph_mouse),m||f==LiteGraph.TRANSPARENT_TITLE){if(o.onDrawTitleBar)o.onDrawTitleBar(t,c,r,this.ds.scale,s);else if(f!=LiteGraph.TRANSPARENT_TITLE&&(o.constructor.title_color||this.render_title_colored)){var L=o.constructor.title_color||s;if(o.flags.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients){var G=__LGraphCanvas.gradients[L];G||(G=__LGraphCanvas.gradients[L]=t.createLinearGradient(0,0,400,0),G.addColorStop(0,L),G.addColorStop(1,"#000")),t.fillStyle=G}else t.fillStyle=L;t.beginPath(),d==LiteGraph.BOX_SHAPE||_?t.rect(0,-c,r[0]+1,c):(d==LiteGraph.ROUND_SHAPE||d==LiteGraph.CARD_SHAPE)&&t.roundRect(0,-c,r[0]+1,c,o.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),t.fill(),t.shadowColor="transparent"}let C=!1;LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[o.mode]&&(C=LiteGraph.NODE_MODES_COLORS[o.mode]),LiteGraph.node_box_coloured_when_on&&(C=o.action_triggered?"#FFF":o.execute_triggered?"#AAA":C);var I=10;if(o.onDrawTitleBox?o.onDrawTitleBox(t,c,r,this.ds.scale):d==LiteGraph.ROUND_SHAPE||d==LiteGraph.CIRCLE_SHAPE||d==LiteGraph.CARD_SHAPE?(_&&(t.fillStyle="black",t.beginPath(),t.arc(c*.5,c*-.5,I*.5+1,0,Math.PI*2),t.fill()),t.fillStyle=o.boxcolor||C||LiteGraph.NODE_DEFAULT_BOXCOLOR,_?t.fillRect(c*.5-I*.5,c*-.5-I*.5,I,I):(t.beginPath(),t.arc(c*.5,c*-.5,I*.5,0,Math.PI*2),t.fill())):(_&&(t.fillStyle="black",t.fillRect((c-I)*.5-1,(c+I)*-.5-1,I+2,I+2)),t.fillStyle=o.boxcolor||C||LiteGraph.NODE_DEFAULT_BOXCOLOR,t.fillRect((c-I)*.5,(c+I)*-.5,I,I)),t.globalAlpha=T,o.onDrawTitleText&&o.onDrawTitleText(t,c,r,this.ds.scale,this.title_text_font,l),!_){t.font=this.title_text_font;var O=String(o.getTitle());O&&(l?t.fillStyle=LiteGraph.NODE_SELECTED_TITLE_COLOR:t.fillStyle=o.constructor.title_text_color||this.node_title_color,o.flags.collapsed?(t.textAlign="left",t.fillText(O.substr(0,20),c,LiteGraph.NODE_TITLE_TEXT_Y-c),t.textAlign="left"):(t.textAlign="left",t.fillText(O,c,LiteGraph.NODE_TITLE_TEXT_Y-c)))}if(!o.flags.collapsed&&o.subgraph&&!o.skip_subgraph_button){var E=LiteGraph.NODE_TITLE_HEIGHT,D=o.size[0]-E,N=LiteGraph.isInsideRectangle(this.graph_mouse[0]-o.pos[0],this.graph_mouse[1]-o.pos[1],D+2,-E+2,E-4,E-4);t.fillStyle=N?"#888":"#555",d==LiteGraph.BOX_SHAPE||_?t.fillRect(D+2,-E+2,E-4,E-4):(t.beginPath(),t.roundRect(D+2,-E+2,E-4,E-4,[4]),t.fill()),t.fillStyle="#333",t.beginPath(),t.moveTo(D+E*.2,-E*.6),t.lineTo(D+E*.8,-E*.6),t.lineTo(D+E*.5,-E*.3),t.fill()}o.onDrawTitle&&o.onDrawTitle(t)}l&&(o.onBounding&&o.onBounding(b),f==LiteGraph.TRANSPARENT_TITLE&&(b[1]-=c,b[3]+=c),t.lineWidth=1,t.globalAlpha=.8,t.beginPath(),d==LiteGraph.BOX_SHAPE?t.rect(-6+b[0],-6+b[1],12+b[2],12+b[3]):d==LiteGraph.ROUND_SHAPE||d==LiteGraph.CARD_SHAPE&&o.flags.collapsed?t.roundRect(-6+b[0],-6+b[1],12+b[2],12+b[3],[this.round_radius*2]):d==LiteGraph.CARD_SHAPE?t.roundRect(-6+b[0],-6+b[1],12+b[2],12+b[3],[this.round_radius*2,2,this.round_radius*2,2]):d==LiteGraph.CIRCLE_SHAPE&&t.arc(r[0]*.5,r[1]*.5,r[0]*.5+6,0,Math.PI*2),t.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,t.stroke(),t.strokeStyle=s,t.globalAlpha=1),o.execute_triggered>0&&o.execute_triggered--,o.action_triggered>0&&o.action_triggered--}drawConnections(o){var t=LiteGraph.getTime(),r=this.visible_area;margin_area[0]=r[0]-20,margin_area[1]=r[1]-20,margin_area[2]=r[2]+40,margin_area[3]=r[3]+40,o.lineWidth=this.connections_width,o.fillStyle="#AAA",o.strokeStyle="#AAA",o.globalAlpha=this.editor_alpha;for(var s=this.graph._nodes,a=0,l=s.length;a<l;++a){var h=s[a];if(!(!h.inputs||!h.inputs.length))for(let D=0;D<h.inputs.length;++D){var u=h.inputs[D];if(!(!u||u.link==null)){var c=u.link,_=this.graph.links[c];if(_){var d=this.graph.getNodeById(_.origin_id);if(d!=null){var f=_.origin_slot,m=null;f==-1?m=[d.pos[0]+10,d.pos[1]+10]:m=d.getConnectionPos(!1,f,tempA);var b=h.getConnectionPos(!0,D,tempB);if(link_bounding[0]=m[0],link_bounding[1]=m[1],link_bounding[2]=b[0]-m[0],link_bounding[3]=b[1]-m[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),!!LiteGraph.overlapBounding(link_bounding,margin_area)){var T=d.outputs[f],L=h.inputs[D];if(!(!T||!L)){var G=T.dir||(d.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),I=L.dir||(h.horizontal?LiteGraph.UP:LiteGraph.LEFT);if(this.renderLink(o,m,b,_,!1,0,null,G,I),_&&_._last_time&&t-_._last_time<1e3){var O=2-(t-_._last_time)*.002,E=o.globalAlpha;o.globalAlpha=E*O,this.renderLink(o,m,b,_,!0,O,"white",G,I),o.globalAlpha=E}}}}}}}}o.globalAlpha=1}renderLink(o,t,r,s,a,l,h,u,c,_){s&&this.visible_links.push(s),!h&&s&&(h=s.color||__LGraphCanvas.link_type_colors[s.type]),h||(h=this.default_link_color),s!=null&&this.highlighted_links[s.id]&&(h="#FFF"),u=u||LiteGraph.RIGHT,c=c||LiteGraph.LEFT;var d=LiteGraph.distance(t,r);this.render_connections_border&&this.ds.scale>.6&&(o.lineWidth=this.connections_width+4),o.lineJoin="round",_=_||1,_>1&&(o.lineWidth=.5),o.beginPath();for(let P=0;P<_;P+=1){var f=(P-(_-1)*.5)*5;if(this.links_render_mode==LiteGraph.SPLINE_LINK){o.moveTo(t[0],t[1]+f);let M=0,A=0,B=0,$=0;switch(u){case LiteGraph.LEFT:M=d*-.25;break;case LiteGraph.RIGHT:M=d*.25;break;case LiteGraph.UP:A=d*-.25;break;case LiteGraph.DOWN:A=d*.25;break}switch(c){case LiteGraph.LEFT:B=d*-.25;break;case LiteGraph.RIGHT:B=d*.25;break;case LiteGraph.UP:$=d*-.25;break;case LiteGraph.DOWN:$=d*.25;break}o.bezierCurveTo(t[0]+M,t[1]+A+f,r[0]+B,r[1]+$+f,r[0],r[1]+f)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){o.moveTo(t[0],t[1]+f);let M=0,A=0,B=0,$=0;switch(u){case LiteGraph.LEFT:M=-1;break;case LiteGraph.RIGHT:M=1;break;case LiteGraph.UP:A=-1;break;case LiteGraph.DOWN:A=1;break}switch(c){case LiteGraph.LEFT:B=-1;break;case LiteGraph.RIGHT:B=1;break;case LiteGraph.UP:$=-1;break;case LiteGraph.DOWN:$=1;break}var m=15;o.lineTo(t[0]+M*m,t[1]+A*m+f),o.lineTo(r[0]+B*m,r[1]+$*m+f),o.lineTo(r[0],r[1]+f)}else if(this.links_render_mode==LiteGraph.STRAIGHT_LINK){o.moveTo(t[0],t[1]);var b=t[0],T=t[1],L=r[0],G=r[1];u==LiteGraph.RIGHT?b+=10:T+=10,c==LiteGraph.LEFT?L-=10:G-=10,o.lineTo(b,T),o.lineTo((b+L)*.5,T),o.lineTo((b+L)*.5,G),o.lineTo(L,G),o.lineTo(r[0],r[1])}else return}this.render_connections_border&&this.ds.scale>.6&&!a&&(o.strokeStyle="rgba(0,0,0,0.5)",o.stroke()),o.lineWidth=this.connections_width,o.fillStyle=o.strokeStyle=h,o.stroke();var I=this.computeConnectionPoint(t,r,.5,u,c);if(s&&s._pos&&(s._pos[0]=I[0],s._pos[1]=I[1]),this.ds.scale>=.6&&this.highquality_render&&c!=LiteGraph.CENTER){if(this.render_connection_arrows){var O=this.computeConnectionPoint(t,r,.25,u,c),E=this.computeConnectionPoint(t,r,.26,u,c),D=this.computeConnectionPoint(t,r,.75,u,c),N=this.computeConnectionPoint(t,r,.76,u,c),C=0,R=0;this.render_curved_connections?(C=-Math.atan2(E[0]-O[0],E[1]-O[1]),R=-Math.atan2(N[0]-D[0],N[1]-D[1])):R=C=r[1]>t[1]?0:Math.PI,o.save(),o.translate(O[0],O[1]),o.rotate(C),o.beginPath(),o.moveTo(-5,-3),o.lineTo(0,7),o.lineTo(5,-3),o.fill(),o.restore(),o.save(),o.translate(D[0],D[1]),o.rotate(R),o.beginPath(),o.moveTo(-5,-3),o.lineTo(0,7),o.lineTo(5,-3),o.fill(),o.restore()}o.beginPath(),o.arc(I[0],I[1],5,0,Math.PI*2),o.fill()}if(l){o.fillStyle=h;for(let P=0;P<5;++P){var S=(LiteGraph.getTime()*.001+P*.2)%1;I=this.computeConnectionPoint(t,r,S,u,c),o.beginPath(),o.arc(I[0],I[1],5,0,2*Math.PI),o.fill()}}}computeConnectionPoint(o,t,r,s,a){s=s||LiteGraph.RIGHT,a=a||LiteGraph.LEFT;var l=LiteGraph.distance(o,t),h=o,u=[o[0],o[1]],c=[t[0],t[1]],_=t;switch(s){case LiteGraph.LEFT:u[0]+=l*-.25;break;case LiteGraph.RIGHT:u[0]+=l*.25;break;case LiteGraph.UP:u[1]+=l*-.25;break;case LiteGraph.DOWN:u[1]+=l*.25;break}switch(a){case LiteGraph.LEFT:c[0]+=l*-.25;break;case LiteGraph.RIGHT:c[0]+=l*.25;break;case LiteGraph.UP:c[1]+=l*-.25;break;case LiteGraph.DOWN:c[1]+=l*.25;break}var d=(1-r)*(1-r)*(1-r),f=3*((1-r)*(1-r))*r,m=3*(1-r)*(r*r),b=r*r*r,T=d*h[0]+f*u[0]+m*c[0]+b*_[0],L=d*h[1]+f*u[1]+m*c[1]+b*_[1];return[T,L]}drawExecutionOrder(o){o.shadowColor="transparent",o.globalAlpha=.25,o.textAlign="center",o.strokeStyle="white",o.globalAlpha=.75;var t=this.visible_nodes;for(let s=0;s<t.length;++s){var r=t[s];o.fillStyle="black",o.fillRect(r.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,r.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),r.order==0&&o.strokeRect(r.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,r.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),o.fillStyle="#FFF",o.fillText(r.order,r.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*-.5,r.pos[1]-6)}o.globalAlpha=1}drawNodeWidgets(o,t,r,s){if(!o.widgets||!o.widgets.length)return 0;var a=o.size[0],l=o.widgets;t+=2;var h=LiteGraph.NODE_WIDGET_HEIGHT,u=!this.lowQualityRenderingRequired(.5);r.save(),r.globalAlpha=this.editor_alpha;var c=LiteGraph.WIDGET_OUTLINE_COLOR,_=LiteGraph.WIDGET_BGCOLOR,d=LiteGraph.WIDGET_TEXT_COLOR,f=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,m=15;for(let N=0;N<l.length;++N){var b=l[N],T=t;b.y&&(T=b.y),b.last_y=T,r.strokeStyle=c,r.fillStyle="#222",r.textAlign="left",b.disabled&&(r.globalAlpha*=.5);var L=b.width||a;switch(b.type){case"button":b.clicked&&(r.fillStyle="#AAA",b.clicked=!1,this.dirty_canvas=!0),r.fillRect(m,T,L-m*2,h),u&&!b.disabled&&r.strokeRect(m,T,L-m*2,h),u&&(r.textAlign="center",r.fillStyle=d,r.fillText(b.label||b.name,L*.5,T+h*.7));break;case"toggle":if(r.textAlign="left",r.strokeStyle=c,r.fillStyle=_,r.beginPath(),u?r.roundRect(m,T,L-m*2,h,[h*.5]):r.rect(m,T,L-m*2,h),r.fill(),u&&!b.disabled&&r.stroke(),r.fillStyle=b.value?"#89A":"#333",r.beginPath(),r.arc(L-m*2,T+h*.5,h*.36,0,Math.PI*2),r.fill(),u){r.fillStyle=f;const C=b.label||b.name;C!=null&&r.fillText(C,m*2,T+h*.7),r.fillStyle=b.value?d:f,r.textAlign="right",r.fillText(b.value?b.options.on||"true":b.options.off||"false",L-40,T+h*.7)}break;case"slider":r.fillStyle=_,r.fillRect(m,T,L-m*2,h);var G=b.options.max-b.options.min,I=(b.value-b.options.min)/G;if(I<0&&(I=0),I>1&&(I=1),r.fillStyle=b.options.hasOwnProperty("slider_color")?b.options.slider_color:s==b?"#89A":"#678",r.fillRect(m,T,I*(L-m*2),h),u&&!b.disabled&&r.strokeRect(m,T,L-m*2,h),b.marker){var O=(b.marker-b.options.min)/G;O<0&&(O=0),O>1&&(O=1),r.fillStyle=b.options.hasOwnProperty("marker_color")?b.options.marker_color:"#AA9",r.fillRect(m+O*(L-m*2),T,2,h)}u&&(r.textAlign="center",r.fillStyle=d,r.fillText(b.label||b.name+"  "+Number(b.value).toFixed(b.options.precision!=null?b.options.precision:3),L*.5,T+h*.7));break;case"number":case"combo":if(r.textAlign="left",r.strokeStyle=c,r.fillStyle=_,r.beginPath(),u?r.roundRect(m,T,L-m*2,h,[h*.5]):r.rect(m,T,L-m*2,h),r.fill(),u)if(b.disabled||r.stroke(),r.fillStyle=d,b.disabled||(r.beginPath(),r.moveTo(m+16,T+5),r.lineTo(m+6,T+h*.5),r.lineTo(m+16,T+h-5),r.fill(),r.beginPath(),r.moveTo(L-m-16,T+5),r.lineTo(L-m-6,T+h*.5),r.lineTo(L-m-16,T+h-5),r.fill()),r.fillStyle=f,r.fillText(b.label||b.name,m*2+5,T+h*.7),r.fillStyle=d,r.textAlign="right",b.type=="number")r.fillText(Number(b.value).toFixed(b.options.precision!==void 0?b.options.precision:3),L-m*2-20,T+h*.7);else{var E=b.value;if(b.options.values){var D=b.options.values;D.constructor===Function&&(D=D()),D&&D.constructor!==Array&&(E=D[b.value])}r.fillText(E,L-m*2-20,T+h*.7)}break;case"string":case"text":if(r.textAlign="left",r.strokeStyle=c,r.fillStyle=_,r.beginPath(),u?r.roundRect(m,T,L-m*2,h,[h*.5]):r.rect(m,T,L-m*2,h),r.fill(),u){b.disabled||r.stroke(),r.save(),r.beginPath(),r.rect(m,T,L-m*2,h),r.clip(),r.fillStyle=f;const C=b.label||b.name;C!=null&&r.fillText(C,m*2,T+h*.7),r.fillStyle=d,r.textAlign="right",r.fillText(String(b.value).substr(0,30),L-m*2,T+h*.7),r.restore()}break;default:b.draw&&b.draw(r,o,L,T,h);break}t+=(b.computeSize?b.computeSize(L)[1]:h)+4,r.globalAlpha=this.editor_alpha}r.restore(),r.textAlign="left"}processNodeWidgets(node,pos,event,active_widget){if(!node.widgets||!node.widgets.length||!this.allow_interaction&&!node.flags.allow_interaction)return null;var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow();for(let i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(!(!w||w.disabled)){var widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(!(w!=active_widget&&(x<6||x>widget_width-12||y<w.last_y||y>w.last_y+widget_height||w.last_y===void 0))){var old_value=w.value;switch(w.type){case"button":event.type==="pointerdown"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":var nvalue=LiteGraph.clamp((x-15)/(widget_width-30),0,1);if(w.options.read_only)break;w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value,old_value)},20),this.dirty_canvas=!0;break;case"number":case"combo":case"enum":if(event.type=="pointermove"&&w.type=="number")deltaX&&(w.value+=deltaX*.1*(w.options.step||1)),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(event.type=="pointerdown"){var values=w.options.values;values&&values.constructor===Function&&(values=w.options.values(w,node));var values_list=null;w.type!="number"&&(values_list=values.constructor===Array?values:Object.keys(values));let o=x<40?-1:x>widget_width-40?1:0;if(w.type=="number")w.value+=o*.1*(w.options.step||1),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(o){var index=-1;this.last_mouseclick=0,values.constructor===Object?index=values_list.indexOf(String(w.value))+o:index=values_list.indexOf(w.value)+o,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index}else{let t=function(r){return values!=values_list&&(r=text_values.indexOf(r)),this.value=r,inner_value_change(this,r,old_value),that.dirty_canvas=!0,!1};var text_values=values!=values_list?Object.values(values):values;new LiteGraph.ContextMenu(text_values,{scale:Math.max(1,this.ds.scale),event,className:"dark",callback:t.bind(w)},ref_window)}}else if(event.type=="pointerup"&&w.type=="number"){let delta=x<40?-1:x>widget_width-40?1:0;event.click_time<200&&delta==0&&this.prompt("Value",w.value,function(v){var n;if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(o){(n=LiteGraph.warn)==null||n.call(LiteGraph,o)}this.value=Number(v),inner_value_change(this,this.value,old_value)}.bind(w),event)}old_value!=w.value&&setTimeout(function(){inner_value_change(this,this.value,old_value)}.bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type=="pointerdown"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type=="pointerdown"&&this.prompt("Value",w.value,function(o){inner_value_change(this,o)}.bind(w),event,w.options?w.options.multiline:!1);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node));break}return w}}}function inner_value_change(o,t,r){var s;(s=LiteGraph.debug)==null||s.call(LiteGraph,"inner_value_change for processNodeWidgets",o,t),r!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,r,w),node.graph.onGraphChanged({action:"widgetChanged",doSave:!0})),o.type=="number"&&(t=Number(t)),o.value=t,o.options&&o.options.property&&node.properties[o.options.property]!==void 0&&node.setProperty(o.options.property,t),o.callback&&o.callback(o.value,that,node,pos,event)}return null}drawGroups(o,t){if(this.graph){var r=this.graph._groups;t.save(),t.globalAlpha=.5*this.editor_alpha;for(let u=0;u<r.length;++u){var s=r[u];if(LiteGraph.overlapBounding(this.visible_area,s._bounding)){t.fillStyle=s.color||"#335",t.strokeStyle=s.color||"#335";var a=s._pos,l=s._size;t.globalAlpha=.25*this.editor_alpha,t.beginPath(),t.rect(a[0]+.5,a[1]+.5,l[0],l[1]),t.fill(),t.globalAlpha=this.editor_alpha,t.stroke(),t.beginPath(),t.moveTo(a[0]+l[0],a[1]+l[1]),t.lineTo(a[0]+l[0]-10,a[1]+l[1]),t.lineTo(a[0]+l[0],a[1]+l[1]-10),t.fill();var h=s.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE;t.font=h+"px Arial",t.textAlign="left",t.fillText(s.title,a[0]+4,a[1]+h)}}t.restore()}}adjustNodesSize(){var o=this.graph._nodes;for(let t=0;t<o.length;++t)o[t].size=o[t].computeSize();this.setDirty(!0,!0)}resize(o,t){if(!o&&!t){var r=this.canvas.parentNode;o=r.offsetWidth,t=r.offsetHeight}this.canvas.width==o&&this.canvas.height==t||(this.canvas.width=o,this.canvas.height=t,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}switchLiveMode(o){if(!o){this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;return}var t=this,r=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var s=setInterval(function(){t.editor_alpha*=r,t.dirty_canvas=!0,t.dirty_bgcanvas=!0,r<1&&t.editor_alpha<.01&&(clearInterval(s),r<1&&(t.live_mode=!0)),r>1&&t.editor_alpha>.99&&(clearInterval(s),t.editor_alpha=1)},1)}static onGroupAdd(o,t,r){var s=__LGraphCanvas.active_canvas,a=new LiteGraph.LGraphGroup;a.pos=s.convertEventToCanvasOffset(r),s.graph.add(a)}static getBoundaryNodes(o){let t=null,r=null,s=null,a=null;for(const l in o){const h=o[l],[u,c]=h.pos,[_,d]=h.size;(t===null||c<t.pos[1])&&(t=h),(r===null||u+_>r.pos[0]+r.size[0])&&(r=h),(s===null||c+d>s.pos[1]+s.size[1])&&(s=h),(a===null||u<a.pos[0])&&(a=h)}return{top:t,right:r,bottom:s,left:a}}boundaryNodesForSelection(){return __LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))}static alignNodes(o,t,r){if(!o)return;const s=__LGraphCanvas.active_canvas;let a=[];r===void 0?a=__LGraphCanvas.getBoundaryNodes(o):a={top:r,right:r,bottom:r,left:r};for(const[l,h]of Object.entries(s.selected_nodes))switch(t){case"right":h.pos[0]=a.right.pos[0]+a.right.size[0]-h.size[0];break;case"left":h.pos[0]=a.left.pos[0];break;case"top":h.pos[1]=a.top.pos[1];break;case"bottom":h.pos[1]=a.bottom.pos[1]+a.bottom.size[1]-h.size[1];break}s.dirty_canvas=!0,s.dirty_bgcanvas=!0}static onNodeAlign(o,t,r,s,a){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:r,callback:l,parentMenu:s});function l(h){__LGraphCanvas.alignNodes(__LGraphCanvas.active_canvas.selected_nodes,h.toLowerCase(),a)}}static onGroupAlign(o,t,r,s){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:r,callback:a,parentMenu:s});function a(l){__LGraphCanvas.alignNodes(__LGraphCanvas.active_canvas.selected_nodes,l.toLowerCase())}}static onMenuAdd(o,t,r,s,a){var l=__LGraphCanvas.active_canvas,h=l.getCanvasWindow(),u=l.graph;if(!u)return;function c(_,d){var f=LiteGraph.getNodeTypesCategories(l.filter||u.filter).filter(function(T){return T.startsWith(_)}),m=[];f.map(function(T){if(T){var L=new RegExp("^("+_+")"),G=T.replace(L,"").split("/")[0],I=_===""?G+"/":_+G+"/",O=G;O.indexOf("::")!=-1&&(O=O.split("::")[1]);var E=m.findIndex(function(D){return D.value===I});E===-1&&m.push({value:I,content:O,has_submenu:!0,callback:function(D,N,C,R){c(D.value,R)}})}});var b=LiteGraph.getNodeTypesInCategory(_.slice(0,-1),l.filter||u.filter);b.map(function(T){if(!T.skip_list){var L={value:T.type,content:T.title,has_submenu:!1,callback:function(G,I,O,E){var D=E.getFirstEvent();l.graph.beforeChange();var N=LiteGraph.createNode(G.value);N&&(N.pos=l.convertEventToCanvasOffset(D),l.graph.add(N)),a&&a(N),l.graph.afterChange()}};m.push(L)}}),new LiteGraph.ContextMenu(m,{event:r,parentMenu:d},h)}return c("",s),!1}static onMenuCollapseAll(){}static onMenuNodeEdit(){}static showMenuNodeOptionalInputs(o,t,r,s,a){var l;if(!a)return;var h=this,u=__LGraphCanvas.active_canvas,c=u.getCanvasWindow();t=a.optional_inputs,a.onGetInputs&&(t=a.onGetInputs());var _=[];if(t)for(let L=0;L<t.length;L++){var d=t[L];if(!d){_.push(null);continue}var f=d[0];d[2]||(d[2]={}),d[2].label&&(f=d[2].label),d[2].removable=!0;var m={content:f,value:d};d[1]==LiteGraph.ACTION&&(m.className="event"),_.push(m)}if(a.onMenuNodeInputs){var b=a.onMenuNodeInputs(_);b&&(_=b)}if(LiteGraph.do_add_triggers_slots&&a.findInputSlot("onTrigger")==-1&&_.push({content:"On Trigger",value:["onTrigger",LiteGraph.EVENT,{nameLocked:!0,removable:!0}],className:"event"}),!_.length){LiteGraph.debug&&((l=LiteGraph.log)==null||l.call(LiteGraph,"no input entries"));return}new LiteGraph.ContextMenu(_,{event:r,callback:T,parentMenu:s,node:a},c);function T(L,G,I){var O;if(a&&(L.callback&&L.callback.call(h,a,L,G,I),L.value)){a.graph.beforeChange();var E={};L.value[2]&&(E=Object.assign(E,L.value[2])),a.addInput(L.value[0],L.value[1],E),(O=a.onNodeInputAdd)==null||O.call(a,L.value),a.setDirtyCanvas(!0,!0),a.graph.afterChange()}}return!1}static showMenuNodeOptionalOutputs(o,t,r,s,a){if(!a)return;var l=this,h=__LGraphCanvas.active_canvas,u=h.getCanvasWindow();t=a.optional_outputs,a.onGetOutputs&&(t=a.onGetOutputs());var c=[];if(t)for(let T=0;T<t.length;T++){var _=t[T];if(!_){c.push(null);continue}if(!(a.flags&&a.flags.skip_repeated_outputs&&a.findOutputSlot(_[0])!=-1)){var d=_[0];_[2]||(_[2]={}),_[2].label&&(d=_[2].label),_[2].removable=!0;var f={content:d,value:_};_[1]==LiteGraph.EVENT&&(f.className="event"),c.push(f)}}if(this.onMenuNodeOutputs&&(c=this.onMenuNodeOutputs(c)),LiteGraph.do_add_triggers_slots&&a.findOutputSlot("onExecuted")==-1&&c.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0,removable:!0}],className:"event"}),a.onMenuNodeOutputs){var m=a.onMenuNodeOutputs(c);m&&(c=m)}if(!c.length)return;new LiteGraph.ContextMenu(c,{event:r,callback:b,parentMenu:s,node:a},u);function b(T,L,G){var I;if(a&&(T.callback&&T.callback.call(l,a,T,L,G),!!T.value)){var O=T.value[1];if(O&&(O.constructor===Object||O.constructor===Array)){var E=[];for(let N in O)E.push({content:N,value:O[N]});return new LiteGraph.ContextMenu(E,{event:L,callback:b,parentMenu:s,node:a}),!1}else{a.graph.beforeChange();var D={};T.value[2]&&(D=Object.assign(D,T.value[2])),a.addOutput(T.value[0],T.value[1],D),(I=a.onNodeOutputAdd)==null||I.call(a,T.value),a.setDirtyCanvas(!0,!0),a.graph.afterChange()}}}return!1}static onShowMenuNodeProperties(o,t,r,s,a){if(!a||!a.properties)return;var l=__LGraphCanvas.active_canvas,h=l.getCanvasWindow(),u=[];for(let d in a.properties){o=a.properties[d]!==void 0?a.properties[d]:" ",typeof o=="object"&&(o=JSON.stringify(o));var c=a.getPropertyInfo(d);(c.type=="enum"||c.type=="combo")&&(o=__LGraphCanvas.getPropertyPrintableValue(o,c.values)),o=__LGraphCanvas.decodeHTML(o),u.push({content:"<span class='property_name'>"+(c.label?c.label:d)+"</span><span class='property_value'>"+o+"</span>",value:d})}if(!u.length)return;new LiteGraph.ContextMenu(u,{event:r,callback:_,parentMenu:s,allow_html:!0,node:a},h);function _(d){if(a){var f=this.getBoundingClientRect();l.showEditPropertyValue(a,d.value,{position:[f.left,f.top]})}}return!1}static decodeHTML(o){var t=document.createElement("div");return t.innerText=o,t.innerHTML}static onMenuResizeNode(o,t,r,s,a){if(!a)return;const l=u=>{u.size=u.computeSize(),u.onResize&&u.onResize(u.size)};var h=__LGraphCanvas.active_canvas;if(!h.selected_nodes||Object.keys(h.selected_nodes).length<=1)l(a);else for(let u in h.selected_nodes)l(h.selected_nodes[u]);a.setDirtyCanvas(!0,!0)}showLinkMenu(o,t){var r=this,s=r.graph.getNodeById(o.origin_id),a=r.graph.getNodeById(o.target_id),l=!1;s&&s.outputs&&s.outputs[o.origin_slot]&&(l=s.outputs[o.origin_slot].type);var h=!1;a&&a.outputs&&a.outputs[o.target_slot]&&(h=a.inputs[o.target_slot].type);var u=new LiteGraph.ContextMenu(options,{event:t,title:o.data!=null?o.data.constructor.name:null,callback:c});function c(_,d,f){switch(_){case"Add Node":__LGraphCanvas.onMenuAdd(null,null,f,u,function(m){var b;(b=LiteGraph.debug)==null||b.call(LiteGraph,"node autoconnect"),!(!m.inputs||!m.inputs.length||!m.outputs||!m.outputs.length)&&s.connectByType(o.origin_slot,m,l)&&(m.connectByType(o.target_slot,a,h),m.pos[0]-=m.size[0]*.5)});break;case"Delete":r.graph.removeLink(o.id);break}}return!1}createDefaultNodeForSlot(o={}){var t,r,s,a,l,h=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},o),u=this,c=h.nodeFrom&&h.slotFrom!==null,_=!c&&h.nodeTo&&h.slotTo!==null;if(!c&&!_)return(t=LiteGraph.warn)==null||t.call(LiteGraph,"No data passed to createDefaultNodeForSlot "+h.nodeFrom+" "+h.slotFrom+" "+h.nodeTo+" "+h.slotTo),!1;if(!h.nodeType)return(r=LiteGraph.warn)==null||r.call(LiteGraph,"No type to createDefaultNodeForSlot"),!1;var d=c?h.nodeFrom:h.nodeTo,f=c?h.slotFrom:h.slotTo,m=!1;switch(typeof f){case"string":m=c?d.findOutputSlot(f,!1):d.findInputSlot(f,!1),f=c?d.outputs[f]:d.inputs[f];break;case"object":m=c?d.findOutputSlot(f.name):d.findInputSlot(f.name);break;case"number":m=f,f=c?d.outputs[f]:d.inputs[f];break;default:return(s=LiteGraph.warn)==null||s.call(LiteGraph,"Cant get slot information "+f),!1}(f===!1||m===!1)&&((a=LiteGraph.warn)==null||a.call(LiteGraph,"createDefaultNodeForSlot bad slotX "+f+" "+m));var b=f.type==LiteGraph.EVENT?"_event_":f.type,T=c?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(T&&T[b]){f.link;var L=!1;if(typeof T[b]=="object"){for(var G in T[b])if(h.nodeType==T[b][G]||h.nodeType=="AUTO"){L=T[b][G];break}}else(h.nodeType==T[b]||h.nodeType=="AUTO")&&(L=T[b]);if(L){var I=!1;typeof L=="object"&&L.node&&(I=L,L=L.node);var O=LiteGraph.createNode(L);if(O){if(I){if(I.properties)for(const[E,D]of Object.entries(I.properties))O.addProperty(E,D);I.inputs&&(O.inputs=[],Object.values(I.inputs).forEach(E=>{O.addOutput(E[0],E[1])})),I.outputs&&(O.outputs=[],Object.values(I.outputs).forEach(E=>{O.addOutput(E[0],E[1])})),I.title&&(O.title=I.title),I.json&&O.configure(I.json)}return u.graph.add(O),O.pos=[h.position[0]+h.posAdd[0]+(h.posSizeFix[0]?h.posSizeFix[0]*O.size[0]:0),h.position[1]+h.posAdd[1]+(h.posSizeFix[1]?h.posSizeFix[1]*O.size[1]:0)],c?h.nodeFrom.connectByType(m,O,b):h.nodeTo.connectByTypeOutput(m,O,b),!0}else(l=LiteGraph.warn)==null||l.call(LiteGraph,"failed creating "+L)}}return!1}showConnectionMenu(o={}){var t,r,s=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},o),a=this,l=s.nodeFrom&&s.slotFrom,h=!l&&s.nodeTo&&s.slotTo;if(!l&&!h)return(t=LiteGraph.warn)==null||t.call(LiteGraph,"No data passed to showConnectionMenu"),!1;var u=l?s.nodeFrom:s.nodeTo,c=l?s.slotFrom:s.slotTo,_=!1;switch(typeof c){case"string":_=l?u.findOutputSlot(c,!1):u.findInputSlot(c,!1),c=l?u.outputs[c]:u.inputs[c];break;case"object":_=l?u.findOutputSlot(c.name):u.findInputSlot(c.name);break;case"number":_=c,c=l?u.outputs[c]:u.inputs[c];break;default:return(r=LiteGraph.warn)==null||r.call(LiteGraph,"Cant get slot information "+c),!1}var d=["Add Node",null];a.allow_searchbox&&(d.push("Search"),d.push(null));const f=c.type===LiteGraph.EVENT?"_event_":c.type,m=l?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(m&&m[f]){const T=m[f];Array.isArray(T)||typeof T=="object"?Object.values(T).forEach(L=>{d.push(L)}):d.push(T)}var b=new LiteGraph.ContextMenu(d,{event:s.e,title:(c&&c.name!=""?c.name+(f?" | ":""):"")+(c&&f?f:""),callback:(T,L,G)=>{const I={"Add Node":()=>{__LGraphCanvas.onMenuAdd(null,null,G,b,O=>{l?s.nodeFrom.connectByType(_,O,f):s.nodeTo.connectByTypeOutput(_,O,f)})},Search:()=>{l?a.showSearchBox(G,{node_from:s.nodeFrom,slot_from:c,type_filter_in:f}):a.showSearchBox(G,{node_to:s.nodeTo,slot_from:c,type_filter_out:f})},default:()=>{a.createDefaultNodeForSlot(Object.assign(s,{position:[s.e.canvasX,s.e.canvasY],nodeType:T}))}};(I[T]||I.default)()}});return!1}static onShowPropertyEditor(o,t,r,s,a){var l=o.property||"title",h=a[l],u=document.createElement("div");u.is_modified=!1,u.className="graphdialog",u.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",u.close=()=>{var E;(E=u.parentNode)==null||E.removeChild(u)};var c=u.querySelector(".name");c.innerText=l;var _=u.querySelector(".value");const d=()=>{_&&O(_.value)};_&&(_.value=h,_.addEventListener("blur",function(E){this.focus()}),_.addEventListener("keydown",function(E){if(u.is_modified=!0,E.keyCode==27)u.close();else if(E.keyCode==13)d();else if(E.keyCode!=13&&E.target.localName!="textarea")return;E.preventDefault(),E.stopPropagation()}));var f=__LGraphCanvas.active_canvas,m=f.canvas,b=m.getBoundingClientRect(),T=-20,L=-20;b&&(T-=b.left,L-=b.top),event?(u.style.left=event.clientX+T+"px",u.style.top=event.clientY+L+"px"):(u.style.left=m.width*.5+T+"px",u.style.top=m.height*.5+L+"px");var G=u.querySelector("button");G.addEventListener("click",d),m.parentNode.appendChild(u),_&&_.focus();let I=null;u.addEventListener("pointerleave",E=>{LiteGraph.dialog_close_on_mouse_leave&&!u.is_modified&&(I=setTimeout(u.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),u.addEventListener("pointerenter",E=>{LiteGraph.dialog_close_on_mouse_leave&&I&&clearTimeout(I)});const O=E=>{var D;switch(o.type){case"Number":E=Number(E);break;case"Boolean":E=!!E;break}a[l]=E,(D=u.parentNode)==null||D.removeChild(u),a.setDirtyCanvas(!0,!0)}}prompt(o="",t,r,s,a){var l,h=document.createElement("div");h.is_modified=!1,h.className="graphdialog rounded",a?h.innerHTML="<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":h.innerHTML="<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",h.close=()=>{var I;this.prompt_box=null,(I=h.parentNode)==null||I.removeChild(h)};var u=__LGraphCanvas.active_canvas,c=u.canvas;c.parentNode.appendChild(h),this.ds.scale>1&&(h.style.transform=`scale(${this.ds.scale})`);var _=null;h.addEventListener("pointerleave",I=>{LiteGraph.dialog_close_on_mouse_leave&&!h.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(_=setTimeout(h.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),h.addEventListener("pointerenter",I=>{LiteGraph.dialog_close_on_mouse_leave&&_&&clearTimeout(_)});const d=h.querySelectorAll("select");d&&d.forEach(I=>{I.addEventListener("click",O=>{}),I.addEventListener("blur",O=>{}),I.addEventListener("change",O=>{})}),(l=this.prompt_box)==null||l.close(),this.prompt_box=h;var f=h.querySelector(".name");f.innerText=o;var m=h.querySelector(".value");m.value=t;const b=m;b.addEventListener("keydown",I=>{var O;switch(h.is_modified=!0,I.keyCode){case 27:h.close();break;case 13:I.target.localName!=="textarea"&&typeof r=="function"&&(r(b.value),this.setDirty(!0)),(O=LiteGraph.debug)==null||O.call(LiteGraph,"prompt v2 ENTER",b.value,I.target.localName,r),h.close();break;default:return}I.preventDefault(),I.stopPropagation()}),h.querySelector("button").addEventListener("click",I=>{var O;typeof r=="function"&&(r(b.value),this.setDirty(!0)),(O=LiteGraph.debug)==null||O.call(LiteGraph,"prompt v2 OK",b.value,r),h.close()});var T=c.getBoundingClientRect(),L=-20,G=-20;return T&&(L-=T.left,G-=T.top),s?(h.style.left=s.clientX+L+"px",h.style.top=s.clientY+G+"px"):(h.style.left=c.width*.5+L+"px",h.style.top=c.height*.5+G+"px"),setTimeout(function(){b.focus()},10),h}showSearchBox(o,t){var r={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};t=Object.assign(r,t||{});var s=this,a=__LGraphCanvas.active_canvas,l=a.canvas,h=l.ownerDocument||document,u=document.createElement("div");if(u.className="litegraph litesearchbox graphdialog rounded",u.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",t.do_type_filter&&(u.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",u.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),t.show_close_button&&(u.innerHTML+="<button class='close_searchbox close'>X</button>"),u.innerHTML+="<div class='helper'></div>",h.fullscreenElement?h.fullscreenElement.appendChild(u):(h.body.appendChild(u),h.body.style.overflow="hidden"),t.do_type_filter)var c=u.querySelector(".slot_in_type_filter"),_=u.querySelector(".slot_out_type_filter");if(u.close=function(){s.search_box=null,this.blur(),l.focus(),h.body.style.overflow="",setTimeout(function(){s.canvas.focus()},20),u.parentNode&&u.parentNode.removeChild(u)},this.ds.scale>1&&(u.style.transform=`scale(${this.ds.scale})`),t.hide_on_mouse_leave){var d=!1,f=null;u.addEventListener("pointerenter",function(S){f&&(clearTimeout(f),f=null)}),u.addEventListener("pointerleave",function(S){d||(f=setTimeout(function(){u.close()},500))}),t.do_type_filter&&(c.addEventListener("click",function(S){d++}),c.addEventListener("blur",function(S){d=0}),c.addEventListener("change",function(S){d=-1}),_.addEventListener("click",function(S){d++}),_.addEventListener("blur",function(S){d=0}),_.addEventListener("change",function(S){d=-1}))}s.search_box&&s.search_box.close(),s.search_box=u;var m=u.querySelector(".helper"),b=null,T=null,L=null,G=u.querySelector("input");if(G&&(G.addEventListener("blur",function(S){s.search_box&&this.focus()}),G.addEventListener("keydown",function(S){if(S.keyCode==38)C(!1);else if(S.keyCode==40)C(!0);else if(S.keyCode==27)u.close();else if(S.keyCode==13)R(),L?N(L.innerHTML):b?N(b):u.close();else{T&&clearInterval(T),T=setTimeout(R,250);return}return S.preventDefault(),S.stopPropagation(),S.stopImmediatePropagation(),!0})),t.do_type_filter){if(c){let S=LiteGraph.slot_types_in,P=S.length;(t.type_filter_in==LiteGraph.EVENT||t.type_filter_in==LiteGraph.ACTION)&&(t.type_filter_in="_event_");for(let M=0;M<P;M++){let A=document.createElement("option");A.value=S[M],A.innerHTML=S[M],c.appendChild(A),t.type_filter_in!==!1&&(t.type_filter_in+"").toLowerCase()==(S[M]+"").toLowerCase()&&(A.selected=!0)}c.addEventListener("change",function(){R()})}if(_){let S=LiteGraph.slot_types_out,P=S.length;(t.type_filter_out==LiteGraph.EVENT||t.type_filter_out==LiteGraph.ACTION)&&(t.type_filter_out="_event_");for(let M=0;M<P;M++){let A=document.createElement("option");A.value=S[M],A.innerHTML=S[M],_.appendChild(A),t.type_filter_out!==!1&&(t.type_filter_out+"").toLowerCase()==(S[M]+"").toLowerCase()&&(A.selected=!0)}_.addEventListener("change",function(){R()})}}if(t.show_close_button){var I=u.querySelector(".close");I.addEventListener("click",u.close)}var O=l.getBoundingClientRect(),E=(o?o.clientX:O.left+O.width*.5)-80,D=(o?o.clientY:O.top+O.height*.5)-20;O.width-E<470&&(E=O.width-470),O.height-D<220&&(D=O.height-220),E<O.left+20&&(E=O.left+20),D<O.top+20&&(D=O.top+20),u.style.left=E+"px",u.style.top=D+"px",G.focus(),t.show_all_on_open&&R();function N(S){if(S)if(s.onSearchBoxSelection)s.onSearchBoxSelection(S,o,a);else{var P=LiteGraph.searchbox_extras[S.toLowerCase()];P&&(S=P.type),a.graph.beforeChange();var M=LiteGraph.createNode(S);if(M&&(M.pos=a.convertEventToCanvasOffset(o),a.graph.add(M,!1,{doProcessChange:!1})),P&&P.data){if(P.data.properties)for(let B in P.data.properties)M.addProperty(B,P.data.properties[B]);if(P.data.inputs){M.inputs=[];for(let B in P.data.inputs)M.addOutput(P.data.inputs[B][0],P.data.inputs[B][1])}if(P.data.outputs){M.outputs=[];for(let B in P.data.outputs)M.addOutput(P.data.outputs[B][0],P.data.outputs[B][1])}P.data.title&&(M.title=P.data.title),P.data.json&&M.configure(P.data.json)}let A;if(t.node_from){switch(A=!1,typeof t.slot_from){case"string":A=t.node_from.findOutputSlot(t.slot_from);break;case"object":t.slot_from.name?A=t.node_from.findOutputSlot(t.slot_from.name):A=-1,A==-1&&typeof t.slot_from.slot_index!="undefined"&&(A=t.slot_from.slot_index);break;case"number":A=t.slot_from;break;default:A=0}typeof t.node_from.outputs[A]!="undefined"&&A!==!1&&A>-1&&t.node_from.connectByType(A,M,t.node_from.outputs[A].type)}if(t.node_to){switch(A=!1,typeof t.slot_from){case"string":A=t.node_to.findInputSlot(t.slot_from);break;case"object":t.slot_from.name?A=t.node_to.findInputSlot(t.slot_from.name):A=-1,A==-1&&typeof t.slot_from.slot_index!="undefined"&&(A=t.slot_from.slot_index);break;case"number":A=t.slot_from;break;default:A=0}typeof t.node_to.inputs[A]!="undefined"&&A!==!1&&A>-1&&t.node_to.connectByTypeOutput(A,M,t.node_to.inputs[A].type)}a.graph.afterChange()}u.close()}function C(S){var P=L;L&&L.classList.remove("selected"),L?(L=S?L.nextSibling:L.previousSibling,L||(L=P)):L=S?m.childNodes[0]:m.childNodes[m.childNodes.length],L&&(L.classList.add("selected"),L.scrollIntoView({block:"end",behavior:"smooth"}))}function R(){T=null;var S=G.value;if(b=null,m.innerHTML="",!S&&!t.show_all_if_empty)return;if(s.onSearchBox){var P=s.onSearchBox(m,S,a);if(P)for(let z=0;z<P.length;++z)W(P[z])}else{let z=function(X,J={}){var pe={skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},q=Object.assign(pe,J),Z=LiteGraph.registered_node_types[X];if(A&&Z.filter!=A||(!t.show_all_if_empty||S)&&X.toLowerCase().indexOf(S)===-1)return!1;if(t.do_type_filter&&!q.skipFilter){var K=X;let xt;var Q=U.value;if(q.inTypeOverride!==!1&&(Q=q.inTypeOverride),U&&Q&&LiteGraph.registered_slot_in_types[Q]&&LiteGraph.registered_slot_in_types[Q].nodes&&(xt=LiteGraph.registered_slot_in_types[Q].nodes.includes(K),xt===!1)||(Q=V.value,q.outTypeOverride!==!1&&(Q=q.outTypeOverride),V&&Q&&LiteGraph.registered_slot_out_types[Q]&&LiteGraph.registered_slot_out_types[Q].nodes&&(xt=LiteGraph.registered_slot_out_types[Q].nodes.includes(K),xt===!1)))return!1}return!0};var M=0;S=S.toLowerCase();var A=a.filter||a.graph.filter;let U,V;t.do_type_filter&&s.search_box?(U=s.search_box.querySelector(".slot_in_type_filter"),V=s.search_box.querySelector(".slot_out_type_filter")):(U=!1,V=!1);for(let X in LiteGraph.searchbox_extras){var B=LiteGraph.searchbox_extras[X];if(!((!t.show_all_if_empty||S)&&B.desc.toLowerCase().indexOf(S)===-1)){var $=LiteGraph.registered_node_types[B.type];if(!($&&$.filter!=A)&&z(B.type)&&(W(B.desc,"searchbox_extra"),__LGraphCanvas.search_limit!==-1&&M++>__LGraphCanvas.search_limit))break}}var H=null;if(Array.prototype.filter)H=Object.keys(LiteGraph.registered_node_types).filter(z);else{H=[];for(let X in LiteGraph.registered_node_types)z(X)&&H.push(X)}for(let X=0;X<H.length&&(W(H[X]),!(__LGraphCanvas.search_limit!==-1&&M++>__LGraphCanvas.search_limit));X++);if(t.show_general_after_typefiltered&&(U.value||V.value)){var F=[];for(let X in LiteGraph.registered_node_types)z(X,{inTypeOverride:U&&U.value?"*":!1,outTypeOverride:V&&V.value?"*":!1})&&F.push(X);for(let X=0;X<F.length&&(W(F[X],"generic_type"),!(__LGraphCanvas.search_limit!==-1&&M++>__LGraphCanvas.search_limit));X++);}if((U.value||V.value)&&m.childNodes.length==0&&t.show_general_if_none_on_typefilter){var F=[];for(let J in LiteGraph.registered_node_types)z(J,{skipFilter:!0})&&F.push(J);for(let J=0;J<F.length&&(W(F[J],"not_in_filter"),!(__LGraphCanvas.search_limit!==-1&&M++>__LGraphCanvas.search_limit));J++);}}function W(z,U){var V=document.createElement("div");b||(b=z),V.innerText=z,V.dataset.type=escape(z),V.className="litegraph lite-search-item",U&&(V.className+=" "+U),V.addEventListener("click",function(X){N(unescape(this.dataset.type))}),m.appendChild(V)}}return u}showEditPropertyValue(o,t,r){var s,a,l,h,u;if(!o||o.properties[t]===void 0)return;r=r||{};var c=o.getPropertyInfo(t),_=c.type;let d;if(_=="string"||_=="number"||_=="array"||_=="object")d="<input autofocus type='text' class='value'/>";else if((_=="enum"||_=="combo")&&c.values){(s=LiteGraph.debug)==null||s.call(LiteGraph,"CREATING showEditPropertyValue ENUM COMBO",b,_,m),d="<select autofocus type='text' class='value'>";for(let I in c.values){var f=I;c.values.constructor===Array&&(f=c.values[I]),d+="<option value='"+f+"' "+(f==o.properties[t]?"selected":"")+">"+c.values[I]+"</option>"}d+="</select>"}else if(_=="boolean"||_=="toggle")d="<input autofocus type='checkbox' class='value' "+(o.properties[t]?"checked":"")+"/>";else{(a=LiteGraph.warn)==null||a.call(LiteGraph,"unknown type: "+_);return}var m=this.createDialog("<span class='name'>"+(c.label?c.label:t)+"</span>"+d+"<button>OK</button>",r),b=!1;(_=="enum"||_=="combo")&&c.values?((l=LiteGraph.debug)==null||l.call(LiteGraph,"showEditPropertyValue ENUM COMBO",b,_,m),b=m.querySelector("select"),b.addEventListener("change",function(I){var O;m.modified(),(O=LiteGraph.debug)==null||O.call(LiteGraph,"Enum change",b,c,I.target),G(I.target.value)})):_=="boolean"||_=="toggle"?((h=LiteGraph.debug)==null||h.call(LiteGraph,"showEditPropertyValue TOGGLE",b,_,m),b=m.querySelector("input"),b&&b.addEventListener("click",function(I){m.modified(),G(!!b.checked)})):(b=m.querySelector("input"),(u=LiteGraph.debug)==null||u.call(LiteGraph,"showEditPropertyValue",b,_,m),b&&(b.addEventListener("blur",function(I){this.focus()}),f=o.properties[t]!==void 0?o.properties[t]:"",_!=="string"&&(f=JSON.stringify(f)),b.value=f,b.addEventListener("keydown",function(I){if(I.keyCode==27)m.close();else if(I.keyCode==13)L();else if(I.keyCode!=13){m.modified();return}I.preventDefault(),I.stopPropagation()}))),b&&b.focus();var T=m.querySelector("button");T.addEventListener("click",L);function L(){G(b.value)}function G(I){var O;c&&c.values&&c.values.constructor===Object&&c.values[I]!=null&&(I=c.values[I]),typeof o.properties[t]=="number"&&(I=Number(I)),(_=="array"||_=="object")&&(I=JSON.parse(I)),o.properties[t]=I,(O=o.graph)==null||O.onGraphChanged({action:"propertyChanged",doSave:!0}),o.onPropertyChanged&&o.onPropertyChanged(t,I),r.onclose&&r.onclose(),m.close(),o.setDirtyCanvas(!0,!0)}return m}createDialog(o,t){var r={checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0};t=Object.assign(r,t||{});var s=document.createElement("div");s.className="graphdialog",s.innerHTML=o,s.is_modified=!1;var a=this.canvas.getBoundingClientRect(),l=-20,h=-20;if(a&&(l-=a.left,h-=a.top),t.position?(l+=t.position[0],h+=t.position[1]):t.event?(l+=t.event.clientX,h+=t.event.clientY):(l+=this.canvas.width*.5,h+=this.canvas.height*.5),s.style.left=l+"px",s.style.top=h+"px",this.canvas.parentNode.appendChild(s),t.checkForInput){var u=[],c=!1;u=s.querySelectorAll("input"),u&&u.forEach(function(m){m.addEventListener("keydown",function(b){if(s.modified(),b.keyCode==27)s.close();else if(b.keyCode!=13)return;b.preventDefault(),b.stopPropagation()}),c||m.focus()})}s.modified=function(){s.is_modified=!0},s.close=function(){s.parentNode&&s.parentNode.removeChild(s)};var _=null,d=!1;s.addEventListener("pointerleave",function(m){d||(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!s.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(_=setTimeout(s.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),s.addEventListener("pointerenter",function(m){(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&_&&clearTimeout(_)});var f=s.querySelectorAll("select");return f&&f.forEach(function(m){m.addEventListener("click",function(b){d++}),m.addEventListener("blur",function(b){d=0}),m.addEventListener("change",function(b){d=-1})}),s}createPanel(o,t){t=t||{};var r=t.window||window,s=document.createElement("div");if(s.className="litegraph dialog",s.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",s.header=s.querySelector(".dialog-header"),t.width&&(s.style.width=t.width+(t.width.constructor===Number?"px":"")),t.height&&(s.style.height=t.height+(t.height.constructor===Number?"px":"")),t.closable){var a=document.createElement("span");a.innerHTML="&#10005;",a.classList.add("close"),a.addEventListener("click",function(){s.close()}),s.header.appendChild(a)}return s.title_element=s.querySelector(".dialog-title"),s.title_element.innerText=o,s.content=s.querySelector(".dialog-content"),s.alt_content=s.querySelector(".dialog-alt-content"),s.footer=s.querySelector(".dialog-footer"),s.close=function(){s.onClose&&typeof s.onClose=="function"&&s.onClose(),s.parentNode&&s.parentNode.removeChild(s),this.parentNode&&this.parentNode.removeChild(this)},s.toggleAltContent=function(l){let h,u;typeof l!="undefined"?(h=l?"block":"none",u=l?"none":"block"):(h=s.alt_content.style.display!="block"?"block":"none",u=s.alt_content.style.display!="block"?"none":"block"),s.alt_content.style.display=h,s.content.style.display=u},s.toggleFooterVisibility=function(l){let h;typeof l!="undefined"?h=l?"block":"none":h=s.footer.style.display!="block"?"block":"none",s.footer.style.display=h},s.clear=function(){this.content.innerHTML=""},s.addHTML=function(l,h,u){var c=document.createElement("div");return h&&(c.className=h),c.innerHTML=l,u?s.footer.appendChild(c):s.content.appendChild(c),c},s.addButton=function(l,h,u){var c=document.createElement("button");return c.innerText=l,c.options=u,c.classList.add("btn"),c.addEventListener("click",h),s.footer.appendChild(c),c},s.addSeparator=function(){var l=document.createElement("div");l.className="separator",s.content.appendChild(l)},s.addWidget=function(l,h,u,c,_){var d,f;c=c||{};var m=String(u);l=l.toLowerCase(),l=="number"&&(m=u.toFixed(3));var b=document.createElement("div");b.className="property",b.innerHTML="<span class='property_name'></span><span class='property_value'></span>",b.querySelector(".property_name").innerText=c.label||h;var T=b.querySelector(".property_value");T.innerText=m,b.dataset.property=h,b.dataset.type=c.type||l,b.options=c,b.value=u,(d=LiteGraph.debug)==null||d.call(LiteGraph,"addWidget",l,u,T,c),l=="code"?b.addEventListener("click",function(G){s.inner_showCodePad(this.dataset.property)}):l=="boolean"?(b.classList.add("boolean"),u&&b.classList.add("bool-on"),b.addEventListener("click",function(){var G=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",L(G,this.value)})):l=="string"||l=="number"?(T.setAttribute("contenteditable",!0),T.addEventListener("keydown",function(G){G.code=="Enter"&&(l!="string"||!G.shiftKey)&&(G.preventDefault(),this.blur())}),T.addEventListener("blur",function(){var G=this.innerText,I=this.parentNode.dataset.property,O=this.parentNode.dataset.type;O=="number"&&(G=Number(G)),L(I,G)})):(l=="enum"||l=="combo")&&(m=__LGraphCanvas.getPropertyPrintableValue(u,c.values),T.innerText=m,(f=LiteGraph.debug)==null||f.call(LiteGraph,"addWidget ENUM COMBO",l,m,T,c),T.addEventListener("click",function(G){var I=c.values||[],O=this.parentNode.dataset.property,E=this;new LiteGraph.ContextMenu(I,{event:G,className:"dark",callback:D},r);function D(N){return E.innerText=N,L(O,N),!1}})),s.content.appendChild(b);function L(G,I){var O;(O=LiteGraph.debug)==null||O.call(LiteGraph,"widgetInnerChange",G,I,c),c.callback&&c.callback(G,I,c),_&&_(G,I,c)}return b},s.onOpen&&typeof s.onOpen=="function"&&s.onOpen(),s}static getPropertyPrintableValue(o,t){if(!t||t.constructor===Array)return String(o);if(t.constructor===Object){var r="";for(var s in t)if(t[s]==o){r=s;break}return String(o)+" ("+r+")"}}closePanels(){var o=document.querySelector("#node-panel");o&&o.close(),o=document.querySelector("#option-panel"),o&&o.close()}showShowGraphOptionsPanel(o,t){var r,s,a,l;let h;if(this.constructor&&this.constructor.name=="HTMLDivElement"){if(!((s=(r=t==null?void 0:t.event)==null?void 0:r.target)!=null&&s.lgraphcanvas)){(a=LiteGraph.warn)==null||a.call(LiteGraph,"References not found to add optionPanel",o,t),LiteGraph.debug&&((l=LiteGraph.debug)==null||l.call(LiteGraph,"!obEv || !obEv.event || !obEv.event.target || !obEv.event.target.lgraphcanvas",t,t.event,t.event.target,t.event.target.lgraphcanvas));return}h=t.event.target.lgraphcanvas}else h=this;h.closePanels();var u=h.getCanvasWindow();panel=h.createPanel("Options",{closable:!0,window:u,onOpen:function(){h.OPTIONPANEL_IS_OPEN=!0},onClose:function(){h.OPTIONPANEL_IS_OPEN=!1,h.options_panel=null}}),h.options_panel=panel,panel.id="option-panel",panel.classList.add("settings");function c(){panel.content.innerHTML="";const _=(b,T,L)=>{L&&L.key&&(b=L.key),L.values&&(T=Object.values(L.values).indexOf(T)),h[b]=T};var d=LiteGraph.availableCanvasOptions;d.sort();for(var f in d){var m=d[f];panel.addWidget("boolean",m,h[m],{key:m,on:"True",off:"False"},_)}panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[h.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},_),panel.addSeparator(),panel.footer.innerHTML=""}c(),h.canvas.parentNode.appendChild(panel)}showShowNodePanel(o){this.SELECTED_NODE=o,this.closePanels();var t=this.getCanvasWindow(),r=this,s=this.createPanel(o.title||"",{closable:!0,window:t,onOpen:function(){r.NODEPANEL_IS_OPEN=!0},onClose:function(){r.NODEPANEL_IS_OPEN=!1,r.node_panel=null}});r.node_panel=s,s.id="node-panel",s.node=o,s.classList.add("settings");function a(){s.content.innerHTML="",s.addHTML("<span class='node_type'>"+o.type+"</span><span class='node_desc'>"+(o.constructor.desc||"")+"</span><span class='separator'></span>"),s.addHTML("<h3>Properties</h3>");const l=(d,f)=>{var m,b;switch(r.graph.beforeChange(o),d){case"Title":o.title=f;break;case"Mode":var T=Object.values(LiteGraph.NODE_MODES).indexOf(f);T>=0&&LiteGraph.NODE_MODES[T]?o.changeMode(T):(m=LiteGraph.warn)==null||m.call(LiteGraph,"unexpected mode: "+f);break;case"Color":__LGraphCanvas.node_colors[f]?(o.color=__LGraphCanvas.node_colors[f].color,o.bgcolor=__LGraphCanvas.node_colors[f].bgcolor):(b=LiteGraph.warn)==null||b.call(LiteGraph,"unexpected color: "+f);break;default:o.setProperty(d,f);break}r.graph.afterChange(),r.dirty_canvas=!0};s.addWidget("string","Title",o.title,{},l),s.addWidget("combo","Mode",LiteGraph.NODE_MODES[o.mode],{values:LiteGraph.NODE_MODES},l);var h="";o.color!==void 0&&(h=Object.keys(__LGraphCanvas.node_colors).filter(function(d){return __LGraphCanvas.node_colors[d].color==o.color})),s.addWidget("combo","Color",h,{values:Object.keys(__LGraphCanvas.node_colors)},l);for(var u in o.properties){var c=o.properties[u],_=o.getPropertyInfo(u);o.onAddPropertyToPanel&&o.onAddPropertyToPanel(u,s,c,_,l)||s.addWidget(_.widget||_.type,u,c,_,l)}s.addSeparator(),o.onShowCustomPanelInfo&&o.onShowCustomPanelInfo(s),s.footer.innerHTML="",s.addButton("Delete",function(){o.block_delete||(o.graph.remove(o),s.close())}).classList.add("delete")}s.inner_showCodePad=function(l){s.classList.remove("settings"),s.classList.add("centered"),s.alt_content.innerHTML="<textarea class='code'></textarea>";var h=s.alt_content.querySelector("textarea"),u=()=>{s.toggleAltContent(!1),s.toggleFooterVisibility(!0),h.parentNode.removeChild(h),s.classList.add("settings"),s.classList.remove("centered"),a()};h.value=o.properties[l],h.addEventListener("keydown",function(d){d.code=="Enter"&&d.ctrlKey&&(o.setProperty(l,h.value),u())}),s.toggleAltContent(!0),s.toggleFooterVisibility(!1),h.style.height="calc(100% - 40px)";var c=s.addButton("Assign",function(){o.setProperty(l,h.value),u()});s.alt_content.appendChild(c);var _=s.addButton("Close",u);_.style.float="right",s.alt_content.appendChild(_)},a(),this.canvas.parentNode.appendChild(s)}showSubgraphPropertiesDialog(o){var t;(t=LiteGraph.log)==null||t.call(LiteGraph,"showing subgraph properties dialog");var r=this.canvas.parentNode.querySelector(".subgraph_dialog");r&&r.close();var s=this.createPanel("Subgraph Inputs",{closable:!0,width:500});s.node=o,s.classList.add("subgraph_dialog");function a(){if(s.clear(),o.inputs)for(let d=0;d<o.inputs.length;++d){var u=o.inputs[d];if(!u.not_subgraph_input){var c="<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>",_=s.addHTML(c,"subgraph_property");_.dataset.name=u.name,_.dataset.slot=d,_.querySelector(".name").innerText=u.name,_.querySelector(".type").innerText=u.type,_.querySelector("button").addEventListener("click",function(f){o.removeInput(Number(this.parentNode.dataset.slot)),a()})}}}var l=" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>",h=s.addHTML(l,"subgraph_property extra",!0);return h.querySelector("button").addEventListener("click",function(u){var c=this.parentNode,_=c.querySelector(".name").value,d=c.querySelector(".type").value;!_||o.findInputSlot(_)!=-1||(o.addInput(_,d),c.querySelector(".name").value="",c.querySelector(".type").value="",a())}),a(),this.canvas.parentNode.appendChild(s),s}showSubgraphPropertiesDialogRight(o){var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var r=this.createPanel("Subgraph Outputs",{closable:!0,width:500});r.node=o,r.classList.add("subgraph_dialog");function s(){if(r.clear(),o.outputs)for(let d=0;d<o.outputs.length;++d){var u=o.outputs[d];if(!u.not_subgraph_output){var c="<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>",_=r.addHTML(c,"subgraph_property");_.dataset.name=u.name,_.dataset.slot=d,_.querySelector(".name").innerText=u.name,_.querySelector(".type").innerText=u.type,_.querySelector("button").addEventListener("click",function(f){o.removeOutput(Number(this.parentNode.dataset.slot)),s()})}}}var a=" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>",l=r.addHTML(a,"subgraph_property extra",!0);l.querySelector(".name").addEventListener("keydown",function(u){e.keyCode==13&&h.apply(this)}),l.querySelector("button").addEventListener("click",function(u){h.apply(this)});function h(){var u=this.parentNode,c=u.querySelector(".name").value,_=u.querySelector(".type").value;!c||o.findOutputSlot(c)!=-1||(o.addOutput(c,_),u.querySelector(".name").value="",u.querySelector(".type").value="",s())}return s(),this.canvas.parentNode.appendChild(r),r}checkPanels(){if(this.canvas){var o=this.canvas.parentNode.querySelectorAll(".litegraph.dialog");for(let r=0;r<o.length;++r){var t=o[r];t.node&&(!t.node.graph||t.graph!=this.graph)&&t.close()}}}static onMenuNodeCollapse(o,t,r,s,a){a.graph.beforeChange();var l=function(u){u.collapse()},h=__LGraphCanvas.active_canvas;if(!h.selected_nodes||Object.keys(h.selected_nodes).length<=1)l(a);else for(let u in h.selected_nodes)l(h.selected_nodes[u]);a.graph.afterChange()}static onMenuNodePin(o,t,r,s,a){a.pin()}static onMenuNodeMode(o,t,r,s,a){new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:r,callback:l,parentMenu:s,node:a});function l(h){if(!a)return;var u=Object.values(LiteGraph.NODE_MODES).indexOf(h);const c=d=>{var f;u>=0&&LiteGraph.NODE_MODES[u]?d.changeMode(u):((f=LiteGraph.warn)==null||f.call(LiteGraph,"unexpected mode: "+h),d.changeMode(LiteGraph.ALWAYS))};var _=__LGraphCanvas.active_canvas;if(!_.selected_nodes||Object.keys(_.selected_nodes).length<=1)c(a);else for(let d in _.selected_nodes)c(_.selected_nodes[d])}return!1}static onMenuNodeColors(o,t,r,s,a){if(!a)throw new Error("no node for color");var l=[];l.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(let u in __LGraphCanvas.node_colors){let c=__LGraphCanvas.node_colors[u];o={value:u,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+c.color+"; background-color:"+c.bgcolor+"'>"+u+"</span>"},l.push(o)}new LiteGraph.ContextMenu(l,{event:r,callback:h,parentMenu:s,node:a});function h(u){if(!a)return;let c=u.value?__LGraphCanvas.node_colors[u.value]:null;const _=f=>{c?f.constructor===LiteGraph.LGraphGroup?f.color=c.groupcolor:(f.color=c.color,f.bgcolor=c.bgcolor):(delete f.color,delete f.bgcolor)};var d=__LGraphCanvas.active_canvas;if(!d.selected_nodes||Object.keys(d.selected_nodes).length<=1)_(a);else for(let f in d.selected_nodes)_(d.selected_nodes[f]);a.setDirtyCanvas(!0,!0)}return!1}static onMenuNodeShapes(o,t,r,s,a){if(!a)throw new Error("no node passed");new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:r,callback:l,parentMenu:s,node:a});function l(h){if(!a)return;a.graph.beforeChange();const u=_=>{_.shape=h};var c=__LGraphCanvas.active_canvas;if(!c.selected_nodes||Object.keys(c.selected_nodes).length<=1)u(a);else for(let _ in c.selected_nodes)u(c.selected_nodes[_]);a.graph.afterChange(),a.setDirtyCanvas(!0)}return!1}static onMenuNodeRemove(o,t,r,s,a){if(!a)throw new Error("no node passed");var l=a.graph;l.beforeChange();const h=c=>{c.removable!==!1&&l.remove(c)};var u=__LGraphCanvas.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)h(a);else for(let c in u.selected_nodes)h(u.selected_nodes[c]);l.afterChange(),a.setDirtyCanvas(!0,!0)}static onMenuNodeToSubgraph(o,t,r,s,a){var l=a.graph,h=__LGraphCanvas.active_canvas;if(h){var u=Object.values(h.selected_nodes||{});u.length||(u=[a]);var c=LiteGraph.createNode("graph/subgraph");c.pos=a.pos.concat(),l.add(c),c.buildFromNodes(u),h.deselectAllNodes(),a.setDirtyCanvas(!0,!0)}}static onMenuNodeClone(o,t,r,s,a){a.graph.beforeChange();var l={};const h=c=>{if(c.clonable!==!1){var _=c.clone();_&&(_.pos=[c.pos[0]+5,c.pos[1]+5],c.graph.add(_),l[_.id]=_)}};var u=__LGraphCanvas.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)h(a);else for(let c in u.selected_nodes)h(u.selected_nodes[c]);Object.keys(l).length&&u.selectNodes(l),a.graph.afterChange(),a.setDirtyCanvas(!0,!0)}getCanvasMenuOptions(){var o=null;if(this.getMenuOptions?o=this.getMenuOptions():(o=[{content:"Add Node",has_submenu:!0,callback:__LGraphCanvas.onMenuAdd},{content:"Add Group",callback:__LGraphCanvas.onGroupAdd}],LiteGraph.showCanvasOptions&&o.push({content:"Options",callback:this.showShowGraphOptionsPanel}),Object.keys(this.selected_nodes).length>1&&o.push({content:"Align",has_submenu:!0,callback:__LGraphCanvas.onGroupAlign}),this._graph_stack&&this._graph_stack.length>0&&o.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var t=this.getExtraMenuOptions(this,o);t&&(o=o.concat(t))}return o}getNodeMenuOptions(o){var t=null;if(o.getMenuOptions?t=o.getMenuOptions(this):(t=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:__LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:__LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:__LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:__LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:__LGraphCanvas.onMenuNodeMode}],o.resizable!==!1&&t.push({content:"Resize",callback:__LGraphCanvas.onMenuResizeNode}),t.push({content:"Collapse",callback:__LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:__LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:__LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:__LGraphCanvas.onMenuNodeShapes},null)),o.onGetInputs){var r=o.onGetInputs();r&&r.length&&(t[0].disabled=!1)}if(o.onGetOutputs){var s=o.onGetOutputs();s&&s.length&&(t[1].disabled=!1)}if(LiteGraph.do_add_triggers_slots&&(t[1].disabled=!1),o.getExtraMenuOptions){var a=o.getExtraMenuOptions(this,t);a&&(a.push(null),t=a.concat(t))}return o.clonable!==!1&&t.push({content:"Clone",callback:__LGraphCanvas.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&t.push({content:"Align Selected To",has_submenu:!0,callback:__LGraphCanvas.onNodeAlign}),t.push(null,{content:"Remove",disabled:!(o.removable!==!1&&!o.block_delete),callback:__LGraphCanvas.onMenuNodeRemove}),o.graph&&o.graph.onGetNodeMenuOptions&&o.graph.onGetNodeMenuOptions(t,o),t}getGroupMenuOptions(){var o=[{content:"Title",callback:__LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:__LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:__LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:__LGraphCanvas.onMenuNodeRemove}];return o}processContextMenu(o,t){var r,s,a,l=this,h=__LGraphCanvas.active_canvas,u=h.getCanvasWindow(),c=null,_={event:t,callback:T,extra:o};o&&(_.title=o.type);var d=null;if(o&&(d=o.getSlotInPosition(t.canvasX,t.canvasY),__LGraphCanvas.active_node=o),d){if(c=[],o.getSlotMenuOptions)c=o.getSlotMenuOptions(d);else{((s=(r=d==null?void 0:d.output)==null?void 0:r.links)!=null&&s.length||(a=d.input)!=null&&a.link)&&c.push({content:"Disconnect Links",slot:d});var f=d.input||d.output;f.removable&&LiteGraph.canRemoveSlots&&c.push(f.locked?"Cannot remove":{content:"Remove Slot",slot:d}),!f.nameLocked&&LiteGraph.canRenameSlots&&c.push({content:"Rename Slot",slot:d})}var m=d.input||d.output;_.title=m.type||"*",m.type==LiteGraph.ACTION?_.title="Action":m.type==LiteGraph.EVENT&&(_.title="Event")}else if(o)c=this.getNodeMenuOptions(o);else{c=this.getCanvasMenuOptions();var b=this.graph.getGroupOnPos(t.canvasX,t.canvasY);b&&c.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:b,options:this.getGroupMenuOptions(b)}})}if(!c)return;new LiteGraph.ContextMenu(c,_,u);function T(L,G){if(!L)return;let I;if(L.content=="Remove Slot"){I=L.slot,o.graph.beforeChange(),I.input?o.removeInput(I.slot):I.output&&o.removeOutput(I.slot),o.graph.afterChange();return}else if(L.content=="Disconnect Links"){I=L.slot,o.graph.beforeChange(),I.output?o.disconnectOutput(I.slot):I.input&&o.disconnectInput(I.slot),o.graph.afterChange();return}else if(L.content=="Rename Slot"){I=L.slot;var O=I.input?o.getInputInfo(I.slot):o.getOutputInfo(I.slot),E=l.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",G),D=E.querySelector("input");D&&O&&(D.value=O.label||"");var N=function(){o.graph.beforeChange(),D.value&&(O&&(O.label=D.value),l.setDirty(!0)),E.close(),o.graph.afterChange()};E.querySelector("button").addEventListener("click",N),D.addEventListener("keydown",function(C){if(E.is_modified=!0,C.keyCode==27)E.close();else if(C.keyCode==13)N();else if(C.keyCode!=13&&C.target.localName!="textarea")return;C.preventDefault(),C.stopPropagation()}),D.focus()}}}lowQualityRenderingRequired(o){return this.ds.scale<o?this.low_quality_rendering_counter>this.low_quality_rendering_threshold:!1}};g(_LGraphCanvas,"DEFAULT_BACKGROUND_IMAGE","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII="),g(_LGraphCanvas,"link_type_colors",{"-1":"#A86",number:"#AAA",node:"#DCA",string:"#77F",boolean:"#F77"}),g(_LGraphCanvas,"gradients",{}),g(_LGraphCanvas,"search_limit",-1),g(_LGraphCanvas,"node_colors",{red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}});let LGraphCanvas=_LGraphCanvas;var temp=new Float32Array(4),temp_vec2=new Float32Array(2),tmp_area=new Float32Array(4),margin_area=new Float32Array(4),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);class DragAndScale{constructor(t,r){g(this,"onMouseDown",s=>{if(!this.enabled)return;const a=this.element.getBoundingClientRect();var l=s.clientX-a.left,h=s.clientY-a.top;s.canvasx=l,s.canvasy=h,s.dragging=this.dragging;var u=!this.viewport||this.viewport&&l>=this.viewport[0]&&l<this.viewport[0]+this.viewport[2]&&h>=this.viewport[1]&&h<this.viewport[1]+this.viewport[3];u&&(this.dragging=!0,this.abortController=new AbortController,document.addEventListener("pointermove",this.onMouseMove,{signal:this.abortController.signal}),document.addEventListener("pointerup",this.onMouseUp,{signal:this.abortController.signal})),this.last_mouse[0]=l,this.last_mouse[1]=h}),g(this,"onMouseMove",s=>{if(!this.enabled)return;const a=this.element.getBoundingClientRect();var l=s.clientX-a.left,h=s.clientY-a.top;s.canvasx=l,s.canvasy=h,s.dragging=this.dragging;var u=l-this.last_mouse[0],c=h-this.last_mouse[1];this.dragging&&this.mouseDrag(u,c),this.last_mouse[0]=l,this.last_mouse[1]=h}),g(this,"onMouseUp",s=>{var a;this.dragging=!1,(a=this.abortController)==null||a.abort()}),g(this,"onWheel",s=>{s.wheel=-s.deltaY,s.delta=s.wheelDelta?s.wheelDelta/40:s.deltaY?-s.deltaY/3:0,this.changeDeltaScale(1+s.delta*.05)}),this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,r||this.bindEvents(t))}bindEvents(t){this.last_mouse=new Float32Array(2),t.addEventListener("pointerdown",this.onMouseDown),t.addEventListener("wheel",this.onWheel)}computeVisibleArea(t){if(!this.element){this.visible_area.set([0,0,0,0]);return}let r=this.element.width,s=this.element.height,a=-this.offset[0],l=-this.offset[1];if(t){a+=t[0]/this.scale,l+=t[1]/this.scale;const[c,_]=t.slice(2);r=c,s=_}const h=a+r/this.scale,u=l+s/this.scale;this.visible_area.set([a,l,h-a,u-l])}toCanvasContext(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]}convertCanvasToOffset(t,r=[0,0]){return r[0]=t[0]/this.scale-this.offset[0],r[1]=t[1]/this.scale-this.offset[1],r}mouseDrag(t,r){var s;this.offset[0]+=t/this.scale,this.offset[1]+=r/this.scale,(s=this.onredraw)==null||s.call(this,this)}changeScale(t,r){var s;if(t=LiteGraph.clamp(t,this.min_scale,this.max_scale),t==this.scale||!this.element)return;const a=this.element.getBoundingClientRect();if(a){r=r||[a.width*.5,a.height*.5];var l=this.convertCanvasToOffset(r);this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1);var h=this.convertCanvasToOffset(r),u=[h[0]-l[0],h[1]-l[1]];this.offset[0]+=u[0],this.offset[1]+=u[1],(s=this.onredraw)==null||s.call(this,this)}}changeDeltaScale(t,r){this.changeScale(this.scale*t,r)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}var ge,Pt,Bt,kt,Ut,$t,zt;const Tt=class Hi{constructor(t,r={}){St(this,ge);var s;this.options=r,(s=r.scroll_speed)!=null||(r.scroll_speed=.1),this.menu_elements=[],ot(this,ge,kt).call(this),ot(this,ge,Ut).call(this),ot(this,ge,Pt).call(this),ot(this,ge,Bt).call(this),this.setTitle(this.options.title),this.addItems(t),ot(this,ge,$t).call(this),ot(this,ge,zt).call(this)}setTitle(t){var r;if(!t)return;(r=this.titleElement)!=null||(this.titleElement=document.createElement("div"));const s=this.titleElement;s.className="litemenu-title",s.innerHTML=t,this.root.parentElement||this.root.appendChild(s)}addItems(t){for(let r=0;r<t.length;r++){let s=t[r];typeof s!="string"&&(s=s&&s.content!==void 0?String(s.content):String(s));let a=t[r];this.menu_elements.push(this.addItem(s,a,this.options))}}addItem(t,r,s={}){var a;const l=document.createElement("div");l.className="litemenu-entry submenu";let h=!1;r===null?l.classList.add("separator"):(l.innerHTML=(a=r==null?void 0:r.title)!=null?a:t,l.value=r,r&&(r.disabled&&(h=!0,l.classList.add("disabled")),(r.submenu||r.has_submenu)&&l.classList.add("has_submenu")),typeof r=="function"?(l.dataset.value=t,l.onclick_callback=r):l.dataset.value=r,r.className&&(l.className+=" "+r.className)),this.root.appendChild(l),h||l.addEventListener("click",c),!h&&s.autoopen&&l.addEventListener("pointerenter",_=>{const d=this.value;!d||!d.has_submenu||c.call(this,_)});var u=this;function c(_){var d,f,m,b,T;const L=this.value;let G=!0;if((d=LiteGraph.debug)==null||d.call(LiteGraph,"ContextMenu handleMenuItemClick",L,s,G,this.current_submenu,this),(f=u.current_submenu)==null||f.close(_),s.callback&&((m=LiteGraph.debug)==null||m.call(LiteGraph,"ContextMenu handleMenuItemClick callback",this,L,s,_,u,s.node),s.callback.call(this,L,s,_,u,s.node)===!0&&(G=!1)),L&&(L.callback&&!s.ignore_item_callbacks&&L.disabled!==!0&&((b=LiteGraph.debug)==null||b.call(LiteGraph,"ContextMenu using value callback and !ignore_item_callbacks",this,L,s,_,u,s.node),L.callback.call(this,L,s,_,u,s.extra)===!0&&(G=!1)),L.submenu)){if((T=LiteGraph.debug)==null||T.call(LiteGraph,"ContextMenu SUBMENU",this,L,L.submenu.options,e,u,s),!L.submenu.options)throw new Error("ContextMenu submenu needs options");new u.constructor(L.submenu.options,{callback:L.submenu.callback,event:_,parentMenu:u,ignore_item_callbacks:L.submenu.ignore_item_callbacks,title:L.submenu.title,extra:L.submenu.extra,autoopen:s.autoopen}),G=!1}G&&!u.lock&&u.close()}return l}close(t,r){var s;if(this.root.f_textfilter){let a=document;a.removeEventListener("keydown",this.root.f_textfilter,!0),a.removeEventListener("keydown",this.root.f_textfilter,!1),t&&t.target&&(a=t.target.ownerDocument),a||(a=document),a.removeEventListener("keydown",this.root.f_textfilter,!0),a.removeEventListener("keydown",this.root.f_textfilter,!1)}this.parentMenu&&!r&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,t===void 0?this.parentMenu.close():t&&!Hi.isCursorOverElement(t,this.parentMenu.root)&&Hi.trigger(this.parentMenu.root,"pointerleave",t)),(s=this.current_submenu)==null||s.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}static trigger(t,r,s,a){const l=new CustomEvent(r,{bubbles:!0,cancelable:!0,detail:s});return Object.defineProperty(l,"target",{value:a}),t.dispatchEvent?t.dispatchEvent(l):t.__events&&t.__events.dispatchEvent(l),l}getTopMenu(){var t,r;return(r=(t=this.options.parentMenu)==null?void 0:t.getTopMenu())!=null?r:this}getFirstEvent(){var t,r;return(r=(t=this.options.parentMenu)==null?void 0:t.getFirstEvent())!=null?r:this.options.event}static isCursorOverElement(t,r){return LiteGraph.isInsideRectangle(t.clientX,t.clientY,r.left,r.top,r.width,r.height)}};ge=new WeakSet,Pt=function(){const o=this.root=document.createElement("div");return this.options.className&&(o.className=this.options.className),o.classList.add("litegraph","litecontextmenu","litemenubar-panel"),o.style.minWidth="80px",o.style.minHeight="10px",o},Bt=function(){const o=this.root;o.style.pointerEvents="none",setTimeout(()=>{o.style.pointerEvents="auto"},100),o.addEventListener("pointerup",t=>(t.preventDefault(),!0)),o.addEventListener("contextmenu",t=>(t.button!=2||t.preventDefault(),!1)),o.addEventListener("pointerdown",t=>{if(t.button==2)return this.close(),t.preventDefault(),!0}),o.addEventListener("wheel",t=>{var r=parseInt(o.style.top);return o.style.top=(r+t.deltaY*this.options.scroll_speed).toFixed()+"px",t.preventDefault(),!0}),o.addEventListener("pointerenter",t=>{o.closing_timer&&clearTimeout(o.closing_timer)})},kt=function(){var o;const t=this.options.parentMenu;if(t){if(t.constructor!==this.constructor){(o=LiteGraph.error)==null||o.call(LiteGraph,"parentMenu must be of class ContextMenu, ignoring it"),this.options.parentMenu=null;return}this.parentMenu=t,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this}},Ut=function(){var o;if(!this.options.event)return;const t=this.options.event.constructor.name;t!=="MouseEvent"&&t!=="CustomEvent"&&t!=="PointerEvent"&&((o=LiteGraph.error)==null||o.call(LiteGraph,`Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. (${t})`),this.options.event=null)},$t=function(){var o,t,r,s;const a=(t=(o=this.options.event)==null?void 0:o.target.ownerDocument)!=null?t:document,l=(r=a.fullscreenElement)!=null?r:a.body,h=this.root,u=this;LiteGraph.context_menu_filter_enabled&&(a?(h.f_textfilter&&(a.removeEventListener("keydown",h.f_textfilter,!1),a.removeEventListener("keydown",h.f_textfilter,!0),h.f_textfilter=!1),h.f_textfilter=function(c){var _,d,f,m,b,T,L;if(u.current_submenu){(_=LiteGraph.debug)==null||_.call(LiteGraph,"Prevent filtering on ParentMenu",u);return}if(u.allOptions||(u.allOptions=u.menu_elements,u.selectedOption=!1),u.currentOptions||(u.currentOptions=u.allOptions),u.filteringText||(u.filteringText=""),c.key){var G=!1;switch(c.key){case"Backspace":u.filteringText.length&&(u.filteringText=u.filteringText.substring(0,u.filteringText.length-1),G=!0);break;case"Escape":h.f_textfilter&&(a.removeEventListener("keydown",h.f_textfilter,!1),a.removeEventListener("keydown",h.f_textfilter,!0),h.f_textfilter=!1),u.close();break;case"ArrowDown":do u.selectedOption=u.selectedOption!==!1?Math.min(Math.max(u.selectedOption+1,0),u.allOptions.length-1):0;while(u.allOptions[u.selectedOption]&&u.allOptions[u.selectedOption].hidden&&u.selectedOption<u.allOptions.length-1);u.allOptions[u.selectedOption]&&u.allOptions[u.selectedOption].hidden&&(u.selectedOption=u.currentOptions[u.currentOptions.length-1].menu_index),G=!0;break;case"ArrowUp":do u.selectedOption=u.selectedOption!==!1?Math.min(Math.max(u.selectedOption-1,0),u.allOptions.length-1):0;while(u.allOptions[u.selectedOption]&&u.allOptions[u.selectedOption].hidden&&u.selectedOption>0);u.allOptions[u.selectedOption]&&u.allOptions[u.selectedOption].hidden&&(u.currentOptions&&u.currentOptions.length?u.selectedOption=u.currentOptions[0].menu_index:u.selectedOption=!1),G=!0;break;case"ArrowLeft":break;case"ArrowRight":case"Enter":if(u.selectedOption!==!1)u.allOptions[u.selectedOption]?((d=LiteGraph.debug)==null||d.call(LiteGraph,"ContextElement simCLICK",u.allOptions[iO]),u.allOptions[u.selectedOption].do_click&&u.allOptions[u.selectedOption].do_click(u.options.event,I)):((f=LiteGraph.debug)==null||f.call(LiteGraph,"ContextElement selection wrong",u.selectedOption),u.selectedOption=u.selectedOption!==!1?Math.min(Math.max(u.selectedOption,0),u.allOptions.length-1):0);else if(u.filteringText.length){for(let A in u.allOptions)if(u.allOptions[A].style.display!=="none"&&!(u.allOptions[A].classList+"").includes("separator")&&u.allOptions[A].textContent!=="Search"){(m=LiteGraph.debug)==null||m.call(LiteGraph,"ContextElement simCLICK",u.allOptions[A]),h.f_textfilter&&a&&(a.removeEventListener("keydown",h.f_textfilter,!1),a.removeEventListener("keydown",h.f_textfilter,!0),(b=LiteGraph.debug)==null||b.call(LiteGraph,"Cleaned ParentContextMenu listener",a,u));var I=!1;u.allOptions[A].do_click(c,I);break}}G=!0;break;default:(T=LiteGraph.debug)==null||T.call(LiteGraph,"ContextMenu filter: keyEvent",c.keyCode,c.key),String.fromCharCode(c.key).match(/(\w|\s)/g);break}!G&&c.key.length==1&&(u.filteringText+=c.key,u.parentMenu)}if(u.filteringText&&u.filteringText!==""){var O=[];u.currentOptions=[];for(let A in u.allOptions){var E=u.allOptions[A].textContent,D=E.toLocaleLowerCase().includes(u.filteringText.toLocaleLowerCase()),N=E.toLocaleLowerCase().startsWith(u.filteringText.toLocaleLowerCase()),C=E.split("/"),R=!1;R=C.length>1&&C[C.length-1].toLocaleLowerCase().startsWith(u.filteringText.toLocaleLowerCase())||C.length==1&&N;var S=(u.allOptions[A].classList+"").includes("separator")||E==="Search";u.allOptions[A].menu_index=A,D&&!S?(O.push(u.allOptions[A]),u.allOptions[A].style.display="block",u.allOptions[A].hidden=!1,u.currentOptions.push(u.allOptions[A]),u.allOptions[A].filtered_index=u.currentOptions.length-1):(u.allOptions[A].hidden=!0,u.allOptions[A].style.display="none",u.allOptions[A].filtered_index=!1),R?u.allOptions[A].style.fontWeight="bold":N&&(u.allOptions[A].style.fontStyle="italic")}u.selectedOption=u.selectedOption!==!1?Math.min(Math.max(u.selectedOption,0),u.allOptions.length-1):0,u.allOptions[u.selectedOption]&&u.allOptions[u.selectedOption].hidden&&u.currentOptions.length&&(u.selectedOption=u.currentOptions[0].menu_index)}else{O=u.allOptions,u.currentOptions=u.allOptions;for(let A in u.allOptions)u.allOptions[A].style.display="block",u.allOptions[A].style.fontStyle="inherit",u.allOptions[A].style.fontWeight="inherit",u.allOptions[A].hidden=!1,u.allOptions[A].filtered_index=!1,u.allOptions[A].menu_index=A}var P=u.selectedOption!==!1;if(P){(L=LiteGraph.debug)==null||L.call(LiteGraph,"ContextMenu selection: ",u.selectedOption);for(let A in u.allOptions){var M=u.selectedOption+""==A+"";M?u.allOptions[A].classList.add("selected"):u.allOptions[A].classList.remove("selected")}}document.body.getBoundingClientRect(),h.getBoundingClientRect(),h.style.top=u.top_original+"px"},a.addEventListener("keydown",h.f_textfilter,!0)):(s=LiteGraph.warn)==null||s.call(LiteGraph,"NO root document to add context menu and event",a,options)),l.appendChild(this.root)},zt=function(){var o;const t=this.options,r=this.root;let s=t.left||0,a=t.top||0;if(this.top_original=a,t.event){if(s=t.event.clientX-10,a=t.event.clientY-10,t.title&&(a-=20),this.top_original=a,t.parentMenu){const u=t.parentMenu.root.getBoundingClientRect();s=u.left+u.width}const l=document.body.getBoundingClientRect(),h=r.getBoundingClientRect();l.height===0&&((o=LiteGraph.error)==null||o.call(LiteGraph,"document.body height is 0. That is dangerous, set html,body { height: 100%; }")),l.width&&s>l.width-h.width-10&&(s=l.width-h.width-10),l.height&&a>l.height-h.height-10&&(a=l.height-h.height-10)}r.style.left=`${s}px`,r.style.top=`${a}px`,t.scale&&(r.style.transform=`scale(${t.scale})`)},g(Tt,"closeAll",(o=window)=>{const t=o.document.querySelectorAll(".litecontextmenu");t.length&&t.forEach(r=>{var s;r.close?r.close():(s=r.parentNode)==null||s.removeChild(r)})});let ContextMenu=Tt;var LiteGraph=new class{constructor(){g(this,"extendClass",(o,t)=>{for(let r in t)o.hasOwnProperty(r)||(o[r]=t[r]);if(t.prototype)for(let r in t.prototype)t.prototype.hasOwnProperty(r)&&(o.prototype.hasOwnProperty(r)||(t.prototype.__lookupGetter__(r)?o.prototype.__defineGetter__(r,t.prototype.__lookupGetter__(r)):o.prototype[r]=t.prototype[r],t.prototype.__lookupSetter__(r)&&o.prototype.__defineSetter__(r,t.prototype.__lookupSetter__(r))))}),g(this,"getParameterNames",o=>(o+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)),g(this,"clamp",(o,t,r)=>t>o?t:r<o?r:o),g(this,"pointer_to_mouse_events",Object.freeze({pointerdown:"mousedown",pointermove:"mousemove",pointerup:"mouseup",pointercancel:"mouseup",pointerover:"mouseover",pointerout:"mouseout",pointerenter:"mouseenter",pointerleave:"mouseleave"})),g(this,"mouse_to_pointer_events",Object.freeze({mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseenter:"pointerenter",mouseleave:"pointerleave"})),g(this,"pointerAddListener",(o,t,r,s)=>{if(!(o!=null&&o.addEventListener)||typeof r!="function")return!1;const a=this.resolvePointerEventName(t);return o.addEventListener(a,r,s),!0}),g(this,"pointerRemoveListener",(o,t,r,s)=>{if(!(o!=null&&o.removeEventListener)||typeof r!="function")return!1;const a=this.resolvePointerEventName(t);return o.removeEventListener(a,r,s),!0}),g(this,"closeAllContextMenus",()=>{LiteGraph.warn("LiteGraph.closeAllContextMenus is deprecated in favor of ContextMenu.closeAll()"),ContextMenu.closeAll()}),this.VERSION="0.10.2",this.LLink=LLink,this.LGraph=LGraph,this.LGraphNode=LGraphNode,this.LGraphGroup=LGraphGroup,this.LGraphCanvas=LGraphCanvas,this.DragAndScale=DragAndScale,this.ContextMenu=ContextMenu,this.CANVAS_GRID_SIZE=10,this.NODE_TITLE_HEIGHT=30,this.NODE_TITLE_TEXT_Y=20,this.NODE_SLOT_HEIGHT=20,this.NODE_WIDGET_HEIGHT=20,this.NODE_WIDTH=140,this.NODE_MIN_WIDTH=50,this.NODE_COLLAPSED_RADIUS=10,this.NODE_COLLAPSED_WIDTH=80,this.NODE_TITLE_COLOR="#999",this.NODE_SELECTED_TITLE_COLOR="#FFF",this.NODE_TEXT_SIZE=14,this.NODE_TEXT_COLOR="#AAA",this.NODE_SUBTEXT_SIZE=12,this.NODE_DEFAULT_COLOR="#333",this.NODE_DEFAULT_BGCOLOR="#353535",this.NODE_DEFAULT_BOXCOLOR="#666",this.NODE_DEFAULT_SHAPE="box",this.NODE_BOX_OUTLINE_COLOR="#FFF",this.DEFAULT_SHADOW_COLOR="rgba(0,0,0,0.5)",this.DEFAULT_GROUP_FONT=24,this.WIDGET_BGCOLOR="#222",this.WIDGET_OUTLINE_COLOR="#666",this.WIDGET_TEXT_COLOR="#DDD",this.WIDGET_SECONDARY_TEXT_COLOR="#999",this.LINK_COLOR="#9A9",this.EVENT_LINK_COLOR="#A86",this.CONNECTING_LINK_COLOR="#AFA",this.MAX_NUMBER_OF_NODES=1e3,this.DEFAULT_POSITION=[100,100],this.VALID_SHAPES=["default","box","round","card"],this.BOX_SHAPE=1,this.ROUND_SHAPE=2,this.CIRCLE_SHAPE=3,this.CARD_SHAPE=4,this.ARROW_SHAPE=5,this.GRID_SHAPE=6,this.INPUT=1,this.OUTPUT=2,this.EVENT=-1,this.ACTION=-1,this.NODE_MODES=["Always","On Event","Never","On Trigger","On Request"],this.NODE_MODES_COLORS=["#666","#422","#333","#224","#626"],this.ALWAYS=0,this.ON_EVENT=1,this.NEVER=2,this.ON_TRIGGER=3,this.ON_REQUEST=4,this.UP=1,this.DOWN=2,this.LEFT=3,this.RIGHT=4,this.CENTER=5,this.LINK_RENDER_MODES=["Straight","Linear","Spline"],this.STRAIGHT_LINK=0,this.LINEAR_LINK=1,this.SPLINE_LINK=2,this.NORMAL_TITLE=0,this.NO_TITLE=1,this.TRANSPARENT_TITLE=2,this.AUTOHIDE_TITLE=3,this.VERTICAL_LAYOUT="vertical",this.proxy=null,this.node_images_path="",this.catch_exceptions=!0,this.throw_errors=!0,this.allow_scripts=!1,this.use_deferred_actions=!0,this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.Globals={},this.searchbox_extras={},this.auto_sort_node_types=!1,this.node_box_coloured_when_on=!1,this.node_box_coloured_by_mode=!1,this.dialog_close_on_mouse_leave=!0,this.dialog_close_on_mouse_leave_delay=500,this.shift_click_do_break_link_from=!1,this.click_do_break_link_to=!1,this.search_hide_on_mouse_leave=!0,this.search_filter_enabled=!1,this.search_show_all_on_open=!0,this.show_node_tooltip=!1,this.show_node_tooltip_use_descr_property=!1,this.auto_load_slot_types=!1,this.registered_slot_in_types={},this.registered_slot_out_types={},this.slot_types_in=[],this.slot_types_out=[],this.slot_types_default_in=[],this.slot_types_default_out=[],this.graphDefaultConfig={align_to_grid:!0,links_ontop:!1},this.alt_drag_do_clone_nodes=!1,this.alt_shift_drag_connect_clone_with_input=!0,this.do_add_triggers_slots=!1,this.allow_multi_output_for_events=!0,this.middle_click_slot_add_default_node=!1,this.release_link_on_empty_shows_menu=!1,this.two_fingers_opens_menu=!1,this.backspace_delete=!0,this.ctrl_shift_v_paste_connect_unselected_outputs=!1,this.actionHistory_enabled=!1,this.actionHistoryMaxSave=40,this.refreshAncestorsOnTriggers=!1,this.refreshAncestorsOnActions=!1,this.ensureUniqueExecutionAndActionCall=!1,this.use_uuids=!1,this.context_menu_filter_enabled=!1,this.showCanvasOptions=!1,this.availableCanvasOptions=["allow_addOutSlot_onExecuted","free_resize","highquality_render","use_gradients","pause_rendering","clear_background","read_only","live_mode","show_info","allow_dragcanvas","allow_dragnodes","allow_interaction","allow_searchbox","move_destination_link_without_shift","set_canvas_dirty_on_mouse_event","always_render_background","render_shadows","render_canvas_border","render_connections_shadows","render_connections_border","render_connection_arrows","render_collapsed_slots","render_execution_order","render_title_colored","render_link_tooltip"],this.actionHistoryMaxSave=40,this.canRemoveSlots=!0,this.canRemoveSlots_onlyOptional=!0,this.canRenameSlots=!0,this.canRenameSlots_onlyOptional=!0,this.ensureNodeSingleExecution=!1,this.ensureNodeSingleAction=!1,this.preventAncestorRecalculation=!1,this.ensureUniqueExecutionAndActionCall=!0,this.allowMultiOutputForEvents=!1,this.log_methods=["error","warn","info","log","debug"],this.logging_set_level(2)}logging_set_level(o){this.debug_level=Number(o)}logging(o){if(o>this.debug_level)return;function t(s){let a=[];for(let l=1;l<s.length;l++)typeof s[l]!="undefined"&&a.push(s[l]);return a}let r="debug";if(o>=0&&o<=4&&(r=["error","warn","info","log","debug"][o]),typeof console[r]!="function")throw console.warn("[LG-log] invalid console method",r,t(arguments)),new RangeError;console[r]("[LG]",...t(arguments))}error(){this.logging(0,...arguments)}warn(){this.logging(1,...arguments)}info(){this.logging(2,...arguments)}log(){this.logging(3,...arguments)}debug(){this.logging(4,...arguments)}registerNodeType(o,t){var r,s,a,l,h,u,c;if(!t.prototype)throw new Error("Cannot register a simple object, it must be a class with a prototype");t.type=o,(r=this.debug)==null||r.call(this,"registerNodeType","start",o);const _=t.name,d=o.lastIndexOf("/");t.category=o.substring(0,d),t.title||(t.title=_);const f=Object.getOwnPropertyDescriptors(LGraphNode.prototype);Object.keys(f).forEach(L=>{t.prototype.hasOwnProperty(L)||Object.defineProperty(t.prototype,L,f[L])});const m=this.registered_node_types[o];if(m&&((s=this.debug)==null||s.call(this,"registerNodeType","replacing node type",o,m)),!Object.prototype.hasOwnProperty.call(t.prototype,"shape")&&(Object.defineProperty(t.prototype,"shape",{set:function(L){switch(L){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=L}},get:function(){return this._shape},enumerable:!0,configurable:!0}),t.supported_extensions))for(let L in t.supported_extensions){const G=t.supported_extensions[L];G&&G.constructor===String&&(this.node_types_by_file_extension[G.toLowerCase()]=t)}if(this.registered_node_types[o]=t,t.constructor.name&&(this.Nodes[_]=t),(a=LiteGraph.onNodeTypeRegistered)==null||a.call(LiteGraph,o,t),m&&((l=LiteGraph.onNodeTypeReplaced)==null||l.call(LiteGraph,o,t,m)),t.prototype.onPropertyChange&&LiteGraph.warn("LiteGraph node class "+o+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),t.supported_extensions)for(var b=0;b<t.supported_extensions.length;b++){var T=t.supported_extensions[b];T&&T.constructor===String&&(this.node_types_by_file_extension[T.toLowerCase()]=t)}(h=this.debug)==null||h.call(this,"registerNodeType","type registered",o),this.auto_load_slot_types&&((u=this.debug)==null||u.call(this,"registerNodeType","do auto_load_slot_types",o)),new t((c=t.title)!=null?c:"tmpnode")}unregisterNodeType(o){const t=o.constructor===String?this.registered_node_types[o]:o;if(!t)throw new Error("node type not found: "+o);delete this.registered_node_types[t.type],t.constructor.name&&delete this.Nodes[t.constructor.name]}registerNodeAndSlotType(o,t,r=!1){const s=(o.constructor===String&&this.registered_node_types[o]!=="anonymous"?this.registered_node_types[o]:o).constructor.type;let a=[];typeof t=="string"?a=t.split(","):t==this.EVENT||t==this.ACTION?a=["_event_"]:a=["*"];for(let l=0;l<a.length;++l){let h=a[l];h===""&&(h="*");const u=r?"registered_slot_out_types":"registered_slot_in_types";this[u][h]===void 0&&(this[u][h]={nodes:[]}),this[u][h].nodes.includes(s)||this[u][h].nodes.push(s),r?this.slot_types_out.includes(h.toLowerCase())||(this.slot_types_out.push(h.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(h.toLowerCase())||(this.slot_types_in.push(h.toLowerCase()),this.slot_types_in.sort())}}buildNodeClassFromObject(o,t){var r="";if(t.inputs)for(let a=0;a<t.inputs.length;++a){let l=t.inputs[a][0],h=t.inputs[a][1];h&&h.constructor===String&&(h='"'+h+'"'),r+="this.addInput('"+l+"',"+h+`);
`}if(t.outputs)for(let a=0;a<t.outputs.length;++a){let l=t.outputs[a][0],h=t.outputs[a][1];h&&h.constructor===String&&(h='"'+h+'"'),r+="this.addOutput('"+l+"',"+h+`);
`}if(t.properties)for(let a in t.properties){let l=t.properties[a];l&&l.constructor===String&&(l='"'+l+'"'),r+="this.addProperty('"+a+"',"+l+`);
`}r+="if(this.onCreate)this.onCreate()";var s=Function(r);for(let a in t)a!="inputs"&&a!="outputs"&&a!="properties"&&(s.prototype[a]=t[a]);return s.title=t.title||o.split("/").pop(),s.desc=t.desc||"Generated from object",this.registerNodeType(o,s),s}wrapFunctionAsNode(o,t,r,s,a){const l=LiteGraph.getParameterNames(t),h=l.map((d,f)=>{const m=r!=null&&r[f]?`'${r[f]}'`:"0";return`this.addInput('${d}', ${m});`}).join(`
`),u=s?`'${s}'`:0,c=a?`this.properties = ${JSON.stringify(a)};`:"",_=new Function(`
            ${h}
            this.addOutput('out', ${u});
            ${c}
        `);return _.title=o.split("/").pop(),_.desc=`Generated from ${t.name}`,_.prototype.onExecute=function(){const d=l.map((m,b)=>this.getInputData(b)),f=t.apply(this,d);this.setOutputData(0,f)},this.registerNodeType(o,_),_}clearRegisteredTypes(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}addNodeMethod(o,t){LGraphNode.prototype[o]=t;for(var r in this.registered_node_types){var s=this.registered_node_types[r];s.prototype[o]&&(s.prototype["_"+o]=s.prototype[o]),s.prototype[o]=t}}createNode(o,t,r={}){var s,a,l,h,u,c,_,d,f,m,b,T;const L=(s=this.registered_node_types[o])!=null?s:null;if(!L)return(a=this.log)==null||a.call(this,`GraphNode type "${o}" not registered.`),null;t=(l=t!=null?t:L.title)!=null?l:o;let G=null;if(LiteGraph.catch_exceptions)try{G=new L(t)}catch(I){return(h=this.error)==null||h.call(this,I),null}else G=new L(t);return G.type=o,(u=G.title)!=null||(G.title=t),(c=G.properties)!=null||(G.properties={}),(_=G.properties_info)!=null||(G.properties_info=[]),(d=G.flags)!=null||(G.flags={}),(f=G.size)!=null||(G.size=G.computeSize()),(m=G.pos)!=null||(G.pos=LiteGraph.DEFAULT_POSITION.concat()),(b=G.mode)!=null||(G.mode=LiteGraph.ALWAYS),Object.assign(G,r),(T=G.onNodeCreated)==null||T.call(G),G}getNodeType(o){return this.registered_node_types[o]}getNodeTypesInCategory(o,t){const r=Object.values(this.registered_node_types).filter(s=>s.filter!==t?!1:o===""?s.category===null:s.category===o);return this.auto_sort_node_types&&r.sort((s,a)=>s.title.localeCompare(a.title)),r}getNodeTypesCategories(o){const t={"":1};Object.values(this.registered_node_types).forEach(s=>{s.category&&!s.skip_list&&s.filter===o&&(t[s.category]=1)});const r=Object.keys(t);return this.auto_sort_node_types?r.sort():r}reloadNodes(o){var t,r,s,a=document.getElementsByTagName("script"),l=[];for(let _=0;_<a.length;_++)l.push(a[_]);var h=document.getElementsByTagName("head")[0];o=document.location.href+o;for(let _=0;_<l.length;_++){var u=l[_].src;if(!(!u||u.substr(0,o.length)!=o))try{(t=this.log)==null||t.call(this,"Reloading: "+u);var c=document.createElement("script");c.type="text/javascript",c.src=u,h.appendChild(c),h.removeChild(l[_])}catch(d){if(LiteGraph.throw_errors)throw d;(r=this.log)==null||r.call(this,"Error while reloading "+u)}}(s=this.log)==null||s.call(this,"Nodes reloaded")}cloneObject(o,t){if(o==null)return null;const r=JSON.parse(JSON.stringify(o));if(!t)return r;for(const s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s]);return t}uuidv4(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,o=>(o^Math.random()*16>>o/4).toString(16))}isValidConnection(o,t){if((o===""||o==="*")&&(o=0),(t===""||t==="*")&&(t=0),!o||!t||o===t||o===LiteGraph.EVENT&&t===LiteGraph.ACTION)return!0;if(o=String(o).toLowerCase(),t=String(t).toLowerCase(),!o.includes(",")&&!t.includes(","))return o===t;const r=o.split(","),s=t.split(",");for(const a of r)for(const l of s)if(this.isValidConnection(a,l))return!0;return!1}registerSearchboxExtra(o,t,r){this.searchbox_extras[t.toLowerCase()]={type:o,desc:t,data:r}}fetchFile(o,t,r,s){if(!o)return null;if(t=t||"text",o.constructor===String)return o.substr(0,4)=="http"&&LiteGraph.proxy&&(o=LiteGraph.proxy+o.substr(o.indexOf(":")+3)),fetch(o).then(l=>{if(!l.ok)throw new Error("File not found");if(t=="arraybuffer")return l.arrayBuffer();if(t=="text"||t=="string")return l.text();if(t=="json")return l.json();if(t=="blob")return l.blob()}).then(l=>{r&&r(l)}).catch(l=>{var h;(h=this.error)==null||h.call(this,"error fetching file:",o),s&&s(l)});if(o.constructor===File||o.constructor===Blob){var a=new FileReader;if(a.onload=l=>{var h=l.target.result;t=="json"&&(h=JSON.parse(h)),r&&r(h)},t=="arraybuffer")return a.readAsArrayBuffer(o);if(t=="text"||t=="json")return a.readAsText(o);if(t=="blob")return a.readAsBinaryString(o)}return null}compareObjects(o,t){const r=Object.keys(o);return r.length!==Object.keys(t).length?!1:r.every(s=>o[s]===t[s])}distance(o,t){const[r,s]=o,[a,l]=t;return Math.sqrt((a-r)**2+(l-s)**2)}colorToString(o){return"rgba("+Math.round(o[0]*255).toFixed()+","+Math.round(o[1]*255).toFixed()+","+Math.round(o[2]*255).toFixed()+","+(o.length==4?o[3].toFixed(2):"1.0")+")"}canvasFillTextMultiline(o,t,r,s,a,l){var h=(t+"").trim().split(" "),u="",c={lines:[],maxW:0,height:0};if(h.length>1)for(var _=0;_<h.length;_++){var d=u+h[_]+" ",f=o.measureText(d),m=f.width;m>a&&_>0?(o.fillText(u,r,s+l*c.lines.length),u=h[_]+" ",c.max=m,c.lines.push(u)):u=d}else u=h[0];return o.fillText(u,r,s+l*c.lines.length),c.lines.push(u),c.height=l*c.lines.length||l,c}isInsideRectangle(o,t,r,s,a,l){return o>r&&o<r+a&&t>s&&t<s+l}growBounding(o,t,r){t<o[0]?o[0]=t:t>o[2]&&(o[2]=t),r<o[1]?o[1]=r:r>o[3]&&(o[3]=r)}isInsideBounding(o,t){return o[0]>=t[0][0]&&o[1]>=t[0][1]&&o[0]<=t[1][0]&&o[1]<=t[1][1]}overlapBounding(o,t){const r=o[0]+o[2],s=o[1]+o[3],a=t[0]+t[2],l=t[1]+t[3];return!(o[0]>a||o[1]>l||r<t[0]||s<t[1])}hex2num(o){o.charAt(0)=="#"&&(o=o.slice(1)),o=o.toUpperCase();for(var t="0123456789ABCDEF",r=new Array(3),s=0,a,l,h=0;h<6;h+=2)a=t.indexOf(o.charAt(h)),l=t.indexOf(o.charAt(h+1)),r[s]=a*16+l,s++;return r}num2hex(o){for(var t="0123456789ABCDEF",r="#",s,a,l=0;l<3;l++)s=o[l]/16,a=o[l]%16,r+=t.charAt(s)+t.charAt(a);return r}resolvePointerEventName(o){if(typeof o!="string")return o;const t=o.toLowerCase(),r=this.pointerevents_method;return r==="mouse"?this.pointer_to_mouse_events[t]||t:r==="pointer"&&this.mouse_to_pointer_events[t]||t}set pointerevents_method(o){const t=typeof o=="string"?o.toLowerCase():"";if(t==="mouse"||t==="pointer"){this._pointerevents_method=t;return}this._pointerevents_method="pointer"}get pointerevents_method(){return this._pointerevents_method||"pointer"}};typeof performance!="undefined"?LiteGraph.getTime=performance.now.bind(performance):typeof Date!="undefined"&&Date.now?LiteGraph.getTime=Date.now.bind(Date):typeof process!="undefined"?LiteGraph.getTime=()=>{var o=process.hrtime();return o[0]*.001+o[1]*1e-6}:LiteGraph.getTime=function(){return new Date().getTime()},typeof window!="undefined"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||(o=>{window.setTimeout(o,1e3/60)}));class Time{constructor(){this.addOutput("in ms","number"),this.addOutput("in sec","number")}onExecute(){this.setOutputData(0,this.graph.globaltime*1e3),this.setOutputData(1,this.graph.globaltime)}}g(Time,"title","Time"),g(Time,"desc","Time"),LiteGraph.registerNodeType("basic/time",Time);class Subgraph{constructor(){this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new LiteGraph.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}onGetInputs(){return[["enabled","boolean"]]}onDblClick(t,r,s){var a=this;setTimeout(function(){s.openSubgraph(a.subgraph)},10)}onAction(t,r){this.subgraph.onAction(t,r)}onExecute(){if(this.enabled=this.getInputOrProperty("enabled"),!!this.enabled){if(this.inputs)for(let t=0;t<this.inputs.length;t++){let r=this.inputs[t],s=this.getInputData(t);this.subgraph.setInputData(r.name,s)}if(this.subgraph.runStep(),this.outputs)for(let t=0;t<this.outputs.length;t++){let r=this.outputs[t],s=this.subgraph.getOutputData(r.name);this.setOutputData(t,s)}}}sendEventToAllNodes(t,r,s){this.enabled&&this.subgraph.sendEventToAllNodes(t,r,s)}onDrawBackground(t,r,s,a){if(this.flags.collapsed)return;var l=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,h=LiteGraph.isInsideRectangle(a[0],a[1],this.pos[0],this.pos[1]+l,this.size[0],LiteGraph.NODE_TITLE_HEIGHT);let u=LiteGraph.isInsideRectangle(a[0],a[1],this.pos[0],this.pos[1]+l,this.size[0]/2,LiteGraph.NODE_TITLE_HEIGHT);t.fillStyle=h?"#555":"#222",t.beginPath(),this._shape==LiteGraph.BOX_SHAPE?u?t.rect(0,l,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT):t.rect(this.size[0]/2,l,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT):u?t.roundRect(0,l,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT,[0,0,8,8]):t.roundRect(this.size[0]/2,l,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT,[0,0,8,8]),h?t.fill():t.fillRect(0,l,this.size[0]+1,LiteGraph.NODE_TITLE_HEIGHT),t.textAlign="center",t.font="24px Arial",t.fillStyle=h?"#DDD":"#999",t.fillText("+",this.size[0]*.25,l+24),t.fillText("+",this.size[0]*.75,l+24)}onMouseDown(t,r,s){var a,l,h,u=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5;(a=console.log)==null||a.call(console,0),r[1]>u&&(r[0]<this.size[0]/2?((l=console.log)==null||l.call(console,1),s.showSubgraphPropertiesDialog(this)):((h=console.log)==null||h.call(console,2),s.showSubgraphPropertiesDialogRight(this)))}computeSize(){var t=this.inputs?this.inputs.length:0,r=this.outputs?this.outputs.length:0;return[200,Math.max(t,r)*LiteGraph.NODE_SLOT_HEIGHT+LiteGraph.NODE_TITLE_HEIGHT]}onSubgraphTrigger(t){var r=this.findOutputSlot(t);r!=-1&&this.triggerSlot(r)}onSubgraphNewInput(t,r){var s=this.findInputSlot(t);s==-1&&this.addInput(t,r)}onSubgraphRenamedInput(t,r){var s=this.findInputSlot(t);if(s!=-1){var a=this.getInputInfo(s);a.name=r}}onSubgraphTypeChangeInput(t,r){var s=this.findInputSlot(t);if(s!=-1){var a=this.getInputInfo(s);a.type=r}}onSubgraphRemovedInput(t){var r=this.findInputSlot(t);r!=-1&&this.removeInput(r)}onSubgraphNewOutput(t,r){var s=this.findOutputSlot(t);s==-1&&this.addOutput(t,r)}onSubgraphRenamedOutput(t,r){var s=this.findOutputSlot(t);if(s!=-1){var a=this.getOutputInfo(s);a.name=r}}onSubgraphTypeChangeOutput(t,r){var s=this.findOutputSlot(t);if(s!=-1){var a=this.getOutputInfo(s);a.type=r}}onSubgraphRemovedOutput(t){var r=this.findOutputSlot(t);r!=-1&&this.removeOutput(r)}getExtraMenuOptions(t){var r=this;return[{content:"Open",callback:function(){t.openSubgraph(r.subgraph)}}]}onResize(t){t[1]+=20}serialize(){var t=LiteGraph.LGraphNode.prototype.serialize.call(this);return t.subgraph=this.subgraph.serialize(),t}reassignSubgraphUUIDs(t){const r={nodeIDs:{},linkIDs:{}};for(const s of t.nodes){const a=s.id,l=LiteGraph.uuidv4();if(s.id=l,r.nodeIDs[a]||r.nodeIDs[l])throw new Error(`New/old node UUID wasn't unique in changed map! ${a} ${l}`);r.nodeIDs[a]=l,r.nodeIDs[l]=a}for(const s of t.links){const a=s[0],l=LiteGraph.uuidv4();if(s[0]=l,r.linkIDs[a]||r.linkIDs[l])throw new Error(`New/old link UUID wasn't unique in changed map! ${a} ${l}`);r.linkIDs[a]=l,r.linkIDs[l]=a;const h=s[1],u=s[3];if(!r.nodeIDs[h])throw new Error(`Old node UUID not found in mapping! ${h}`);if(s[1]=r.nodeIDs[h],!r.nodeIDs[u])throw new Error(`Old node UUID not found in mapping! ${u}`);s[3]=r.nodeIDs[u]}for(const s of t.nodes){if(s.inputs)for(const a of s.inputs)a.link&&(a.link=r.linkIDs[a.link]);if(s.outputs)for(const a of s.outputs)a.links&&(a.links=a.links.map(l=>r.linkIDs[l]))}for(const s of t.nodes)if(s.type==="graph/subgraph"){const a=reassignGraphUUIDs(s.subgraph);r.nodeIDs.assign(a.nodeIDs),r.linkIDs.assign(a.linkIDs)}}clone(){var t=LiteGraph.createNode(this.type),r=this.serialize();if(LiteGraph.use_uuids){const s=LiteGraph.cloneObject(r.subgraph);this.reassignSubgraphUUIDs(s),r.subgraph=s}return delete r.id,delete r.inputs,delete r.outputs,t.configure(r),t}buildFromNodes(t){var r={};for(let s=0;s<t.length;++s)r[node.id]=t[s];for(let s=0;s<t.length;++s){let a=t[s];if(a.inputs)for(let l=0;l<a.inputs.length;++l){let h=a.inputs[l];if(!h||!h.link)continue;let u=a.graph.links[h.link];u&&(r[u.origin_id]||this.subgraph.addInput(h.name,u.type))}if(a.outputs)for(let l=0;l<a.outputs.length;++l){let h=a.outputs[l];if(!(!h||!h.links||!h.links.length))for(let u=0;u<h.links.length;++u){let c=a.graph.links[h.links[u]];if(c&&!r[c.target_id])break}}}}}g(Subgraph,"title","Subgraph"),g(Subgraph,"desc","Graph inside a node"),g(Subgraph,"title_color","#334"),LiteGraph.Subgraph=Subgraph,LiteGraph.registerNodeType("graph/subgraph",Subgraph);class GraphInput{constructor(){this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var t=this;this.name_widget=this.addWidget("text","Name",this.properties.name,function(r){r&&t.setProperty("name",r)}),this.type_widget=this.addWidget("text","Type",this.properties.type,function(r){t.setProperty("type",r)}),this.value_widget=this.addWidget("number","Value",this.properties.value,function(r){t.setProperty("value",r)}),this.widgets_up=!0,this.size=[180,90]}onConfigure(){this.updateType()}updateType(){var t=this.properties.type;this.type_widget.value=t,this.outputs[0].type!=t&&(LiteGraph.isValidConnection(this.outputs[0].type,t)||this.disconnectOutput(0),this.outputs[0].type=t),t=="number"?(this.value_widget.type="number",this.value_widget.value=0):t=="boolean"?(this.value_widget.type="toggle",this.value_widget.value=!0):t=="string"?(this.value_widget.type="text",this.value_widget.value=""):(this.value_widget.type=null,this.value_widget.value=null),this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,t)}onPropertyChanged(t,r){if(t=="name"){if(r==""||r==this.name_in_graph||r=="enabled")return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,r):this.graph.addInput(r,this.properties.type)),this.name_widget.value=r,this.name_in_graph=r}else t=="type"&&this.updateType()}getTitle(){return this.flags.collapsed?this.properties.name:this.title}onAction(t,r){this.properties.type==LiteGraph.EVENT&&this.triggerSlot(0,r)}onExecute(){var t=this.properties.name,r=this.graph.inputs[t];if(!r){this.setOutputData(0,this.properties.value);return}this.setOutputData(0,r.value!==void 0?r.value:this.properties.value)}onRemoved(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)}}g(GraphInput,"title","Input"),g(GraphInput,"desc","Input of the graph"),LiteGraph.GraphInput=GraphInput,LiteGraph.registerNodeType("graph/input",GraphInput);class GraphOutput{constructor(){this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""},this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}onPropertyChanged(t,r){if(t=="name"){if(r==""||r==this.name_in_graph||r=="enabled")return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,r):this.graph.addOutput(r,this.properties.type)),this.name_widget.value=r,this.name_in_graph=r}else t=="type"&&this.updateType()}updateType(){var t=this.properties.type;this.type_widget&&(this.type_widget.value=t),this.inputs[0].type!=t&&((t=="action"||t=="event")&&(t=LiteGraph.EVENT),LiteGraph.isValidConnection(this.inputs[0].type,t)||this.disconnectInput(0),this.inputs[0].type=t),this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,t)}onExecute(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)}onAction(t,r){this.properties.type==LiteGraph.ACTION&&this.graph.trigger(this.properties.name,r)}onRemoved(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)}getTitle(){return this.flags.collapsed?this.properties.name:this.title}}g(GraphOutput,"title","Output"),g(GraphOutput,"desc","Output of the graph"),LiteGraph.GraphOutput=GraphOutput,LiteGraph.registerNodeType("graph/output",GraphOutput);class ConstantNumber{constructor(){this.addOutput("value","number"),this.addProperty("value",1),this.widget=this.addWidget("number","value",1,"value"),this.widgets_up=!0,this.size=[180,30]}onExecute(){this.setOutputData(0,parseFloat(this.properties.value))}getTitle(){return this.flags.collapsed?this.properties.value:this.title}setValue(t){this.setProperty("value",t)}onDrawBackground(){this.outputs[0].label=this.properties.value.toFixed(3)}}g(ConstantNumber,"title","Const Number"),g(ConstantNumber,"desc","Constant number"),LiteGraph.registerNodeType("basic/const",ConstantNumber);class ConstantBoolean{constructor(){this.addOutput("bool","boolean"),this.addProperty("value",!0),this.widget=this.addWidget("toggle","value",!0,"value"),this.serialize_widgets=!0,this.widgets_up=!0,this.size=[140,30]}onExecute(){this.setOutputData(0,this.properties.value)}onGetInputs(){return[["toggle",LiteGraph.ACTION]]}onAction(){this.setValue(!this.properties.value)}}g(ConstantBoolean,"title","Const Boolean"),g(ConstantBoolean,"desc","Constant boolean"),ConstantBoolean.prototype.getTitle=ConstantNumber.prototype.getTitle,ConstantBoolean.prototype.setValue=ConstantNumber.prototype.setValue,LiteGraph.registerNodeType("basic/boolean",ConstantBoolean);class ConstantString{constructor(){this.addOutput("string","string"),this.addProperty("value",""),this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0,this.size=[180,30]}onExecute(){this.setOutputData(0,this.properties.value)}onDropFile(t){var r=this,s=new FileReader;s.onload=function(a){r.setProperty("value",a.target.result)},s.readAsText(t)}}g(ConstantString,"title","Const String"),g(ConstantString,"desc","Constant string"),ConstantString.prototype.getTitle=ConstantNumber.prototype.getTitle,ConstantString.prototype.setValue=ConstantNumber.prototype.setValue,LiteGraph.registerNodeType("basic/string",ConstantString);class ConstantObject{constructor(){this.addOutput("obj","object"),this.size=[120,30],this._object={}}onExecute(){this.setOutputData(0,this._object)}}g(ConstantObject,"title","Const Object"),g(ConstantObject,"desc","Constant Object"),LiteGraph.registerNodeType("basic/object",ConstantObject);class ConstantFile{constructor(){this.addInput("url","string"),this.addOutput("file","string"),this.addProperty("url",""),this.addProperty("type","text"),this.widget=this.addWidget("text","url","","url"),this._data=null}onPropertyChanged(t,r){t=="url"&&(r==null||r==""?this._data=null:this.fetchFile(r))}onExecute(){var t=this.getInputData(0)||this.properties.url;t&&(t!=this._url||this._type!=this.properties.type)&&this.fetchFile(t),this.setOutputData(0,this._data)}fetchFile(t){var r=this;if(!t||t.constructor!==String){r._data=null,r.boxcolor=null;return}this._url=t,this._type=this.properties.type,t.substr(0,4)=="http"&&LiteGraph.proxy&&(t=LiteGraph.proxy+t.substr(t.indexOf(":")+3)),fetch(t).then(function(s){if(!s.ok)throw new Error("File not found");if(r.properties.type=="arraybuffer")return s.arrayBuffer();if(r.properties.type=="text")return s.text();if(r.properties.type=="json")return s.json();if(r.properties.type=="blob")return s.blob()}).then(function(s){r._data=s,r.boxcolor="#AEA"}).catch(s=>{var a;r._data=null,r.boxcolor="red",(a=console.error)==null||a.call(console,"error fetching file:",t)})}onDropFile(t){var r=this;this._url=t.name,this._type=this.properties.type,this.properties.url=t.name;var s=new FileReader;if(s.onload=function(a){r.boxcolor="#AEA";var l=a.target.result;r.properties.type=="json"&&(l=JSON.parse(l)),r._data=l},r.properties.type=="arraybuffer")s.readAsArrayBuffer(t);else if(r.properties.type=="text"||r.properties.type=="json")s.readAsText(t);else if(r.properties.type=="blob")return s.readAsBinaryString(t)}}g(ConstantFile,"title","Const File"),g(ConstantFile,"desc","Fetches a file from an url"),g(ConstantFile,"@type",{type:"enum",values:["text","arraybuffer","blob","json"]}),ConstantFile.prototype.setValue=ConstantNumber.prototype.setValue,LiteGraph.registerNodeType("basic/file",ConstantFile);class JSONParse{constructor(){this.addInput("parse",LiteGraph.ACTION),this.addInput("json","string"),this.addOutput("done",LiteGraph.EVENT),this.addOutput("object","object"),this.widget=this.addWidget("button","parse","",this.parse.bind(this)),this._str=null,this._obj=null}parse(){if(this._str)try{this._str=this.getInputData(1),this._obj=JSON.parse(this._str),this.boxcolor="#AEA",this.triggerSlot(0)}catch{this.boxcolor="red"}}onExecute(){this._str=this.getInputData(1),this.setOutputData(1,this._obj)}onAction(t){t=="parse"&&this.parse()}}g(JSONParse,"title","JSON Parse"),g(JSONParse,"desc","Parses JSON String into object"),LiteGraph.registerNodeType("basic/jsonparse",JSONParse);class ConstantData{constructor(){this.addOutput("data","object"),this.addProperty("value",""),this.widget=this.addWidget("text","json","","value"),this.widgets_up=!0,this.size=[140,30],this._value=null}onPropertyChanged(t,r){if(this.widget.value=r,!(r==null||r==""))try{this._value=JSON.parse(r),this.boxcolor="#AEA"}catch{this.boxcolor="red"}}onExecute(){this.setOutputData(0,this._value)}}g(ConstantData,"title","Const Data"),g(ConstantData,"desc","Constant Data"),ConstantData.prototype.setValue=ConstantNumber.prototype.setValue,LiteGraph.registerNodeType("basic/data",ConstantData);class ConstantArray{constructor(){this._value=[],this.addInput("json",""),this.addOutput("arrayOut","array"),this.addOutput("length","number"),this.addProperty("value","[]"),this.widget=this.addWidget("text","array",this.properties.value,"value"),this.widgets_up=!0,this.size=[140,50]}onPropertyChanged(t,r){if(this.widget.value=r,!(r==null||r==""))try{r[0]!="["?this._value=JSON.parse("["+r+"]"):this._value=JSON.parse(r),this.boxcolor="#AEA"}catch{this.boxcolor="red"}}onExecute(){var t=this.getInputData(0);if(t&&t.length){this._value||(this._value=new Array),this._value.length=t.length;for(var r=0;r<t.length;++r)this._value[r]=t[r];this.changeOutputType("arrayOut","array")}this.setOutputData(0,this._value),this.setOutputData(1,this._value&&this._value.length||0)}}g(ConstantArray,"title","Const Array"),g(ConstantArray,"desc","Constant Array"),ConstantArray.prototype.setValue=ConstantNumber.prototype.setValue,LiteGraph.registerNodeType("basic/array",ConstantArray);class ArrayLength{constructor(){this.addInput("arr","array"),this.addOutput("length","number")}onExecute(){var t,r=this.getInputData(0);r&&(["array","object"].includes(typeof r)&&typeof r.length!="undefined"?this.setOutputData(0,r.length):((t=console.debug)==null||t.call(console,"Not an array or object",typeof r,r),this.setOutputData(0,null)))}}g(ArrayLength,"title","aLength"),g(ArrayLength,"desc","Get the length of an array"),LiteGraph.registerNodeType("basic/array_length",ArrayLength);class SetArray{constructor(){this.addInput("arr","array"),this.addInput("value",""),this.addOutput("arr","array"),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties.index,"index",{precision:0,step:10,min:0})}onExecute(){var t=this.getInputData(0);if(t){var r=this.getInputData(1);r!==void 0&&(this.properties.index&&(t[Math.floor(this.properties.index)]=r),this.setOutputData(0,t))}}}g(SetArray,"title","Set Array"),g(SetArray,"desc","Sets index of array"),LiteGraph.registerNodeType("basic/set_array",SetArray);class ArrayElement{constructor(){this.addInput("array","array,table,string"),this.addInput("index","number"),this.addOutput("value",""),this.addProperty("index",0)}onExecute(){var t=this.getInputData(0),r=this.getInputData(1);r==null&&(r=this.properties.index),!(t==null||r==null)&&this.setOutputData(0,t[Math.floor(Number(r))])}}g(ArrayElement,"title","Array[i]"),g(ArrayElement,"desc","Returns an element from an array"),LiteGraph.registerNodeType("basic/array[]",ArrayElement);class TableElement{constructor(){this.addInput("table","table"),this.addInput("row","number"),this.addInput("col","number"),this.addOutput("value",""),this.addProperty("row",0),this.addProperty("column",0)}onExecute(){var t=this.getInputData(0),r=this.getInputData(1),s=this.getInputData(2);r==null&&(r=this.properties.row),s==null&&(s=this.properties.column),!(t==null||r==null||s==null)&&(r=t[Math.floor(Number(r))],r?this.setOutputData(0,r[Math.floor(Number(s))]):this.setOutputData(0,null))}}g(TableElement,"title","Table[row][col]"),g(TableElement,"desc","Returns an element from a table"),LiteGraph.registerNodeType("basic/table[][]",TableElement);class ObjectProperty{constructor(){this.addInput("obj","object"),this.addOutput("property",0),this.addProperty("value",0),this.widget=this.addWidget("text","prop.","",this.setValue.bind(this)),this.widgets_up=!0,this.size=[140,30],this._value=null}setValue(t){this.properties.value=t,this.widget.value=t}getTitle(){return this.flags.collapsed?"in."+this.properties.value:this.title}onPropertyChanged(t,r){this.widget.value=r}onExecute(){var t=this.getInputData(0);t!=null&&this.setOutputData(0,t[this.properties.value])}}g(ObjectProperty,"title","Object property"),g(ObjectProperty,"desc","Outputs the property of an object"),LiteGraph.registerNodeType("basic/object_property",ObjectProperty);class ObjectKeys{constructor(){this.addInput("obj",""),this.addOutput("keys","array"),this.size=[140,30]}onExecute(){var t=this.getInputData(0);t!=null&&this.setOutputData(0,Object.keys(t))}}g(ObjectKeys,"title","Object keys"),g(ObjectKeys,"desc","Outputs an array with the keys of an object"),LiteGraph.registerNodeType("basic/object_keys",ObjectKeys);class SetObject{constructor(){this.addInput("obj",""),this.addInput("value",""),this.addOutput("obj",""),this.properties={property:""},this.name_widget=this.addWidget("text","prop.",this.properties.property,"property")}onExecute(){var t=this.getInputData(0);if(t){var r=this.getInputData(1);r!==void 0&&(this.properties.property&&(t[this.properties.property]=r),this.setOutputData(0,t))}}}g(SetObject,"title","Set Object"),g(SetObject,"desc","Adds propertiesrty to object"),LiteGraph.registerNodeType("basic/set_object",SetObject);class MergeObjects{constructor(){this.addInput("A","object"),this.addInput("B","object"),this.addOutput("out","object"),this._result={};var t=this;this.addWidget("button","clear","",function(){t._result={}}),this.size=this.computeSize()}onExecute(){var t=this.getInputData(0),r=this.getInputData(1),s=this._result;if(t)for(let a in t)s[a]=t[a];if(r)for(let a in r)s[a]=r[a];this.setOutputData(0,s)}}g(MergeObjects,"title","Merge Objects"),g(MergeObjects,"desc","Creates an object copying properties from others"),LiteGraph.registerNodeType("basic/merge_objects",MergeObjects);const ut=class Di{constructor(){this.size=[60,30],this.addInput("in"),this.addOutput("out"),this.properties={varname:"myname",container:Di.LITEGRAPH},this.value=null}onExecute(){var t=this.getContainer();if(this.isInputConnected(0)){this.value=this.getInputData(0),t[this.properties.varname]=this.value,this.setOutputData(0,this.value);return}this.setOutputData(0,t[this.properties.varname])}getContainer(){switch(this.properties.container){case Di.GRAPH:return this.graph?this.graph.vars:{};case Di.GLOBALSCOPE:return global;default:return LiteGraph.Globals}}getTitle(){return this.properties.varname}};g(ut,"title","Variable"),g(ut,"desc","store/read variable value");let Variable=ut;Variable.LITEGRAPH=0,Variable.GRAPH=1,Variable.GLOBALSCOPE=2,Variable["@container"]={type:"enum",values:{litegraph:Variable.LITEGRAPH,graph:Variable.GRAPH,global:Variable.GLOBALSCOPE}},LiteGraph.registerNodeType("basic/variable",Variable);function length(o){return o&&o.length!=null?Number(o.length):0}LiteGraph.wrapFunctionAsNode("basic/length",length,[""],"number"),LiteGraph.wrapFunctionAsNode("basic/not",function(o){return!o},[""],"boolean");class DownloadData{constructor(){this.size=[60,30],this.addInput("data",0),this.addInput("download",LiteGraph.ACTION),this.properties={filename:"data.json"},this.value=null;var t=this;this.addWidget("button","Download","",()=>{t.value&&t.downloadAsFile()})}downloadAsFile(){if(this.value!=null){var t=null;this.value.constructor===String?t=this.value:t=JSON.stringify(this.value);var r=new Blob([t]),s=URL.createObjectURL(r),a=document.createElement("a");a.setAttribute("href",s),a.setAttribute("download",this.properties.filename),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(function(){URL.revokeObjectURL(s)},1e3*60)}}onAction(){var t=this;setTimeout(function(){t.downloadAsFile()},100)}onExecute(){this.inputs[0]&&(this.value=this.getInputData(0))}getTitle(){return this.flags.collapsed?this.properties.filename:this.title}}g(DownloadData,"title","Download"),g(DownloadData,"desc","Download some data"),LiteGraph.registerNodeType("basic/download",DownloadData);const gt=class Vi{constructor(){this.size=[60,30],this.addInput("value",0,{label:""}),this.value=0}onExecute(){this.inputs[0]&&(this.value=this.getInputData(0))}getTitle(){return this.flags.collapsed?this.inputs[0].label:this.title}static toString(t){if(t==null)return"null";if(t.constructor===Number)return t.toFixed(3);if(t.constructor===Array){for(var r="[",s=0;s<t.length;++s)r+=Vi.toString(t[s])+(s+1!=t.length?",":"");return r+="]",r}else return String(t)}onDrawBackground(){this.inputs[0].label=Vi.toString(this.value)}};g(gt,"title","Watch"),g(gt,"desc","Show value of input");let Watch=gt;LiteGraph.registerNodeType("basic/watch",Watch);class Cast{constructor(){this.addInput("in",0),this.addOutput("out",0),this.size=[40,30]}onExecute(){this.setOutputData(0,this.getInputData(0))}}g(Cast,"title","Cast"),g(Cast,"desc","Allows to connect different types"),LiteGraph.registerNodeType("basic/cast",Cast);class Console{constructor(){this.mode=LiteGraph.ON_EVENT,this.size=[80,30],this.addProperty("msg",""),this.addInput("log",LiteGraph.EVENT),this.addInput("msg",0)}onAction(t,r){var s,a,l,h=this.getInputData(1);h||(h=this.properties.msg),h||(h="Event: "+r),t=="log"?(s=console.log)==null||s.call(console,h):t=="warn"?(a=console.warn)==null||a.call(console,h):t=="error"&&((l=console.error)==null||l.call(console,h))}onExecute(){var t,r=this.getInputData(1);r||(r=this.properties.msg),r!=null&&typeof r!="undefined"&&(this.properties.msg=r,(t=console.log)==null||t.call(console,r))}onGetInputs(){return[["log",LiteGraph.ACTION],["warn",LiteGraph.ACTION],["error",LiteGraph.ACTION]]}}g(Console,"title","Console"),g(Console,"desc","Show value inside the console"),LiteGraph.registerNodeType("basic/console",Console);class Alert{constructor(){this.mode=LiteGraph.ON_EVENT,this.addProperty("msg",""),this.addInput("",LiteGraph.EVENT),this.widget=this.addWidget("text","Text","","msg"),this.widgets_up=!0,this.size=[200,30]}onConfigure(t){this.widget.value=t.properties.msg}onAction(){var t=this.properties.msg;setTimeout(function(){alert(t)},10)}}g(Alert,"title","Alert"),g(Alert,"desc","Show an alert window"),g(Alert,"color","#510"),LiteGraph.registerNodeType("basic/alert",Alert);class NodeScript{constructor(){this.size=[60,30],this.addProperty("onExecute","return A;"),this.addInput("A",0),this.addInput("B",0),this.addOutput("out",0),this._func=null,this.data={}}onConfigure(t){var r;t.properties.onExecute&&LiteGraph.allow_scripts?this.compileCode(t.properties.onExecute):(r=console.warn)==null||r.call(console,"Script not compiled, LiteGraph.allow_scripts is false")}onPropertyChanged(t,r){var s;t=="onExecute"&&LiteGraph.allow_scripts?this.compileCode(r):(s=console.warn)==null||s.call(console,"Script not compiled, LiteGraph.allow_scripts is false")}compileCode(t){var r,s,a,l;if(this._func=null,t.length>256)(r=console.warn)==null||r.call(console,"Script too long, max 256 chars");else{for(var h=t.toLowerCase(),u=["script","body","document","eval","nodescript","function"],c=0;c<u.length;++c)if(h.indexOf(u[c])!=-1){(s=console.warn)==null||s.call(console,"invalid script");return}try{this._func=new Function("A","B","C","DATA","node",t)}catch(_){(a=console.error)==null||a.call(console,"Error parsing script"),(l=console.error)==null||l.call(console,_)}}}onExecute(){var t,r;if(this._func)try{var s=this.getInputData(0),a=this.getInputData(1),l=this.getInputData(2);this.setOutputData(0,this._func(s,a,l,this.data,this))}catch(h){(t=console.error)==null||t.call(console,"Error in script"),(r=console.error)==null||r.call(console,h)}}onGetOutputs(){return[["C",""]]}}g(NodeScript,"title","Script"),g(NodeScript,"desc","executes a code (max 256 characters)"),g(NodeScript,"widgets_info",{onExecute:{type:"code"}}),LiteGraph.registerNodeType("basic/script",NodeScript);const ke=class Xi{constructor(){this.addInput("A",0),this.addInput("B",0),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","==","enum",{values:Xi.values}),this.addWidget("combo","Op.",this.properties.OP,{property:"OP",values:Xi.values}),this.size=[80,60]}getTitle(){return"*A "+this.properties.OP+" *B"}onExecute(){var t=this.getInputData(0);t===void 0?t=this.properties.A:this.properties.A=t;var r=this.getInputData(1);r===void 0?r=this.properties.B:this.properties.B=r;var s=!1;if(typeof t==typeof r)switch(this.properties.OP){case"==":case"!=":switch(s=!0,typeof t){case"object":var a=Object.getOwnPropertyNames(t),l=Object.getOwnPropertyNames(r);if(a.length!=l.length){s=!1;break}for(var h=0;h<a.length;h++){var u=a[h];if(t[u]!==r[u]){s=!1;break}}break;default:s=t==r}this.properties.OP=="!="&&(s=!s);break}this.setOutputData(0,s),this.setOutputData(1,!s)}};g(ke,"title","Compare *"),g(ke,"desc","evaluates condition between A and B"),g(ke,"values",["==","!="]),g(ke,"@OP",{type:"enum",title:"operation",values:ke.values});let GenericCompare=ke;LiteGraph.registerNodeType("basic/CompareValues",GenericCompare);class LogEvent{constructor(){this.size=[60,30],this.addInput("event",LiteGraph.ACTION)}onAction(t,r){var s;(s=console.log)==null||s.call(console,t,r)}}g(LogEvent,"title","Log Event"),g(LogEvent,"desc","Log event in console"),LiteGraph.registerNodeType("events/log",LogEvent);class TriggerEvent{constructor(){this.size=[60,30],this.addInput("if",""),this.addOutput("true",LiteGraph.EVENT),this.addOutput("change",LiteGraph.EVENT),this.addOutput("false",LiteGraph.EVENT),this.properties={only_on_change:!0,tooltip:"Triggers event if input evaluates to true"},this.prev=0}onExecute(t,r){var s=this.getInputData(0),a=s!=this.prev;this.prev===0&&(a=!1);var l=a&&this.properties.only_on_change||!a&&!this.properties.only_on_change;s&&l&&this.triggerSlot(0,t,null,r),!s&&l&&this.triggerSlot(2,t,null,r),a&&this.triggerSlot(1,t,null,r),this.prev=s}}g(TriggerEvent,"title","TriggerEvent"),g(TriggerEvent,"desc","Triggers event if input evaluates to true"),LiteGraph.registerNodeType("events/trigger",TriggerEvent);var Gt;let Sequence$1=(Gt=class{constructor(){var o=this;this.addInput("",LiteGraph.ACTION),this.addInput("",LiteGraph.ACTION),this.addInput("",LiteGraph.ACTION),this.addOutput("",LiteGraph.EVENT),this.addOutput("",LiteGraph.EVENT),this.addOutput("",LiteGraph.EVENT),this.addWidget("button","+",null,function(){o.addInput("",LiteGraph.ACTION),o.addOutput("",LiteGraph.EVENT)}),this.size=[90,70],this.flags={horizontal:!0,render_box:!1}}getTitle(){return""}onAction(o,t,r){if(this.outputs){r=r||{};for(var s=0;s<this.outputs.length;++s)r.action_call?r.action_call=r.action_call+"_seq_"+s:r.action_call=this.id+"_"+(o||"action")+"_seq_"+s+"_"+Math.floor(Math.random()*9999),this.triggerSlot(s,t,null,r)}}},g(Gt,"title","Sequence"),g(Gt,"desc","Triggers a sequence of events when an event arrives"),Gt);LiteGraph.registerNodeType("events/sequence",Sequence$1);class WaitAll{constructor(){var t=this;this.addInput("",LiteGraph.ACTION),this.addInput("",LiteGraph.ACTION),this.addOutput("",LiteGraph.EVENT),this.addWidget("button","+",null,function(){t.addInput("",LiteGraph.ACTION),t.size[0]=90}),this.size=[90,70],this.ready=[]}getTitle(){return""}onDrawBackground(t){if(!this.flags.collapsed)for(var r=0;r<this.inputs.length;++r){var s=r*LiteGraph.NODE_SLOT_HEIGHT+10;t.fillStyle=this.ready[r]?"#AFB":"#000",t.fillRect(20,s,10,10)}}onAction(t,r,s,a){if(a!=null){this.ready.length=this.outputs.length,this.ready[a]=!0;for(var l=0;l<this.ready.length;++l)if(!this.ready[l])return;this.reset(),this.triggerSlot(0)}}reset(){this.ready.length=0}}g(WaitAll,"title","WaitAll"),g(WaitAll,"desc","Wait until all input events arrive then triggers output"),LiteGraph.registerNodeType("events/waitAll",WaitAll);class Stepper{constructor(){var t=this;this.properties={index:0},this.addInput("index","number"),this.addInput("step",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("index","number"),this.addOutput("",LiteGraph.EVENT),this.addOutput("",LiteGraph.EVENT),this.addOutput("",LiteGraph.EVENT,{removable:!0}),this.addWidget("button","+",null,function(){t.addOutput("",LiteGraph.EVENT,{removable:!0})}),this.size=[120,120],this.flags={render_box:!1}}onDrawBackground(t){if(!this.flags.collapsed){var r=this.properties.index||0;t.fillStyle="#AFB";var s=this.size[0],a=(r+1)*LiteGraph.NODE_SLOT_HEIGHT+4;t.beginPath(),t.moveTo(s-30,a),t.lineTo(s-30,a+LiteGraph.NODE_SLOT_HEIGHT),t.lineTo(s-15,a+LiteGraph.NODE_SLOT_HEIGHT*.5),t.fill()}}onExecute(){var t=this.getInputData(0);t!=null&&(t=Math.floor(t),t=LiteGraph.clamp(t,0,this.outputs?this.outputs.length-2:0),t!=this.properties.index&&(this.properties.index=t,this.triggerSlot(t+1))),this.setOutputData(0,this.properties.index)}onAction(t,r){if(t=="reset")this.properties.index=0;else if(t=="step"){this.triggerSlot(this.properties.index+1,r);var s=this.outputs?this.outputs.length-1:0;this.properties.index=(this.properties.index+1)%s}}}g(Stepper,"title","Stepper"),g(Stepper,"desc","Trigger events sequentially when an tick arrives"),LiteGraph.registerNodeType("events/stepper",Stepper);class FilterEvent{constructor(){this.size=[60,30],this.addInput("event",LiteGraph.ACTION),this.addOutput("event",LiteGraph.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}onAction(t,r,s){if(r!=null&&!(this.properties.equal_to&&this.properties.equal_to!=r)){if(this.properties.has_property){var a=r[this.properties.has_property];if(a==null||this.properties.property_equal_to&&this.properties.property_equal_to!=a)return}this.triggerSlot(0,r,null,s)}}}g(FilterEvent,"title","Filter Event"),g(FilterEvent,"desc","Blocks events that do not match the filter"),LiteGraph.registerNodeType("events/filter",FilterEvent);class EventBranch{constructor(){this.addInput("in",LiteGraph.ACTION),this.addInput("cond","boolean"),this.addOutput("true",LiteGraph.EVENT),this.addOutput("false",LiteGraph.EVENT),this.size=[120,60],this._value=!1}onExecute(){this._value=this.getInputData(1)}onAction(t,r,s){this._value=this.getInputData(1),this.triggerSlot(this._value?0:1,r,null,s)}}g(EventBranch,"title","Branch"),g(EventBranch,"desc","If condition is true, outputs triggers true, otherwise false"),LiteGraph.registerNodeType("events/branch",EventBranch);class EventCounter{constructor(){this.addInput("inc",LiteGraph.ACTION),this.addInput("dec",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("change",LiteGraph.EVENT),this.addOutput("num","number"),this.addProperty("doCountExecution",!1,"boolean",{name:"Count Executions"}),this.addWidget("toggle","Count Exec.",this.properties.doCountExecution,"doCountExecution"),this.num=0}getTitle(){return this.flags.collapsed?String(this.num):this.title}onAction(t){var r=this.num;t=="inc"?this.num+=1:t=="dec"?this.num-=1:t=="reset"&&(this.num=0),this.num!=r&&this.trigger("change",this.num)}onDrawBackground(t){this.flags.collapsed||(t.fillStyle="#AAA",t.font="20px Arial",t.textAlign="center",t.fillText(this.num,this.size[0]*.5,this.size[1]*.5))}onExecute(){this.properties.doCountExecution&&(this.num+=1),this.setOutputData(1,this.num)}}g(EventCounter,"title","Counter"),g(EventCounter,"desc","Counts events"),LiteGraph.registerNodeType("events/counter",EventCounter);class DelayEvent{constructor(){this.size=[60,30],this.addProperty("time_in_ms",1e3),this.addInput("event",LiteGraph.ACTION),this.addOutput("on_time",LiteGraph.EVENT),this._pending=[]}onAction(t,r,s){var a=this.properties.time_in_ms;a<=0?this.trigger(null,r,s):this._pending.push([a,r])}onExecute(t,r){var s=this.graph.elapsed_time*1e3;this.isInputConnected(1)&&(this.properties.time_in_ms=this.getInputData(1));for(var a=0;a<this._pending.length;++a){var l=this._pending[a];l[0]-=s,!(l[0]>0)&&(this._pending.splice(a,1),--a,this.trigger(null,l[1],r))}}onGetInputs(){return[["event",LiteGraph.ACTION],["time_in_ms","number"]]}}g(DelayEvent,"title","Delay"),g(DelayEvent,"desc","Delays one event"),LiteGraph.registerNodeType("events/delay",DelayEvent);const _t=class Wi{constructor(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",LiteGraph.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}onStart(){this.time=0}getTitle(){return"Timer: "+this.last_interval.toString()+"ms"}onDrawBackground(){this.boxcolor=this.triggered?Wi.on_color:Wi.off_color,this.triggered=!1}onExecute(){var t=this.graph.elapsed_time*1e3,r=this.time==0;if(this.time+=t,this.last_interval=Math.max(1,this.getInputOrProperty("interval")|0),!r&&(this.time<this.last_interval||isNaN(this.last_interval))){this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!1);return}this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!0)}onGetInputs(){return[["interval","number"]]}onGetOutputs(){return[["tick","boolean"]]}};g(_t,"title","Timer"),g(_t,"desc","Sends an event every N milliseconds");let TimerEvent=_t;TimerEvent.on_color="#AAA",TimerEvent.off_color="#222",LiteGraph.registerNodeType("events/timer",TimerEvent);class SemaphoreEvent{constructor(){this.addInput("go",LiteGraph.ACTION),this.addInput("green",LiteGraph.ACTION),this.addInput("red",LiteGraph.ACTION),this.addOutput("continue",LiteGraph.EVENT),this.addOutput("blocked",LiteGraph.EVENT),this.addOutput("is_green","boolean"),this._ready=!1,this.properties={};var t=this;this.addWidget("button","reset","",function(){t._ready=!1})}onExecute(){this.setOutputData(1,this._ready),this.boxcolor=this._ready?"#9F9":"#FA5"}onAction(t){t=="go"?this.triggerSlot(this._ready?0:1):t=="green"?this._ready=!0:t=="red"&&(this._ready=!1)}}g(SemaphoreEvent,"title","Semaphore Event"),g(SemaphoreEvent,"desc","Until both events are not triggered, it doesnt continue."),LiteGraph.registerNodeType("events/semaphore",SemaphoreEvent);class OnceEvent{constructor(){this.addInput("in",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("out",LiteGraph.EVENT),this._once=!1,this.properties={};var t=this;this.addWidget("button","reset","",function(){t._once=!1})}onAction(t,r){t=="in"&&!this._once?(this._once=!0,this.triggerSlot(0,r)):t=="reset"&&(this._once=!1)}}g(OnceEvent,"title","Once"),g(OnceEvent,"desc","Only passes an event once, then gets locked"),LiteGraph.registerNodeType("events/once",OnceEvent);class DataStore{constructor(){this.addInput("data",0),this.addInput("assign",LiteGraph.ACTION),this.addOutput("data",0),this._last_value=null,this.properties={data:null,serialize:!0};var t=this;this.addWidget("button","store","",function(){t.properties.data=t._last_value})}onExecute(){this._last_value=this.getInputData(0),this.setOutputData(0,this.properties.data)}onAction(){this.properties.data=this._last_value}onSerialize(t){t.data!=null&&(!this.properties.serialize||t.data.constructor!==String&&t.data.constructor!==Number&&t.data.constructor!==Boolean&&t.data.constructor!==Array&&t.data.constructor!==Object)&&(t.data=null)}}g(DataStore,"title","Data Store"),g(DataStore,"desc","Stores data and only changes when event is received"),LiteGraph.registerNodeType("basic/data_store",DataStore);const mt=class Ji{constructor(){this.addOutput("",LiteGraph.EVENT),this.addOutput("","boolean"),this.addProperty("text","DO"),this.addProperty("font_size",30),this.addProperty("message",""),this.size=[84,84],this.clicked=!1}onDrawForeground(t){if(!this.flags.collapsed){var r=10;if(t.fillStyle="black",t.fillRect(r+1,r+1,this.size[0]-r*2,this.size[1]-r*2),t.fillStyle="#AAF",t.fillRect(r-1,r-1,this.size[0]-r*2,this.size[1]-r*2),t.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",t.fillRect(r,r,this.size[0]-r*2,this.size[1]-r*2),this.properties.text||this.properties.text===0){var s=this.properties.font_size||30;t.textAlign="center",t.fillStyle=this.clicked?"black":"white",t.font=s+"px "+Ji.font,t.fillText(this.properties.text,this.size[0]*.5,this.size[1]*.5+s*.3),t.textAlign="left"}}}onMouseDown(t,r){if(r[0]>1&&r[1]>1&&r[0]<this.size[0]-2&&r[1]<this.size[1]-2)return this.clicked=!0,this.setOutputData(1,this.clicked),this.triggerSlot(0,this.properties.message),!0}onExecute(){this.setOutputData(1,this.clicked)}onMouseUp(t){this.clicked=!1}};g(mt,"title","Button"),g(mt,"desc","Triggers an event"),g(mt,"font","Arial");let WidgetButton=mt;LiteGraph.registerNodeType("widget/button",WidgetButton);class WidgetToggle{constructor(){this.addInput("","boolean"),this.addInput("e",LiteGraph.ACTION),this.addOutput("v","boolean"),this.addOutput("e",LiteGraph.EVENT),this.properties={font:"",value:!1},this.size=[160,44]}onDrawForeground(t){if(!this.flags.collapsed){var r=this.size[1]*.5,s=.25,a=this.size[1]*.8;t.font=this.properties.font||(r*.8).toFixed(0)+"px Arial";var l=t.measureText(this.title).width,h=(this.size[0]-(l+r))*.5;t.fillStyle="#AAA",t.fillRect(h,a-r,r,r),t.fillStyle=this.properties.value?"#AEF":"#000",t.fillRect(h+r*s,a-r+r*s,r*(1-s*2),r*(1-s*2)),t.textAlign="left",t.fillStyle="#AAA",t.fillText(this.title,r*1.2+h,a*.85),t.textAlign="left"}}onAction(t){this.properties.value=!this.properties.value,this.trigger("e",this.properties.value)}onExecute(){var t=this.getInputData(0);t!=null&&(this.properties.value=t),this.setOutputData(0,this.properties.value)}onMouseDown(t,r){if(r[0]>1&&r[1]>1&&r[0]<this.size[0]-2&&r[1]<this.size[1]-2)return this.properties.value=!this.properties.value,this.graph._version++,this.trigger("e",this.properties.value),!0}}g(WidgetToggle,"title","Toggle"),g(WidgetToggle,"desc","Toggles between true or false"),LiteGraph.registerNodeType("widget/toggle",WidgetToggle);const Ke=class ji{constructor(){this.addOutput("","number"),this.size=[80,60],this.properties={min:-1e3,max:1e3,value:1,step:1},this.old_y=-1,this._remainder=0,this._precision=0,this.mouse_captured=!1}onDrawForeground(t){var r=this.size[0]*.5,s=this.size[1];s>30?(t.fillStyle=ji.markers_color,t.beginPath(),t.moveTo(r,s*.1),t.lineTo(r+s*.1,s*.2),t.lineTo(r+s*-.1,s*.2),t.fill(),t.beginPath(),t.moveTo(r,s*.9),t.lineTo(r+s*.1,s*.8),t.lineTo(r+s*-.1,s*.8),t.fill(),t.font=(s*.7).toFixed(1)+"px Arial"):t.font=(s*.8).toFixed(1)+"px Arial",t.textAlign="center",t.font=(s*.7).toFixed(1)+"px Arial",t.fillStyle="#EEE",t.fillText(this.properties.value.toFixed(this._precision),r,s*.75)}onExecute(){this.setOutputData(0,this.properties.value)}onPropertyChanged(t,r){var s=(this.properties.step+"").split(".");this._precision=s.length>1?s[1].length:0}onMouseDown(t,r){if(!(r[1]<0))return this.old_y=t.canvasY,this.captureInput(!0),this.mouse_captured=!0,!0}onMouseMove(t){if(this.mouse_captured){var r=this.old_y-t.canvasY;t.shiftKey&&(r*=10),(t.metaKey||t.altKey)&&(r*=.1),this.old_y=t.canvasY;var s=this._remainder+r/ji.pixels_threshold;this._remainder=s%1,s=s|0;var a=LiteGraph.clamp(this.properties.value+s*this.properties.step,this.properties.min,this.properties.max);this.properties.value=a,this.graph._version++,this.setDirtyCanvas(!0)}}onMouseUp(t,r){if(t.click_time<200){var s=r[1]>this.size[1]*.5?-1:1;this.properties.value=LiteGraph.clamp(this.properties.value+s*this.properties.step,this.properties.min,this.properties.max),this.graph._version++,this.setDirtyCanvas(!0)}this.mouse_captured&&(this.mouse_captured=!1,this.captureInput(!1))}};g(Ke,"title","Number"),g(Ke,"desc","Widget to select number value"),g(Ke,"pixels_threshold",10),g(Ke,"markers_color","#666");let WidgetNumber=Ke;LiteGraph.registerNodeType("widget/number",WidgetNumber);class WidgetCombo{constructor(){this.addOutput("","string"),this.addOutput("change",LiteGraph.EVENT),this.size=[80,60],this.properties={value:"A",values:"A;B;C"},this.old_y=-1,this.mouse_captured=!1,this._values=this.properties.values.split(";");var t=this;this.widgets_up=!0,this.widget=this.addWidget("combo","",this.properties.value,function(r){t.properties.value=r,t.triggerSlot(1,r)},{property:"value",values:this._values})}onExecute(){this.setOutputData(0,this.properties.value)}onPropertyChanged(t,r){t=="values"?(this._values=r.split(";"),this.widget.options.values=this._values):t=="value"&&(this.widget.value=r)}}g(WidgetCombo,"title","Combo"),g(WidgetCombo,"desc","Widget to select from a list"),LiteGraph.registerNodeType("widget/combo",WidgetCombo);class WidgetKnob{constructor(){this.addOutput("","number"),this.size=[64,84],this.properties={min:0,max:1,value:.5,color:"#7AF",precision:2},this.value=-1}onDrawForeground(t){if(!this.flags.collapsed){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min));var r=this.size[0]*.5,s=this.size[1]*.5,a=Math.min(this.size[0],this.size[1])*.5-5;t.globalAlpha=1,t.save(),t.translate(r,s),t.rotate(Math.PI*.75),t.fillStyle="rgba(0,0,0,0.5)",t.beginPath(),t.moveTo(0,0),t.arc(0,0,a,0,Math.PI*1.5),t.fill(),t.strokeStyle="black",t.fillStyle=this.properties.color,t.lineWidth=2,t.beginPath(),t.moveTo(0,0),t.arc(0,0,a-4,0,Math.PI*1.5*Math.max(.01,this.value)),t.closePath(),t.fill(),t.lineWidth=1,t.globalAlpha=1,t.restore(),t.fillStyle="black",t.beginPath(),t.arc(r,s,a*.75,0,Math.PI*2,!0),t.fill(),t.fillStyle=this.mouseOver?"white":this.properties.color,t.beginPath();var l=this.value*Math.PI*1.5+Math.PI*.75;t.arc(r+Math.cos(l)*a*.65,s+Math.sin(l)*a*.65,a*.05,0,Math.PI*2,!0),t.fill(),t.fillStyle=this.mouseOver?"white":"#AAA",t.font=Math.floor(a*.5)+"px Arial",t.textAlign="center",t.fillText(this.properties.value.toFixed(this.properties.precision),r,s+a*.15)}}onExecute(){this.setOutputData(0,this.properties.value),this.boxcolor=LiteGraph.colorToString([this.value,this.value,this.value])}onMouseDown(t){return this.center=[this.size[0]*.5,this.size[1]*.5+20],this.radius=this.size[0]*.5,t.canvasY-this.pos[1]<20||LiteGraph.distance([t.canvasX,t.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius?!1:(this.oldmouse=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],this.captureInput(!0),!0)}onMouseMove(t){if(this.oldmouse){var r=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],s=this.value;s-=(r[1]-this.oldmouse[1])*.01,s>1?s=1:s<0&&(s=0),this.value=s,this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.oldmouse=r,this.setDirtyCanvas(!0)}}onMouseUp(t){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))}onPropertyChanged(t,r){if(t=="min"||t=="max"||t=="value")return this.properties[t]=parseFloat(r),!0}}g(WidgetKnob,"title","Knob"),g(WidgetKnob,"desc","Circular controller"),g(WidgetKnob,"size",[80,100]),LiteGraph.registerNodeType("widget/knob",WidgetKnob);class WidgetSliderGUI{constructor(){this.addOutput("","number"),this.properties={value:.5,min:0,max:1,text:"V"};var t=this;this.size=[140,40],this.slider=this.addWidget("slider","V",this.properties.value,function(r){t.properties.value=r},this.properties),this.widgets_up=!0}onPropertyChanged(t,r){t=="value"&&(this.slider.value=r)}onExecute(){this.setOutputData(0,this.properties.value)}}g(WidgetSliderGUI,"title","Inner Slider"),LiteGraph.registerNodeType("widget/internal_slider",WidgetSliderGUI);class WidgetHSlider{constructor(){this.size=[160,26],this.addOutput("","number"),this.properties={color:"#7AF",min:0,max:1,value:.5},this.value=-1}onDrawForeground(t){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),t.globalAlpha=1,t.lineWidth=1,t.fillStyle="#000",t.fillRect(2,2,this.size[0]-4,this.size[1]-4),t.fillStyle=this.properties.color,t.beginPath(),t.rect(4,4,(this.size[0]-8)*this.value,this.size[1]-8),t.fill()}onExecute(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.setOutputData(0,this.properties.value),this.boxcolor=LiteGraph.colorToString([this.value,this.value,this.value])}onMouseDown(t){return t.canvasY-this.pos[1]<0?!1:(this.oldmouse=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],this.captureInput(!0),!0)}onMouseMove(t){if(this.oldmouse){var r=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],s=this.value,a=r[0]-this.oldmouse[0];s+=a/this.size[0],s>1?s=1:s<0&&(s=0),this.value=s,this.oldmouse=r,this.setDirtyCanvas(!0)}}onMouseUp(t){this.oldmouse=null,this.captureInput(!1)}}g(WidgetHSlider,"title","H.Slider"),g(WidgetHSlider,"desc","Linear slider controller"),LiteGraph.registerNodeType("widget/hslider",WidgetHSlider);class WidgetProgress{constructor(){this.size=[160,26],this.addInput("","number"),this.properties={min:0,max:1,value:0,color:"#AAF"}}onExecute(){var t=this.getInputData(0);t!=null&&(this.properties.value=t)}onDrawForeground(t){t.lineWidth=1,t.fillStyle=this.properties.color;var r=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min);r=Math.min(1,r),r=Math.max(0,r),t.fillRect(2,2,(this.size[0]-4)*r,this.size[1]-4)}}g(WidgetProgress,"title","Progress"),g(WidgetProgress,"desc","Shows data in linear progress"),LiteGraph.registerNodeType("widget/progress",WidgetProgress);class WidgetText{constructor(){this.addInputs("",0),this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}onDrawForeground(t){t.fillStyle=this.properties.color;var r=this.properties.value;this.properties.glowSize?(t.shadowColor=this.properties.color,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=this.properties.glowSize):t.shadowColor="transparent";var s=this.properties.fontsize;if(t.textAlign=this.properties.align,t.font=s.toString()+"px "+this.properties.font,this.str=typeof r=="number"?r.toFixed(this.properties.decimals):r,typeof this.str=="string")for(var a=this.str.replace(/[\r\n]/g,"\\n").split("\\n"),l=0;l<a.length;l++)t.fillText(a[l],this.properties.align=="left"?15:this.size[0]-15,s*-.15+s*(parseInt(l)+1));t.shadowColor="transparent",this.last_ctx=t,t.textAlign="left"}onExecute(){var t=this.getInputData(0);t!=null&&(this.properties.value=t)}resize(){if(this.last_ctx){var t=this.str.split("\\n");this.last_ctx.font=this.properties.fontsize+"px "+this.properties.font;for(var r=0,s=0;s<t.length;s++){var a=this.last_ctx.measureText(t[s]).width;r<a&&(r=a)}this.size[0]=r+20,this.size[1]=4+t.length*this.properties.fontsize,this.setDirtyCanvas(!0)}}onPropertyChanged(t,r){return this.properties[t]=r,this.str=typeof r=="number"?r.toFixed(3):r,!0}}g(WidgetText,"title","Text"),g(WidgetText,"desc","Shows the input value"),g(WidgetText,"widgets",[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}]),LiteGraph.registerNodeType("widget/text",WidgetText);class WidgetPanel{constructor(){g(this,"widgets",[{name:"update",text:"Update",type:"button"}]),this.size=[200,100],this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}createGradient(t){if(this.properties.bgcolorTop==""||this.properties.bgcolorBottom==""){this.lineargradient=0;return}this.lineargradient=t.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,this.properties.bgcolorBottom)}onDrawForeground(t){this.flags.collapsed||(this.lineargradient==null&&this.createGradient(t),this.lineargradient&&(t.lineWidth=1,t.strokeStyle=this.properties.borderColor,t.fillStyle=this.lineargradient,this.properties.shadowSize?(t.shadowColor="#000",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=this.properties.shadowSize):t.shadowColor="transparent",t.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),t.fill(),t.shadowColor="transparent",t.stroke()))}}g(WidgetPanel,"title","Panel"),g(WidgetPanel,"desc","Non interactive panel"),LiteGraph.registerNodeType("widget/panel",WidgetPanel);const ae=class At{constructor(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",LiteGraph.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}onExecute(){var t=this.getGamepad(),r=this.properties.threshold||0;if(t&&(this._left_axis[0]=Math.abs(t.xbox.axes.lx)>r?t.xbox.axes.lx:0,this._left_axis[1]=Math.abs(t.xbox.axes.ly)>r?t.xbox.axes.ly:0,this._right_axis[0]=Math.abs(t.xbox.axes.rx)>r?t.xbox.axes.rx:0,this._right_axis[1]=Math.abs(t.xbox.axes.ry)>r?t.xbox.axes.ry:0,this._triggers[0]=Math.abs(t.xbox.axes.ltrigger)>r?t.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(t.xbox.axes.rtrigger)>r?t.xbox.axes.rtrigger:0),this.outputs)for(var s=0;s<this.outputs.length;s++){var a=this.outputs[s];if(!(!a.links||!a.links.length)){var l=null;if(t)switch(a.name){case"left_axis":l=this._left_axis;break;case"right_axis":l=this._right_axis;break;case"left_x_axis":l=this._left_axis[0];break;case"left_y_axis":l=this._left_axis[1];break;case"right_x_axis":l=this._right_axis[0];break;case"right_y_axis":l=this._right_axis[1];break;case"trigger_left":l=this._triggers[0];break;case"trigger_right":l=this._triggers[1];break;case"a_button":l=t.xbox.buttons.a?1:0;break;case"b_button":l=t.xbox.buttons.b?1:0;break;case"x_button":l=t.xbox.buttons.x?1:0;break;case"y_button":l=t.xbox.buttons.y?1:0;break;case"lb_button":l=t.xbox.buttons.lb?1:0;break;case"rb_button":l=t.xbox.buttons.rb?1:0;break;case"ls_button":l=t.xbox.buttons.ls?1:0;break;case"rs_button":l=t.xbox.buttons.rs?1:0;break;case"hat_left":l=t.xbox.hatmap&At.LEFT;break;case"hat_right":l=t.xbox.hatmap&At.RIGHT;break;case"hat_up":l=t.xbox.hatmap&At.UP;break;case"hat_down":l=t.xbox.hatmap&At.DOWN;break;case"hat":l=t.xbox.hatmap;break;case"start_button":l=t.xbox.buttons.start?1:0;break;case"back_button":l=t.xbox.buttons.back?1:0;break;case"button_pressed":for(var h=0;h<this._current_buttons.length;++h)this._current_buttons[h]&&!this._previous_buttons[h]&&this.triggerSlot(s,At.buttons[h]);break}else switch(a.name){case"button_pressed":break;case"left_axis":case"right_axis":l=At.zero;break;default:l=0}this.setOutputData(s,l)}}}getGamepad(){var t=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!t)return null;var r=t.call(navigator),s=null;this._previous_buttons.set(this._current_buttons);for(var a=this.properties.gamepad_index;a<4;a++)if(r[a]){s=r[a];var l=this.xbox_mapping;l||(l=this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:At.CENTER}),l.axes.lx=s.axes[0],l.axes.ly=s.axes[1],l.axes.rx=s.axes[2],l.axes.ry=s.axes[3],l.axes.ltrigger=s.buttons[6].value,l.axes.rtrigger=s.buttons[7].value,l.hat="",l.hatmap=At.CENTER;for(var h=0;h<s.buttons.length;h++)if(this._current_buttons[h]=s.buttons[h].pressed,h<12)l.buttons[At.mapping_array[h]]=s.buttons[h].pressed,s.buttons[h].was_pressed&&this.trigger(At.mapping_array[h]+"_button_event");else switch(h){case 12:s.buttons[h].pressed&&(l.hat+="up",l.hatmap|=At.UP);break;case 13:s.buttons[h].pressed&&(l.hat+="down",l.hatmap|=At.DOWN);break;case 14:s.buttons[h].pressed&&(l.hat+="left",l.hatmap|=At.LEFT);break;case 15:s.buttons[h].pressed&&(l.hat+="right",l.hatmap|=At.RIGHT);break;case 16:l.buttons.home=s.buttons[h].pressed;break}return s.xbox=l,s}}onDrawBackground(t){if(!this.flags.collapsed){var r=this._left_axis,s=this._right_axis;t.strokeStyle="#88A",t.strokeRect((r[0]+1)*.5*this.size[0]-4,(r[1]+1)*.5*this.size[1]-4,8,8),t.strokeStyle="#8A8",t.strokeRect((s[0]+1)*.5*this.size[0]-4,(s[1]+1)*.5*this.size[1]-4,8,8);var a=this.size[1]/this._current_buttons.length;t.fillStyle="#AEB";for(var l=0;l<this._current_buttons.length;++l)this._current_buttons[l]&&t.fillRect(0,a*l,6,a)}}onGetOutputs(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",LiteGraph.EVENT],["b_button_event",LiteGraph.EVENT],["x_button_event",LiteGraph.EVENT],["y_button_event",LiteGraph.EVENT],["lb_button_event",LiteGraph.EVENT],["rb_button_event",LiteGraph.EVENT],["ls_button_event",LiteGraph.EVENT],["rs_button_event",LiteGraph.EVENT],["start_button_event",LiteGraph.EVENT],["back_button_event",LiteGraph.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",LiteGraph.EVENT]]}};g(ae,"title","Gamepad"),g(ae,"desc","gets the input of the gamepad"),g(ae,"zero",new Float32Array(2)),g(ae,"buttons",["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"]),g(ae,"mapping",{a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11}),g(ae,"mapping_array",["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"]);let GamepadInput=ae;GamepadInput.CENTER=0,GamepadInput.LEFT=1,GamepadInput.RIGHT=2,GamepadInput.UP=4,GamepadInput.DOWN=8,LiteGraph.registerNodeType("input/gamepad",GamepadInput);class Converter{constructor(){this.addInput("in",0),this.addOutput("out",0),this.size=[80,30]}onExecute(){var t=this.getInputData(0);if(t!=null&&this.outputs)for(var r=0;r<this.outputs.length;r++){var s=this.outputs[r];if(!(!s.links||!s.links.length)){var a=null;switch(s.name){case"number":a=t.length?t[0]:parseFloat(t);break;case"vec2":case"vec3":case"vec4":a=null;var l=1;switch(s.name){case"vec2":l=2;break;case"vec3":l=3;break;case"vec4":l=4;break}if(a=new Float32Array(l),t.length)for(var h=0;h<t.length&&h<a.length;h++)a[h]=t[h];else a[0]=parseFloat(t);break}this.setOutputData(r,a)}}}onGetOutputs(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]}}g(Converter,"title","Converter"),g(Converter,"desc","type A to type B"),LiteGraph.registerNodeType("math/converter",Converter);class Bypass{constructor(){this.addInput("in"),this.addOutput("out"),this.size=[80,30]}onExecute(){var t=this.getInputData(0);this.setOutputData(0,t)}}g(Bypass,"title","Bypass"),g(Bypass,"desc","removes the type"),LiteGraph.registerNodeType("math/bypass",Bypass);class ToNumber{constructor(){this.addInput("in"),this.addOutput("out")}onExecute(){var t=this.getInputData(0);this.setOutputData(0,Number(t))}}g(ToNumber,"title","to Number"),g(ToNumber,"desc","Cast to number"),LiteGraph.registerNodeType("math/to_number",ToNumber);class MathRange{constructor(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addOutput("clamped","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[120,50]}getTitle(){return this.flags.collapsed?(this._last_v||0).toFixed(2):this.title}onExecute(){let t;if(this.inputs)for(let h=0;h<this.inputs.length;h++){let u=this.inputs[h];t=this.getInputData(h),t!==void 0&&(this.properties[u.name]=t)}t=this.properties.in,(t==null||t.constructor!==Number)&&(t=0);var r=this.properties.in_min,s=this.properties.in_max,a=this.properties.out_min,l=this.properties.out_max;this._last_v=(t-r)/(s-r)*(l-a)+a,this.setOutputData(0,this._last_v),this.setOutputData(1,LiteGraph.clamp(this._last_v,a,l))}onDrawBackground(t){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"}onGetInputs(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]}}g(MathRange,"title","Range"),g(MathRange,"desc","Convert a number from one range to another"),LiteGraph.registerNodeType("math/range",MathRange);class MathRand{constructor(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}onExecute(){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var r=this.inputs[t],s=this.getInputData(t);s!==void 0&&(this.properties[r.name]=s)}var a=this.properties.min,l=this.properties.max;this._last_v=Math.random()*(l-a)+a,this.setOutputData(0,this._last_v)}onDrawBackground(t){this.outputs[0].label=(this._last_v||0).toFixed(3)}onGetInputs(){return[["min","number"],["max","number"]]}}g(MathRand,"title","Rand"),g(MathRand,"desc","Random number"),LiteGraph.registerNodeType("math/rand",MathRand);const Ee=class Qt{constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}static getValue(t,r){if(!Qt.data){Qt.data=new Float32Array(1024);for(var s=0;s<Qt.data.length;++s)Qt.data[s]=Math.random()}t=t%1024,t<0&&(t+=1024);var a=Math.floor(t);t-=a;var l=Qt.data[a],h=Qt.data[a==1023?0:a+1];return r&&(t=t*t*t*(t*(t*6-15)+10)),l*(1-t)+h*t}onExecute(){var t=this.getInputData(0)||0,r=this.properties.octaves||1,s=0,a=1,l=this.properties.seed||0;t+=l;for(var h=this.properties.speed||1,u=0,c=0;c<r&&(s+=Qt.getValue(t*(1+c)*h,this.properties.smooth)*a,u+=a,a*=this.properties.persistence,!(a<.001));++c);s/=u;var _=this.properties.min,d=this.properties.max;this._last_v=s*(d-_)+_,this.setOutputData(0,this._last_v)}onDrawBackground(t){this.outputs[0].label=(this._last_v||0).toFixed(3)}};g(Ee,"title","Noise"),g(Ee,"desc","Random number with temporal continuity"),g(Ee,"data",null);let MathNoise=Ee;LiteGraph.registerNodeType("math/noise",MathNoise);class MathSpikes{constructor(){this.addOutput("out","number"),this.addProperty("min_time",1),this.addProperty("max_time",2),this.addProperty("duration",.2),this.size=[90,30],this._remaining_time=0,this._blink_time=0}onExecute(){var t=this.graph.elapsed_time;this._remaining_time-=t,this._blink_time-=t;var r=0;if(this._blink_time>0){var s=this._blink_time/this.properties.duration;r=1/(Math.pow(s*8-4,4)+1)}this._remaining_time<0?(this._remaining_time=Math.random()*(this.properties.max_time-this.properties.min_time)+this.properties.min_time,this._blink_time=this.properties.duration,this.boxcolor="#FFF"):this.boxcolor="#000",this.setOutputData(0,r)}}LiteGraph.registerNodeType("math/spikes",MathSpikes);class MathClamp{constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("min",0),this.addProperty("max",1)}onExecute(){var t=this.getInputData(0);t!=null&&(t=Math.max(this.properties.min,t),t=Math.min(this.properties.max,t),this.setOutputData(0,t))}getCode(){var t="";return this.isInputConnected(0)&&(t+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),t}}g(MathClamp,"title","Clamp"),g(MathClamp,"desc","Clamp number between min and max"),LiteGraph.registerNodeType("math/clamp",MathClamp);class MathLerp{constructor(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}onExecute(){var t=this.getInputData(0);t==null&&(t=0);var r=this.getInputData(1);r==null&&(r=0);var s=this.properties.f,a=this.getInputData(2);a!==void 0&&(s=a),this.setOutputData(0,t*(1-s)+r*s)}onGetInputs(){return[["f","number"]]}}g(MathLerp,"title","Lerp"),g(MathLerp,"desc","Linear Interpolation"),LiteGraph.registerNodeType("math/lerp",MathLerp);class MathAbs{constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}onExecute(){var t=this.getInputData(0);t!=null&&this.setOutputData(0,Math.abs(t))}}g(MathAbs,"title","Abs"),g(MathAbs,"desc","Absolute"),LiteGraph.registerNodeType("math/abs",MathAbs);class MathFloor{constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}onExecute(){var t=this.getInputData(0);t!=null&&this.setOutputData(0,Math.floor(t))}}g(MathFloor,"title","Floor"),g(MathFloor,"desc","Floor number to remove fractional part"),LiteGraph.registerNodeType("math/floor",MathFloor);class MathFrac{constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}onExecute(){var t=this.getInputData(0);t!=null&&this.setOutputData(0,t%1)}}g(MathFrac,"title","Frac"),g(MathFrac,"desc","Returns fractional part"),LiteGraph.registerNodeType("math/frac",MathFrac);class MathSmoothStep{constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.properties={A:0,B:1}}onExecute(){var t=this.getInputData(0);if(t!==void 0){var r=this.properties.A,s=this.properties.B;t=LiteGraph.clamp((t-r)/(s-r),0,1),t=t*t*(3-2*t),this.setOutputData(0,t)}}}g(MathSmoothStep,"title","Smoothstep"),g(MathSmoothStep,"desc","Smoothstep"),LiteGraph.registerNodeType("math/smoothstep",MathSmoothStep);class MathScale{constructor(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[80,30],this.addProperty("factor",1)}onExecute(){var t=this.getInputData(0);t!=null&&this.setOutputData(0,t*this.properties.factor)}}g(MathScale,"title","Scale"),g(MathScale,"desc","v * factor"),LiteGraph.registerNodeType("math/scale",MathScale);class Gate{constructor(){this.addInput("v","boolean"),this.addInput("A"),this.addInput("B"),this.addOutput("out")}onExecute(){var t=this.getInputData(0);this.setOutputData(0,this.getInputData(t?1:2))}}g(Gate,"title","Gate"),g(Gate,"desc","if v is true, then outputs A, otherwise B"),LiteGraph.registerNodeType("math/gate",Gate);class MathAverageFilter{constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}onExecute(){var t=this.getInputData(0);t==null&&(t=0);var r=this._values.length;this._values[this._current%r]=t,this._current+=1,this._current>r&&(this._current=0);for(var s=0,a=0;a<r;++a)s+=this._values[a];this.setOutputData(0,s/r)}onPropertyChanged(t,r){r<1&&(r=1),this.properties.samples=Math.round(r);var s=this._values;this._values=new Float32Array(this.properties.samples),s.length<=this._values.length?this._values.set(s):this._values.set(s.subarray(0,this._values.length))}onPropertyChanged(t,r){t=="formula"&&(this.code_widget.value=r)}}g(MathAverageFilter,"title","Average"),g(MathAverageFilter,"desc","Average Filter"),LiteGraph.registerNodeType("math/average",MathAverageFilter);class MathTendTo{constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[80,30],this._value=null}onExecute(){var t=this.getInputData(0);t==null&&(t=0);var r=this.properties.factor;this._value==null?this._value=t:this._value=this._value*(1-r)+t*r,this.setOutputData(0,this._value)}}g(MathTendTo,"title","TendTo"),g(MathTendTo,"desc","moves the output value always closer to the input"),LiteGraph.registerNodeType("math/tendTo",MathTendTo);const _e=class ci{constructor(){this.addInput("A","number,array,object"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:ci.values}),this._func=ci.funcs[this.properties.OP],this._result=[]}getTitle(){return this.properties.OP=="max"||this.properties.OP=="min"?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"}setValue(t){typeof t=="string"&&(t=parseFloat(t)),this.properties.value=t}onPropertyChanged(t,r){var s;t=="OP"&&(this._func=ci.funcs[this.properties.OP],this._func||((s=console.warn)==null||s.call(console,"Unknown operation: "+this.properties.OP),this._func=function(a){return a}))}onExecute(){var t=this.getInputData(0),r=this.getInputData(1);t!=null?t.constructor===Number&&(this.properties.A=t):t=this.properties.A,r!=null?this.properties.B=r:r=this.properties.B;var s=ci.funcs[this.properties.OP],a;if(t.constructor===Number)a=0,a=s(t,r);else if(t.constructor===Array){a=this._result,a.length=t.length;for(let l=0;l<t.length;++l)a[l]=s(t[l],r)}else{a={};for(let l in t)a[l]=s(t[l],r)}this.setOutputData(0,a)}onDrawBackground(t){this.flags.collapsed||(t.font="40px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(this.properties.OP,this.size[0]*.5,(this.size[1]+LiteGraph.NODE_TITLE_HEIGHT)*.5),t.textAlign="left")}};g(_e,"title","Operation"),g(_e,"desc","Easy math operators"),g(_e,"values",["+","-","*","/","%","^","max","min"]),g(_e,"funcs",{"+":function(o,t){return o+t},"-":function(o,t){return o-t},x:function(o,t){return o*t},X:function(o,t){return o*t},"*":function(o,t){return o*t},"/":function(o,t){return o/t},"%":function(o,t){return o%t},"^":function(o,t){return Math.pow(o,t)},max:function(o,t){return Math.max(o,t)},min:function(o,t){return Math.min(o,t)}}),g(_e,"@OP",{type:"enum",title:"operation",values:_e.values}),g(_e,"size",[100,60]);let MathOperation=_e;LiteGraph.registerNodeType("math/operation",MathOperation),LiteGraph.registerSearchboxExtra("math/operation","MAX",{properties:{OP:"max"},title:"MAX()"}),LiteGraph.registerSearchboxExtra("math/operation","MIN",{properties:{OP:"min"},title:"MIN()"});class MathCompare{constructor(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}onExecute(){var t=this.getInputData(0),r=this.getInputData(1);t!==void 0?this.properties.A=t:t=this.properties.A,r!==void 0?this.properties.B=r:r=this.properties.B;for(var s=0,a=this.outputs.length;s<a;++s){var l=this.outputs[s];if(!(!l.links||!l.links.length)){var h;switch(l.name){case"A==B":h=t==r;break;case"A!=B":h=t!=r;break;case"A>B":h=t>r;break;case"A<B":h=t<r;break;case"A<=B":h=t<=r;break;case"A>=B":h=t>=r;break}this.setOutputData(s,h)}}}onGetOutputs(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]}}g(MathCompare,"title","Compare"),g(MathCompare,"desc","compares between two values"),LiteGraph.registerNodeType("math/compare",MathCompare),LiteGraph.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),LiteGraph.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),LiteGraph.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),LiteGraph.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),LiteGraph.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),LiteGraph.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"});const Ue=class qi{constructor(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","enum",{values:qi.values}),this.addWidget("combo","Cond.",this.properties.OP,{property:"OP",values:qi.values}),this.size=[80,60]}getTitle(){return"A "+this.properties.OP+" B"}onExecute(){var t=this.getInputData(0);t===void 0?t=this.properties.A:this.properties.A=t;var r=this.getInputData(1);r===void 0?r=this.properties.B:this.properties.B=r;var s=!0;switch(this.properties.OP){case">":s=t>r;break;case"<":s=t<r;break;case"==":s=t==r;break;case"!=":s=t!=r;break;case"<=":s=t<=r;break;case">=":s=t>=r;break;case"||":s=t||r;break;case"&&":s=t&&r;break}this.setOutputData(0,s),this.setOutputData(1,!s)}};g(Ue,"title","Condition"),g(Ue,"desc","evaluates condition between A and B"),g(Ue,"values",[">","<","==","!=","<=",">=","||","&&"]),g(Ue,"@OP",{type:"enum",title:"operation",values:Ue.values});let MathCondition=Ue;LiteGraph.registerNodeType("math/condition",MathCondition);class MathBranch{constructor(){this.addInput("in",0),this.addInput("cond","boolean"),this.addOutput("true",0),this.addOutput("false",0),this.size=[80,60]}onExecute(){var t=this.getInputData(0),r=this.getInputData(1);r?(this.setOutputData(0,t),this.setOutputData(1,null)):(this.setOutputData(0,null),this.setOutputData(1,t))}}g(MathBranch,"title","Branch"),g(MathBranch,"desc","If condition is true, outputs IN in true, otherwise in false"),LiteGraph.registerNodeType("math/branch",MathBranch);class MathAccumulate{constructor(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}onExecute(){this.properties.value===null&&(this.properties.value=0);var t=this.getInputData(0);t!==null?this.properties.value+=t:this.properties.value+=this.properties.increment,this.setOutputData(0,this.properties.value)}}g(MathAccumulate,"title","Accumulate"),g(MathAccumulate,"desc","Increments a value every time"),LiteGraph.registerNodeType("math/accumulate",MathAccumulate);class MathTrigonometry{constructor(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}onExecute(){var t=this.getInputData(0);t==null&&(t=0);var r=this.properties.amplitude,s=this.findInputSlot("amplitude");s!=-1&&(r=this.getInputData(s));var a=this.properties.offset;s=this.findInputSlot("offset"),s!=-1&&(a=this.getInputData(s));for(var l=0,h=this.outputs.length;l<h;++l){var u=this.outputs[l],c;switch(u.name){case"sin":c=Math.sin(t);break;case"cos":c=Math.cos(t);break;case"tan":c=Math.tan(t);break;case"asin":c=Math.asin(t);break;case"acos":c=Math.acos(t);break;case"atan":c=Math.atan(t);break}this.setOutputData(l,r*c+a)}}onGetInputs(){return[["v","number"],["amplitude","number"],["offset","number"]]}onGetOutputs(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]}}g(MathTrigonometry,"title","Trigonometry"),g(MathTrigonometry,"desc","Sin Cos Tan"),LiteGraph.registerNodeType("math/trigonometry",MathTrigonometry),LiteGraph.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),LiteGraph.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),LiteGraph.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"});class MathFormula{constructor(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.code_widget=this.addWidget("text","F(x,y)",this.properties.formula,function(t,r,s){s.properties.formula=t}),this.addWidget("toggle","allow",LiteGraph.allow_scripts,function(t){LiteGraph.allow_scripts=t}),this._func=null}onExecute(){if(LiteGraph.allow_scripts){var t=this.getInputData(0),r=this.getInputData(1);t!=null?this.properties.x=t:t=this.properties.x,r!=null?this.properties.y=r:r=this.properties.y;var s;try{(!this._func||this._func_code!=this.properties.formula)&&(this._func=new Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula),s=this._func(t,r,this.graph.globaltime),this.boxcolor=null}catch{this.boxcolor="red"}this.setOutputData(0,s)}}getTitle(){return this._func_code||"Formula"}onDrawBackground(){var t=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=t)}}g(MathFormula,"title","Formula"),g(MathFormula,"desc","Compute formula"),g(MathFormula,"size",[160,100]),LiteGraph.registerNodeType("math/formula",MathFormula);class Math3DVec2ToXY{constructor(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}onExecute(){var t=this.getInputData(0);t!=null&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]))}}g(Math3DVec2ToXY,"title","Vec2->XY"),g(Math3DVec2ToXY,"desc","vector 2 to components"),LiteGraph.registerNodeType("math3d/vec2-to-xy",Math3DVec2ToXY);class Math3DXYToVec2{constructor(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}onExecute(){var t=this.getInputData(0);t==null&&(t=this.properties.x);var r=this.getInputData(1);r==null&&(r=this.properties.y);var s=this._data;s[0]=t,s[1]=r,this.setOutputData(0,s)}}g(Math3DXYToVec2,"title","XY->Vec2"),g(Math3DXYToVec2,"desc","components to vector2"),LiteGraph.registerNodeType("math3d/xy-to-vec2",Math3DXYToVec2);class Math3DVec3ToXYZ{constructor(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}onExecute(){var t=this.getInputData(0);t!=null&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]),this.setOutputData(2,t[2]))}}g(Math3DVec3ToXYZ,"title","Vec3->XYZ"),g(Math3DVec3ToXYZ,"desc","vector 3 to components"),LiteGraph.registerNodeType("math3d/vec3-to-xyz",Math3DVec3ToXYZ);class Math3DXYZToVec3{constructor(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}onExecute(){var t=this.getInputData(0);t==null&&(t=this.properties.x);var r=this.getInputData(1);r==null&&(r=this.properties.y);var s=this.getInputData(2);s==null&&(s=this.properties.z);var a=this._data;a[0]=t,a[1]=r,a[2]=s,this.setOutputData(0,a)}}g(Math3DXYZToVec3,"title","XYZ->Vec3"),g(Math3DXYZToVec3,"desc","components to vector3"),LiteGraph.registerNodeType("math3d/xyz-to-vec3",Math3DXYZToVec3);class Math3DVec4ToXYZW{constructor(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}onExecute(){var t=this.getInputData(0);t!=null&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]),this.setOutputData(2,t[2]),this.setOutputData(3,t[3]))}}g(Math3DVec4ToXYZW,"title","Vec4->XYZW"),g(Math3DVec4ToXYZW,"desc","vector 4 to components"),LiteGraph.registerNodeType("math3d/vec4-to-xyzw",Math3DVec4ToXYZW);class Math3DXYZWToVec4{constructor(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}onExecute(){var t=this.getInputData(0);t==null&&(t=this.properties.x);var r=this.getInputData(1);r==null&&(r=this.properties.y);var s=this.getInputData(2);s==null&&(s=this.properties.z);var a=this.getInputData(3);a==null&&(a=this.properties.w);var l=this._data;l[0]=t,l[1]=r,l[2]=s,l[3]=a,this.setOutputData(0,l)}}g(Math3DXYZWToVec4,"title","XYZW->Vec4"),g(Math3DXYZWToVec4,"desc","components to vector4"),LiteGraph.registerNodeType("math3d/xyzw-to-vec4",Math3DXYZWToVec4);const DEG2RAD$1=.0174532925,$e=class Si{constructor(){this.addInput("T","vec3"),this.addInput("R","vec3"),this.addInput("S","vec3"),this.addOutput("mat4","mat4"),this.properties={T:[0,0,0],R:[0,0,0],S:[1,1,1],R_in_degrees:!0},this._result=mat4.create(),this._must_update=!0}onPropertyChanged(t,r){this._must_update=!0}onExecute(){var t=this._result,r=Si.temp_quat,s=Si.temp_mat4,a=Si.temp_vec3,l=this.getInputData(0),h=this.getInputData(1),u=this.getInputData(2);(this._must_update||l||h||u)&&(l=l||this.properties.T,h=h||this.properties.R,u=u||this.properties.S,mat4.identity(t),mat4.translate(t,t,l),this.properties.R_in_degrees?(a.set(h),vec3.scale(a,a,DEG2RAD$1),quat.fromEuler(r,a)):quat.fromEuler(r,h),mat4.fromQuat(s,r),mat4.multiply(t,t,s),mat4.scale(t,t,u)),this.setOutputData(0,t)}};g($e,"title","mat4"),g($e,"temp_quat",new Float32Array([0,0,0,1])),g($e,"temp_mat4",new Float32Array(16)),g($e,"temp_vec3",new Float32Array(3));let Math3DMat4=$e;LiteGraph.registerNodeType("math3d/mat4",Math3DMat4);const ze=class Zi{constructor(){this.addInput("A","number,vec3"),this.addInput("B","number,vec3"),this.addOutput("=","number,vec3"),this.addProperty("OP","+","enum",{values:Zi.values}),this._result=vec3.create()}getTitle(){return this.properties.OP=="max"||this.properties.OP=="min"?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"}onExecute(){var t,r=this.getInputData(0),s=this.getInputData(1);if(!(r==null||s==null)){r.constructor===Number&&(r=[r,r,r]),s.constructor===Number&&(s=[s,s,s]);var a=this._result;switch(this.properties.OP){case"+":a=vec3.add(a,r,s);break;case"-":a=vec3.sub(a,r,s);break;case"x":case"X":case"*":a=vec3.mul(a,r,s);break;case"/":a=vec3.div(a,r,s);break;case"%":a[0]=r[0]%s[0],a[1]=r[1]%s[1],a[2]=r[2]%s[2];break;case"^":a[0]=Math.pow(r[0],s[0]),a[1]=Math.pow(r[1],s[1]),a[2]=Math.pow(r[2],s[2]);break;case"max":a[0]=Math.max(r[0],s[0]),a[1]=Math.max(r[1],s[1]),a[2]=Math.max(r[2],s[2]);break;case"min":a[0]=Math.min(r[0],s[0]),a[1]=Math.min(r[1],s[1]),a[2]=Math.min(r[2],s[2]);break;case"dot":a=vec3.dot(r,s);break;case"cross":vec3.cross(a,r,s);break;default:(t=console.warn)==null||t.call(console,"Unknown operation: "+this.properties.OP)}this.setOutputData(0,a)}}onDrawBackground(t){this.flags.collapsed||(t.font="40px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(this.properties.OP,this.size[0]*.5,(this.size[1]+LiteGraph.NODE_TITLE_HEIGHT)*.5),t.textAlign="left")}};g(ze,"title","Operation"),g(ze,"desc","Easy math 3D operators"),g(ze,"values",["+","-","*","/","%","^","max","min","dot","cross"]),g(ze,"@OP",{type:"enum",title:"operation",values:ze.values}),g(ze,"size",[100,60]);let Math3DOperation=ze;LiteGraph.registerSearchboxExtra("math3d/operation","CROSS()",{properties:{OP:"cross"},title:"CROSS()"}),LiteGraph.registerSearchboxExtra("math3d/operation","DOT()",{properties:{OP:"dot"},title:"DOT()"}),LiteGraph.registerNodeType("math3d/operation",Math3DOperation);class Math3DVec3Scale{constructor(){this.addInput("in","vec3"),this.addInput("f","number"),this.addOutput("out","vec3"),this.properties={f:1},this._data=new Float32Array(3)}onExecute(){var t=this.getInputData(0);if(t!=null){var r=this.getInputData(1);r==null&&(r=this.properties.f);var s=this._data;s[0]=t[0]*r,s[1]=t[1]*r,s[2]=t[2]*r,this.setOutputData(0,s)}}}g(Math3DVec3Scale,"title","vec3_scale"),g(Math3DVec3Scale,"desc","scales the components of a vec3"),LiteGraph.registerNodeType("math3d/vec3-scale",Math3DVec3Scale);class Math3DVec3Length{constructor(){this.addInput("in","vec3"),this.addOutput("out","number")}onExecute(){var t=this.getInputData(0);if(t!=null){var r=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);this.setOutputData(0,r)}}}g(Math3DVec3Length,"title","vec3_length"),g(Math3DVec3Length,"desc","returns the module of a vector"),LiteGraph.registerNodeType("math3d/vec3-length",Math3DVec3Length);class Math3DVec3Normalize{constructor(){this.addInput("in","vec3"),this.addOutput("out","vec3"),this._data=new Float32Array(3)}onExecute(){var t=this.getInputData(0);if(t!=null){var r=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),s=this._data;s[0]=t[0]/r,s[1]=t[1]/r,s[2]=t[2]/r,this.setOutputData(0,s)}}}g(Math3DVec3Normalize,"title","vec3_normalize"),g(Math3DVec3Normalize,"desc","returns the vector normalized"),LiteGraph.registerNodeType("math3d/vec3-normalize",Math3DVec3Normalize);class Math3DVec3Lerp{constructor(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addInput("f","vec3"),this.addOutput("out","vec3"),this.properties={f:.5},this._data=new Float32Array(3)}onExecute(){var t=this.getInputData(0);if(t!=null){var r=this.getInputData(1);if(r!=null){var s=this.getInputOrProperty("f"),a=this._data;a[0]=t[0]*(1-s)+r[0]*s,a[1]=t[1]*(1-s)+r[1]*s,a[2]=t[2]*(1-s)+r[2]*s,this.setOutputData(0,a)}}}}g(Math3DVec3Lerp,"title","vec3_lerp"),g(Math3DVec3Lerp,"desc","returns the interpolated vector"),LiteGraph.registerNodeType("math3d/vec3-lerp",Math3DVec3Lerp);class Math3DVec3Dot{constructor(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addOutput("out","number")}onExecute(){var t=this.getInputData(0);if(t!=null){var r=this.getInputData(1);if(r!=null){var s=t[0]*r[0]+t[1]*r[1]+t[2]*r[2];this.setOutputData(0,s)}}}}g(Math3DVec3Dot,"title","vec3_dot"),g(Math3DVec3Dot,"desc","returns the dot product"),LiteGraph.registerNodeType("math3d/vec3-dot",Math3DVec3Dot);var Ct;if(glMatrix){class o{constructor(){this.addOutput("quat","quat"),this.properties={x:0,y:0,z:0,w:1,normalize:!1},this._value=quat.create()}onExecute(){this._value[0]=this.getInputOrProperty("x"),this._value[1]=this.getInputOrProperty("y"),this._value[2]=this.getInputOrProperty("z"),this._value[3]=this.getInputOrProperty("w"),this.properties.normalize&&quat.normalize(this._value,this._value),this.setOutputData(0,this._value)}onGetInputs(){return[["x","number"],["y","number"],["z","number"],["w","number"]]}}g(o,"title","Quaternion"),g(o,"desc","quaternion"),LiteGraph.registerNodeType("math3d/quaternion",o);class t{constructor(){this.addInputs([["degrees","number"],["axis","vec3"]]),this.addOutput("quat","quat"),this.properties={angle:90,axis:vec3.fromValues(0,1,0)},this._value=quat.create()}onExecute(){var _=this.getInputData(0);_==null&&(_=this.properties.angle);var d=this.getInputData(1);d==null&&(d=this.properties.axis);var f=quat.setAxisAngle(this._value,d,_*.0174532925);this.setOutputData(0,f)}}g(t,"title","Rotation"),g(t,"desc","quaternion rotation"),LiteGraph.registerNodeType("math3d/rotation",t);class r{constructor(){this.addInput("euler","vec3"),this.addOutput("quat","quat"),this.properties={euler:[0,0,0],use_yaw_pitch_roll:!1},this._degs=vec3.create(),this._value=quat.create()}onExecute(){var _=this.getInputData(0);_==null&&(_=this.properties.euler),vec3.scale(this._degs,_,DEG2RAD$1),this.properties.use_yaw_pitch_roll&&(this._degs=[this._degs[2],this._degs[0],this._degs[1]]);var d=quat.fromEuler(this._value,this._degs);this.setOutputData(0,d)}}g(r,"title","Euler->Quat"),g(r,"desc","Converts euler angles (in degrees) to quaternion"),LiteGraph.registerNodeType("math3d/euler_to_quat",r);class s{constructor(){this.addInput(["quat","quat"]),this.addOutput("euler","vec3"),this._value=vec3.create()}onExecute(){var _=this.getInputData(0);_&&(quat.toEuler(this._value,_),vec3.scale(this._value,this._value,DEG2RAD$1),this.setOutputData(0,this._value))}}g(s,"title","Euler->Quat"),g(s,"desc","Converts rotX,rotY,rotZ in degrees to quat"),LiteGraph.registerNodeType("math3d/quat_to_euler",s);class a{constructor(){this.addInputs([["vec3","vec3"],["quat","quat"]]),this.addOutput("result","vec3"),this.properties={vec:[0,0,1]}}onExecute(){var _=this.getInputData(0);_==null&&(_=this.properties.vec);var d=this.getInputData(1);d==null?this.setOutputData(_):this.setOutputData(0,vec3.transformQuat(vec3.create(),_,d))}}g(a,"title","Rot. Vec3"),g(a,"desc","rotate a point"),LiteGraph.registerNodeType("math3d/rotate_vec3",a);class l{constructor(){this.addInputs([["A","quat"],["B","quat"]]),this.addOutput("A*B","quat"),this._value=quat.create()}onExecute(){var _=this.getInputData(0);if(_!=null){var d=this.getInputData(1);if(d!=null){var f=quat.multiply(this._value,_,d);this.setOutputData(0,f)}}}}g(l,"title","Mult. Quat"),g(l,"desc","rotate quaternion"),LiteGraph.registerNodeType("math3d/mult-quat",l);class h{constructor(){this.addInputs([["A","quat"],["B","quat"],["factor","number"]]),this.addOutput("slerp","quat"),this.addProperty("factor",.5),this._value=quat.create()}onExecute(){var _=this.getInputData(0);if(_!=null){var d=this.getInputData(1);if(d!=null){var f=this.properties.factor;this.getInputData(2)!=null&&(f=this.getInputData(2));var m=quat.slerp(this._value,_,d,f);this.setOutputData(0,m)}}}}g(h,"title","Quat Slerp"),g(h,"desc","quaternion spherical interpolation"),LiteGraph.registerNodeType("math3d/quat-slerp",h);class u{constructor(){this.addInput("vec3","vec3"),this.addOutput("remap","vec3"),this.addOutput("clamped","vec3"),this.properties={clamp:!0,range_min:[-1,-1,0],range_max:[1,1,0],target_min:[-1,-1,0],target_max:[1,1,0]},this._value=vec3.create(),this._clamped=vec3.create()}onExecute(){var _=this.getInputData(0);_&&this._value.set(_);for(var d=this.properties.range_min,f=this.properties.range_max,m=this.properties.target_min,b=this.properties.target_max,T=0;T<3;++T){var L=f[T]-d[T];if(this._clamped[T]=LiteGraph.clamp(this._value[T],d[T],f[T]),L==0){this._value[T]=(m[T]+b[T])*.5;continue}var G=(this._value[T]-d[T])/L;this.properties.clamp&&(G=LiteGraph.clamp(G,0,1));var I=b[T]-m[T];this._value[T]=m[T]+G*I}this.setOutputData(0,this._value),this.setOutputData(1,this._clamped)}}g(u,"title","Remap Range"),g(u,"desc","remap a 3D range"),LiteGraph.registerNodeType("math3d/remap_range",u)}else LiteGraph.debug&&((Ct=console.warn)==null||Ct.call(console,"No glmatrix found, some Math3D nodes may not work"));function toString(o){if(o&&o.constructor===Object)try{return JSON.stringify(o)}catch{return String(o)}return String(o)}LiteGraph.wrapFunctionAsNode("string/toString",toString,[""],"string");function compare(o,t){return o==t}LiteGraph.wrapFunctionAsNode("string/compare",compare,["string","string"],"boolean");function concatenate(o,t){return o===void 0?t:t===void 0?o:o+""+t}LiteGraph.wrapFunctionAsNode("string/concatenate",concatenate,["string","string"],"string");function contains(o,t){return o===void 0||t===void 0?!1:o.indexOf(t)!=-1}LiteGraph.wrapFunctionAsNode("string/contains",contains,["string","string"],"boolean");function toUpperCase(o){return o!=null&&o.constructor===String?o.toUpperCase():o}LiteGraph.wrapFunctionAsNode("string/toUpperCase",toUpperCase,["string"],"string");function split(o,t){if(t==null&&(t=this.properties.separator),o==null)return[];if(o.constructor===String)return o.split(t||" ");if(o.constructor===Array){for(var r=[],s=0;s<o.length;++s)typeof o[s]=="string"&&(r[s]=o[s].split(t||" "));return r}return null}LiteGraph.wrapFunctionAsNode("string/split",split,["string,array","string"],"array",{separator:","});function toFixed(o){return o!=null&&o.constructor===Number?o.toFixed(this.properties.precision):o}LiteGraph.wrapFunctionAsNode("string/toFixed",toFixed,["number"],"string",{precision:0});class StringToTable{constructor(){this.addInput("","string"),this.addOutput("table","table"),this.addOutput("rows","number"),this.addProperty("value",""),this.addProperty("separator",","),this._table=null}onExecute(){var t=this.getInputData(0);if(t){var r=this.properties.separator||",";(t!=this._str||r!=this._last_separator)&&(this._last_separator=r,this._str=t,this._table=t.split(`
`).map(function(s){return s.trim().split(r)})),this.setOutputData(0,this._table),this.setOutputData(1,this._table?this._table.length:0)}}}g(StringToTable,"title","toTable"),g(StringToTable,"desc","Splits a string to table"),LiteGraph.registerNodeType("string/toTable",StringToTable);class Selector{constructor(){this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0}onDrawBackground(t){if(!this.flags.collapsed){t.fillStyle="#AFB";var r=(this.selected+1)*LiteGraph.NODE_SLOT_HEIGHT+6;t.beginPath(),t.moveTo(50,r),t.lineTo(50,r+LiteGraph.NODE_SLOT_HEIGHT),t.lineTo(34,r+LiteGraph.NODE_SLOT_HEIGHT*.5),t.fill()}}onExecute(){var t=this.getInputData(0);(t==null||t.constructor!==Number)&&(t=0),this.selected=t=Math.round(t)%(this.inputs.length-1);var r=this.getInputData(t+1);r!==void 0&&this.setOutputData(0,r)}onGetInputs(){return[["E",0],["F",0],["G",0],["H",0]]}}g(Selector,"title","Selector"),g(Selector,"desc","selects an output"),LiteGraph.registerNodeType("logic/selector",Selector);class Sequence{constructor(){this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(",")}onPropertyChanged(t,r){t=="sequence"&&(this.values=r.split(","))}onExecute(){var t=this.getInputData(1);t&&t!=this.current_sequence&&(this.values=t.split(","),this.current_sequence=t);var r=this.getInputData(0);r==null&&(r=0),this.index=r=Math.round(r)%this.values.length,this.setOutputData(0,this.values[r])}}g(Sequence,"title","Sequence"),g(Sequence,"desc","select one element from a sequence from a string"),LiteGraph.registerNodeType("logic/sequence",Sequence);class logicAnd{constructor(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}onExecute(){let t=!0;for(let r in this.inputs)if(!this.getInputData(r)){t=!1;break}this.setOutputData(0,t)}onGetInputs(){return[["and","boolean"]]}}g(logicAnd,"title","AND"),g(logicAnd,"desc","Return true if all inputs are true"),LiteGraph.registerNodeType("logic/AND",logicAnd);class logicOr{constructor(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}onExecute(){var t=!1;for(var r in this.inputs)if(this.getInputData(r)){t=!0;break}this.setOutputData(0,t)}onGetInputs(){return[["or","boolean"]]}}g(logicOr,"title","OR"),g(logicOr,"desc","Return true if at least one input is true"),LiteGraph.registerNodeType("logic/OR",logicOr);class logicNot{constructor(){this.properties={},this.addInput("in","boolean"),this.addOutput("out","boolean")}onExecute(){var t=!this.getInputData(0);this.setOutputData(0,t)}}g(logicNot,"title","NOT"),g(logicNot,"desc","Return the logical negation"),LiteGraph.registerNodeType("logic/NOT",logicNot);class logicCompare{constructor(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}onExecute(){var t=null,r=!0;for(var s in this.inputs)if(t===null)t=this.getInputData(s);else if(t!=this.getInputData(s)){r=!1;break}this.setOutputData(0,r)}onGetInputs(){return[["bool","boolean"]]}}g(logicCompare,"title","bool == bool"),g(logicCompare,"desc","Compare for logical equality"),LiteGraph.registerNodeType("logic/CompareBool",logicCompare);class logicBranch{constructor(){this.properties={},this.addInput("onTrigger",LiteGraph.ACTION),this.addInput("condition","boolean"),this.addOutput("true",LiteGraph.EVENT),this.addOutput("false",LiteGraph.EVENT),this.mode=LiteGraph.ON_TRIGGER}onExecute(t,r){var s=this.getInputData(1);s?this.triggerSlot(0):this.triggerSlot(1)}}g(logicBranch,"title","Branch"),g(logicBranch,"desc","Branch execution on condition"),LiteGraph.registerNodeType("logic/IF",logicBranch);class logicFor{constructor(){this.properties={},this.addInput("start","number"),this.addInput("nElements","number"),this.addInput("do",LiteGraph.ACTION),this.addInput("break",LiteGraph.ACTION),this.addOutput("do",LiteGraph.EVENT),this.addOutput("index","number"),this.started=!1,this.stopped=!1}onExecute(t){var r,s;if(this.started){for(var a=this.getInputData(0),l=this.getInputData(1),h=a;h<a+l;h++){if((r=console.debug)==null||r.call(console,"for cycle "+h),this.triggerSlot(0,t),this.stopped){(s=console.debug)==null||s.call(console,"for cycle stopped on index "+h);break}this.setOutputData(1,h)}this.started=!1,this.stopped=!0}}onAction(t){switch(t){case"break":this.stopped=!0;break;case"do":this.started=!0,this.stopped=!1,this.execute();break}}}g(logicFor,"title","FOR"),g(logicFor,"desc","Cycle FOR"),LiteGraph.registerNodeType("logic/CycleFOR",logicFor);class logicWhile{constructor(){this.properties={cycleLimit:999,checkOnStart:!0},this.addInput("do",LiteGraph.ACTION),this.addInput("condition","boolean"),this.addInput("break",LiteGraph.ACTION),this.addOutput("do",LiteGraph.EVENT),this.addOutput("index","number"),this.started=!1,this.stopped=!1,this.k=0,this.cond=!1,this.addWidget("toggle","checkOnStart",this.properties.checkOnStart,"checkOnStart")}onExecute(){this.setOutputData(1,this.k),this.cond=this.getInputData(1)}onAction(t,r){var s,a;switch(t){case"break":this.stopped=!0;break;case"do":this.started=!0,this.stopped=!1;var l=this.getInputOrProperty("checkOnStart");for(this.cond=!l||this.getInputData(1),this.k=0,cycleLimit=this.properties.cycleLimit||999;this.cond&&this.k<cycleLimit;){if((s=console.debug)==null||s.call(console,"while cycle "+this.k),this.setOutputData(1,this.k),this.triggerSlot(0,r),this.stopped){(a=console.debug)==null||a.call(console,"while cycle stopped on index "+k);break}this.k++,this.cond=this.getInputData(1,!0,!0)}this.k=0,this.setOutputData(1,this.k),this.cond=this.getInputData(1),this.started=!1,this.stopped=!0;break}}}g(logicWhile,"title","WHILE"),g(logicWhile,"desc","Cycle WHILE"),LiteGraph.registerNodeType("logic/CycleWHILE",logicWhile);const Et=class er{constructor(){this.addInput("A","Number"),this.addInput("B","Number"),this.addInput("C","Number"),this.addInput("D","Number"),this.values=[[],[],[],[]],this.properties={scale:2}}onExecute(){if(!this.flags.collapsed)for(var t=this.size,r=0;r<4;++r){var s=this.getInputData(r);if(s!=null){var a=this.values[r];a.push(s),a.length>t[0]&&a.shift()}}}onDrawBackground(t){if(!this.flags.collapsed){var r=this.size,s=.5*r[1]/this.properties.scale,a=er.colors,l=r[1]*.5;if(t.fillStyle="#000",t.fillRect(0,0,r[0],r[1]),t.strokeStyle="#555",t.beginPath(),t.moveTo(0,l),t.lineTo(r[0],l),t.stroke(),this.inputs)for(let h=0;h<4;++h){let u=this.values[h];if(!this.inputs[h]||!this.inputs[h].link)continue;t.strokeStyle=a[h],t.beginPath();let c=u[0]*s*-1+l;t.moveTo(0,LiteGraph.clamp(c,0,r[1]));for(let _=1;_<u.length&&_<r[0];++_)c=u[_]*s*-1+l,t.lineTo(_,LiteGraph.clamp(c,0,r[1]));t.stroke()}}}};g(Et,"title","Plot"),g(Et,"desc","Plots data over time"),g(Et,"colors",["#FFF","#F99","#9F9","#99F"]);let GraphicsPlot=Et;LiteGraph.registerNodeType("graphics/plot",GraphicsPlot);class GraphicsImage{constructor(){this.addOutput("frame","image"),this.properties={url:""}}onAdded(){this.properties.url!=""&&this.img==null&&this.loadImage(this.properties.url)}onDrawBackground(t){this.flags.collapsed||this.img&&this.size[0]>5&&this.size[1]>5&&this.img.width&&t.drawImage(this.img,0,0,this.size[0],this.size[1])}onExecute(){this.img||(this.boxcolor="#000"),this.img&&this.img.width?this.setOutputData(0,this.img):this.setOutputData(0,null),this.img&&this.img.dirty&&(this.img.dirty=!1)}onPropertyChanged(t,r){return this.properties[t]=r,t=="url"&&r!=""&&this.loadImage(r),!0}loadImage(t,r){if(t==""){this.img=null;return}this.img=document.createElement("img"),t.substr(0,4)=="http"&&LiteGraph.proxy&&(t=LiteGraph.proxy+t.substr(t.indexOf(":")+3)),this.img.src=t,this.boxcolor="#F95";var s=this;this.img.onload=function(){var a;r&&r(this),(a=console.log)==null||a.call(console,`Image loaded, size: ${s.img.width}x${s.img.height}`),this.dirty=!0,s.boxcolor="#9F9",s.setDirtyCanvas(!0)},this.img.onerror=function(){var a;(a=console.log)==null||a.call(console,"error loading the image:"+t)}}onWidget(t,r){r.name=="load"&&this.loadImage(this.properties.url)}onDropFile(t){var r=this;this._url&&URL.revokeObjectURL(this._url),this._url=URL.createObjectURL(t),this.properties.url=this._url,this.loadImage(this._url,function(s){r.size[1]=s.height/s.width*r.size[0]})}}g(GraphicsImage,"title","Image"),g(GraphicsImage,"desc","Image loader"),g(GraphicsImage,"widgets",[{name:"load",text:"Load",type:"button"}]),g(GraphicsImage,"supported_extensions",["jpg","jpeg","png","gif"]),LiteGraph.registerNodeType("graphics/image",GraphicsImage);class ColorPalette{constructor(){this.addInput("f","number"),this.addOutput("Color","color"),this.properties={colorA:"#444444",colorB:"#44AAFF",colorC:"#44FFAA",colorD:"#FFFFFF"}}onExecute(){var t=[];this.properties.colorA!=null&&t.push(hex2num(this.properties.colorA)),this.properties.colorB!=null&&t.push(hex2num(this.properties.colorB)),this.properties.colorC!=null&&t.push(hex2num(this.properties.colorC)),this.properties.colorD!=null&&t.push(hex2num(this.properties.colorD));var r=this.getInputData(0);if(r==null&&(r=.5),r>1?r=1:r<0&&(r=0),t.length!=0){var s=[0,0,0];if(r==0)s=t[0];else if(r==1)s=t[t.length-1];else{var a=(t.length-1)*r,l=t[Math.floor(a)],h=t[Math.floor(a)+1],u=a-Math.floor(a);s[0]=l[0]*(1-u)+h[0]*u,s[1]=l[1]*(1-u)+h[1]*u,s[2]=l[2]*(1-u)+h[2]*u}for(var c=0;c<s.length;c++)s[c]/=255;this.boxcolor=colorToString(s),this.setOutputData(0,s)}}}g(ColorPalette,"title","Palette"),g(ColorPalette,"desc","Generates a color"),LiteGraph.registerNodeType("color/palette",ColorPalette);class ImageFrame{constructor(){this.addInput("","image,canvas"),this.size=[200,200]}onDrawBackground(t){this.frame&&!this.flags.collapsed&&t.drawImage(this.frame,0,0,this.size[0],this.size[1])}onExecute(){this.frame=this.getInputData(0),this.setDirtyCanvas(!0)}onWidget(t,r){if(r.name=="resize"&&this.frame){var s=this.frame.width,a=this.frame.height;!s&&this.frame.videoWidth!=null&&(s=this.frame.videoWidth,a=this.frame.videoHeight),s&&a&&(this.size=[s,a]),this.setDirtyCanvas(!0,!0)}else r.name=="view"&&this.show()}show(){showElement&&this.frame&&showElement(this.frame)}}g(ImageFrame,"title","Frame"),g(ImageFrame,"desc","Frame viewer"),g(ImageFrame,"widgets",[{name:"resize",text:"Resize box",type:"button"},{name:"view",text:"View Image",type:"button"}]),LiteGraph.registerNodeType("graphics/frame",ImageFrame);class ImageFade{constructor(){this.addInputs([["img1","image"],["img2","image"],["fade","number"]]),this.addOutput("","image"),this.properties={fade:.5,width:512,height:512}}onAdded(){this.createCanvas();var t=this.canvas.getContext("2d");t.fillStyle="#000",t.fillRect(0,0,this.properties.width,this.properties.height)}createCanvas(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height}onExecute(){var t=this.canvas.getContext("2d"),r=this.getInputData(0);r!=null&&t.drawImage(r,0,0,this.canvas.width,this.canvas.height);var s=this.getInputData(2);s==null?s=this.properties.fade:this.properties.fade=s,t.globalAlpha=s;var a=this.getInputData(1);a!=null&&t.drawImage(a,0,0,this.canvas.width,this.canvas.height),t.globalAlpha=1,this.setOutputData(0,this.canvas),this.setDirtyCanvas(!0)}}g(ImageFade,"title","Image fade"),g(ImageFade,"desc","Fades between images"),g(ImageFade,"widgets",[{name:"resizeA",text:"Resize to A",type:"button"},{name:"resizeB",text:"Resize to B",type:"button"}]),LiteGraph.registerNodeType("graphics/imagefade",ImageFade);class ImageCrop{constructor(){this.addInput("","image"),this.addOutput("","image"),this.properties={width:256,height:256,x:0,y:0,scale:1},this.size=[50,20]}onAdded(){this.createCanvas()}createCanvas(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height}onExecute(){var t=this.getInputData(0);if(t)if(t.width){var r=this.canvas.getContext("2d");r.drawImage(t,-this.properties.x,-this.properties.y,t.width*this.properties.scale,t.height*this.properties.scale),this.setOutputData(0,this.canvas)}else this.setOutputData(0,null)}onDrawBackground(t){this.flags.collapsed||this.canvas&&t.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.size[0],this.size[1])}onPropertyChanged(t,r){var s;return this.properties[t]=r,t=="scale"?(this.properties[t]=parseFloat(r),this.properties[t]==0&&((s=console.error)==null||s.call(console,"Error in scale"),this.properties[t]=1)):this.properties[t]=parseInt(r),this.createCanvas(),!0}}g(ImageCrop,"title","Crop"),g(ImageCrop,"desc","Crop Image"),LiteGraph.registerNodeType("graphics/cropImage",ImageCrop);class CanvasNode{constructor(){this.addInput("clear",LiteGraph.ACTION),this.addOutput("","canvas"),this.properties={width:512,height:512,autoclear:!0},this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}onExecute(){var t=this.canvas,r=this.properties.width|0,s=this.properties.height|0;t.width!=r&&(t.width=r),t.height!=s&&(t.height=s),this.properties.autoclear&&this.ctx.clearRect(0,0,t.width,t.height),this.setOutputData(0,t)}onAction(t){t=="clear"&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}}g(CanvasNode,"title","Canvas"),g(CanvasNode,"desc","Canvas to render stuff"),LiteGraph.registerNodeType("graphics/canvas",CanvasNode);class DrawImageNode{constructor(){this.addInput("canvas","canvas"),this.addInput("img","image,canvas"),this.addInput("x","number"),this.addInput("y","number"),this.properties={x:0,y:0,opacity:1}}onExecute(){var t=this.getInputData(0);if(t){var r=this.getInputOrProperty("img");if(r){var s=this.getInputOrProperty("x"),a=this.getInputOrProperty("y"),l=t.getContext("2d");l.drawImage(r,s,a)}}}}g(DrawImageNode,"title","DrawImage"),g(DrawImageNode,"desc","Draws image into a canvas"),LiteGraph.registerNodeType("graphics/drawImage",DrawImageNode);class DrawRectangleNode{constructor(){this.addInput("canvas","canvas"),this.addInput("x","number"),this.addInput("y","number"),this.addInput("w","number"),this.addInput("h","number"),this.properties={x:0,y:0,w:10,h:10,color:"white",opacity:1}}onExecute(){var t=this.getInputData(0);if(t){var r=this.getInputOrProperty("x"),s=this.getInputOrProperty("y"),a=this.getInputOrProperty("w"),l=this.getInputOrProperty("h"),h=t.getContext("2d");h.fillRect(r,s,a,l)}}}g(DrawRectangleNode,"title","DrawRectangle"),g(DrawRectangleNode,"desc","Draws rectangle in canvas"),LiteGraph.registerNodeType("graphics/drawRectangle",DrawRectangleNode);class ImageVideo{constructor(){this.addInput("t","number"),this.addOutputs([["frame","image"],["t","number"],["d","number"]]),this.properties={url:"",use_proxy:!0}}onExecute(){if(this.properties.url&&(this.properties.url!=this._video_url&&this.loadVideo(this.properties.url),!(!this._video||this._video.width==0))){var t=this.getInputData(0);t&&t>=0&&t<=1&&(this._video.currentTime=t*this._video.duration,this._video.pause()),this._video.dirty=!0,this.setOutputData(0,this._video),this.setOutputData(1,this._video.currentTime),this.setOutputData(2,this._video.duration),this.setDirtyCanvas(!0)}}onStart(){this.play()}onStop(){this.stop()}loadVideo(t){this._video_url=t;var r=t.substr(0,10).indexOf(":"),s="";r!=-1&&(s=t.substr(0,r));var a="";s&&(a=t.substr(0,t.indexOf("/",s.length+3)),a=a.substr(s.length+3)),this.properties.use_proxy&&s&&LiteGraph.proxy&&a!=location.host&&(t=LiteGraph.proxy+t.substr(t.indexOf(":")+3)),this._video=document.createElement("video"),this._video.src=t,this._video.type="type=video/mp4",this._video.muted=!0,this._video.autoplay=!0;var l=this;this._video.addEventListener("loadedmetadata",h=>{var u,c;(u=console.log)==null||u.call(console,"Duration: "+this.duration+" seconds"),(c=console.log)==null||c.call(console,"Size: "+this.videoWidth+","+this.videoHeight),l.setDirtyCanvas(!0),this.width=this.videoWidth,this.height=this.videoHeight}),this._video.addEventListener("progress",h=>{var u;(u=console.log)==null||u.call(console,"video loading...")}),this._video.addEventListener("error",h=>{var u,c,_,d,f;if((u=console.error)==null||u.call(console,"Error loading video: "+this.src),this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:(c=console.error)==null||c.call(console,"You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:(_=console.error)==null||_.call(console,"Network error - please try again later.");break;case this.error.MEDIA_ERR_DECODE:(d=console.error)==null||d.call(console,"Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:(f=console.error)==null||f.call(console,"Sorry, your browser can't play this video.");break}}),this._video.addEventListener("ended",h=>{var u;(u=console.log)==null||u.call(console,"Video Ended."),this.play()})}onPropertyChanged(t,r){return this.properties[t]=r,t=="url"&&r!=""&&this.loadVideo(r),!0}play(){this._video&&this._video.videoWidth&&this._video.play()}playPause(){this._video&&(this._video.paused?this.play():this.pause())}stop(){this._video&&(this._video.pause(),this._video.currentTime=0)}pause(){var t;this._video&&((t=console.log)==null||t.call(console,"Video paused"),this._video.pause())}onWidget(t,r){}}g(ImageVideo,"title","Video"),g(ImageVideo,"desc","Video playback"),g(ImageVideo,"widgets",[{name:"play",text:"PLAY",type:"minibutton"},{name:"stop",text:"STOP",type:"minibutton"},{name:"demo",text:"Demo video",type:"button"},{name:"mute",text:"Mute video",type:"button"}]),LiteGraph.registerNodeType("graphics/video",ImageVideo);const Qe=class Ni{constructor(){this.addOutput("Webcam","image"),this.properties={filterFacingMode:!1,facingMode:"user"},this.boxcolor="black",this.frame=0}openStream(){var t;if(!navigator.mediaDevices.getUserMedia){(t=console.log)==null||t.call(console,"getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0;var r={audio:!1,video:this.properties.filterFacingMode?{facingMode:this.properties.facingMode}:!0};navigator.mediaDevices.getUserMedia(r).then(this.streamReady.bind(this)).catch(a);var s=this;function a(l){var h;(h=console.log)==null||h.call(console,"Webcam rejected",l),s._webcam_stream=!1,Ni.is_webcam_open=!1,s.boxcolor="red",s.trigger("stream_error")}}closeStream(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var r=0;r<t.length;++r)t[r].stop();Ni.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}}onPropertyChanged(t,r){t=="facingMode"&&(this.properties.facingMode=r,this.closeStream(),this.openStream())}onRemoved(){this.closeStream()}streamReady(t){this._webcam_stream=t,this.boxcolor="green";var r=this._video;r||(r=document.createElement("video"),r.autoplay=!0,r.srcObject=t,this._video=r,r.onloadedmetadata=function(s){var a;(a=console.log)==null||a.call(console,s),Ni.is_webcam_open=!0}),this.trigger("stream_ready",r)}onExecute(){if(this._webcam_stream==null&&!this._waiting_confirmation&&this.openStream(),!(!this._video||!this._video.videoWidth)){this._video.frame=++this.frame,this._video.width=this._video.videoWidth,this._video.height=this._video.videoHeight,this.setOutputData(0,this._video);for(var t=1;t<this.outputs.length;++t)if(this.outputs[t])switch(this.outputs[t].name){case"width":this.setOutputData(t,this._video.videoWidth);break;case"height":this.setOutputData(t,this._video.videoHeight);break}}}getExtraMenuOptions(){var t=this,r=t.properties.show?"Hide Frame":"Show Frame";return[{content:r,callback:function(){t.properties.show=!t.properties.show}}]}onDrawBackground(t){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._video&&(t.save(),t.drawImage(this._video,0,0,this.size[0],this.size[1]),t.restore())}onGetOutputs(){return[["width","number"],["height","number"],["stream_ready",LiteGraph.EVENT],["stream_closed",LiteGraph.EVENT],["stream_error",LiteGraph.EVENT]]}};g(Qe,"title","Webcam"),g(Qe,"desc","Webcam image"),g(Qe,"is_webcam_open",!1);let ImageWebcam=Qe;LiteGraph.registerNodeType("graphics/webcam",ImageWebcam);const DDS=(function(){var o=542327876,t=131072,r=512,s=4;function a(A){return A.charCodeAt(0)+(A.charCodeAt(1)<<8)+(A.charCodeAt(2)<<16)+(A.charCodeAt(3)<<24)}function l(A){return String.fromCharCode(A&255,A>>8&255,A>>16&255,A>>24&255)}var h=a("DXT1"),u=a("DXT3"),c=a("DXT5"),_=31,d=0,f=1,m=2,b=3,T=4,L=7,G=20,I=21,O=27;function E(A,B,$,H){for(var F=new Uint16Array(4),W=new Uint16Array($*H),z=0,U=0,V=0,X=0,J=0,pe=0,q=0,Z=0,K=0,Q=$/4,xt=H/4,It=0;It<xt;It++)for(var ri=0;ri<Q;ri++)V=B+4*(It*Q+ri),F[0]=A[V],F[1]=A[V+1],X=F[0]&31,J=F[0]&2016,pe=F[0]&63488,q=F[1]&31,Z=F[1]&2016,K=F[1]&63488,F[2]=5*X+3*q>>3|5*J+3*Z>>3&2016|5*pe+3*K>>3&63488,F[3]=5*q+3*X>>3|5*Z+3*J>>3&2016|5*K+3*pe>>3&63488,z=A[V+2],U=It*4*$+ri*4,W[U]=F[z&3],W[U+1]=F[z>>2&3],W[U+2]=F[z>>4&3],W[U+3]=F[z>>6&3],U+=$,W[U]=F[z>>8&3],W[U+1]=F[z>>10&3],W[U+2]=F[z>>12&3],W[U+3]=F[z>>14],z=A[V+3],U+=$,W[U]=F[z&3],W[U+1]=F[z>>2&3],W[U+2]=F[z>>4&3],W[U+3]=F[z>>6&3],U+=$,W[U]=F[z>>8&3],W[U+1]=F[z>>10&3],W[U+2]=F[z>>12&3],W[U+3]=F[z>>14];return W}function D(A){for(var B=0,$=A.length,H=0;B<$;B+=4)H=A[B],A[B]=A[B+2],A[B+2]=H}function N(A,B,$,H){var F=new Int32Array($,0,_),W,z,U,V,X,J,pe,q,Z,K,Q,xt,It;if(F[d]!=o)return console.error("Invalid magic number in DDS header"),0;if(!F[G]&s)return console.error("Unsupported format, must contain a FourCC code"),0;switch(W=F[I],W){case h:z=8,U=B?B.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case u:z=16,U=B?B.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case c:z=16,U=B?B.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:z=4,W=null,U=A.RGBA}if(Q=1,F[m]&t&&H!==!1&&(Q=Math.max(1,F[L])),V=F[T],X=F[b],pe=F[f]+4,q=!!(F[O+1]&r),q)for(It=0;It<6;++It){V=F[T],X=F[b];for(var xt=0;xt<Q;++xt)W?(J=Math.max(4,V)/4*Math.max(4,X)/4*z,K=new Uint8Array($,pe,J),A.compressedTexImage2D(A.TEXTURE_CUBE_MAP_POSITIVE_X+It,xt,U,V,X,0,K)):(A.pixelStorei(A.UNPACK_FLIP_Y_WEBGL,!1),J=V*X*z,K=new Uint8Array($,pe,J),D(K),A.texImage2D(A.TEXTURE_CUBE_MAP_POSITIVE_X+It,xt,U,V,X,0,A.RGBA,A.UNSIGNED_BYTE,K)),pe+=J,V*=.5,X*=.5}else if(B){A.pixelStorei(A.UNPACK_FLIP_Y_WEBGL,!0);for(var xt=0;xt<Q;++xt)W?(J=Math.max(4,V)/4*Math.max(4,X)/4*z,K=new Uint8Array($,pe,J),A.compressedTexImage2D(A.TEXTURE_2D,xt,U,V,X,0,K)):(J=V*X*z,K=new Uint8Array($,pe,J),D(K),A.texImage2D(A.TEXTURE_2D,xt,U,V,X,0,U,A.UNSIGNED_BYTE,K)),pe+=J,V*=.5,X*=.5}else if(W==h)J=Math.max(4,V)/4*Math.max(4,X)/4*z,K=new Uint16Array($),Z=E(K,pe/2,V,X),A.texImage2D(A.TEXTURE_2D,0,A.RGB,V,X,0,A.RGB,A.UNSIGNED_SHORT_5_6_5,Z),H&&A.generateMipmap(A.TEXTURE_2D);else return console.error("No manual decoder for",l(W),"and no native support"),0;return Q}function C(A,B){var $=new Int32Array(A,0,_),H,F,W,z,U,V,X,J,pe,q,Z,K;if($[d]!=o)return console.error("Invalid magic number in DDS header"),0;if(!$[G]&s)return console.error("Unsupported format, must contain a FourCC code"),0;switch(H=$[I],H){case h:F=8,W="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case u:F=16,W="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case c:F=16,W="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:F=4,W="RGBA"}q=1,$[m]&t&&loadMipmaps!==!1&&(q=Math.max(1,$[L])),z=$[T],U=$[b],X=$[f]+4,J=!!($[O+1]&r);var Q=[];if(J)for(var K=0;K<6;++K){z=$[T],U=$[b];for(var Z=0;Z<q;++Z)H?(V=Math.max(4,z)/4*Math.max(4,U)/4*F,pe=new Uint8Array(A,X,V),Q.push({tex:"TEXTURE_CUBE_MAP",face:K,mipmap:Z,internalFormat:W,width:z,height:U,offset:0,dataOffset:X,dataLength:V})):(V=z*U*F,pe=new Uint8Array(A,X,V),D(pe),Q.push({tex:"TEXTURE_CUBE_MAP",face:K,mipmap:Z,internalFormat:W,width:z,height:U,offset:0,type:"UNSIGNED_BYTE",dataOffset:X,dataLength:V})),X+=V,z*=.5,U*=.5}else for(var Z=0;Z<q;++Z)V=Math.max(4,z)/4*Math.max(4,U)/4*F,pe=new Uint8Array(A,X,V),Q.push({tex:"TEXTURE_2D",mipmap:Z,internalFormat:W,width:z,height:U,offset:0,type:"UNSIGNED_BYTE",dataOffset:X,dataLength:V}),X+=V,z*=.5,U*=.5;return Q}function R(A,B,$,H,F,W){var z=new XMLHttpRequest;return z.open("GET",$,!0),z.responseType="arraybuffer",z.onload=function(){if(this.status==200){var U=new Int32Array(this.response,0,_),V=!!(U[O+1]&r),X=V?A.TEXTURE_CUBE_MAP:A.TEXTURE_2D;A.bindTexture(X,H);var J=N(A,B,this.response,F);A.texParameteri(X,A.TEXTURE_MAG_FILTER,A.LINEAR),A.texParameteri(X,A.TEXTURE_MIN_FILTER,J>1?A.LINEAR_MIPMAP_LINEAR:A.LINEAR),A.bindTexture(X,null),H.texture_type=X,H.width=U[T],H.height=U[b]}W&&W(H)},z.send(null),H}function S(A,B,$,H,F){var W=new Int32Array($,0,_),z=!!(W[O+1]&r),U=z?A.TEXTURE_CUBE_MAP:A.TEXTURE_2D;H.handler,A.bindTexture(U,H.handler);var V=N(A,B,$,F);return A.texParameteri(U,A.TEXTURE_MAG_FILTER,A.LINEAR),A.texParameteri(U,A.TEXTURE_MIN_FILTER,V>1?A.LINEAR_MIPMAP_LINEAR:A.LINEAR),z&&(A.texParameteri(U,A.TEXTURE_WRAP_S,A.CLAMP_TO_EDGE),A.texParameteri(U,A.TEXTURE_WRAP_T,A.CLAMP_TO_EDGE)),A.bindTexture(U,null),H.handler&&(H.texture_type=U,H.width=W[T],H.height=W[b]),H}function P(A){var B=new Int32Array(A,0,_),$=!!(B[O+1]&r),H=$?"TEXTURE_CUBE_MAP":"TEXTURE_2D",F=C(A),W={type:H,buffers:F,data:A,width:B[T],height:B[b]};return W}function M(A,W,$,H){var F=A.createTexture(),W=A.getExtension("WEBGL_compressed_texture_s3tc");return R(A,W,$,F,!0,H),F}return{dxtToRgb565:E,uploadDDSLevels:N,loadDDSTextureEx:R,loadDDSTexture:M,loadDDSTextureFromMemoryEx:S,getDDSTextureFromMemoryEx:P}})();class Editor{constructor(t,r={}){const s=this.root=document.createElement("div");s.className="litegraph litegraph-editor",s.innerHTML=`
        <div class="header">
            <div class="tools tools-left"></div>
            <div class="tools tools-right"></div>
        </div>
        <div class="content">
            <div class="editor-area">
                <canvas class="graphcanvas" width="1000" height="500" tabindex="10"></canvas>
            </div>
        </div>
        <div class="footer">
            <div class="tools tools-left"></div>
            <div class="tools tools-right"></div>
        </div>`,this.tools=s.querySelector(".tools"),this.content=s.querySelector(".content"),this.footer=s.querySelector(".footer");const a=this.canvas=s.querySelector(".graphcanvas"),l=this.graph=new LGraph,h=this.graphcanvas=new LGraphCanvas(a,l);h.background_image="imgs/grid.png",l.onAfterExecute=()=>{h.draw(!0)},h.onDropItem=this.onDropItem.bind(this),this.addLoadCounter(),this.addToolsButton("playnode_button","Play","imgs/icon-play.png",this.onPlayButton.bind(this),".tools-right"),this.addToolsButton("playstepnode_button","Step","imgs/icon-playstep.png",this.onPlayStepButton.bind(this),".tools-right"),r.skip_livemode||this.addToolsButton("livemode_button","Live","imgs/icon-record.png",this.onLiveButton.bind(this),".tools-right"),r.skip_maximize||this.addToolsButton("maximize_button","","imgs/icon-maximize.png",this.onFullscreenButton.bind(this),".tools-right"),r.miniwindow&&this.addMiniWindow(300,200);const u=document.getElementById(t);if(u)u==null||u.appendChild(s);else throw new Error("Editor has no parentElement to bind to");l.onPlayEvent=()=>{const c=this.root.querySelector("#playnode_button");c.innerHTML='<img src="imgs/icon-stop.png"/> Stop'},l.onStopEvent=()=>{const c=this.root.querySelector("#playnode_button");c.innerHTML='<img src="imgs/icon-play.png"/> Play'},h.resize()}addLoadCounter(){const t=document.createElement("div");t.className="headerpanel loadmeter toolbar-widget",t.innerHTML=`
            <div class="cpuload">
                <strong>CPU</strong> 
                <div class="bgload">
                    <div class="fgload"></div>
                </div>
            </div>
            <div class="gpuload">
                <strong>GFX</strong> 
                <div class="bgload">
                    <div class="fgload"></div>
                </div>
            </div>`,this.root.querySelector(".header .tools-left").appendChild(t);var r=this;setInterval(()=>{t.querySelector(".cpuload .fgload").style.width=`${2*r.graph.execution_time*90}px`,r.graph.status==LGraph.STATUS_RUNNING?t.querySelector(".gpuload .fgload").style.width=`${r.graphcanvas.render_time*10*90}px`:t.querySelector(".gpuload .fgload").style.width="4px"},200)}addToolsButton(t,r,s,a,l=".tools"){const h=this.createButton(r,s,a);h.id=t,this.root.querySelector(l).appendChild(h)}createButton(t,r,s){const a=document.createElement("button");return r&&(a.innerHTML=`<img src="${r}"/> `),a.classList.add("btn"),a.innerHTML+=t,s&&a.addEventListener("click",s),a}onLoadButton(){var t=this.graphcanvas.createPanel("Load session",{closable:!0});this.root.appendChild(t)}onSaveButton(){}onPlayButton(){var t=this.graph;t.status==LGraph.STATUS_STOPPED?t.start():t.stop()}onPlayStepButton(){var t=this.graph;t.runStep(1),this.graphcanvas.draw(!0,!0)}onLiveButton(){var t=!this.graphcanvas.live_mode;this.graphcanvas.switchLiveMode(!0),this.graphcanvas.draw();var r=this.root.querySelector("#livemode_button");r.innerHTML=t?'<img src="imgs/icon-gear.png"/> Edit':'<img src="imgs/icon-record.png"/> Live'}onDropItem(t){for(var r=this,s=0;s<t.dataTransfer.files.length;++s){var a=t.dataTransfer.files[s],l=LGraphCanvas.getFileExtension(a.name),h=new FileReader;l=="json"&&(h.onload=u=>{var c=JSON.parse(u.target.result);r.graph.configure(c)},h.readAsText(a))}}goFullscreen(){if(this.root.requestFullscreen)this.root.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT);else if(this.root.mozRequestFullscreen)this.root.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT);else if(this.root.webkitRequestFullscreen)this.root.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);else throw new Error("Fullscreen not supported");var t=this;setTimeout(()=>{t.graphcanvas.resize()},100)}onFullscreenButton(){this.isFullscreen()?this.exitFullscreen():this.goFullscreen()}addMiniWindow(t,r){var s=document.createElement("div");s.className="litegraph miniwindow",s.innerHTML=`<canvas class="graphcanvas" width="${t}" height="${r}" tabindex="10"></canvas>`;var a=s.querySelector("canvas"),l=this,h=new LGraphCanvas(a,this.graph);h.show_info=!1,h.background_image="imgs/grid.png",h.scale=.25,h.allow_dragnodes=!1,h.allow_interaction=!1,h.render_shadows=!1,h.max_zoom=.25,this.miniwindow_graphcanvas=h,h.onClear=()=>{h.scale=.25,h.allow_dragnodes=!1,h.allow_interaction=!1},h.onRenderBackground=function(c,_){_.strokeStyle="#567";var d=l.graphcanvas.convertOffsetToCanvas([0,0]),f=l.graphcanvas.convertOffsetToCanvas([l.graphcanvas.canvas.width,l.graphcanvas.canvas.height]);d=this.convertCanvasToOffset(d),f=this.convertCanvasToOffset(f),_.lineWidth=1,_.strokeRect(Math.floor(d[0])+.5,Math.floor(d[1])+.5,Math.floor(f[0]-d[0]),Math.floor(f[1]-d[1]))},s.style.position="absolute",s.style.top="4px",s.style.right="4px";var u=document.createElement("div");u.className="corner-button",u.innerHTML="&#10060;",u.addEventListener("click",c=>{h.setGraph(null),s.parentNode.removeChild(s)}),s.appendChild(u),this.root.querySelector(".content").appendChild(s)}addMultiview(){var t=this.canvas;let r;if(this.graphcanvas2){this.graphcanvas2.setGraph(null,!0),this.graphcanvas2.viewport=null,this.graphcanvas2=null,this.graphcanvas.viewport=null,this.graphcanvas.setGraph(null,!0),this.graphcanvas=null,r=new LGraphCanvas(t,this.graph),r.background_image="imgs/grid.png",this.graphcanvas=r,window.graphcanvas=this.graphcanvas;return}this.graphcanvas.ctx.fillStyle="black",this.graphcanvas.ctx.fillRect(0,0,t.width,t.height),this.graphcanvas.viewport=[0,0,t.width*.5-2,t.height],r=new LGraphCanvas(t,this.graph),r.background_image="imgs/grid.png",this.graphcanvas2=r,this.graphcanvas2.viewport=[t.width*.5,0,t.width*.5,t.height]}isFullscreen(){return document.fullscreenElement||document.mozRequestFullscreen||document.webkitRequestFullscreen||!1}exitFullscreen(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullscreen?document.mozCancelFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}}var gl$1=null;typeof global=="object"&&(global.LiteGraph=LiteGraph),typeof window=="object"&&(window.LiteGraph=LiteGraph);var Nt;(Nt=LiteGraph.info)==null||Nt.call(LiteGraph,"LiteGraph included");var webgl_canvas=null;LiteGraph.node_images_path="../nodes_data/";var editor=new Editor("main",{miniwindow:!1});window.graphcanvas=editor.graphcanvas,window.graph=editor.graph,updateEditorHiPPICanvas(),window.addEventListener("resize",function(){editor.graphcanvas.resize(),updateEditorHiPPICanvas()}),window.onbeforeunload=function(){var o=JSON.stringify(graph.serialize());localStorage.setItem("litegraphg demo backup",o)};function updateEditorHiPPICanvas(){const o=window.devicePixelRatio;if(o==1)return;const t=editor.canvas.parentNode.getBoundingClientRect(),{width:r,height:s}=t;return editor.canvas.width=r*o,editor.canvas.height=s*o,editor.canvas.style.width=r+"px",editor.canvas.style.height=s+"px",editor.canvas.getContext("2d").scale(o,o),editor.canvas}LiteGraph.allow_scripts=!0;var elem=document.createElement("span");elem.id="LGEditorTopBarSelector",elem.className="selector",elem.innerHTML="",elem.innerHTML+="Demo <select><option>Empty</option></select> <button class='btn' id='save'>Save</button><button class='btn' id='load'>Load</button><button class='btn' id='download'>Download</button> | <button class='btn' id='webgl'>WebGL</button> <button class='btn' id='multiview'>Multiview</button>",editor.tools.appendChild(elem);var select=elem.querySelector("select");select.addEventListener("change",function(o){var t=this.options[this.selectedIndex],r=t.dataset.url;r?graph.load(r):t.callback?t.callback():graph.clear()}),elem.querySelector("#save").addEventListener("click",function(){var o;(o=console.log)==null||o.call(console,"saved"),localStorage.setItem("graphdemo_save",JSON.stringify(graph.serialize()))}),elem.querySelector("#load").addEventListener("click",function(){var o,t=localStorage.getItem("graphdemo_save");t&&graph.configure(JSON.parse(t)),(o=console.log)==null||o.call(console,"loaded")}),elem.querySelector("#download").addEventListener("click",function(){var o=JSON.stringify(graph.serialize()),t=new Blob([o]),r=URL.createObjectURL(t),s=document.createElement("a");s.setAttribute("href",r),s.setAttribute("download","graph.JSON"),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(function(){URL.revokeObjectURL(r)},1e3*60)}),elem.querySelector("#webgl").addEventListener("click",enableWebGL),elem.querySelector("#multiview").addEventListener("click",function(){editor.addMultiview()});function addDemo(o,t){var r=document.createElement("option");t.constructor===String?r.dataset.url=t:r.callback=t,r.innerHTML=o,select.appendChild(r)}addDemo("Features","examples/features.json"),addDemo("Benchmark","examples/benchmark.json"),addDemo("Subgraph","examples/subgraph.json"),addDemo("Audio","examples/audio.json"),addDemo("Audio Delay","examples/audio_delay.json"),addDemo("Audio Reverb","examples/audio_reverb.json"),addDemo("MIDI Generation","examples/midi_generation.json"),addDemo("Copy Paste","examples/copypaste.json"),addDemo("autobackup",function(){var o=localStorage.getItem("litegraphg demo backup");if(o){var t=JSON.parse(o);graph.configure(t)}});function enableWebGL(){if(webgl_canvas){webgl_canvas.style.display=webgl_canvas.style.display=="none"?"block":"none";return}let o=["./libs/gl-matrix-min.js","./libs/litegl.js"];async function t(s){var a,l;if(o.length===0)return r();try{await import(s),(a=console.log)==null||a.call(console,`${s} loaded successfully`)}catch(h){(l=console.error)==null||l.call(console,`Error loading ${s}: ${h}`)}}o.forEach(s=>t(s));const r=()=>{var s,a,l,h;if((s=console.log)==null||s.call(console,this.src),!window.GL){(a=LiteGraph.warn)==null||a.call(LiteGraph,"GL doesn't exist");return}webgl_canvas=document.createElement("canvas"),webgl_canvas.width=400,webgl_canvas.height=300,webgl_canvas.style.position="absolute",webgl_canvas.style.top="0px",webgl_canvas.style.right="0px",webgl_canvas.style.border="1px solid #AAA",webgl_canvas.addEventListener("click",function(){var c=webgl_canvas.parentNode.getBoundingClientRect();webgl_canvas.width!=c.width?(webgl_canvas.width=c.width,webgl_canvas.height=c.height):(webgl_canvas.width=400,webgl_canvas.height=300)});var u=document.querySelector(".editor-area");if(u.appendChild(webgl_canvas),gl$1=GL.create({canvas:webgl_canvas}),!gl$1){(l=LiteGraph.warn)==null||l.call(LiteGraph,"gl doesn't exist");return}o=["../src/nodes/gltextures.js","../src/nodes/glfx.js","../src/nodes/glshaders.js","../src/nodes/geometry.js"],o.forEach(c=>t(c)),editor.graph.onBeforeStep=()=>{gl$1.clearColor(0,0,0,0),gl$1.clear(gl$1.COLOR_BUFFER_BIT|gl$1.DEPTH_BUFFER_BIT),gl$1.viewport(0,0,gl$1.canvas.width,gl$1.canvas.height)},(h=console.log)==null||h.call(console,"webgl ready")}}const global$1={gl:gl$1};var Rt,Mt,Ft;if((Ft=window.requestAnimationFrame)!=null||(window.requestAnimationFrame=(Mt=(Rt=window.mozRequestAnimationFrame)!=null?Rt:window.webkitRequestAnimationFrame)!=null?Mt:function(o){setTimeout(o,1e3/60)}),typeof glMatrix=="undefined")throw new Error("litegl.js requires gl-matrix to work. It must be included before litegl.");var GL$1=new class{constructor(){this.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0},this.reverse=null,this.LEFT_MOUSE_BUTTON=0,this.MIDDLE_MOUSE_BUTTON=1,this.RIGHT_MOUSE_BUTTON=2,this.LEFT_MOUSE_BUTTON_MASK=1,this.RIGHT_MOUSE_BUTTON_MASK=2,this.MIDDLE_MOUSE_BUTTON_MASK=4,this.last_context_id=0,this.COLOR_BUFFER_BIT=16384,this.DEPTH_BUFFER_BIT=256,this.STENCIL_BUFFER_BIT=1024,this.TEXTURE_2D=3553,this.TEXTURE_CUBE_MAP=34067,this.TEXTURE_3D=32879,this.TEXTURE_MAG_FILTER=10240,this.TEXTURE_MIN_FILTER=10241,this.TEXTURE_WRAP_S=10242,this.TEXTURE_WRAP_T=10243,this.BYTE=5120,this.UNSIGNED_BYTE=5121,this.SHORT=5122,this.UNSIGNED_SHORT=5123,this.INT=5124,this.UNSIGNED_INT=5125,this.FLOAT=5126,this.HALF_FLOAT_OES=36193,this.HALF_FLOAT=5131,this.DEPTH_COMPONENT16=33189,this.DEPTH_COMPONENT24=33190,this.DEPTH_COMPONENT32F=36012,this.FLOAT_VEC2=35664,this.FLOAT_VEC3=35665,this.FLOAT_VEC4=35666,this.INT_VEC2=35667,this.INT_VEC3=35668,this.INT_VEC4=35669,this.BOOL=35670,this.BOOL_VEC2=35671,this.BOOL_VEC3=35672,this.BOOL_VEC4=35673,this.FLOAT_MAT2=35674,this.FLOAT_MAT3=35675,this.FLOAT_MAT4=35676,this.TYPE_LENGTH={},this.TYPE_LENGTH[this.FLOAT]=this.TYPE_LENGTH[this.INT]=this.TYPE_LENGTH[this.BYTE]=this.TYPE_LENGTH[this.BOOL]=1,this.TYPE_LENGTH[this.FLOAT_VEC2]=this.TYPE_LENGTH[this.INT_VEC2]=this.TYPE_LENGTH[this.BOOL_VEC2]=2,this.TYPE_LENGTH[this.FLOAT_VEC3]=this.TYPE_LENGTH[this.INT_VEC3]=this.TYPE_LENGTH[this.BOOL_VEC3]=3,this.TYPE_LENGTH[this.FLOAT_VEC4]=this.TYPE_LENGTH[this.INT_VEC4]=this.TYPE_LENGTH[this.BOOL_VEC4]=4,this.TYPE_LENGTH[this.FLOAT_MAT3]=9,this.TYPE_LENGTH[this.FLOAT_MAT4]=16,this.SAMPLER_2D=35678,this.SAMPLER_3D=35679,this.SAMPLER_CUBE=35680,this.DEPTH_COMPONENT=6402,this.ALPHA=6406,this.RGB=6407,this.RGBA=6408,this.LUMINANCE=6409,this.LUMINANCE_ALPHA=6410,this.DEPTH_STENCIL=34041,this.UNSIGNED_INT_24_8_WEBGL=34042,this.R8=33321,this.R16F=33325,this.R32F=33326,this.R8UI=33330,this.RG8=33323,this.RG16F=33327,this.RG32F=33328,this.RGB8=32849,this.SRGB8=35905,this.RGB565=36194,this.R11F_G11F_B10F=35898,this.RGB9_E5=35901,this.RGB16F=34843,this.RGB32F=34837,this.RGB8UI=36221,this.RGBA8=32856,this.RGB5_A1=32855,this.RGBA16F=34842,this.RGBA32F=34836,this.RGBA8UI=36220,this.RGBA16I=36232,this.RGBA16UI=36214,this.RGBA32I=36226,this.RGBA32UI=36208,this.NEAREST=9728,this.LINEAR=9729,this.NEAREST_MIPMAP_NEAREST=9984,this.LINEAR_MIPMAP_NEAREST=9985,this.NEAREST_MIPMAP_LINEAR=9986,this.LINEAR_MIPMAP_LINEAR=9987,this.REPEAT=10497,this.CLAMP_TO_EDGE=33071,this.MIRRORED_REPEAT=33648,this.ZERO=0,this.ONE=1,this.SRC_COLOR=768,this.ONE_MINUS_SRC_COLOR=769,this.SRC_ALPHA=770,this.ONE_MINUS_SRC_ALPHA=771,this.DST_ALPHA=772,this.ONE_MINUS_DST_ALPHA=773,this.DST_COLOR=774,this.ONE_MINUS_DST_COLOR=775,this.SRC_ALPHA_SATURATE=776,this.CONSTANT_COLOR=32769,this.ONE_MINUS_CONSTANT_COLOR=32770,this.CONSTANT_ALPHA=32771,this.ONE_MINUS_CONSTANT_ALPHA=32772,this.VERTEX_SHADER=35633,this.FRAGMENT_SHADER=35632,this.FRONT=1028,this.BACK=1029,this.FRONT_AND_BACK=1032,this.NEVER=512,this.LESS=513,this.EQUAL=514,this.LEQUAL=515,this.GREATER=516,this.NOTEQUAL=517,this.GEQUAL=518,this.ALWAYS=519,this.KEEP=7680,this.REPLACE=7681,this.INCR=7682,this.DECR=7683,this.INCR_WRAP=34055,this.DECR_WRAP=34056,this.INVERT=5386,this.STREAM_DRAW=35040,this.STATIC_DRAW=35044,this.DYNAMIC_DRAW=35048,this.ARRAY_BUFFER=34962,this.ELEMENT_ARRAY_BUFFER=34963,this.POINTS=0,this.LINES=1,this.LINE_LOOP=2,this.LINE_STRIP=3,this.TRIANGLES=4,this.TRIANGLE_STRIP=5,this.TRIANGLE_FAN=6,this.CW=2304,this.CCW=2305,this.CULL_FACE=2884,this.DEPTH_TEST=2929,this.BLEND=3042,this.temp_vec3=vec3.create(),this.temp2_vec3=vec3.create(),this.temp_vec4=vec4.create(),this.temp_quat=quat.create(),this.temp_mat3=mat3.create(),this.temp_mat4=mat4.create(),this.dragging=!1,this.last_pos=[0,0]}isPowerOfTwo(o){return Math.log(o)/Math.log(2)%1==0}nearestPowerOfTwo(o){return Math.pow(2,Math.round(Math.log(o)/Math.log(2)))}polarToCartesian(o,t,r,s){return o=o||vec3.create(),o[0]=s*Math.sin(r)*Math.cos(t),o[1]=s*Math.cos(r),o[2]=s*Math.sin(r)*Math.sin(t),o}cartesianToPolar(o,t,r,s){return o=o||vec3.create(),o[2]=Math.sqrt(t*t+r*r+s*s),o[0]=Math.atan2(t,s),o[1]=Math.acos(s/o[2]),o}cloneObject(o,t){if(o.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";t=t||{};for(var r in o){var s=o[r];if(s===null){t[r]=null;continue}switch(s.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:t[r]=new s.constructor(s);break;case Boolean:case Number:case String:t[r]=s;break;case Array:t[r]=s.concat();break;case Object:t[r]=GL$1.cloneObject(s);break}}return t}createCanvas(o,t){var r=document.createElement("canvas");return r.width=o,r.height=t,r}cloneCanvas(o){var t=document.createElement("canvas");t.width=o.width,t.height=o.height;var r=t.getContext("2d");return r.drawImage(o,0,0),t}extendClass(o,t){for(var r in t)o.hasOwnProperty(r)||(o[r]=t[r]);if(t.prototype)for(var s=Object.getOwnPropertyNames(t.prototype),r=0;r<s.length;++r){var a=s[r];o.prototype.hasOwnProperty(a)||(t.prototype.__lookupGetter__(a)?o.prototype.__defineGetter__(a,t.prototype.__lookupGetter__(a)):o.prototype[a]=t.prototype[a],t.prototype.__lookupSetter__(a)&&o.prototype.__defineSetter__(a,t.prototype.__lookupSetter__(a)))}o.hasOwnProperty("superclass")||Object.defineProperty(o,"superclass",{get:function(){return t},enumerable:!1})}RGBToHex(o,t,r){return o=Math.min(255,o*255)|0,t=Math.min(255,t*255)|0,r=Math.min(255,r*255)|0,"#"+((1<<24)+(o<<16)+(t<<8)+r).toString(16).slice(1)}HUEToRGB(o,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?o+(t-o)*6*r:r<1/2?t:r<2/3?o+(t-o)*(2/3-r)*6:o}HSLToRGB(o,t,r,s){var a,l,h;if(s=s||vec3.create(),t==0)a=l=h=r;else{var u=r<.5?r*(1+t):r+t-r*t,c=2*r-u;a=HUEToRGB(c,u,o+1/3),l=HUEToRGB(c,u,o),h=HUEToRGB(c,u,o-1/3)}return s[0]=a,s[1]=l,s[2]=h,s}linearizeArray(o,t){if(o.constructor===t)return o;if(o.constructor!==Array)return t=t||Float32Array,new t(o);t=t||Float32Array;for(var r=o[0].length,s=o.length*r,a=new t(s),l=0;l<o.length;++l)for(var h=0;h<r;++h)a[l*r+h]=o[l][h];return a}create(o={}){var t=null;if(o.canvas)if(typeof o.canvas=="string"){if(t=document.getElementById(o.canvas),!t)throw"Canvas element not found: "+o.canvas}else t=o.canvas;else{var r=null;if(o.container&&(r=o.container.constructor===String?document.querySelector(o.container):o.container),r&&!o.width){var s=r.getBoundingClientRect();o.width=s.width,o.height=s.height}t=GL$1.createCanvas(o.width||800,o.height||600),r&&r.appendChild(t)}"alpha"in o||(o.alpha=!1);var a=null,l=null;if(o.version==2?l=["webgl2","experimental-webgl2"]:o.version==1||o.version===void 0?l=["webgl","experimental-webgl"]:o.version===0&&(l=["webgl2","experimental-webgl2","webgl","experimental-webgl"]),!l)throw"Incorrect WebGL version, must be 1 or 2";for(var h={alpha:o.alpha===void 0?!0:o.alpha,depth:o.depth===void 0?!0:o.depth,stencil:o.stencil===void 0?!0:o.stencil,antialias:o.antialias===void 0?!0:o.antialias,premultipliedAlpha:o.premultipliedAlpha===void 0?!0:o.premultipliedAlpha,preserveDrawingBuffer:o.preserveDrawingBuffer===void 0?!0:o.preserveDrawingBuffer},u=0;u<l.length;++u){try{a=t.getContext(l[u],h)}catch{}if(a)break}if(!a)throw t.getContext("webgl")?"WebGL supported but not with those parameters":"WebGL not supported";a.webgl_version=a.constructor.name==="WebGL2RenderingContext"?2:1,global$1.gl=a,t.is_webgl=!0,t.gl=a,a.context_id=this.last_context_id++;var c=a.getSupportedExtensions();a.extensions={};for(var u in c)a.extensions[c[u]]=a.getExtension(c[u]);if(a.derivatives_supported=a.extensions.OES_standard_derivatives!=null||a.webgl_version>1,a.webgl_version==1?a.HIGH_PRECISION_FORMAT=a.extensions.OES_texture_half_float?GL$1.HALF_FLOAT_OES:a.extensions.OES_texture_float?GL$1.FLOAT:GL$1.UNSIGNED_BYTE:a.HIGH_PRECISION_FORMAT=GL$1.HALF_FLOAT_OES,a.max_texture_units=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS),a._viewport_func?console.warn("Creating LiteGL context over the same canvas twice"):(a._viewport_func=a.viewport,a.viewport_data=new Float32Array([0,0,a.canvas.width,a.canvas.height]),a.viewport=function(E,D,N,C){var R=this.viewport_data;R[0]=E|0,R[1]=D|0,R[2]=N|0,R[3]=C|0,this._viewport_func(E,D,N,C)},a.getViewport=function(E){return E?(E[0]=a.viewport_data[0],E[1]=a.viewport_data[1],E[2]=a.viewport_data[2],E[3]=a.viewport_data[3],E):new Float32Array(a.viewport_data)},a.setViewport=function(E,D){a.viewport_data.set(E),D&&(a.viewport_data[1]=this.drawingBufferHeight-E[1]-E[3]),this._viewport_func(E[0],a.viewport_data[1],E[2],E[3])}),!GL$1.reverse){GL$1.reverse={};for(var u in a)a[u]&&a[u].constructor===Number&&(GL$1.reverse[a[u]]=u)}if(typeof glMatrix=="undefined")throw"glMatrix not found, LiteGL requires glMatrix to be included";var _=0;a.shaders={},a.textures={},a.meshes={},a.makeCurrent=function(){global$1.gl=this},a.execute=function(E){var D=global$1.gl;global$1.gl=this,E(),global$1.gl=D},a.animate=function(E){if(E===!1){global$1.cancelAnimationFrame(this._requestFrame_id),this._requestFrame_id=null;return}var D=global$1.requestAnimationFrame,N=getTime(),C=this;function R(){if(!a.destroyed){C._requestFrame_id=D(R);var S=getTime(),P=(S-N)*.001;if(C.mouse&&(C.mouse.last_buttons=C.mouse.buttons),C.onupdate&&C.onupdate(P),LEvent.trigger(C,"update",P),C.ondraw){var M=global$1.gl;global$1.gl=C,C.ondraw(),LEvent.trigger(C,"draw"),global$1.gl=M}N=S}}this._requestFrame_id=D(R)},a.destroy=function(){L&&(document.removeEventListener("keydown",L),document.removeEventListener("keyup",L)),this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.destroyed=!0,global$1.gl==this&&(global$1.gl=null)};var d=a.mouse={buttons:0,last_buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,clientx:0,clienty:0,isInsideRect:function(E,D,N,C,R){var S=this.y;return R&&(S=a.canvas.height-S),this.x>E&&this.x<E+N&&S>D&&S<D+C},isButtonPressed:function(E){if(E==GL$1.LEFT_MOUSE_BUTTON)return this.buttons&GL$1.LEFT_MOUSE_BUTTON_MASK;if(E==GL$1.MIDDLE_MOUSE_BUTTON)return this.buttons&GL$1.MIDDLE_MOUSE_BUTTON_MASK;if(E==GL$1.RIGHT_MOUSE_BUTTON)return this.buttons&GL$1.RIGHT_MOUSE_BUTTON_MASK},wasButtonPressed:function(E){var D=0;return E==GL$1.LEFT_MOUSE_BUTTON?D=GL$1.LEFT_MOUSE_BUTTON_MASK:E==GL$1.MIDDLE_MOUSE_BUTTON?D=GL$1.MIDDLE_MOUSE_BUTTON_MASK:E==GL$1.RIGHT_MOUSE_BUTTON&&(D=GL$1.RIGHT_MOUSE_BUTTON_MASK),this.buttons&D&&!(this.last_buttons&D)}};a.captureMouse=function(E,D){t.addEventListener("pointerdown",f),t.addEventListener("pointermove",f),t.addEventListener("dragstart",f),E&&t.addEventListener("wheel",f,!1),t.addEventListener("contextmenu",function(N){return N.preventDefault(),!1}),D&&this.captureTouch(!0)};function f(E){if(!a.ignore_events){var D=a.mouse.buttons;GL$1.augmentEvent(E,t),E.eventType=E.eventType||E.type;var N=getTime();if(d.dragging=E.dragging,d.position[0]=E.canvasx,d.position[1]=E.canvasy,d.x=E.canvasx,d.y=E.canvasy,d.mousex=E.mousex,d.mousey=E.mousey,d.canvasx=E.canvasx,d.canvasy=E.canvasy,d.clientx=E.mousex,d.clienty=E.mousey,d.buttons=E.buttons,d.left_button=!!(d.buttons&GL$1.LEFT_MOUSE_BUTTON_MASK),d.middle_button=!!(d.buttons&GL$1.MIDDLE_MOUSE_BUTTON_MASK),d.right_button=!!(d.buttons&GL$1.RIGHT_MOUSE_BUTTON_MASK),E.eventType=="pointerdown"){if(D==0){t.removeEventListener("pointermove",f);var C=t.ownerDocument;C.addEventListener("pointermove",f),C.addEventListener("pointerup",f)}_=N,a.onmousedown&&a.onmousedown(E),LEvent.trigger(a,"pointerdown")}else if(E.eventType=="pointermove")a.onmousemove&&a.onmousemove(E),LEvent.trigger(a,"pointermove",E);else if(E.eventType=="pointerup"){if(a.mouse.buttons==0){t.addEventListener("pointermove",f);var C=t.ownerDocument;C.removeEventListener("pointermove",f),C.removeEventListener("pointerup",f)}E.click_time=N-_,a.onmouseup&&a.onmouseup(E),LEvent.trigger(a,"pointerup",E)}else E.eventType=="wheel"?(E.type=="wheel"?E.wheel=-E.deltaY:E.wheel=E.wheelDeltaY!=null?E.wheelDeltaY:E.detail*-60,E.delta=E.wheelDelta!==void 0?E.wheelDelta/40:E.deltaY?-E.deltaY/3:0,a.onmousewheel&&a.onmousewheel(E),LEvent.trigger(a,"wheel",E)):E.eventType=="dragstart"&&(a.ondragstart&&a.ondragstart(E),LEvent.trigger(a,"dragstart",E));if(a.onmouse&&a.onmouse(E),!E.skip_preventDefault)return E.eventType!="pointermove"&&E.stopPropagation(),E.preventDefault(),!1}}var m=!1;a.captureTouch=function(E){m=E,t.addEventListener("touchstart",b,!0),t.addEventListener("touchmove",b,!0),t.addEventListener("touchend",b,!0),t.addEventListener("touchcancel",b,!0),t.addEventListener("gesturestart",T),t.addEventListener("gesturechange",T),t.addEventListener("gestureend",T)};function b(E){var D=E.changedTouches,N=D[0],C="";if(!(a.ontouch&&a.ontouch(E)===!0)&&LEvent.trigger(a,E.type,E)!==!0&&m&&!(E.touches.length&&E.changedTouches[0].identifier!==E.touches[0].identifier)&&!(D>1)){switch(E.type){case"touchstart":C="pointerdown";break;case"touchmove":C="pointermove";break;case"touchend":C="pointerup";break;default:return}var R=document.createEvent("MouseEvent");R.initMouseEvent(C,!0,!0,window,1,N.screenX,N.screenY,N.clientX,N.clientY,!1,!1,!1,!1,0,null),R.originalEvent=R,R.is_touch=!0,N.target.dispatchEvent(R),E.preventDefault()}}function T(E){E.eventType=E.type,!(a.ongesture&&a.ongesture(E)===!1)&&LEvent.trigger(a,E.type,E)!==!1&&E.preventDefault()}a.keys={};var L=null;a.captureKeys=function(E,D){if(L)return;a.keys={},D&&a.canvas,document.addEventListener("keydown",N),document.addEventListener("keyup",N);function N(C){G(C,E)}L=N};function G(E,D){E.eventType=E.type;var N=E.target.nodeName.toLowerCase();if(!(N==="input"||N==="textarea"||N==="select")){E.character=String.fromCharCode(E.keyCode).toLowerCase();var C=!1,R=GL$1.mapKeyCode(E.keyCode);R||(R=E.character),!E.altKey&&!E.ctrlKey&&!E.metaKey&&(R&&(a.keys[R]=E.type=="keydown"),C=a.keys[E.keyCode],a.keys[E.keyCode]=E.type=="keydown"),C!=a.keys[E.keyCode]&&(E.type=="keydown"&&a.onkeydown?a.onkeydown(E):E.type=="keyup"&&a.onkeyup&&a.onkeyup(E),LEvent.trigger(a,E.type,E)),a.onkey&&a.onkey(E),D&&(E.isChar||GL$1.blockable_keys[E.keyIdentifier||E.key])&&E.preventDefault()}}a.gamepads=null,a.captureGamepads=function(){var E=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;E&&(this.gamepads=E.call(navigator))},a.getGamepads=function(E){var D=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(D){var N=D.call(navigator);this.gamepads||(this.gamepads=[]);for(var C=0;C<4;C++){var R=N[C];if(R&&!E&&I(R),R&&!R.prev_buttons){R.prev_buttons=new Uint8Array(32);var S=new CustomEvent("gamepadconnected");S.eventType=S.type,S.gamepad=R,this.ongamepadconnected&&this.ongamepadconnected(S),LEvent.trigger(a,"gamepadconnected",S)}if(R)for(var P=0;P<R.buttons.length;++P){var M=R.buttons[P];if(M.was_pressed=!1,M.pressed&&!R.prev_buttons[P]){M.was_pressed=!0;var S=new CustomEvent("gamepadButtonDown");S.eventType=S.type,S.button=M,S.which=P,S.gamepad=R,a.onbuttondown&&a.onbuttondown(S),LEvent.trigger(a,"buttondown",S)}else if(!M.pressed&&R.prev_buttons[P]){var S=new CustomEvent("gamepadButtonUp");S.eventType=S.type,S.button=M,S.which=P,S.gamepad=R,a.onbuttondown&&a.onbuttondown(S),LEvent.trigger(a,"buttonup",S)}R.prev_buttons[P]=M.pressed?1:0}}return this.gamepads=N,N}};function I(E){var D=E.xbox||{axes:[],buttons:{},hat:""};D.axes.lx=E.axes[0],D.axes.ly=E.axes[1],D.axes.rx=E.axes[2],D.axes.ry=E.axes[3],D.axes.triggers=E.axes[4];for(var N=0;N<E.buttons.length;N++)switch(N){case 0:D.buttons.a=E.buttons[N].pressed;break;case 1:D.buttons.b=E.buttons[N].pressed;break;case 2:D.buttons.x=E.buttons[N].pressed;break;case 3:D.buttons.y=E.buttons[N].pressed;break;case 4:D.buttons.lb=E.buttons[N].pressed;break;case 5:D.buttons.rb=E.buttons[N].pressed;break;case 6:D.buttons.lt=E.buttons[N].pressed;break;case 7:D.buttons.rt=E.buttons[N].pressed;break;case 8:D.buttons.back=E.buttons[N].pressed;break;case 9:D.buttons.start=E.buttons[N].pressed;break;case 10:D.buttons.ls=E.buttons[N].pressed;break;case 11:D.buttons.rs=E.buttons[N].pressed;break;case 12:E.buttons[N].pressed&&(D.hat+="up");break;case 13:E.buttons[N].pressed&&(D.hat+="down");break;case 14:E.buttons[N].pressed&&(D.hat+="left");break;case 15:E.buttons[N].pressed&&(D.hat+="right");break;case 16:D.buttons.home=E.buttons[N].pressed;break}E.xbox=D}a.fullscreen=function(){var E=this.canvas;E.requestFullScreen?E.requestFullScreen():E.webkitRequestFullScreen?E.webkitRequestFullScreen():E.mozRequestFullScreen?E.mozRequestFullScreen():console.error("Fullscreen not supported")},a.snapshot=function(E,D,N,C,R){var S=GL$1.createCanvas(N,C),B=S.getContext("2d"),P=B.getImageData(0,0,S.width,S.height),M=new Uint8Array(N*C*4);if(a.readPixels(E,D,S.width,S.height,a.RGBA,a.UNSIGNED_BYTE,M),P.data.set(M),B.putImageData(P,0,0),R)return S;var A=GL$1.createCanvas(N,C),B=A.getContext("2d");return B.translate(0,C),B.scale(1,-1),B.drawImage(S,0,0),A};var O={};return a.loadTexture=function(E,D,N){if(this.textures[E])return this.textures[E];if(O[E])return null;var C=new Image;return C.url=E,C.onload=function(){var R=GL$1.Texture.fromImage(this,D);R.img=this,a.textures[this.url]=R,delete O[this.url],N&&N(R)},C.src=E,O[E]=!0,null},a.drawTexture=(function(){var E=mat3.create(),D=vec2.create(),N=vec2.create(),C=vec4.create(),R=vec4.fromValues(1,1,1,1),S=vec2.create(),P={u_texture:0,u_position:D,u_color:R,u_size:N,u_texture_area:C,u_viewport:S,u_transform:E};return(function(M,A,B,$,H,F,W,z,U,V,X){D[0]=A,D[1]=B,$===void 0&&($=M.width),H===void 0&&(H=M.height),N[0]=$,N[1]=H,F===void 0&&(F=0),W===void 0&&(W=0),z===void 0&&(z=M.width),U===void 0&&(U=M.height),C[0]=F/M.width,C[1]=W/M.height,C[2]=(F+z)/M.width,C[3]=(W+U)/M.height,S[0]=this.viewport_data[2],S[1]=this.viewport_data[3],V=V||Shader.getPartialQuadShader(this);var J=Mesh$1.getScreenQuad(this);M.bind(0),V.uniforms(P),X&&V.uniforms(X),V.draw(J,a.TRIANGLES)})})(),a.canvas.addEventListener("webglcontextlost",function(E){E.preventDefault(),a.context_lost=!0,a.onlosecontext&&a.onlosecontext(E)},!1),a.reset=function(){a.viewport(0,0,this.canvas.width,this.canvas.height),a.disable(a.BLEND),a.disable(a.CULL_FACE),a.disable(a.DEPTH_TEST),a.frontFace(a.CCW),a._current_texture_drawto=null,a._current_fbo_color=null,a._current_fbo_depth=null},a.dump=function(){console.log("userAgent: ",navigator.userAgent),console.log("Supported extensions:");var E=a.getSupportedExtensions();console.log(E.join(","));var D=["VENDOR","VERSION","MAX_VERTEX_ATTRIBS","MAX_VARYING_VECTORS","MAX_VERTEX_UNIFORM_VECTORS","MAX_VERTEX_TEXTURE_IMAGE_UNITS","MAX_FRAGMENT_UNIFORM_VECTORS","MAX_TEXTURE_SIZE","MAX_TEXTURE_IMAGE_UNITS"];console.log("WebGL info:");for(var N in D)console.log(" * "+D[N]+": "+a.getParameter(a[D[N]]));console.log("*************************************************")},a.reset(),a}mapKeyCode(o){var t={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};return t[o]||(o>=65&&o<=90?String.fromCharCode(o):null)}augmentEvent(o,t){var r=null;t=t||o.target||gl.canvas,r=t.getBoundingClientRect(),o.mousex=o.clientX-r.left,o.mousey=o.clientY-r.top,o.canvasx=o.mousex,o.canvasy=r.height-o.mousey,o.deltax=0,o.deltay=0,o.type=="pointerdown"?this.dragging=!0:o.type=="pointermove"||o.type=="pointerup"&&o.buttons==0&&(this.dragging=!1),o.movementX!==void 0&&!GL$1.isMobile()?(o.deltax=o.movementX,o.deltay=o.movementY):(o.deltax=o.mousex-this.last_pos[0],o.deltay=o.mousey-this.last_pos[1]),this.last_pos[0]=o.mousex,this.last_pos[1]=o.mousey,o.dragging=this.dragging,o.leftButton=!!(gl.mouse.buttons&GL$1.LEFT_MOUSE_BUTTON_MASK),o.middleButton=!!(gl.mouse.buttons&GL$1.MIDDLE_MOUSE_BUTTON_MASK),o.rightButton=!!(gl.mouse.buttons&GL$1.RIGHT_MOUSE_BUTTON_MASK),o.buttons_mask=0,o.leftButton&&(o.buttons_mask=1),o.middleButton&&(o.buttons_mask|=2),o.rightButton&&(o.buttons_mask|=4),o.isButtonPressed=function(s){return this.buttons_mask&1<<s}}isMobile(){return this.mobile!==void 0?this.mobile:global$1.navigator?navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/Android/i)?this.mobile=!0:this.mobile=!1:this.mobile=!1}};const EPSILON=1e-6;var typed_arrays=[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array];function typedToArray(){return Array.prototype.slice.call(this)}if(typed_arrays.forEach(function(o){o.prototype.toJSON||Object.defineProperty(o.prototype,"toJSON",{value:typedToArray,enumerable:!1})}),typeof performance!="undefined"?global$1.getTime=performance.now.bind(performance):global$1.getTime=Date.now.bind(Date),GL$1.getTime=global$1.getTime,typeof Image!="undefined"&&(Image.prototype.getPixels=function(){var o=document.createElement("canvas");o.width=this.width,o.height=this.height;var t=o.getContext("2d");return t.drawImage(this,0,0),t.getImageData(0,0,this.width,this.height).data}),String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(o){var t=this;for(var r in o)t=t.split(r).join(o[r]);return t},enumerable:!1}),String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var o=0,t,r,s;if(this.length==0)return o;for(t=0,s=this.length;t<s;++t)r=this.charCodeAt(t),o=(o<<5)-o+r,o|=0;return o},enumerable:!1}),Array.prototype.hasOwnProperty("clone")||Object.defineProperty(Array.prototype,"clone",{value:Array.prototype.concat,enumerable:!1}),Float32Array.prototype.hasOwnProperty("clone")||Object.defineProperty(Float32Array.prototype,"clone",{value:function(){return new Float32Array(this)},enumerable:!1}),global$1.HttpRequest=GL$1.request=function o(t,r,s,a,l){var h=!0;if(l&&l.async!==void 0&&(h=l.async),r){var u=null,c=[];for(var _ in r)c.push(_+"="+r[_]);u=c.join("&"),t=t+"?"+u}var d=new XMLHttpRequest;if(d.open("GET",t,h),d.onload=function(f){if(this.response,this.getResponseHeader("Content-Type"),this.status!=200){LEvent.trigger(d,"fail",this.status),a&&a(this.status);return}LEvent.trigger(d,"done",this.response),s&&s(this.response)},d.onerror=function(f){LEvent.trigger(d,"fail",f)},l){for(var _ in l)d[_]=l[_];l.binary&&(d.responseType="arraybuffer")}return d.send(),d},global$1.XMLHttpRequest&&(XMLHttpRequest.prototype.hasOwnProperty("done")||Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(o){return LEvent.bind(this,"done",function(t,r){o(r)}),this}}),XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(o){return LEvent.bind(this,"fail",function(t,r){o(r)}),this}})),typeof glMatrix=="undefined")throw new Error("You must include glMatrix on your project");Math.clamp=function(o,t,r){return t>o?t:r<o?r:o},vec3.create,vec3.create,vec3.ZERO=vec3.fromValues(0,0,0),vec3.FRONT=vec3.fromValues(0,0,-1),vec3.UP=vec3.fromValues(0,1,0),vec3.RIGHT=vec3.fromValues(1,0,0),vec2.rotate=function(o,t,r){var s=t[0],a=t[1],l=Math.cos(r),h=Math.sin(r);return o[0]=s*l-a*h,o[1]=s*h+a*l,o},vec3.zero=function(o){return o[0]=o[1]=0,o},vec2.perpdot=function(o,t){return o[1]*t[0]+-o[0]*t[1]},vec2.computeSignedAngle=function(o,t){return Math.atan2(vec2.perpdot(o,t),vec2.dot(o,t))},vec2.random=function(o,t){return t=t||1,o[0]=Math.random()*t,o[1]=Math.random()*t,o},vec3.zero=function(o){return o[0]=o[1]=o[2]=0,o},vec3.minValue=function(o){return o[0]<o[1]&&o[0]<o[2]?o[0]:o[1]<o[2]?o[1]:o[2]},vec3.maxValue=function(o){return o[0]>o[1]&&o[0]>o[2]?o[0]:o[1]>o[2]?o[1]:o[2]},vec3.minValue=function(o){return o[0]<o[1]&&o[0]<o[2]?o[0]:o[1]<o[2]?o[1]:o[2]},vec3.addValue=function(o,t,r){o[0]=t[0]+r,o[1]=t[1]+r,o[2]=t[2]+r},vec3.subValue=function(o,t,r){o[0]=t[0]-r,o[1]=t[1]-r,o[2]=t[2]-r},vec3.toArray=function(o){return[o[0],o[1],o[2]]},vec3.rotateX=function(o,t,r){var s=t[1],a=t[2],l=Math.cos(r),h=Math.sin(r);return o[0]=t[0],o[1]=s*l-a*h,o[2]=s*h+a*l,o},vec3.rotateY=function(o,t,r){var s=t[0],a=t[2],l=Math.cos(r),h=Math.sin(r);return o[0]=s*l-a*h,o[1]=t[1],o[2]=s*h+a*l,o},vec3.rotateZ=function(o,t,r){var s=t[0],a=t[1],l=Math.cos(r),h=Math.sin(r);return o[0]=s*l-a*h,o[1]=s*h+a*l,o[2]=t[2],o},vec3.angle=function(o,t){return Math.acos(vec3.dot(o,t))},vec3.signedAngle=function(o,t,r){var s=vec3.angle(o,t),a=o[1]*t[2]-o[2]*t[1],l=o[2]*t[0]-o[0]*t[2],h=o[0]*t[1]-o[1]*t[0],u=Math.sign(r[0]*a+r[1]*l+r[2]*h);return s*u},vec3.random=function(o,t){return t=t||1,o[0]=Math.random()*t,o[1]=Math.random()*t,o[2]=Math.random()*t,o},vec3.polarToCartesian=function(o,t){var r=t[0],s=t[1],a=t[2];return o[0]=r*Math.cos(s)*Math.sin(a),o[1]=r*Math.sin(s),o[2]=r*Math.cos(s)*Math.cos(a),o},vec3.reflect=function(o,t,r){var s=t[0],a=t[1],l=t[2];return vec3.scale(o,r,-2*vec3.dot(t,r)),o[0]+=s,o[1]+=a,o[2]+=l,o},vec4.random=function(o,t){return t=t||1,o[0]=Math.random()*t,o[1]=Math.random()*t,o[2]=Math.random()*t,o[3]=Math.random()*t,o},vec4.toArray=function(o){return[o[0],o[1],o[2],o[3]]},mat3.IDENTITY=mat3.create(),mat4.IDENTITY=mat4.create(),mat4.toArray=function(o){return[o[0],o[1],o[2],o[3],o[4],o[5],o[6],o[7],o[8],o[9],o[10],o[11],o[12],o[13],o[14],o[15]]},mat4.setUpAndOrthonormalize=function(o,t,r){t!=o&&mat4.copy(o,t);var s=o.subarray(0,3);vec3.normalize(o.subarray(4,7),r);var a=o.subarray(8,11);vec3.cross(s,r,a),vec3.normalize(s,s),vec3.cross(a,s,r),vec3.normalize(a,a)},mat4.multiplyVec3=function(o,t,r){var s=r[0],a=r[1],l=r[2];return o[0]=t[0]*s+t[4]*a+t[8]*l+t[12],o[1]=t[1]*s+t[5]*a+t[9]*l+t[13],o[2]=t[2]*s+t[6]*a+t[10]*l+t[14],o},mat4.projectVec3=function(o,t,r){var s=r[0],a=r[1],l=r[2],h=t[0]*s+t[4]*a+t[8]*l+t[12],u=t[1]*s+t[5]*a+t[9]*l+t[13],c=t[2]*s+t[6]*a+t[10]*l+t[14],_=t[3]*s+t[7]*a+t[11]*l+t[15];return o[0]=(h/_+1)/2,o[1]=(u/_+1)/2,o[2]=(c/_+1)/2,o},vec3.project=function(o,t,r,s){s=s||gl.viewport_data;var a=r,l=t[0],h=t[1],u=t[2],c=a[0]*l+a[4]*h+a[8]*u+a[12],_=a[1]*l+a[5]*h+a[9]*u+a[13],d=a[2]*l+a[6]*h+a[10]*u+a[14],f=a[3]*l+a[7]*h+a[11]*u+a[15],m=(c/f+1)/2,b=1-(_/f+1)/2,T=(d/f+1)/2;return o[0]=m*s[2]+s[0],o[1]=b*s[3]+s[1],o[2]=T,o};var unprojectMat=mat4.create(),unprojectVec=vec4.create();vec3.unproject=function(o,t,r,s){var a=unprojectMat,l=unprojectVec;return l[0]=(t[0]-s[0])*2/s[2]-1,l[1]=(t[1]-s[1])*2/s[3]-1,l[2]=2*t[2]-1,l[3]=1,!mat4.invert(a,r)||(vec4.transformMat4(l,l,a),l[3]===0)?null:(o[0]=l[0]/l[3],o[1]=l[1]/l[3],o[2]=l[2]/l[3],o)},mat4.rotateVec3=function(o,t,r){var s=r[0],a=r[1],l=r[2];return o[0]=t[0]*s+t[4]*a+t[8]*l,o[1]=t[1]*s+t[5]*a+t[9]*l,o[2]=t[2]*s+t[6]*a+t[10]*l,o},mat4.fromTranslationFrontTop=function(o,t,r,s){return vec3.cross(o.subarray(0,3),r,s),o.set(s,4),o.set(r,8),o.set(t,12),o},mat4.translationMatrix=function(o){var t=mat4.create();return t[12]=o[0],t[13]=o[1],t[14]=o[2],t},mat4.setTranslation=function(o,t){return o[12]=t[0],o[13]=t[1],o[14]=t[2],o},mat4.getTranslation=function(o,t){return o[0]=t[12],o[1]=t[13],o[2]=t[14],o},mat4.toRotationMat4=function(o,t){return mat4.copy(o,t),o[12]=o[13]=o[14]=0,o},mat4.swapRows=function(o,t,r,s){if(o!=t)return mat4.copy(o,t),o[4*r]=t[4*s],o[4*r+1]=t[4*s+1],o[4*r+2]=t[4*s+2],o[4*r+3]=t[4*s+3],o[4*s]=t[4*r],o[4*s+1]=t[4*r+1],o[4*s+2]=t[4*r+2],o[4*s+3]=t[4*r+3],o;var a=new Float32Array(matrix.subarray(r*4,r*5));return matrix.set(matrix.subarray(s*4,s*5),r*4),matrix.set(a,s*4),o},mat4.scaleAndAdd=function(o,t,r,s){return o[0]=t[0]+r[0]*s,o[1]=t[1]+r[1]*s,o[2]=t[2]+r[2]*s,o[3]=t[3]+r[3]*s,o[4]=t[4]+r[4]*s,o[5]=t[5]+r[5]*s,o[6]=t[6]+r[6]*s,o[7]=t[7]+r[7]*s,o[8]=t[8]+r[8]*s,o[9]=t[9]+r[9]*s,o[10]=t[10]+r[10]*s,o[11]=t[11]+r[11]*s,o[12]=t[12]+r[12]*s,o[13]=t[13]+r[13]*s,o[14]=t[14]+r[14]*s,o[15]=t[15]+r[15]*s,o},quat.fromAxisAngle=function(o,t){var r=quat.create();t=t*.5;var s=Math.sin(t);return r[0]=s*o[0],r[1]=s*o[1],r[2]=s*o[2],r[3]=Math.cos(t),r},quat.lookRotation=(function(){var o=vec3.create(),t=vec3.create(),r=vec3.create();return function(s,a,l){vec3.normalize(o,a),vec3.cross(t,l,o),vec3.normalize(t,t),vec3.cross(r,o,t);var h=t[0],u=t[1],c=t[2],_=r[0],d=r[1],f=r[2],m=o[0],b=o[1],T=o[2],L=h+d+T;if(L>0){var G=Math.sqrt(L+1);return s[3]=G*.5,G=.5/G,s[0]=(f-b)*G,s[1]=(m-c)*G,s[2]=(u-_)*G,s}if(h>=d&&h>=T){var I=Math.sqrt(1+h-d-T),O=.5/I;return s[0]=.5*I,s[1]=(u+_)*O,s[2]=(c+m)*O,s[3]=(f-b)*O,s}if(d>T){var E=Math.sqrt(1+d-h-T),D=.5/E;return s[0]=(_+u)*D,s[1]=.5*E,s[2]=(b+f)*D,s[3]=(m-c)*D,s}var N=Math.sqrt(1+T-h-d),C=.5/N;return s[0]=(m+c)*C,s[1]=(b+f)*C,s[2]=.5*N,s[3]=(u-_)*C,s}})(),quat.toEuler=function(o,t){var r=Math.atan2(2*t[1]*t[3]-2*t[0]*t[2],1-2*t[1]*t[1]-2*t[2]*t[2]),s=Math.asin(2*t[0]*t[1]+2*t[2]*t[3]),a=Math.atan2(2*t[0]*t[3]-2*t[1]*t[2],1-2*t[0]*t[0]-2*t[2]*t[2]);return o||(o=vec3.create()),vec3.set(o,r,s,a),o},quat.fromEuler=function(o,t){var r=t[0],s=t[1],a=t[2],l=Math.cos(r),h=Math.cos(s),u=Math.cos(a),c=Math.sin(r),_=Math.sin(s),d=Math.sin(a),f=Math.sqrt(1+l*h+l*u-c*_*d+h*u)*.5;f==0&&(f=1e-6);var m=(h*d+l*d+c*_*u)/(4*f),b=(c*h+c*u+l*_*d)/(4*f),T=(-c*d+l*_*u+_)/(4*f);return quat.set(o,m,b,T,f),quat.normalize(o,o),o},quat.fromMat4=function(o,t){var r=t[0]+t[5]+t[10];if(r>0){var s=Math.sqrt(r+1);o[3]=s*.5;var a=.5/s;o[0]=(t[9]-t[6])*a,o[1]=(t[2]-t[8])*a,o[2]=(t[4]-t[1])*a}else{var l=0;t[5]>t[0]&&(l=1),t[10]>t[l*4+l]&&(l=2);var h=(l+1)%3,u=(h+1)%3,s=Math.sqrt(t[l*4+l]-t[h*4+h]-t[u*4+u]+1);o[l]=.5*s;var a=.5/s;o[3]=(t[u*4+h]-t[h*4+u])*a,o[h]=(t[h*4+l]+t[l*4+h])*a,o[u]=(t[u*4+l]+t[l*4+u])*a}quat.normalize(o,o)},vec3.getMat3Column=function(o,t,r){return o[0]=t[r*3],o[1]=t[r*3+1],o[2]=t[r*3+2],o},mat3.setColumn=function(o,t,r){return o[r*3]=t[0],o[r*3+1]=t[1],o[r*3+2]=t[2],o},quat.fromMat3AndQuat=(function(){var o=mat3.create(),t=quat.create(),r=vec3.create(),s=vec3.create(),a=vec3.create(),l=vec3.create(),h=vec3.create(),u=vec3.create(),c=vec3.create(),_=vec3.create(),d=vec3.create(),f=vec3.create();return mat3.create(),function(m,b,T){T=T||25;for(var L=0;L<T;++L){var G=mat3.fromQuat(o,m);vec3.getMat3Column(r,G,0),vec3.getMat3Column(s,G,1),vec3.getMat3Column(a,G,2),vec3.getMat3Column(l,b,0),vec3.getMat3Column(h,b,1),vec3.getMat3Column(u,b,2),vec3.cross(c,r,l),vec3.cross(_,s,h),vec3.cross(d,a,u),vec3.add(f,c,_),vec3.add(f,f,d);var I=1/Math.abs(vec3.dot(r,l)+vec3.dot(s,h)+vec3.dot(a,u))+1e-9;vec3.scale(f,f,I);var O=vec3.length(f);if(O<1e-9)break;vec3.scale(f,f,1/O),quat.setAxisAngle(t,f,O),quat.mul(m,t,m),quat.normalize(m,m)}return m}})(),quat.rotateToFrom=(function(){var o=vec3.create();return function(t,r,s){t=t||quat.create();var a=vec3.cross(o,r,s),l=vec3.dot(r,s);return l<-1+.01?(t[0]=0,t[1]=1,t[2]=0,t[3]=0,t):(t[0]=a[0]*.5,t[1]=a[1]*.5,t[2]=a[2]*.5,t[3]=(1+l)*.5,quat.normalize(t,t),t)}})(),quat.lookAt=(function(){var o=vec3.create();return function(t,r,s){var a=vec3.dot(vec3.FRONT,r);if(Math.abs(a- -1)<1e-6)return t.set(vec3.UP),t[3]=Math.PI,t;if(Math.abs(a-1)<1e-6)return quat.identity(t);var l=Math.acos(a);return vec3.cross(o,vec3.FRONT,r),vec3.normalize(o,o),quat.setAxisAngle(t,o,l),t}})(),GL$1.Indexer=function o(){this.unique=[],this.indices=[],this.map={}},GL$1.Indexer.prototype={add:function(o){var t=JSON.stringify(o);return t in this.map||(this.map[t]=this.unique.length,this.unique.push(o)),this.map[t]}},GL$1.Buffer=function o(t,r,s,a,l){GL$1.debug&&console.log("GL.Buffer created"),l!==null&&(l=l||global$1.gl),this.gl=l,this.buffer=null,this.target=t,this.attribute=null,this.data=r,this.spacing=s||3,this.data&&this.gl&&this.upload(a)},GL$1.Buffer.prototype.bind=function(o,t){t=t||this.gl,t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.enableVertexAttribArray(o),t.vertexAttribPointer(o,this.spacing,this.buffer.gl_type,!1,0,0)},GL$1.Buffer.prototype.unbind=function(o,t){t=t||this.gl,t.disableVertexAttribArray(o)},GL$1.Buffer.prototype.forEach=function(o){for(var t=this.data,r=0,s=this.spacing,a=t.length;r<a;r+=s)o(t.subarray(r,r+s),r);return this},GL$1.Buffer.prototype.applyTransform=function(o){for(var t=this.data,r=0,s=this.spacing,a=t.length;r<a;r+=s){var l=t.subarray(r,r+s);vec3.transformMat4(l,l,o)}return this},GL$1.Buffer.prototype.upload=function(o){var t=this.spacing||3,r=this.gl;if(r){if(!this.data)throw"No data supplied";var s=this.data;if(!s.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||r.createBuffer(),!!this.buffer){switch(this.buffer.length=s.length,this.buffer.spacing=t,s.constructor){case Int8Array:this.buffer.gl_type=r.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=r.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=r.SHORT;break;case Uint16Array:this.buffer.gl_type=r.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=r.INT;break;case Uint32Array:this.buffer.gl_type=r.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=r.FLOAT;break;default:throw"unsupported buffer type"}this.target==r.ARRAY_BUFFER&&(this.buffer.gl_type==r.INT||this.buffer.gl_type==r.UNSIGNED_INT)&&(console.warn("WebGL does not support UINT32 or INT32 as vertex buffer types, converting to FLOAT"),this.buffer.gl_type=r.FLOAT,s=new Float32Array(s)),r.bindBuffer(this.target,this.buffer),r.bufferData(this.target,s,o||this.stream_type||r.STATIC_DRAW)}}},GL$1.Buffer.prototype.compile=GL$1.Buffer.prototype.upload,GL$1.Buffer.prototype.setData=function(o,t){if(!o.buffer)throw"Data must be typed array";if(t=t||0,this.data){if(this.data.length<o.length)throw"buffer is not big enough, you cannot set data to a smaller buffer"}else{this.data=o,this.upload();return}if(this.data!=o){if(this.data.length==o.length){this.data.set(o),this.upload();return}var r=new Uint8Array(o.buffer,o.buffer.byteOffset,o.buffer.byteLength),s=new Uint8Array(this.data.buffer);s.set(r,t),this.uploadRange(t,r.length)}},GL$1.Buffer.prototype.uploadRange=function(o,t){if(!this.data)throw"No data stored in this buffer";var r=this.data;if(!r.buffer)throw"Buffers must be typed arrays";var s=new Uint8Array(this.data.buffer,o,t),a=this.gl;a.bindBuffer(this.target,this.buffer),a.bufferSubData(this.target,o,s)},GL$1.Buffer.prototype.clone=function(o){var t=new GL$1.Buffer;if(o)for(var r in this)t[r]=this[r];else this.target&&(t.target=this.target),this.gl&&(t.gl=this.gl),this.spacing&&(t.spacing=this.spacing),this.data&&(t.data=new global$1[this.data.constructor](this.data),t.upload());return t},GL$1.Buffer.prototype.toJSON=function(){if(!this.data)return console.error("cannot serialize a mesh without data"),null;function o(t){if(t){if(t.name)return t.name;if(t.toString){var r=t.toString().match(/function\s*(\w+)/);if(r&&r.length==2)return r[1]}}}return{data_type:o(this.data),data:this.data.toJSON(),target:this.target,attribute:this.attribute,spacing:this.spacing}},GL$1.Buffer.prototype.fromJSON=function(o){var t=global$1[o.data_type]||Float32Array;this.data=new t(o.data),this.target=o.target,this.spacing=o.spacing||3,this.attribute=o.attribute,this.upload(GL$1.STATIC_DRAW)},GL$1.Buffer.prototype.delete=function(){var o=this.gl;o.deleteBuffer(this.buffer),this.buffer=null};var se;let Mesh$1=(se=class{constructor(o,t,r,s){if(GL$1.debug&&console.log("GL.Mesh created"),s!==null&&(s=s||global$1.gl,this.gl=s),this._context_id=s.context_id,this.vertexBuffers={},this.indexBuffers={},this.info={groups:[]},this._bounding=BBox.create(),(o||t)&&this.addBuffers(o,t,r?r.stream_type:null),r)for(var a in r)this[a]=r[a]}set bounding(o){if(o){if(o.length<13)throw"Bounding must use the BBox bounding format of 13 floats: center, halfsize, min, max, radius";this._bounding.set(o)}}get bounding(){return this._bounding}addBuffer(o,t){if(t.target==gl.ARRAY_BUFFER?this.vertexBuffers[o]=t:this.indexBuffers[o]=t,!t.attribute){var r=GL$1.Mesh.common_buffers[o];r&&(t.attribute=r.attribute)}}addBuffers(o,t,r){var s=0;this.vertexBuffers.vertices&&(s=this.vertexBuffers.vertices.data.length/3);for(var a in o){var l=o[a];if(l){if(l.constructor==GL$1.Buffer)l=l.data;else if(typeof l[0]!="number"){for(var h=[],u=0,c=1e4;u<l.length;u+=c)h=Array.prototype.concat.apply(h,l.slice(u,u+c));l=h}var _=GL$1.Mesh.common_buffers[a];if(l.constructor===Array){var d=GL$1.Mesh.default_datatype;_&&_.type&&(d=_.type),l=new d(l)}a=="vertices"&&(s=l.length/3);var f=l.length/s;_&&_.spacing&&(f=_.spacing);var m="a_"+a;_&&_.attribute&&(m=_.attribute),this.vertexBuffers[a]?this.updateVertexBuffer(a,m,f,l,r):this.createVertexBuffer(a,m,f,l,r)}}if(t)for(var a in t){var l=t[a];if(l){if(l.constructor==GL$1.Buffer&&(l=l.data),typeof l[0]!="number"){h=[];for(var a=0,c=1e4;a<l.length;a+=c)h=Array.prototype.concat.apply(h,l.slice(a,a+c));l=h}if(l.constructor===Array){var d=Uint16Array;s>256*256&&(d=Uint32Array),l=new d(l)}this.createIndexBuffer(a,l)}}}createVertexBuffer(o,t,r,s,a){var l=GL$1.Mesh.common_buffers[o];if(!t&&l&&(t=l.attribute),!t)throw"Buffer added to mesh without attribute name";if(!r&&l&&(l&&l.spacing?r=l.spacing:r=3),!s){var h=this.getNumVertices();if(!h)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";s=new GL$1.Mesh.default_datatype(h*r)}if(!s.buffer)throw"Buffer data MUST be typed array";var u=this.vertexBuffers[o]=new GL$1.Buffer(gl.ARRAY_BUFFER,s,r,a,this.gl);return u.name=o,u.attribute=t,u}updateVertexBuffer(o,t,r,s,a){var l=this.vertexBuffers[o];if(!l){console.log("buffer not found: ",o);return}s.length&&(l.attribute=t,l.spacing=r,l.data=s,l.upload(a))}removeVertexBuffer(o,t){var r=this.vertexBuffers[o];r&&(t&&r.delete(),delete this.vertexBuffers[o])}getVertexBuffer(o){return this.vertexBuffers[o]}createIndexBuffer(o,t,r){if(t.constructor===Array){var s=Uint16Array,a=this.vertexBuffers.vertices;if(a){var l=a.data.length/3;l>256*256&&(s=Uint32Array),t=new s(t)}}var h=this.indexBuffers[o]=new GL$1.Buffer(gl.ELEMENT_ARRAY_BUFFER,t,0,r,this.gl);return h}getBuffer(o){return this.vertexBuffers[o]}getIndexBuffer(o){return this.indexBuffers[o]}removeIndexBuffer(o,t){var r=this.indexBuffers[o];r&&(t&&r.delete(),delete this.indexBuffers[o])}upload(o){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t];r.upload(o)}for(var s in this.indexBuffers){var r=this.indexBuffers[s];r.upload()}}deleteBuffers(){for(var o in this.vertexBuffers){var t=this.vertexBuffers[o];t.delete()}this.vertexBuffers={};for(var o in this.indexBuffers){var t=this.indexBuffers[o];t.delete()}this.indexBuffers={}}bindBuffers(o){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t],s=r.attribute||t,a=o.attributes[s];a==null||!r.buffer||(gl.bindBuffer(gl.ARRAY_BUFFER,r.buffer),gl.enableVertexAttribArray(a),gl.vertexAttribPointer(a,r.buffer.spacing,r.buffer.gl_type,!1,0,0))}}unbindBuffers(o){for(var t in this.vertexBuffers){var r=this.vertexBuffers[t],s=r.attribute||t,a=o.attributes[s];a==null||!r.buffer||gl.disableVertexAttribArray(o.attributes[s])}}clone(t){var t=t||global$1.gl,r={},s={};for(var a in this.vertexBuffers){var l=this.vertexBuffers[a];r[a]=new l.data.constructor(l.data)}for(var a in this.indexBuffers){var l=this.indexBuffers[a];s[a]=new l.data.constructor(l.data)}return new GL$1.Mesh(r,s,void 0,t)}cloneShared(t){var t=t||global$1.gl;return new GL$1.Mesh(this.vertexBuffers,this.indexBuffers,void 0,t)}toObject(){var o={},t={};for(var r in this.vertexBuffers){var s=this.vertexBuffers[r];o[r]={spacing:s.spacing,data:new s.data.constructor(s.data)}}for(var r in this.indexBuffers){var s=this.indexBuffers[r];t[r]={data:new s.data.constructor(s.data)}}return{vertexBuffers:o,indexBuffers:t,info:this.info?GL$1.cloneObject(this.info):null,bounding:this._bounding.toJSON()}}toJSON(){var o={vertexBuffers:{},indexBuffers:{},info:this.info?GL$1.cloneObject(this.info):null,bounding:this._bounding.toJSON()};for(var t in this.vertexBuffers)o.vertexBuffers[t]=this.vertexBuffers[t].toJSON();for(var t in this.indexBuffers)o.indexBuffers[t]=this.indexBuffers[t].toJSON();return o}fromJSON(o){this.vertexBuffers={},this.indexBuffers={};for(var t in o.vertexBuffers)if(o.vertexBuffers[t]){var r=new GL$1.Buffer;r.fromJSON(o.vertexBuffers[t]),!r.attribute&&GL$1.Mesh.common_buffers[t]&&(r.attribute=GL$1.Mesh.common_buffers[t].attribute),this.vertexBuffers[t]=r}for(var t in o.indexBuffers)if(o.indexBuffers[t]){var r=new GL$1.Buffer;r.fromJSON(o.indexBuffers[t]),this.indexBuffers[t]=r}o.info&&(this.info=GL$1.cloneObject(o.info)),o.bounding&&(this.bounding=o.bounding)}generateMetadata(){var o={},t=this.vertexBuffers.vertices.data,r=this.indexBuffers.triangles.data;o.vertices=t.length/3,r?o.faces=r.length/3:o.faces=t.length/9,o.indexed=!!this.metadata.faces,this.metadata=o}computeWireframe(){var o=this.indexBuffers.triangles,t=this.vertexBuffers.vertices.data,r=t.length/3;if(o){for(var s=o.data,a=new GL$1.Indexer,l=0;l<s.length;l+=3)for(var h=s.subarray(l,l+3),u=0;u<h.length;u++){var c=h[u],_=h[(u+1)%h.length];a.add([Math.min(c,_),Math.max(c,_)])}for(var d=a.unique,f=r>256*256?new Uint32Array(d.length*2):new Uint16Array(d.length*2),l=0,m=d.length;l<m;++l)f.set(d[l],l*2)}else for(var b=r/3,f=r>256*256?new Uint32Array(b*6):new Uint16Array(b*6),l=0;l<r;l+=3)f[l*2]=l,f[l*2+1]=l+1,f[l*2+2]=l+1,f[l*2+3]=l+2,f[l*2+4]=l+2,f[l*2+5]=l;return this.createIndexBuffer("wireframe",f),this}flipNormals(o){var t=this.vertexBuffers.normals;if(t){for(var r=t.data,s=r.length,a=0;a<s;++a)r[a]*=-1;t.upload(o),this.indexBuffers.triangles||this.computeIndices();for(var l=this.indexBuffers.triangles,r=l.data,s=r.length,a=0;a<s;a+=3){var h=r[a];r[a]=r[a+1],r[a+1]=h}l.upload(o)}}computeIndices(){var o=[],t=[],r=[],s=[],a=this.vertexBuffers.vertices,l=this.vertexBuffers.normals,h=this.vertexBuffers.coords,u=a.data,c=null;l&&(c=l.data);var _=null;h&&(_=h.data);for(var d={},f=u.length/3,m=0;m<f;++m){var b=u.subarray(m*3,(m+1)*3),T=b[0]*1e3|0,L=0,G=d[T];if(G)for(var I=G.length;L<I;L++){var O=o[G[L]];if(vec3.sqrDist(b,O)<.01){s.push(L);break}}if(!(G&&L!=I)){var E=L;o.push(b),d[T]?d[T].push(E):d[T]=[E],c&&t.push(c.subarray(m*3,(m+1)*3)),_&&r.push(_.subarray(m*2,(m+1)*2)),s.push(E)}}this.vertexBuffers={},this.createVertexBuffer("vertices",GL$1.Mesh.common_buffers.vertices.attribute,3,GL$1.linearizeArray(o)),c&&this.createVertexBuffer("normals",GL$1.Mesh.common_buffers.normals.attribute,3,GL$1.linearizeArray(t)),_&&this.createVertexBuffer("coords",GL$1.Mesh.common_buffers.coords.attribute,2,GL$1.linearizeArray(r)),this.createIndexBuffer("triangles",s)}explodeIndices(o){o=o||"triangles";var t=this.getIndexBuffer(o);if(t){var r=t.data,s={};for(var a in this.vertexBuffers){var l=GL$1.Mesh.common_buffers[a];s[a]=new(l.type||Float32Array)(l.spacing*r.length)}for(var a=0,h=r.length;a<h;++a){var u=r[a];for(var c in this.vertexBuffers){var _=this.vertexBuffers[c],l=GL$1.Mesh.common_buffers[c],d=_.spacing||l.spacing,f=s[c];f.set(_.data.subarray(u*d,u*d+d),a*d)}}for(var a in s){var m=this.vertexBuffers[a];this.createVertexBuffer(a,m.attribute,m.spacing,s[a])}delete this.indexBuffers[o]}}computeNormals(o){var t=this.vertexBuffers.vertices;if(!t)return console.error("Cannot compute normals of a mesh without vertices");var r=this.vertexBuffers.vertices.data;r.length/3;var s=new Float32Array(r.length),a=null;this.indexBuffers.triangles&&(a=this.indexBuffers.triangles.data);for(var l=GL$1.temp_vec3,h=GL$1.temp2_vec3,u,c,_,d,f,m,b,T,L,G=a?a.length:r.length,I=0;I<G;I+=3)a?(u=a[I],c=a[I+1],_=a[I+2],d=r.subarray(u*3,u*3+3),f=r.subarray(c*3,c*3+3),m=r.subarray(_*3,_*3+3),b=s.subarray(u*3,u*3+3),T=s.subarray(c*3,c*3+3),L=s.subarray(_*3,_*3+3)):(d=r.subarray(I*3,I*3+3),f=r.subarray(I*3+3,I*3+6),m=r.subarray(I*3+6,I*3+9),b=s.subarray(I*3,I*3+3),T=s.subarray(I*3+3,I*3+6),L=s.subarray(I*3+6,I*3+9)),vec3.sub(l,f,d),vec3.sub(h,m,d),vec3.cross(l,l,h),vec3.normalize(l,l),vec3.add(b,b,l),vec3.add(T,T,l),vec3.add(L,L,l);if(a)for(var I=0,G=s.length;I<G;I+=3){var O=s.subarray(I,I+3);vec3.normalize(O,O)}var E=this.vertexBuffers.normals;if(E)E.data=s,E.upload(o);else return this.createVertexBuffer("normals",GL$1.Mesh.common_buffers.normals.attribute,3,s);return E}computeTangents(){var o=this.vertexBuffers.vertices;if(!o)return console.error("Cannot compute tangents of a mesh without vertices");var t=this.vertexBuffers.normals;if(!t)return console.error("Cannot compute tangents of a mesh without normals");var r=this.vertexBuffers.coords;if(!r)return console.error("Cannot compute tangents of a mesh without uvs");var s=this.indexBuffers.triangles;if(!s)return console.error("Cannot compute tangents of a mesh without indices");var a=o.data,l=t.data,h=r.data,u=s.data;if(!(!a||!l||!h)){var c=a.length/3,_=new Float32Array(c*4),d=new Float32Array(c*3*2),f=d.subarray(c*3),m,b,T=vec3.create(),L=vec3.create(),G=vec3.create(),I=vec3.create();for(m=0,b=u.length;m<b;m+=3){var O=u[m],E=u[m+1],D=u[m+2],N=a.subarray(O*3,O*3+3),C=a.subarray(E*3,E*3+3),R=a.subarray(D*3,D*3+3),S=h.subarray(O*2,O*2+2),P=h.subarray(E*2,E*2+2),M=h.subarray(D*2,D*2+2),A=C[0]-N[0],B=R[0]-N[0],$=C[1]-N[1],H=R[1]-N[1],F=C[2]-N[2],W=R[2]-N[2],z=P[0]-S[0],U=M[0]-S[0],V=P[1]-S[1],X=M[1]-S[1],J,pe=z*X-U*V;Math.abs(pe)<1e-9?J=0:J=1/pe,vec3.copy(T,[(X*A-V*B)*J,(X*$-V*H)*J,(X*F-V*W)*J]),vec3.copy(L,[(z*B-U*A)*J,(z*H-U*$)*J,(z*W-U*F)*J]),vec3.add(d.subarray(O*3,O*3+3),d.subarray(O*3,O*3+3),T),vec3.add(d.subarray(E*3,E*3+3),d.subarray(E*3,E*3+3),T),vec3.add(d.subarray(D*3,D*3+3),d.subarray(D*3,D*3+3),T),vec3.add(f.subarray(O*3,O*3+3),f.subarray(O*3,O*3+3),L),vec3.add(f.subarray(E*3,E*3+3),f.subarray(E*3,E*3+3),L),vec3.add(f.subarray(D*3,D*3+3),f.subarray(D*3,D*3+3),L)}for(m=0,b=a.length;m<b;m+=3){var q=l.subarray(m,m+3),Z=d.subarray(m,m+3);vec3.subtract(G,Z,vec3.scale(G,q,vec3.dot(q,Z))),vec3.normalize(G,G);var K=vec3.dot(vec3.cross(I,q,Z),f.subarray(m,m+3))<0?-1:1;_.set([G[0],G[1],G[2],K],m/3*4)}this.createVertexBuffer("tangents",se.common_buffers.tangents.attribute,4,_)}}computeTextureCoordinates(o){var t=this.vertexBuffers.vertices;if(!t)return console.error("Cannot compute uvs of a mesh without vertices");this.explodeIndices("triangles"),t=this.vertexBuffers.vertices;var r=t.data,s=r.length/3,a=this.vertexBuffers.coords,l=new Float32Array(s*2),h=this.indexBuffers.triangles,u=null;h&&(u=h.data);var c=vec3.create(),_=vec3.create(),d=vec3.create(),f=this.getBoundingBox(),m=BBox.getCenter(f),b=vec3.create();b.set(BBox.getHalfsize(f)),vec3.scale(b,b,2);for(var T=u?u.length:r.length/3,L=0;L<T;L+=3){if(u)var G=u[L],I=u[L+1],O=u[L+2],E=r.subarray(G*3,G*3+3),D=r.subarray(I*3,I*3+3),N=r.subarray(O*3,O*3+3),C=l.subarray(G*2,G*2+2),R=l.subarray(I*2,I*2+2),S=l.subarray(O*2,O*2+2);else var E=r.subarray(L*3,L*3+3),D=r.subarray((L+1)*3,(L+1)*3+3),N=r.subarray((L+2)*3,(L+2)*3+3),C=l.subarray(L*2,L*2+2),R=l.subarray((L+1)*2,(L+1)*2+2),S=l.subarray((L+2)*2,(L+2)*2+2);vec3.sub(_,E,D),vec3.sub(d,E,N),vec3.cross(c,_,d),c[0]=Math.abs(c[0]),c[1]=Math.abs(c[1]),c[2]=Math.abs(c[2]),c[0]>c[1]&&c[0]>c[2]?(C[0]=(E[2]-m[2])/b[2],C[1]=(E[1]-m[1])/b[1],R[0]=(D[2]-m[2])/b[2],R[1]=(D[1]-m[1])/b[1],S[0]=(N[2]-m[2])/b[2],S[1]=(N[1]-m[1])/b[1]):c[1]>c[2]?(C[0]=(E[0]-m[0])/b[0],C[1]=(E[2]-m[2])/b[2],R[0]=(D[0]-m[0])/b[0],R[1]=(D[2]-m[2])/b[2],S[0]=(N[0]-m[0])/b[0],S[1]=(N[2]-m[2])/b[2]):(C[0]=(E[0]-m[0])/b[0],C[1]=(E[1]-m[1])/b[1],R[0]=(D[0]-m[0])/b[0],R[1]=(D[1]-m[1])/b[1],S[0]=(N[0]-m[0])/b[0],S[1]=(N[1]-m[1])/b[1])}a?(a.data=l,a.upload(o)):this.createVertexBuffer("coords",se.common_buffers.coords.attribute,2,l)}getNumVertices(){var o=this.vertexBuffers.vertices;return o?o.data.length/o.spacing:0}getNumTriangles(){var o=this.getIndexBuffer("triangles");return o?o.data.length/3:this.getNumVertices()/3}static computeBoundingBox(o,t,r){if(o){var s=0;if(r){for(var a=0;a<r.length;++a)if(r[a]){s=a;break}if(s==r.length){console.warn("mask contains only zeros, no vertices marked");return}}for(var l=vec3.clone(o.subarray(s*3,s*3+3)),h=vec3.clone(o.subarray(s*3,s*3+3)),u,a=s*3;a<o.length;a+=3)r&&!r[a/3]||(u=o.subarray(a,a+3),vec3.min(l,u,l),vec3.max(h,u,h));(isNaN(l[0])||isNaN(l[1])||isNaN(l[2])||isNaN(h[0])||isNaN(h[1])||isNaN(h[2]))&&(l[0]=l[1]=l[2]=0,h[0]=h[1]=h[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices"));var c=vec3.add(vec3.create(),l,h);vec3.scale(c,c,.5);var _=vec3.subtract(vec3.create(),h,c);return BBox.setCenterHalfsize(t||BBox.create(),c,_)}}getBoundingBox(){return this._bounding?this._bounding:(this.updateBoundingBox(),this._bounding)}updateBoundingBox(){var o=this.vertexBuffers.vertices;o&&(GL$1.Mesh.computeBoundingBox(o.data,this._bounding),this.info&&this.info.groups&&this.info.groups.length&&this.computeGroupsBoundingBoxes())}computeGroupsBoundingBoxes(){var o=null,t=this.getIndexBuffer("triangles");t&&(o=t.data);var r=this.getVertexBuffer("vertices");if(!r)return!1;var s=r.data;if(!s.length)return!1;for(var a=this.info.groups,l=0;l<a.length;++l){var h=a[l];h.bounding=h.bounding||BBox.create();var u=null;if(o){for(var c=new Uint8Array(s.length/3),_=h.start,d=0,f=h.length;d<f;d+=3)c[o[_+d]]=1,c[o[_+d+1]]=1,c[o[_+d+2]]=1;GL$1.Mesh.computeBoundingBox(s,h.bounding,c)}else u=s.subarray(h.start*3,(h.start+h.length)*3),GL$1.Mesh.computeBoundingBox(u,h.bounding)}return!0}setBoundingBox(o,t){BBox.setCenterHalfsize(this._bounding,o,t)}freeData(){for(var o in this.vertexBuffers)this.vertexBuffers[o].data=null,delete this[this.vertexBuffers[o].name];for(var t in this.indexBuffers)this.indexBuffers[t].data=null,delete this[this.indexBuffers[t].name]}configure(o,t={}){var r={},s={};for(var a in o)if(o[a]){if(a=="vertexBuffers"||a=="vertex_buffers"){for(l in o[a])r[l]=o[a][l];continue}if(a=="indexBuffers"||a=="index_buffers"){for(l in o[a])s[l]=o[a][l];continue}a=="indices"||a=="lines"||a=="wireframe"||a=="triangles"?s[a]=o[a]:GL$1.Mesh.common_buffers[a]?r[a]=o[a]:t[a]=o[a]}this.addBuffers(r,s,t.stream_type);for(var l in t)this[l]=t[l];t.bounding||this.updateBoundingBox()}totalMemory(){var o=0;for(var t in this.vertexBuffers)o+=this.vertexBuffers[t].data.buffer.byteLength;for(var t in this.indexBuffers)o+=this.indexBuffers[t].data.buffer.byteLength;return o}slice(o,t){var r={},s=this.indexBuffers.triangles;if(!s)return console.warn("splice in not indexed not supported yet"),null;var a=s.data,l=[],h=new Int32Array(a.length);h.fill(-1);var u=o+t;u>=a.length&&(u=a.length);for(var c=0,_=o;_<u;++_){var d=a[_];if(h[d]!=-1){l.push(h[d]);continue}var f=c++;h[d]=f,l.push(f);for(var m in this.vertexBuffers){var b=this.vertexBuffers[m],T=b.data,L=b.spacing;r[m]||(r[m]=[]);for(var G=r[m],I=0;I<L;++I)G.push(T[I+d*L])}}var O=new GL$1.Mesh(r,{triangles:l},null,gl);return O.updateBoundingBox(),O}simplify(){var o=this.getBoundingBox(),t=BBox.getMin(o),r=BBox.getHalfsize(o),s=vec3.scale(vec3.create(),r,2),a=new GL$1.Mesh,l=vec3.create();for(var h in this.vertexBuffers){var u=this.vertexBuffers[h],c=u.data,_=new Float32Array(c.length);if(h=="vertices")for(var d=0,f=c.length;d<f;d+=3){var m=c.subarray(d,d+3);vec3.sub(l,m,t),vec3.div(l,l,s),l[0]=Math.round(l[0]*256)/256,l[1]=Math.round(l[1]*256)/256,l[2]=Math.round(l[2]*256)/256,vec3.mul(l,l,s),vec3.add(l,l,t),_.set(l,d)}a.addBuffer()}}static load(o,t={},r,s){t.no_gl&&(s=null);var a=r||new GL$1.Mesh(null,null,null,s);return a.configure(o,t),a}static mergeMeshes(o,t={}){for(var r={},s={},a={},l=[],h=0,u=[],c=0;c<o.length;++c){var _=o[c],d=_.mesh,f=h;l.push(f);var m=d.vertexBuffers.vertices.data.length/3;h+=m;for(var b in d.vertexBuffers)r[b]?r[b]+=d.vertexBuffers[b].data.length:r[b]=d.vertexBuffers[b].data.length;for(var b in d.indexBuffers)s[b]?s[b]+=d.indexBuffers[b].data.length:s[b]=d.indexBuffers[b].data.length;var T={name:"mesh_"+c,start:f,length:m,material:""};u.push(T)}for(var b in r){var L=t[b];if(L===null){delete r[b];continue}L||(L=Float32Array),r[b]=new L(r[b]),a[b]=0}for(var b in s)s[b]=new Uint32Array(s[b]),a[b]=0;for(var c=0;c<o.length;++c){var _=o[c],d=_.mesh,f=0,m=0;for(var b in d.vertexBuffers)if(r[b]){if(b=="vertices"&&(m=d.vertexBuffers[b].data.length/3),r[b].set(d.vertexBuffers[b].data,a[b]),_[b+"_matrix"]){var G=_[b+"_matrix"];G.length==16?I(r[b],a[b],d.vertexBuffers[b].data.length,G):G.length==9&&O(r[b],a[b],d.vertexBuffers[b].data.length,G)}a[b]+=d.vertexBuffers[b].data.length}for(var b in d.indexBuffers)s[b].set(d.indexBuffers[b].data,a[b]),E(s[b],a[b],d.indexBuffers[b].data.length,l[c]),a[b]+=d.indexBuffers[b].data.length}function I(N,C,R,S){for(var P=C+R,M=C;M<P;M+=3){var A=N.subarray(M,M+3);vec3.transformMat4(A,A,S)}}function O(N,C,R,S){for(var P=C+R,M=C;M<P;M+=2){var A=N.subarray(M,M+2);vec2.transformMat3(A,A,S)}}function E(N,C,R,S){for(var P=C+R,M=C;M<P;++M)N[M]+=S}var D={info:{groups:u}};return typeof gl!="undefined"||t.only_data?new GL$1.Mesh(r,s,D):{vertexBuffers:r,indexBuffers:s,info:{groups:u}}}encode(o,t){o=o.toLowerCase();var r=se.encoders[o];if(r)return r.call(null,this,t);throw"Mesh.encode: no encoder found for format "+o}static getScreenQuad(o){o=o||global$1.gl;var t=o.meshes[":screen_quad"];if(t)return t;var r=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]),s=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]);return t=new se({vertices:r,coords:s},void 0,void 0,o),o.meshes[":screen_quad"]=t}plane(o={},t){o.triangles=[];var r=o.detailX||o.detail||1,s=o.detailY||o.detail||1,a=o.width||o.size||1,l=o.height||o.size||1,h=o.xz;a*=.5,l*=.5;var u=[],c=[],_=[],d=[],f=vec3.fromValues(0,0,1);h&&f.set([0,1,0]);for(var m=0;m<=s;m++)for(var b=m/s,T=0;T<=r;T++){var L=T/r;if(h?c.push((2*L-1)*a,0,-(2*b-1)*l):c.push((2*L-1)*a,(2*b-1)*l,0),_.push(L,b),d.push(f[0],f[1],f[2]),T<r&&m<s){var G=T+m*(r+1);h?(u.push(G+1,G+r+1,G),u.push(G+1,G+r+2,G+r+1)):(u.push(G,G+1,G+r+1),u.push(G+r+1,G+1,G+r+2))}}var I=BBox.fromCenterHalfsize([0,0,0],h?[a,0,l]:[a,l,0]),O={vertices:c,normals:d,coords:_,triangles:u};return se.load(O,{bounding:I},t)}plane2D(o,t){var r=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),s=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(o&&o.size)for(var a=o.size*.5,l=0;l<r.length;++l)r[l]*=a;return new se({vertices2D:r,coords:s},null,t)}point(o){return new se({vertices:[0,0,0]})}cube(o={},t){var r=(o.size||1)*.5,s={};s.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var a=0,l=s.vertices.length;a<l;++a)s.vertices[a]*=r;return s.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]),s.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]),o.wireframe&&(s.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11])),o.bounding=BBox.fromCenterHalfsize([0,0,0],[r,r,r]),GL$1.Mesh.load(s,o,t)}box(o={},t){var r=o.sizex||1,s=o.sizey||1,a=o.sizez||1;r*=.5,s*=.5,a*=.5;var l={};l.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var h=0,u=l.vertices.length;h<u;h+=3)l.vertices[h]*=r,l.vertices[h+1]*=s,l.vertices[h+2]*=a;return l.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]),l.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]),o.wireframe&&(l.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11])),o.bounding=BBox.fromCenterHalfsize([0,0,0],[r,s,a]),GL$1.Mesh.load(l,o,t)}circle(o={},t){var r=o.size||o.radius||1,s=Math.ceil(o.slices||24),a=o.xz||!1,l=o.empty||!1;s<3&&(s=3);var h=2*Math.PI/s,u=vec3.create(),c=vec3.create(),_=vec3.fromValues(0,0,1),d=vec2.fromValues(.5,.5),f=vec2.create();a&&_.set([0,1,0]);var m=a?2:1,b=new Float32Array(3*(s+1)),T=new Float32Array(3*(s+1)),L=new Float32Array(2*(s+1)),G=null;b.set(u,0),T.set(_,0),L.set(d,0);for(var I=0,O=0,E=0;E<s;++E)I=Math.sin(h*E),O=Math.cos(h*E),c[0]=I*r,c[m]=O*r,f[0]=I*.5+.5,f[1]=O*.5+.5,b.set(c,E*3+3),T.set(_,E*3+3),L.set(f,E*2+2);if(l)b=b.subarray(3),T=b.subarray(3),L=b.subarray(2),G=null;else{var G=new Uint16Array(3*s),D=2,N=1;a&&(D=1,N=2);for(var E=0;E<s-1;++E)G[E*3]=0,G[E*3+1]=E+D,G[E*3+2]=E+N;G[E*3]=0,a?(G[E*3+1]=E+1,G[E*3+2]=1):(G[E*3+1]=1,G[E*3+2]=E+1)}o.bounding=BBox.fromCenterHalfsize([0,0,0],a?[r,0,r]:[r,r,0]);var C={vertices:b,normals:T,coords:L,triangles:G};if(o.wireframe){for(var R=new Uint16Array(s*2),E=0;E<s;E++)R[E*2]=E,R[E*2+1]=E+1;R[0]=s,C.wireframe=R}return GL$1.Mesh.load(C,o,t)}cylinder(o={},t){for(var r=o.radius||o.size||1,s=o.height||o.size||2,a=o.subdivisions||64,l=new Float32Array(a*6*3*2),h=new Float32Array(a*6*3*2),u=new Float32Array(a*6*2*2),c=2*Math.PI/a,_=null,d=0;d<a;++d){var f=d*c;_=[Math.sin(f),0,Math.cos(f)],l.set([_[0]*r,s*.5,_[2]*r],d*6*3),h.set(_,d*6*3),u.set([d/a,1],d*6*2),_=[Math.sin(f),0,Math.cos(f)],l.set([_[0]*r,s*-.5,_[2]*r],d*6*3+3),h.set(_,d*6*3+3),u.set([d/a,0],d*6*2+2),_=[Math.sin(f+c),0,Math.cos(f+c)],l.set([_[0]*r,s*-.5,_[2]*r],d*6*3+6),h.set(_,d*6*3+6),u.set([(d+1)/a,0],d*6*2+4),_=[Math.sin(f+c),0,Math.cos(f+c)],l.set([_[0]*r,s*.5,_[2]*r],d*6*3+9),h.set(_,d*6*3+9),u.set([(d+1)/a,1],d*6*2+6),_=[Math.sin(f),0,Math.cos(f)],l.set([_[0]*r,s*.5,_[2]*r],d*6*3+12),h.set(_,d*6*3+12),u.set([d/a,1],d*6*2+8),_=[Math.sin(f+c),0,Math.cos(f+c)],l.set([_[0]*r,s*-.5,_[2]*r],d*6*3+15),h.set(_,d*6*3+15),u.set([(d+1)/a,0],d*6*2+10)}var m=d*6*3,b=d*6*2,T=m;if(o.caps===!1)l=l.subarray(0,m),h=h.subarray(0,m),u=u.subarray(0,b);else for(var L=vec3.fromValues(0,s*.5,0),G=vec3.fromValues(0,s*-.5,0),I=vec3.fromValues(0,1,0),O=vec3.fromValues(0,-1,0),d=0;d<a;++d){var f=d*c,E=vec3.fromValues(Math.sin(f),0,Math.cos(f)),D=vec3.fromValues(Math.sin(f+c),0,Math.cos(f+c));l.set([E[0]*r,s*.5,E[2]*r],m+d*6*3),h.set(I,m+d*6*3),u.set([-E[0]*.5+.5,E[2]*.5+.5],b+d*6*2),l.set([D[0]*r,s*.5,D[2]*r],m+d*6*3+3),h.set(I,m+d*6*3+3),u.set([-D[0]*.5+.5,D[2]*.5+.5],b+d*6*2+2),l.set(L,m+d*6*3+6),h.set(I,m+d*6*3+6),u.set([.5,.5],b+d*6*2+4),l.set([D[0]*r,s*-.5,D[2]*r],m+d*6*3+9),h.set(O,m+d*6*3+9),u.set([D[0]*.5+.5,D[2]*.5+.5],b+d*6*2+6),l.set([E[0]*r,s*-.5,E[2]*r],m+d*6*3+12),h.set(O,m+d*6*3+12),u.set([E[0]*.5+.5,E[2]*.5+.5],b+d*6*2+8),l.set(G,m+d*6*3+15),h.set(O,m+d*6*3+15),u.set([.5,.5],b+d*6*2+10)}var N={vertices:l,normals:h,coords:u};return o.bounding=BBox.fromCenterHalfsize([0,0,0],[r,s*.5,r]),o.info={groups:[]},o.caps!==!1&&(o.info.groups.push({name:"side",start:0,length:T/3}),o.info.groups.push({name:"caps",start:T/3,length:(l.length-T)/3})),se.load(N,o,t)}cone(o={},t){for(var r=o.radius||o.size||1,s=o.height||o.size||2,a=o.subdivisions||64,l=new Float32Array(a*3*3*2),h=new Float32Array(a*3*3*2),u=new Float32Array(a*2*3*2),c=2*Math.PI/a,_=null,d=r/s,f=0;f<a;++f){var m=f*c;_=[Math.sin(m+c*.5),d,Math.cos(m+c*.5)],vec3.normalize(_,_),l.set([0,s,0],f*6*3),h.set(_,f*6*3),u.set([f/a,1],f*6*2),_=[Math.sin(m),d,Math.cos(m)],l.set([_[0]*r,0,_[2]*r],f*6*3+3),vec3.normalize(_,_),h.set(_,f*6*3+3),u.set([f/a,0],f*6*2+2),_=[Math.sin(m+c),d,Math.cos(m+c)],l.set([_[0]*r,0,_[2]*r],f*6*3+6),vec3.normalize(_,_),h.set(_,f*6*3+6),u.set([(f+1)/a,0],f*6*2+4)}for(var b=0,T=0,L=vec3.fromValues(0,0,0),G=vec3.fromValues(0,-1,0),f=0;f<a;++f){var m=f*c,I=vec3.fromValues(Math.sin(m),0,Math.cos(m)),O=vec3.fromValues(Math.sin(m+c),0,Math.cos(m+c));l.set([O[0]*r,0,O[2]*r],b+f*6*3+9),h.set(G,b+f*6*3+9),u.set([O[0]*.5+.5,O[2]*.5+.5],T+f*6*2+6),l.set([I[0]*r,0,I[2]*r],b+f*6*3+12),h.set(G,b+f*6*3+12),u.set([I[0]*.5+.5,I[2]*.5+.5],T+f*6*2+8),l.set(L,b+f*6*3+15),h.set(G,b+f*6*3+15),u.set([.5,.5],T+f*6*2+10)}var E={vertices:l,normals:h,coords:u};return o.bounding=BBox.fromCenterHalfsize([0,s*.5,0],[r,s*.5,r]),se.load(E,o,t)}sphere(o={},t){for(var r=o.radius||o.size||1,s=o.lat||o.subdivisions||16,a=o.long||o.subdivisions||16,l=new Float32Array((s+1)*(a+1)*3),h=new Float32Array((s+1)*(a+1)*3),u=new Float32Array((s+1)*(a+1)*2),c=new Uint16Array(s*a*6),_=o.hemi?Math.PI*.5:Math.PI,d=0,f=0,m=0;m<=s;m++)for(var b=m*_/s,T=Math.sin(b),L=Math.cos(b),G=0;G<=a;G++){var I=G*2*Math.PI/a,O=Math.sin(I),E=Math.cos(I),D=E*T,N=L,C=O*T,R=1-G/a,S=1-m/s;l.set([r*D,r*N,r*C],d),h.set([D,N,C],d),u.set([R,S],f),d+=3,f+=2}d=0;for(var m=0;m<s;m++)for(var G=0;G<a;G++){var P=m*(a+1)+G,M=P+a+1;c.set([M,P,P+1],d),c.set([M+1,M,P+1],d+3),d+=6}var A={vertices:l,normals:h,coords:u,triangles:c};if(o.wireframe){for(var B=new Uint16Array(a*s*4),$=0,d=0;d<s;d++){for(var H=0;H<a;H++)B[$]=d*(a+1)+H,B[$+1]=d*(a+1)+H+1,$+=2;B[$-a*2]=d*(a+1)+H}for(var d=0;d<a;d++)for(var H=0;H<s;H++)B[$]=H*(a+1)+d,B[$+1]=(H+1)*(a+1)+d,$+=2;A.wireframe=B}return o.hemi?o.bounding=BBox.fromCenterHalfsize([0,r*.5,0],[r,r*.5,r],r):o.bounding=BBox.fromCenterHalfsize([0,0,0],[r,r,r],r),GL$1.Mesh.load(A,o,t)}grid(o={},t){var r=o.lines||11;r<0&&(r=1);for(var s=o.size||10,a=new Float32Array(r*2*2*3),l=s*.5,h=0,u=-l,c=s/(r-1),_=0;_<r;_++)a[h]=u,a[h+2]=-l,a[h+3]=u,a[h+5]=l,a[h+6]=l,a[h+8]=u,a[h+9]=-l,a[h+11]=u,u+=c,h+=12;return new GL$1.Mesh({vertices:a},o,t)}icosahedron(o={},t){var r=o.radius||o.size||1,s=o.subdivisions===void 0?0:o.subdivisions;s>6&&(s=6);for(var a=(1+Math.sqrt(5))/2,l=[-1,a,0,1,a,0,-1,-a,0,1,-a,0,0,-1,a,0,1,a,0,-1,-a,0,1,-a,a,0,-1,a,0,1,-a,0,-1,-a,0,1],h=[],u=[],c=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],_=l.length,d=0;d<_;d+=3){var f=Math.sqrt(l[d]*l[d]+l[d+1]*l[d+1]+l[d+2]*l[d+2]),m=l[d]/f,b=l[d+1]/f,T=l[d+2]/f;h.push(m,b,T),u.push(Math.atan2(m,T),Math.acos(b)),l[d]*=r/f,l[d+1]*=r/f,l[d+2]*=r/f}var L={};function G(C,R){var S=c[C]<c[R]?c[C]+":"+c[R]:c[R]+":"+c[C],P=L[S];if(P)return P;var M=l.length/3;l.push((l[c[C]*3]+l[c[R]*3])*.5,(l[c[C]*3+1]+l[c[R]*3+1])*.5,(l[c[C]*3+2]+l[c[R]*3+2])*.5);var A=Math.sqrt(l[M*3]*l[M*3]+l[M*3+1]*l[M*3+1]+l[M*3+2]*l[M*3+2]),B=l[M*3]/A,$=l[M*3+1]/A,H=l[M*3+2]/A;return h.push(B,$,H),u.push(Math.atan2(B,H)/Math.PI*.5,Math.acos($)/Math.PI),l[M*3]*=r/A,l[M*3+1]*=r/A,l[M*3+2]*=r/A,L[S]=M,M}for(var I=0;I<s;++I){for(var O=[],_=c.length,d=0;d<_;d+=3){var E=G(d,d+1),D=G(d+1,d+2),N=G(d+2,d);O.push(c[d],E,N),O.push(c[d+1],D,E),O.push(c[d+2],N,D),O.push(E,D,N)}c=O}return o.bounding=BBox.fromCenterHalfsize([0,0,0],[r,r,r],r),new GL$1.Mesh.load({vertices:l,coords:u,normals:h,triangles:c},o,t)}static parseOBJ(o,t={}){for(var r=[],s=[],a=[],l=[],h=[],u=[],c=[],_={},d=0,f=null,m=null,b=0,T=0,L=0,G=0,I=0,O=0,E=null,D=!1,N=!1,C=!1,R=0,S=t.noindex?t.noindex:o.length>1e7,P=t.flipAxis,M=P||t.flipNormals,A=null,B=[],$=1,H=2,F=3,W=4,z=5,U=6,V={v:$,vt:H,vn:F,f:W,g:z,o:U},X=o.split(`
`),J=X.length,pe=0;pe<J;++pe)if(f=X[pe].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),f[0]!="#"&&f!=""){E=f.split(" ");var q=V[E[0]];if(q<=F&&(G=parseFloat(E[1]),I=parseFloat(E[2]),q!=H&&(E[3]=="\\"?(++pe,f=X[pe].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),O=parseFloat(f)):O=parseFloat(E[3]))),q==$)P?h.push(-1*G,O,I):h.push(G,I,O);else if(q==H)u.push(G,I);else if(q==F)M?c.push(-I,-O,G):c.push(G,I,O);else if(q==W){if(E.length<4)continue;for(var Z=[],K=1;K<E.length;++K){if(!(E[K]in _)||S){if(m=E[K].split("/"),m.length==1)b=parseInt(m[0])-1,T=b,L=b;else if(m.length==2)b=parseInt(m[0])-1,T=parseInt(m[1])-1,L=-1;else if(m.length==3)b=parseInt(m[0])-1,T=parseInt(m[1])-1,L=parseInt(m[2])-1;else return console.err("Problem parsing: unknown number of values per face"),!1;if(K>3&&S){var Q=r.length;r.push(r[Q-(K-3)*9],r[Q-(K-3)*9+1],r[Q-(K-3)*9+2]),r.push(r[Q-3],r[Q-2],r[Q-1]),Q=s.length,s.push(s[Q-(K-3)*6],s[Q-(K-3)*6+1]),s.push(s[Q-2],s[Q-1]),Q=a.length,a.push(a[Q-(K-3)*9],a[Q-(K-3)*9+1],a[Q-(K-3)*9+2]),a.push(a[Q-3],a[Q-2],a[Q-1])}G=0,I=0,O=0,b*3+2<h.length&&(D=!0,G=h[b*3+0],I=h[b*3+1],O=h[b*3+2]),r.push(G,I,O),G=0,I=0,T*2+1<u.length&&(N=!0,G=u[T*2+0],I=u[T*2+1]),s.push(G,I),G=0,I=0,O=1,L!=-1&&(L*3+2<c.length&&(C=!0,G=c[L*3+0],I=c[L*3+1],O=c[L*3+2]),a.push(G,I,O)),S||(_[E[K]]=d++)}if(!S){var xt=_[E[K]];Z.push(xt),R<xt&&(R=xt)}}if(!S)for(var It=2;It<Z.length;It++)l.push(Z[0],Z[It-1],Z[It])}else q==z?E.length>1&&(A!=null&&(A.length=l.length-A.start,A.length>0&&B.push(A)),A={name:E[1],start:l.length,length:-1,material:""}):E[0]=="usemtl"&&A&&(A.material=E[1])}if(!h.length)return console.error("OBJ doesnt have vertices, maybe the file is not a OBJ"),null;if(A&&l.length-A.start>1&&(A.length=l.length-A.start,B.push(A)),(R>256*256||S)&&l.length>0){console.log("Deindexing mesh...");for(var ri=new Float32Array(l.length*3),Ai=a&&a.length?new Float32Array(l.length*3):null,Oi=s&&s.length?new Float32Array(l.length*2):null,K=0;K<l.length;K+=1)ri.set(r.slice(l[K]*3,l[K]*3+3),K*3),Ai&&Ai.set(a.slice(l[K]*3,l[K]*3+3),K*3),Oi&&Oi.set(s.slice(l[K]*2,l[K]*2+2),K*2);r=ri,Ai&&(a=Ai),Oi&&(s=Oi),l=null}var si={};D&&(si.vertices=new Float32Array(r)),C&&a.length>0&&(si.normals=new Float32Array(a)),N&&s.length>0&&(si.coords=new Float32Array(s)),l&&l.length>0&&(si.triangles=new Uint16Array(l));var Qi={};if(B.length>1&&(Qi.groups=B),si.info=Qi,t.only_data)return si;var zi=null;return zi=se.load(si,null,t.mesh),zi.updateBoundingBox(),zi}},g(se,"common_buffers",{vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal"},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color"},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights"},extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}}),g(se,"default_datatype",Float32Array),g(se,"parsers",{}),g(se,"encoders",{}),g(se,"binary_file_formats",{}),g(se,"compressors",{}),g(se,"decompressors",{}),g(se,"fromURL",function(o,t,r,s={}){r=r||global$1.gl;var a=new GL$1.Mesh(void 0,void 0,void 0,r);a.ready=!1;var l=o.lastIndexOf("."),h=o.substr(l+1).toLowerCase();return s.binary=se.binary_file_formats[h],HttpRequest(o,null,function(u){a.parse(u,h),delete a.ready,t&&t.call(a,a,o)},function(u){t&&t(null)},s),a}),se);GL$1.Mesh=Mesh$1,GL$1.Mesh.EXTENSION="wbin",GL$1.Mesh.enable_wbin_compression=!0,Mesh$1.prototype.delete=Mesh$1.prototype.deleteBuffers,Mesh$1.parsers.obj=Mesh$1.parseOBJ,Mesh$1.encoders.obj=function(o,t){var r=o.getBuffer("vertices");if(!r)return null;var s=[];s.push(`# Generated with liteGL.js by Javi Agenjo
`);for(var a=r.data,l=0;l<a.length;l+=3)s.push("v "+a[l].toFixed(4)+" "+a[l+1].toFixed(4)+" "+a[l+2].toFixed(4));var h=o.getBuffer("normals");if(h){s.push("");for(var u=h.data,l=0;l<u.length;l+=3)s.push("vn "+u[l].toFixed(4)+" "+u[l+1].toFixed(4)+" "+u[l+2].toFixed(4))}var c=o.getBuffer("coords");if(c){s.push("");for(var _=c.data,l=0;l<_.length;l+=2)s.push("vt "+_[l].toFixed(4)+" "+_[l+1].toFixed(4)+"  0.0000")}var d=o.info.groups,f=o.getIndexBuffer("triangles");if(f){var m=f.data;(!d||!d.length)&&(d=[{start:0,length:m.length,name:"mesh"}]);for(var b=0;b<d.length;++b){var T=d[b];s.push("g "+T.name),s.push("usemtl "+(T.material||"mat_"+b));for(var L=T.start,G=L+T.length,l=L;l<G;l+=3)s.push("f "+(m[l]+1)+"/"+(m[l]+1)+"/"+(m[l]+1)+" "+(m[l+1]+1)+"/"+(m[l+1]+1)+"/"+(m[l+1]+1)+" "+(m[l+2]+1)+"/"+(m[l+2]+1)+"/"+(m[l+2]+1))}}else{(!d||!d.length)&&(d=[{start:0,length:a.length/3,name:"mesh"}]);for(var b=0;b<d.length;++b){var T=d[b];s.push("g "+T.name),s.push("usemtl "+(T.material||"mat_"+b));for(var L=T.start,G=L+T.length,l=L;l<G;l+=3)s.push("f "+(l+1)+"/"+(l+1)+"/"+(l+1)+" "+(l+2)+"/"+(l+2)+"/"+(l+2)+" "+(l+3)+"/"+(l+3)+"/"+(l+3))}}return s.join(`
`)},Mesh$1.parsers.mesh=function(o,t){for(var r={},s=o.split(`
`),a=0;a<s.length;++a){var l=s[a],h=l[0],u=l.substr(1).split(","),c=u[0];if(h=="-"){for(var _=new Float32Array(Number(u[1])),d=0;d<_.length;++d)_[d]=Number(u[d+2]);r[c]=_}else if(h=="*"){for(var _=Number(u[1])>65536?new Uint32Array(Number(u[1])):new Uint16Array(Number(u[1])),d=0;d<_.length;++d)_[d]=Number(u[d+2]);r[c]=_}else if(h=="@"){if(c=="bones"){for(var f=[],m=Number(u[1]),d=0;d<m;++d){var b=u.slice(3+d*17,3+(d+1)*17-1).map(Number);f.push([u[2+d*17],b])}r.bones=f}else if(c=="bind_matrix")r.bind_matrix=u.slice(1,17).map(Number);else if(c=="groups"){r.info={groups:[]};for(var T=Number(u[1]),d=0;d<T;++d){var L={name:u[2+d*4],material:u[2+d*4+1],start:Number(u[2+d*4+2]),length:Number(u[2+d*4+3])};r.info.groups.push(L)}}}else console.warn("type unknown: "+u[0])}if(t.only_data)return r;var G=null;return G=Mesh$1.load(r,null,t.mesh),G.updateBoundingBox(),G},Mesh$1.encoders.mesh=function(o,t){var r=[];for(var s in o.vertexBuffers){var a=o.vertexBuffers[s],l=["-"+s,a.data.length,a.data,Array.from(a.data)];r.push(l.join(","))}for(var s in o.indexBuffers){var a=o.indexBuffers[s],l=["*"+s,a.data.length,a.data,Array.from(a.data)];r.push(l.join(","))}if(o.bounding&&r.push(["@bounding",Array.from(o.bounding.subarray(0,6))].join(",")),o.info&&o.info.groups){for(var h=[],u=0;u<o.info.groups.length;++u){var c=o.info.groups[u];h.push(c.name,c.material,c.start,c.length)}r.push(["@groups",o.info.groups.length].concat(h).join(","))}return o.bones&&r.push(["@bones",o.bones.length,o.bones.flat()].join(",")),o.bind_matrix&&r.push(["@bind_matrix",Array.from(o.bind_matrix)].join(",")),r.join(`
`)},global$1.WBin&&(global$1.WBin.classes.Mesh=Mesh$1),Mesh$1.binary_file_formats.wbin=!0,Mesh$1.parsers.wbin=Mesh$1.fromBinary=function(o,t={}){if(!global$1.WBin)throw"To use binary meshes you need to install WBin.js from https://github.com/jagenjo/litescene.js/blob/master/src/utils/wbin.js ";var r=null;o.constructor==ArrayBuffer?r=WBin.load(o,!0):r=o,r.info||console.warn("This WBin doesn't seem to contain a mesh. Classname: ",r["@classname"]),r.format&&GL$1.Mesh.decompress(r);var s={};if(r.vertex_buffers)for(var a in r.vertex_buffers)s[r.vertex_buffers[a]]=r[r.vertex_buffers[a]];else r.vertices&&(s.vertices=r.vertices),r.normals&&(s.normals=r.normals),r.coords&&(s.coords=r.coords),r.weights&&(s.weights=r.weights),r.bone_indices&&(s.bone_indices=r.bone_indices);var l={};if(r.index_buffers)for(var a in r.index_buffers)l[r.index_buffers[a]]=r[r.index_buffers[a]];else r.triangles&&(l.triangles=r.triangles),r.wireframe&&(l.wireframe=r.wireframe);var h={vertex_buffers:s,index_buffers:l,bounding:r.bounding,info:r.info};if(r.bones){h.bones=r.bones;for(var a=0;a<h.bones.length;++a)h.bones[a][1]=mat4.clone(h.bones[a][1]);r.bind_matrix&&(h.bind_matrix=mat4.clone(r.bind_matrix))}if(r.morph_targets&&(h.morph_targets=r.morph_targets),t.only_data)return h;var u=t.mesh||new GL$1.Mesh;return u.configure(h),u},Mesh$1.encoders.wbin=function(o,t){return o.toBinary(t)},Mesh$1.prototype.toBinary=function(o){if(!global$1.WBin)throw"to use Mesh.toBinary you need to have WBin included. Check the repository for wbin.js";this.info||(this.info={});var t={object_class:"Mesh",info:this.info,groups:this.groups};if(this.bones){for(var r=[],s=0;s<this.bones.length;++s)r.push([this.bones[s][0],mat4.toArray(this.bones[s][1])]);t.bones=r,this.bind_matrix&&(t.bind_matrix=this.bind_matrix)}this.bounding||this.updateBoundingBox(),t.bounding=this.bounding;var a=[],l=[];for(var s in this.vertexBuffers){var h=this.vertexBuffers[s];t[h.name]=h.data,a.push(h.name),h.name=="vertices"&&(t.info.num_vertices=h.data.length/3)}for(var s in this.indexBuffers){var h=this.indexBuffers[s];t[s]=h.data,l.push(s)}t.vertex_buffers=a,t.index_buffers=l,GL$1.Mesh.enable_wbin_compression&&GL$1.Mesh.compress(t);var u=WBin.create(t,"Mesh");return u},Mesh$1.compress=function(o,t){t=t||"bounding_compressed",o.format={type:t};var r=Mesh$1.compressors[t];if(!r)throw"compression format not supported:"+t;return r(o)},Mesh$1.decompress=function(o){if(o.format){var t=Mesh$1.decompressors[o.format.type];if(!t)throw"decompression format not supported:"+o.format.type;return t(o)}},Mesh$1.compressors.bounding_compressed=function(o){if(!o.vertex_buffers)throw"buffers not found";for(var t=BBox.getMin(o.bounding),r=BBox.getMax(o.bounding),s=vec3.sub(vec3.create(),r,t),a=o.vertices,l=new Uint16Array(a.length),h=0;h<a.length;h+=3)l[h]=(a[h]-t[0])/s[0]*65535,l[h+1]=(a[h+1]-t[1])/s[1]*65535,l[h+2]=(a[h+2]-t[2])/s[2]*65535;if(o.vertices=l,o.normals){for(var u=o.normals,c=new Uint8Array(u.length),_=c.constructor==Uint8Array?255:65535,h=0;h<u.length;h+=3)c[h]=(u[h]*.5+.5)*_,c[h+1]=(u[h+1]*.5+.5)*_,c[h+2]=(u[h+2]*.5+.5)*_;o.normals=c}if(o.coords){for(var d=o.coords,f=[1e4,1e4,-1e4,-1e4],h=0;h<d.length;h+=2){var m=d[h];f[0]>m?f[0]=m:f[2]<m&&(f[2]=m);var b=d[h+1];f[1]>b?f[1]=b:f[3]<b&&(f[3]=b)}o.format.uvs_bounding=f;for(var T=new Uint16Array(d.length),s=[f[2]-f[0],f[3]-f[1]],h=0;h<d.length;h+=2)T[h]=(d[h]-f[0])/s[0]*65535,T[h+1]=(d[h+1]-f[1])/s[1]*65535;o.coords=T}if(o.weights){for(var L=o.weights,G=new Uint16Array(L.length),I=G.constructor==Uint8Array?255:65535,h=0;h<L.length;h+=4)G[h]=L[h]*I,G[h+1]=L[h+1]*I,G[h+2]=L[h+2]*I,G[h+3]=L[h+3]*I;o.weights=G}},Mesh$1.decompressors.bounding_compressed=function(o){var t=o.bounding;if(!t)throw"error in mesh decompressing data: bounding not found, cannot use the bounding decompression.";for(var r=BBox.getMin(t),s=BBox.getMax(t),a=vec3.sub(vec3.create(),s,r),l=o.format,h=1/255,u=1/65535,c=o.vertices,_=new Float32Array(c.length),d=0,f=c.length;d<f;d+=3)_[d]=c[d]*u*a[0]+r[0],_[d+1]=c[d+1]*u*a[1]+r[1],_[d+2]=c[d+2]*u*a[2]+r[2];if(o.vertices=_,o.normals&&o.normals.constructor!=Float32Array){for(var m=o.normals,b=new Float32Array(m.length),T=m.constructor==Uint8Array?h:u,d=0,f=m.length;d<f;d+=3){b[d]=m[d]*T*2-1,b[d+1]=m[d+1]*T*2-1,b[d+2]=m[d+2]*T*2-1;var L=b.subarray(d,d+3);vec3.normalize(L,L)}o.normals=b}if(o.coords&&l.uvs_bounding&&o.coords.constructor!=Float32Array){for(var G=o.coords,I=l.uvs_bounding,a=[I[2]-I[0],I[3]-I[1]],O=new Float32Array(G.length),d=0,f=G.length;d<f;d+=2)O[d]=G[d]*u*a[0]+I[0],O[d+1]=G[d+1]*u*a[1]+I[1];o.coords=O}if(o.weights&&o.weights.constructor!=Float32Array){for(var E=o.weights,D=new Float32Array(E.length),N=E.constructor==Uint8Array?h:u,d=0,f=E.length;d<f;d+=4)D[d]=E[d]*N,D[d+1]=E[d+1]*N,D[d+2]=E[d+2]*N,D[d+3]=E[d+3]*N;o.weights=D}};const Je=class Ci{constructor(t,r,s,a,l){t=t||1024,GL$1.debug&&console.log("GL.Mesh created"),l!==null&&(l=l||global$1.gl,this.gl=l),this._context_id=l.context_id,this.vertexBuffers={},this.indexBuffers={},this.info={groups:[]},this._bounding=BBox.create(),this.resize(t)}resize(t){var r={};this._vertex_data=new Float32Array(t*3),r.vertices=this._vertex_data,normals&&(r.normals=this._normal_data=new Float32Array(t*3)),coords&&(r.coords=this._coord_data=new Float32Array(t*2)),colors&&(r.colors=this._color_data=new Float32Array(t*4)),this.addBuffers(r),this.current_pos=0,this.max_size=t,this._must_update=!0}clear(){this.current_pos=0}addPoint(t,r,s,a){if(l>=this.max_size)return console.warn("DynamicMesh: not enough space, reserve more"),!1;var l=this.current_pos++;return this._vertex_data.set(t,l*3),this._normal_data&&this._normal_data.set(r||Ci.DEFAULT_NORMAL,l*3),this._coord_data&&this._coord_data.set(s||Ci.DEFAULT_COORD,l*2),this._color_data&&this._color_data.set(a||Ci.DEFAULT_COLOR,l*4),this._must_update=!0,!0}update(t){return!this._must_update&&!t?this.current_pos:(this._must_update=!1,this.getBuffer("vertices").upload(gl.STREAM_DRAW),this._normal_data&&this.getBuffer("normal").upload(gl.STREAM_DRAW),this._coord_data&&this.getBuffer("coord").upload(gl.STREAM_DRAW),this._color_data&&this.getBuffer("color").upload(gl.STREAM_DRAW),this.current_pos)}};g(Je,"DEFAULT_NORMAL",vec3.fromValues(0,1,0)),g(Je,"DEFAULT_COORD",vec2.fromValues(.5,.5)),g(Je,"DEFAULT_COLOR",vec4.fromValues(1,1,1,1));let DynamicMesh=Je;GL$1.extendClass(DynamicMesh,Mesh$1);const te=class wt{constructor(t,r,s={},a){if(a=a||global$1.gl,this.gl=a,this._context_id=a.context_id,t=parseInt(t),r=parseInt(r),GL$1.debug&&console.log("GL.Texture created: ",t,r),this.handler=a.createTexture(),this.width=t,this.height=r,s.depth&&(this.depth=s.depth),this.texture_type=s.texture_type||a.TEXTURE_2D,this.format=s.format||wt.DEFAULT_FORMAT,this.internalFormat=s.internalFormat,this.type=s.type||wt.DEFAULT_TYPE,this.magFilter=s.magFilter||s.filter||wt.DEFAULT_MAG_FILTER,this.minFilter=s.minFilter||s.filter||wt.DEFAULT_MIN_FILTER,this.wrapS=s.wrap||s.wrapS||wt.DEFAULT_WRAP_S,this.wrapT=s.wrap||s.wrapT||wt.DEFAULT_WRAP_T,this.data=null,wt.MAX_TEXTURE_IMAGE_UNITS||(wt.MAX_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS)),this.has_mipmaps=!1,this.format==a.DEPTH_COMPONENT&&a.webgl_version==1&&!a.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==a.FLOAT&&!a.extensions.OES_texture_float&&a.webgl_version==1)throw"Float Texture not supported";if(this.type==a.HALF_FLOAT_OES){if(!a.extensions.OES_texture_half_float&&a.webgl_version==1)throw"Half Float Texture extension not supported.";a.webgl_version>1&&(console.warn("using HALF_FLOAT_OES in WebGL2 is deprecated, suing HALF_FLOAT instead"),this.type=this.format==a.RGB?a.RGB16F:a.RGBA16F)}if((!isPowerOfTwo(this.width)||!isPowerOfTwo(this.height))&&(this.minFilter!=a.NEAREST&&this.minFilter!=a.LINEAR||this.wrapS!=a.CLAMP_TO_EDGE||this.wrapT!=a.CLAMP_TO_EDGE))if(s.ignore_pot)this.minFilter=this.magFilter=a.LINEAR,this.wrapS=this.wrapT=a.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(!t||!r)return;this.internalFormat||this.computeInternalFormat(),a.activeTexture(a.TEXTURE0+wt.MAX_TEXTURE_IMAGE_UNITS-1),a.bindTexture(this.texture_type,this.handler),a.texParameteri(this.texture_type,a.TEXTURE_MAG_FILTER,this.magFilter),a.texParameteri(this.texture_type,a.TEXTURE_MIN_FILTER,this.minFilter),a.texParameteri(this.texture_type,a.TEXTURE_WRAP_S,this.wrapS),a.texParameteri(this.texture_type,a.TEXTURE_WRAP_T,this.wrapT),s.anisotropic&&a.extensions.EXT_texture_filter_anisotropic&&a.texParameterf(GL$1.TEXTURE_2D,a.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,s.anisotropic);var l=this.type,h=s.pixel_data;if(h&&!h.buffer){if(this.texture_type==GL$1.TEXTURE_CUBE_MAP)if(h[0].constructor===Number)h=c(h),h=[h,h,h,h,h,h];else for(var u=0;u<h.length;++u)h[u]=c(h[u]);else h=c(h);this.data=h}function c(_){return _.constructor!==Array?_:l==GL$1.FLOAT?new Float32Array(_):l==GL$1.HALF_FLOAT_OES?new Uint16Array(_):new Uint8Array(_)}if(this.texture_type==GL$1.TEXTURE_2D)a.texImage2D(GL$1.TEXTURE_2D,0,this.internalFormat,t,r,0,this.format,this.type,h||null),GL$1.isPowerOfTwo(t)&&GL$1.isPowerOfTwo(r)&&s.minFilter&&s.minFilter!=a.NEAREST&&s.minFilter!=a.LINEAR&&(a.generateMipmap(this.texture_type),this.has_mipmaps=!0);else if(this.texture_type==GL$1.TEXTURE_CUBE_MAP)for(var u=0;u<6;++u)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,0,this.internalFormat,this.width,this.height,0,this.format,this.type,h?h[u]:null);else if(this.texture_type==GL$1.TEXTURE_3D){if(this.gl.webgl_version==1)throw"TEXTURE_3D not supported in WebGL 1. Enable WebGL 2 in the context by passing webgl2:true to the context";if(!s.depth)throw"3d texture depth must be set in the options.depth";a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.texImage3D(GL$1.TEXTURE_3D,0,this.internalFormat,t,r,s.depth,0,this.format,this.type,h||null)}a.bindTexture(this.texture_type,null),a.activeTexture(a.TEXTURE0)}computeInternalFormat(){if(this.internalFormat=this.format,this.format==GL$1.DEPTH_COMPONENT){if(this.minFilter=this.magFilter=GL$1.NEAREST,gl.webgl_version==2)if(this.type==GL$1.UNSIGNED_SHORT)this.internalFormat=GL$1.DEPTH_COMPONENT16;else if(this.type==GL$1.UNSIGNED_INT)this.internalFormat=GL$1.DEPTH_COMPONENT24;else if(this.type==GL$1.FLOAT)this.internalFormat=GL$1.DEPTH_COMPONENT32F;else throw"unsupported type for a depth texture";else if(gl.webgl_version==1){if(this.type==GL$1.FLOAT)throw"WebGL 1.0 does not support float depth textures";this.internalFormat=GL$1.DEPTH_COMPONENT}}else this.format==gl.RGBA&&(gl.webgl_version==2?this.type==GL$1.FLOAT?this.internalFormat=GL$1.RGBA32F:this.type==GL$1.HALF_FLOAT?this.internalFormat=GL$1.RGBA16F:this.type==GL$1.HALF_FLOAT_OES&&(console.warn("webgl 2 does not use HALF_FLOAT_OES, converting to HALF_FLOAT"),this.type=GL$1.HALF_FLOAT,this.internalFormat=GL$1.RGBA16F):gl.webgl_version==1&&this.type==GL$1.HALF_FLOAT&&(console.warn("webgl 1 does not use HALF_FLOAT, converting to HALF_FLOAT_OES"),this.type=GL$1.HALF_FLOAT_OES))}delete(){gl.deleteTexture(this.handler),this.handler=null}getProperties(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}}hasSameProperties(t){return t?t.width==this.width&&t.height==this.height&&t.type==this.type&&t.format==this.format&&t.texture_type==this.texture_type:!1}hasSameSize(t){return t?t.width==this.width&&t.height==this.height:!1}toJSON(){return""}static isDepthSupported(){return gl.extensions.WEBGL_depth_texture!=null}bind(t){t==null&&(t=0);var r=this.gl;return r.activeTexture(r.TEXTURE0+t),r.bindTexture(this.texture_type,this.handler),t}unbind(t){t===void 0&&(t=0);var r=this.gl;r.activeTexture(r.TEXTURE0+t),r.bindTexture(this.texture_type,null)}setParameter(t,r){switch(this.bind(0),this.gl.texParameteri(this.texture_type,t,r),t){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=r;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=r;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=r;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=r;break}}static setUploadOptions(t,r){r=r||global$1.gl,t?(r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!t.premultiply_alpha),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!t.no_flip)):(r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0)),r.pixelStorei(r.UNPACK_ALIGNMENT,1)}uploadImage(t,r){this.bind();var s=this.gl;if(!t)throw"uploadImage parameter must be Image";wt.setUploadOptions(r,s);try{s.texImage2D(s.TEXTURE_2D,0,this.format,this.format,this.type,t),this.width=t.videoWidth||t.width,this.height=t.videoHeight||t.height,this.data=t}catch{throw location.protocol=="file:"?'image not loaded for security reasons (serve this page over "http://" instead)':"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}this.minFilter&&this.minFilter!=s.NEAREST&&this.minFilter!=s.LINEAR&&(s.generateMipmap(this.texture_type),this.has_mipmaps=!0),s.bindTexture(this.texture_type,null)}uploadData(t,r={},s){if(!t)throw"no data passed";var a=this.gl;this.bind(),wt.setUploadOptions(r,a);var l=r.mipmap_level||0,h=this.width,u=this.height;h=h>>l,u=u>>l;var c=this.internalFormat||this.format;if(this.type==GL$1.HALF_FLOAT_OES&&t.constructor===Float32Array&&console.warn("cannot uploadData to a HALF_FLOAT texture from a Float32Array, must be Uint16Array. To upload it we recomment to create a FLOAT texture, upload data there and copy to your HALF_FLOAT."),this.texture_type==GL$1.TEXTURE_2D)a.webgl_version==1?t.buffer&&t.buffer.constructor==ArrayBuffer?a.texImage2D(this.texture_type,l,c,h,u,0,this.format,this.type,t):a.texImage2D(this.texture_type,l,c,this.format,this.type,t):a.webgl_version==2&&(t.buffer&&t.buffer.constructor==ArrayBuffer?a.texImage2D(this.texture_type,l,c,h,u,0,this.format,this.type,t):a.texImage2D(this.texture_type,l,c,h,u,0,this.format,this.type,t));else if(this.texture_type==GL$1.TEXTURE_3D)a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.texImage3D(this.texture_type,l,c,h,u,this.depth>>l,0,this.format,this.type,t);else if(this.texture_type==GL$1.TEXTURE_CUBE_MAP)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+(r.cubemap_face||0),l,c,h,u,0,this.format,this.type,t);else throw"cannot uploadData for this texture type";this.data=t,!s&&this.minFilter&&this.minFilter!=a.NEAREST&&this.minFilter!=a.LINEAR&&(a.generateMipmap(this.texture_type),this.has_mipmaps=!0),a.bindTexture(this.texture_type,null)}drawTo(t,r){var s=this.gl,a=s.getViewport(),l=GL$1.getTime(),h=s.getParameter(s.FRAMEBUFFER_BINDING),u=s._framebuffer=s._framebuffer||s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,u);var c=null;{s._renderbuffers_pool||(s._renderbuffers_pool={});var _=this.width+":"+this.height;s._renderbuffers_pool[_]?(c=s._renderbuffers_pool[_],c.time=l,s.bindRenderbuffer(s.RENDERBUFFER,c)):(s._renderbuffers_pool[_]=c=s.createRenderbuffer(),c.time=l,c.width=this.width,c.height=this.height,s.bindRenderbuffer(s.RENDERBUFFER,c),setTimeout(d.bind(c),1e3*60))}this.format===s.DEPTH_COMPONENT?s.renderbufferStorage(s.RENDERBUFFER,s.RGBA4,this.width,this.height):s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_COMPONENT16,this.width,this.height);function d(){GL$1.getTime()-this.time>=1e3*60?(s.deleteRenderbuffer(s._renderbuffers_pool[_]),delete s._renderbuffers_pool[_]):setTimeout(d.bind(this),1e3*60)}if(s.viewport(0,0,this.width,this.height),s._current_texture_drawto=this,s._current_fbo_color=u,s._current_fbo_depth=c,this.texture_type==s.TEXTURE_2D)this.format!==s.DEPTH_COMPONENT?(s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.handler,0),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,c)):(s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,c),s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.TEXTURE_2D,this.handler,0)),t(this,r);else if(this.texture_type==s.TEXTURE_CUBE_MAP){this.format!==s.DEPTH_COMPONENT?s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,c):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,c);for(var f=0;f<6;f++)this.format!==s.DEPTH_COMPONENT?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+f,this.handler,0):s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.TEXTURE_CUBE_MAP_POSITIVE_X+f,this.handler,0),t(this,f,r)}return this.data=null,s._current_texture_drawto=null,s._current_fbo_color=null,s._current_fbo_depth=null,s.bindFramebuffer(s.FRAMEBUFFER,h),s.bindRenderbuffer(s.RENDERBUFFER,null),s.viewport(a[0],a[1],a[2],a[3]),this}static drawTo(t,r,s){var a=-1,l=-1,h=null;if(!t&&!s)throw"Textures missing in drawTo";if(t&&t.length)for(var u=0;u<t.length;u++){var c=t[u];if(a==-1)a=c.width;else if(a!=c.width)throw"Cannot use Texture.drawTo if textures have different dimensions";if(l==-1)l=c.height;else if(l!=c.height)throw"Cannot use Texture.drawTo if textures have different dimensions";if(h==null)h=c.type;else if(h!=c.type)throw"Cannot use Texture.drawTo if textures have different data type, all must have the same type"}else a=s.width,l=s.height;var _=gl.extensions.WEBGL_draw_buffers;if(!_&&t&&t.length>1)throw"Rendering to several textures not supported";var d=gl.getViewport();gl._framebuffer=gl._framebuffer||gl.createFramebuffer(),gl.bindFramebuffer(gl.FRAMEBUFFER,gl._framebuffer),gl.viewport(0,0,a,l);var f=null;if(s&&s.format!==gl.DEPTH_COMPONENT||s.type!=gl.UNSIGNED_INT)throw"Depth texture must be of format: gl.DEPTH_COMPONENT and type: gl.UNSIGNED_INT";if(s?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,s.handler,0):(f=gl._renderbuffer=gl._renderbuffer||gl.createRenderbuffer(),f.width=a,f.height=l,gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a,l),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,f)),t){for(var m=[],u=0;u<t.length;u++){var c=t[u];gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+u,gl.TEXTURE_2D,c.handler,0),m.push(gl.COLOR_ATTACHMENT0+u)}t.length>1&&_.drawBuffersWEBGL(m)}else{var b=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer();b.width=a,b.height=l,gl.bindRenderbuffer(gl.RENDERBUFFER,b),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,a,l),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,b)}var T=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(T!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+T;if(r(),t.length)for(var u=0;u<t.length;++u)t[u].data=null;gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(d[0],d[1],d[2],d[3])}static drawToColorAndDepth(t,r,s){var a=t.gl;if(r.width!=t.width||r.height!=t.height)throw"Different size between color texture and depth texture";var l=a.getViewport();a._framebuffer=a._framebuffer||a.createFramebuffer(),a.bindFramebuffer(a.FRAMEBUFFER,a._framebuffer),a.viewport(0,0,t.width,t.height),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,t.handler,0),a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_2D,r.handler,0),s(),t.data=null,r.data=null,a.bindFramebuffer(a.FRAMEBUFFER,null),a.viewport(l[0],l[1],l[2],l[3])}copyTo(t,r,s){var a=this.gl;if(!t)throw"target_texture required";var l=a.getParameter(a.FRAMEBUFFER_BINDING),h=a.getViewport();r||(r=this.texture_type==a.TEXTURE_2D?GL$1.Shader.getScreenShader():GL$1.Shader.getCubemapCopyShader()),a.disable(a.BLEND),a.disable(a.DEPTH_TEST),r&&s&&r.uniforms(s);var u=a.__copy_fbo;if(u||(u=a.__copy_fbo=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,u),a.viewport(0,0,t.width,t.height),this.texture_type==a.TEXTURE_2D)if(this.format!==a.DEPTH_COMPONENT&&this.format!==a.DEPTH_STENCIL)a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,t.handler,0),this.toViewport(r);else{var c=a._color_renderbuffer=a._color_renderbuffer||a.createRenderbuffer(),_=c.width=t.width,d=c.height=t.height;a.bindRenderbuffer(a.RENDERBUFFER,c),a.renderbufferStorage(a.RENDERBUFFER,a.RGBA4,_,d),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.RENDERBUFFER,c);var f=t.format==a.DEPTH_STENCIL?a.DEPTH_STENCIL_ATTACHMENT:a.DEPTH_ATTACHMENT;a.framebufferTexture2D(a.FRAMEBUFFER,f,a.TEXTURE_2D,t.handler,0);var m=a.checkFramebufferStatus(a.FRAMEBUFFER);if(m!==a.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+m;a.enable(a.DEPTH_TEST),a.depthFunc(a.ALWAYS),a.colorMask(!1,!1,!1,!1),r=GL$1.Shader.getCopyDepthShader(),this.toViewport(r),a.colorMask(!0,!0,!0,!0),a.disable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.RENDERBUFFER,null),a.framebufferTexture2D(a.FRAMEBUFFER,f,a.TEXTURE_2D,null,0)}else if(this.texture_type==a.TEXTURE_CUBE_MAP){r.uniforms({u_texture:0});for(var b=GL$1.temp_mat3,T=0;T<6;T++){a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+T,t.handler,0);var L=GL$1.Texture.cubemap_camera_parameters[T];mat3.identity(b),b.set(L.right,0),b.set(L.up,3),b.set(L.dir,6),this.toViewport(r,{u_rotation:b})}}return a.setViewport(h),a.bindFramebuffer(a.FRAMEBUFFER,l),t.minFilter&&t.minFilter!=a.NEAREST&&t.minFilter!=a.LINEAR&&(t.bind(),a.generateMipmap(t.texture_type),t.has_mipmaps=!0),t.data=null,a.bindTexture(t.texture_type,null),this}toViewport(t,r){t=t||Shader.getScreenShader();var s=Mesh$1.getScreenQuad();this.bind(0),r&&t.uniforms(r),t.draw(s,gl.TRIANGLES)}fill(t,r){var s=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(t[0],t[1],t[2],t[3]),this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)}),gl.clearColor(s[0],s[1],s[2],s[3]),!r&&this.minFilter&&this.minFilter!=gl.NEAREST&&this.minFilter!=gl.LINEAR&&(this.bind(),gl.generateMipmap(this.texture_type),this.has_mipmaps=!0)}applyBlur(t,r,s,a,l){var h=this.gl;t===void 0&&(t=1),r===void 0&&(r=1),h.disable(h.DEPTH_TEST),h.disable(h.BLEND),a=a||this;var u=!l;if(l===a)throw"cannot use applyBlur in a texture using as temporary itself";if(a&&this.texture_type!==a.texture_type)throw"cannot use applyBlur with textures of different texture_type";var c=h.getParameter(h.FRAMEBUFFER_BINDING),_=h.getViewport(),d=h.__copy_fbo;if(d||(d=h.__copy_fbo=h.createFramebuffer()),h.bindFramebuffer(h.FRAMEBUFFER,d),h.viewport(0,0,this.width,this.height),this.texture_type===h.TEXTURE_2D){var f=GL$1.Shader.getBlurShader();l||(l=GL$1.Texture.getTemporary(this.width,this.height,this)),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,l.handler,0),this.toViewport(f,{u_texture:0,u_intensity:s,u_offset:[0,r/this.height]}),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,a.handler,0),h.viewport(0,0,a.width,a.height),l.toViewport(f,{u_intensity:s,u_offset:[t/l.width,0]}),u&&GL$1.Texture.releaseTemporary(l)}else if(this.texture_type===h.TEXTURE_CUBE_MAP){var f=GL$1.Shader.getCubemapBlurShader();f.uniforms({u_texture:0,u_intensity:s,u_offset:[t/this.width,r/this.height]}),this.bind(0);var m=Mesh$1.getScreenQuad();m.bindBuffers(f),f.bind();var b=null;!l&&a==this?b=l=GL$1.Texture.getTemporary(a.width,a.height,a):b=a;for(var T=GL$1.temp_mat3,L=0;L<6;++L){h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_CUBE_MAP_POSITIVE_X+L,b.handler,0);var G=GL$1.Texture.cubemap_camera_parameters[L];mat3.identity(T),T.set(G.right,0),T.set(G.up,3),T.set(G.dir,6),f._setUniform("u_rotation",T),h.drawArrays(h.TRIANGLES,0,6)}m.unbindBuffers(f),l&&l.copyTo(a),l&&u&&GL$1.Texture.releaseTemporary(l)}h.setViewport(_),h.bindFramebuffer(h.FRAMEBUFFER,c),a.data=null,a.minFilter&&a.minFilter!=h.NEAREST&&a.minFilter!=h.LINEAR&&(a.bind(),h.generateMipmap(a.texture_type),a.has_mipmaps=!0),h.bindTexture(a.texture_type,null)}static fromURL(t,r={},s,a){a=a||global$1.gl,r=Object.create(r);var l=r.texture||new GL$1.Texture(1,1,r,a);t.length<64&&(l.url=t),l.bind();var h=r.temp_color||wt.loading_color;a.pixelStorei(a.UNPACK_ALIGNMENT,4);var u=r.type==a.FLOAT?new Float32Array(h):new Uint8Array(h);a.texImage2D(a.TEXTURE_2D,0,l.format,l.width,l.height,0,l.format,l.type,u),a.bindTexture(l.texture_type,null),l.ready=!1;var c=null;if(r.extension&&(c=r.extension),!c&&t.length<512){var _=t,d=t.indexOf("?");d!=-1&&(_=t.substr(0,d)),d=_.lastIndexOf("."),d!=-1&&(c=_.substr(d+1).toLowerCase())}if(c=="dds"){var c=a.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||a.getExtension("WEBGL_compressed_texture_s3tc"),f=new GL$1.Texture(0,0,r,a);DDS.loadDDSTextureEx(a,c,t,f.handler,!0,function(T){l.texture_type=T.texture_type,l.handler=T,delete l.ready,s&&s(l,t)})}else if(c=="tga")HttpRequest(t,null,function(b){var T=GL$1.Texture.parseTGA(b);T&&(r.texture=l,T.format=="RGB"&&(l.format=a.RGB),l=GL$1.Texture.fromMemory(T.width,T.height,T.pixels,r),delete l.ready,s&&s(l,t))},null,{binary:!0});else{var m=new Image;m.src=t,m.onload=function(){r.texture=l,GL$1.Texture.fromImage(this,r),delete l.ready,s&&s(l,t)},m.onerror=function(){s&&s(null)}}return l}static parseTGA(t){if(!t||t.constructor!==ArrayBuffer)throw"TGA: data must be ArrayBuffer";t=new Uint8Array(t);for(var r=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),s=t.subarray(0,12),a=0;a<s.length;a++)if(r[a]!=s[a])return console.error("TGA header is not valid"),null;var l=t.subarray(12,18),h={};if(h.width=l[1]*256+l[0],h.height=l[3]*256+l[2],h.bpp=l[4],h.bytesPerPixel=h.bpp/8,h.imageSize=h.width*h.height*h.bytesPerPixel,h.pixels=t.subarray(18,18+h.imageSize),h.pixels=new Uint8Array(h.pixels),(l[5]&16)==0){for(var a=0;a<h.imageSize;a+=h.bytesPerPixel){var u=h.pixels[a];h.pixels[a]=h.pixels[a+2],h.pixels[a+2]=u}l[5]|=16,h.format=h.bpp==32?"RGBA":"RGB"}else h.format=h.bpp==32?"RGBA":"RGB";return h.flipY=!0,h}static fromImage(t,r={}){var s=r.texture||new GL$1.Texture(t.width,t.height,r);return s.uploadImage(t,r),s.bind(),gl.texParameteri(s.texture_type,gl.TEXTURE_MAG_FILTER,s.magFilter),gl.texParameteri(s.texture_type,gl.TEXTURE_MIN_FILTER,s.minFilter),gl.texParameteri(s.texture_type,gl.TEXTURE_WRAP_S,s.wrapS),gl.texParameteri(s.texture_type,gl.TEXTURE_WRAP_T,s.wrapT),GL$1.isPowerOfTwo(s.width)&&GL$1.isPowerOfTwo(s.height)?r.minFilter&&r.minFilter!=gl.NEAREST&&r.minFilter!=gl.LINEAR&&(s.bind(),gl.generateMipmap(s.texture_type),s.has_mipmaps=!0):(gl.texParameteri(s.texture_type,gl.TEXTURE_MIN_FILTER,GL$1.LINEAR),gl.texParameteri(s.texture_type,gl.TEXTURE_WRAP_S,GL$1.CLAMP_TO_EDGE),gl.texParameteri(s.texture_type,gl.TEXTURE_WRAP_T,GL$1.CLAMP_TO_EDGE),s.has_mipmaps=!1),gl.bindTexture(s.texture_type,null),s.data=t,r.keep_image&&(s.img=t),s}static fromVideo(t,r={}){var s=r.texture||new GL$1.Texture(t.videoWidth,t.videoHeight,r);return s.bind(),s.uploadImage(t,r),r.minFilter&&r.minFilter!=gl.NEAREST&&r.minFilter!=gl.LINEAR&&(s.bind(),gl.generateMipmap(s.texture_type),s.has_mipmaps=!0,s.data=t),gl.bindTexture(s.texture_type,null),s}static fromTexture(t,r={}){var s=new GL$1.Texture(t.width,t.height,r);return t.copyTo(s),s}clone(t){var r=this.getProperties();if(t)for(var s in t)r[s]=t[s];return wt.fromTexture(this,r)}static fromMemory(t,r,s,a={}){var l=a.texture||new GL$1.Texture(t,r,a);return wt.setUploadOptions(a),l.bind(),s.constructor===Array&&(a.type==gl.FLOAT?s=new Float32Array(s):a.type==GL$1.HALF_FLOAT||a.type==GL$1.HALF_FLOAT_OES?s=new Uint16Array(s):s=new Uint8Array(s)),gl.texImage2D(gl.TEXTURE_2D,0,l.format,t,r,0,l.format,l.type,s),l.width=t,l.height=r,l.data=s,a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),l.has_mipmaps=!0),gl.bindTexture(l.texture_type,null),l}static fromDDSInMemory(t,r={}){var s=r.texture||new GL$1.Texture(0,0,r);GL$1.Texture.setUploadOptions(r),s.bind();var a=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");return DDS.loadDDSTextureFromMemoryEx(gl,a,t,s,!0),gl.bindTexture(s.texture_type,null),s}static fromShader(t,r,s,a={}){var l=new GL$1.Texture(t,r,a);return l.drawTo(function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE);var h=Mesh$1.getScreenQuad();s.draw(h)}),l}static cubemapFromImages(t,r={}){if(t.length!=6)throw"missing images to create cubemap";var s=t[0].width,a=t[0].height;r.texture_type=gl.TEXTURE_CUBE_MAP;var l=null;r.texture?(l=r.texture,l.width=s,l.height=a):l=new GL$1.Texture(s,a,r),wt.setUploadOptions(r),l.bind();try{for(var h=0;h<6;h++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+h,0,l.format,l.format,l.type,t[h]);l.data=t}catch{throw location.protocol=="file:"?'image not loaded for security reasons (serve this page over "http://" instead)':"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}return r.minFilter&&r.minFilter!=gl.NEAREST&&r.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),l.has_mipmaps=!0),l.unbind(),l}static cubemapFromImage(t,r={}){if(t.width!=t.height/6&&t.height%6!=0&&!r.faces&&!r.is_polar)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",t.width,t.height),null;var s=t.width,a=t.height;if(r.is_polar){var m=r.size||GL$1.nearestPowerOfTwo(t.height),l=GL$1.Texture.fromImage(t,{ignore_pot:!0,wrap:gl.REPEAT,filter:gl.LINEAR}),h=new GL$1.Texture(m,m,{texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGBA});if(r.texture){var u=r.texture;for(var c in h)u[c]=h[c];h=u}var _=mat3.create(),d={u_texture:0,u_rotation:_};gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND);var f=GL$1.Shader.getPolarToCubemapShader();return h.drawTo(function(O,E){var D=GL$1.Texture.cubemap_camera_parameters[E];mat3.identity(_),_.set(D.right,0),_.set(D.up,3),_.set(D.dir,6),l.toViewport(f,d)}),r.keep_image&&(h.img=t),h}else r.is_cross!==void 0?(r.faces=wt.generateCubemapCrossFacesInfo(t.width,r.is_cross),s=a=t.width/4):r.faces?(s=r.width||r.faces[0].width,a=r.height||r.faces[0].height):a/=6;if(s!=a)return console.log("Texture not valid, width and height for every face must be square"),null;var m=s;r.no_flip=!0;for(var b=[],c=0;c<6;c++){var T=GL$1.createCanvas(m,m),L=T.getContext("2d");r.faces?L.drawImage(t,r.faces[c].x,r.faces[c].y,r.faces[c].width||m,r.faces[c].height||m,0,0,m,m):L.drawImage(t,0,a*c,s,a,0,0,m,m),b.push(T)}var G=wt.cubemapFromImages(b,r);return r.keep_image&&(G.img=t),G}static generateCubemapCrossFacesInfo(t,r){r===void 0&&(r=1);var s=t/4;return[{x:2*s,y:s,width:s,height:s},{x:0,y:s,width:s,height:s},{x:r*s,y:0,width:s,height:s},{x:r*s,y:2*s,width:s,height:s},{x:s,y:s,width:s,height:s},{x:3*s,y:s,width:s,height:s}]}static cubemapFromURL(t,r={},s){r=Object.create(r),r.texture_type=gl.TEXTURE_CUBE_MAP;var a=r.texture||new GL$1.Texture(1,1,r);a.bind(),wt.setUploadOptions(r);for(var l=r.temp_color||[0,0,0,255],h=r.type==gl.FLOAT?new Float32Array(l):new Uint8Array(l),u=0;u<6;u++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+u,0,a.format,1,1,0,a.format,a.type,h);gl.bindTexture(a.texture_type,null),a.ready=!1;var c=new Image;return c.src=t,c.onload=function(){r.texture=a,a=GL$1.Texture.cubemapFromImage(this,r),a&&delete a.ready,s&&s(a)},a}getPixels(t,r){r=r||0;var s=this.gl,a=s.getViewport(),l=s.getParameter(s.FRAMEBUFFER_BINDING);if(this.format==s.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";s.disable(s.DEPTH_TEST);var h=s.__copy_fbo;h||(h=s.__copy_fbo=s.createFramebuffer()),s.bindFramebuffer(s.FRAMEBUFFER,h);var u=null,c=this.width>>r,_=this.height>>r;s.viewport(0,0,c,_),this.texture_type==s.TEXTURE_2D?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.handler,r):this.texture_type==s.TEXTURE_CUBE_MAP&&s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+(t||0),this.handler,r);var d=this.format==s.RGB?3:4;d=4;var f=this.type;return f==s.UNSIGNED_BYTE?u=new Uint8Array(c*_*d):f==GL$1.HALF_FLOAT||f==GL$1.HALF_FLOAT_OES?u=new Uint16Array(c*_*d):u=new Float32Array(c*_*d),s.readPixels(0,0,c,_,d==3?s.RGB:s.RGBA,f,u),s.bindFramebuffer(s.FRAMEBUFFER,l),s.viewport(a[0],a[1],a[2],a[3]),u}setPixels(t,r,s,a){var l={no_flip:r};a&&(l.cubemap_face=a),this.uploadData(t,l,s)}getCubemapPixels(){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap";return[this.getPixels(0),this.getPixels(1),this.getPixels(2),this.getPixels(3),this.getPixels(4),this.getPixels(5)]}setCubemapPixels(t,r){if(this.texture_type!==gl.TEXTURE_CUBE_MAP)throw"this texture is not a cubemap, it should be created with { texture_type: gl.TEXTURE_CUBE_MAP }";for(var s=0;s<6;++s)this.setPixels(t[s],r,s!=5,s)}toCanvas(t,r,s){s=s||8192;var a=this.gl,l=Math.min(this.width,s),h=Math.min(this.height,s);this.texture_type==a.TEXTURE_CUBE_MAP&&(l=l*4,h=h*3),t=t||GL$1.createCanvas(l,h),t.width!=l&&(t.width=l),t.height!=h&&(t.height=h);var u=null;if(this.texture_type==a.TEXTURE_2D){if(this.width!=l||this.height!=h||this.type!=a.UNSIGNED_BYTE){var c=new GL$1.Texture(l,h,{format:a.RGBA,filter:a.NEAREST});this.copyTo(c),u=c.getPixels()}else u=this.getPixels();var _=t.getContext("2d"),d=_.getImageData(0,0,l,h);if(d.data.set(u),_.putImageData(d,0,0),r){var c=GL$1.createCanvas(l,h),f=c.getContext("2d");f.translate(0,c.height),f.scale(1,-1),f.drawImage(t,0,0,c.width,c.height),_.clearRect(0,0,_.canvas.width,_.canvas.height),_.drawImage(c,0,0)}}else if(this.texture_type==a.TEXTURE_CUBE_MAP){var m=GL$1.createCanvas(this.width,this.height),f=m.getContext("2d"),b=GL$1.Texture.generateCubemapCrossFacesInfo(t.width,1),_=t.getContext("2d");_.fillStyle="black",_.fillRect(0,0,t.width,t.height);var T=this;this.type!=a.UNSIGNED_BYTE&&(T=new GL$1.Texture(this.width,this.height,{format:a.RGBA,texture_type:a.TEXTURE_CUBE_MAP,filter:a.NEAREST,type:a.UNSIGNED_BYTE}),this.copyTo(T));for(var L=0;L<6;L++){var d=f.getImageData(0,0,m.width,m.height);u=T.getPixels(L),d.data.set(u),f.putImageData(d,0,0),_.drawImage(m,b[L].x,b[L].y,m.width,m.height)}}return t}toBinary(t,r){for(var s=this.toCanvas(null,t),a=s.toDataURL(r),l=a.indexOf(","),h=a.substr(l+1),u=atob(h),c=u.length,_=new Uint8Array(c),d=0;d<c;++d)_[d]=u.charCodeAt(d);return _}toBlob(t,r){var s=this.toBinary(t),a=new Blob([s],{type:r||"image/png"});return a}toBlobAsync(t,r,s){var a=this.toCanvas(null,t);if(a.toBlob){a.toBlob(s,r);return}var l=this.toBlob(t,r);s&&s(l)}toBase64(t){var r=this.width,s=this.height,a=this.getPixels(),l=GL$1.createCanvas(r,s),h=l.getContext("2d"),u=h.getImageData(0,0,r,s);if(u.data.set(a),h.putImageData(u,0,0),t){var c=GL$1.createCanvas(r,s),_=c.getContext("2d");_.translate(0,s),_.scale(1,-1),_.drawImage(l,0,0),l=c}var d=l.toDataURL("image/png");return d}generateMetadata(){var t={};t.width=this.width,t.height=this.height,this.metadata=t}static compareFormats(t,r){return!t||!r?!1:t==r?!0:!(t.width!=r.width||t.height!=r.height||t.type!=r.type||t.format!=r.format||t.texture_type!=r.texture_type)}static blend(t,r,s,a){if(!t||!r)return!1;if(t==r)return a?t.copyTo(a):t.toViewport(),!0;gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE);var l=GL$1.Shader.getBlendShader(),h=GL$1.Mesh.getScreenQuad();return r.bind(1),l.uniforms({u_texture:0,u_texture2:1,u_factor:s}),a?(a.drawTo(function(){if(t==a||r==a)throw"Blend output cannot be the same as the input";t.bind(0),l.draw(h,gl.TRIANGLES)}),!0):(t.bind(0),l.draw(h,gl.TRIANGLES),!0)}static cubemapToTexture2D(t,r,s,a,l){if(!t||t.texture_type!=gl.TEXTURE_CUBE_MAP)throw"No cubemap in convert";r=r||t.width;var h=a?t.type:gl.UNSIGNED_BYTE;l=l||0,s||(s=new GL$1.Texture(r*2,r,{minFilter:gl.NEAREST,type:h}));var u=gl.shaders.cubemap_to_texture2D;return u||(u=gl.shaders.cubemap_to_texture2D=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,`			precision mediump float;
			#define PI 3.14159265358979323846264
			uniform samplerCube texture;			varying vec2 v_coord;			uniform float u_yaw;
			void main() {				float alpha = ((1.0 - v_coord.x) * 2.0) * PI + u_yaw;				float beta = (v_coord.y * 2.0 - 1.0) * PI * 0.5;				vec3 N = vec3( -cos(alpha) * cos(beta), sin(beta), sin(alpha) * cos(beta) );				gl_FragColor = textureCube(texture,N);			}`)),u.setUniform("u_yaw",l),s.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),t.toViewport(u)}),s}static getWhiteTexture(t){t=t||global$1.gl;var r=t.textures[":white"];if(r)return r;var s=new Uint8Array([255,255,255,255]);return t.textures[":white"]=new GL$1.Texture(1,1,{pixel_data:s})}static getBlackTexture(t){t=t||global$1.gl;var r=t.textures[":black"];if(r)return r;var s=new Uint8Array([0,0,0,255]);return t.textures[":black"]=new GL$1.Texture(1,1,{pixel_data:s})}static getTemporary(t,r,s,a){a=a||global$1.gl,a._texture_pool||(a._texture_pool=[]);var l=GL$1.TEXTURE_2D,h=wt.DEFAULT_TYPE,u=wt.DEFAULT_FORMAT;s&&(s.texture_type&&(l=s.texture_type),s.type&&(h=s.type),s.format&&(u=s.format));for(var c=l+":"+h+":"+t+"x"+r+":"+u,_=a._texture_pool,d=0;d<_.length;++d){var f=_[d];if(f._key==c)return _.splice(d,1),f._pool=0,f}var f=new GL$1.Texture(t,r,{type:h,texture_type:l,format:u});return f._key=c,f._pool=0,f}static releaseTemporary(t,r){r=r||global$1.gl,r._texture_pool||(r._texture_pool=[]),t._pool>0&&console.warn("this texture is already in the textures pool");var s=r._texture_pool;if(s||(s=r._texture_pool=[]),t._pool=getTime(),s.push(t),s.length>20){s.sort(function(l,h){return h._pool-l._pool});var t=s.pop();t._pool=0,t.delete()}}static nextPOT(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)))}};g(te,"DEFAULT_TYPE",GL$1.UNSIGNED_BYTE),g(te,"DEFAULT_FORMAT",GL$1.RGBA),g(te,"DEFAULT_MAG_FILTER",GL$1.LINEAR),g(te,"DEFAULT_MIN_FILTER",GL$1.LINEAR),g(te,"DEFAULT_WRAP_S",GL$1.CLAMP_TO_EDGE),g(te,"DEFAULT_WRAP_T",GL$1.CLAMP_TO_EDGE),g(te,"EXTENSION","png"),g(te,"framebuffer",null),g(te,"renderbuffer",null),g(te,"loading_color",new Uint8Array([0,0,0,0])),g(te,"use_renderbuffer_pool",!0),g(te,"cubemap_camera_parameters",[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,0,0)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}]),g(te,"binary_extension","png");let Texture=te;Texture.prototype.blit=(function(){var o=new Float32Array(4);return function(t,r,s){var a=this.gl;if(this.texture_type!=a.TEXTURE_2D||this.format===a.DEPTH_COMPONENT||this.format===a.DEPTH_STENCIL)throw"blit only support TEXTURE_2D of RGB or RGBA. use copyTo instead";var l=a.getParameter(a.FRAMEBUFFER_BINDING);o.set(a.viewport_data),r=r||GL$1.Shader.getScreenShader(),r&&s&&r.uniforms(s);var h=a.__copy_fbo;return h||(h=a.__copy_fbo=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,h),a.viewport(0,0,t.width,t.height),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,t.handler,0),this.bind(0),r.draw(GL$1.Mesh.getScreenQuad(),a.TRIANGLES),a.setViewport(o),a.bindFramebuffer(a.FRAMEBUFFER,l),t.data=null,a.bindTexture(t.texture_type,null),this}})(),Texture.prototype.renderQuad=(function(){var o=mat3.create(),t=vec2.create(),r=vec2.create(),s=vec4.fromValues(1,1,1,1);return(function(a,l,h,u,c,_){t[0]=a,t[1]=l,r[0]=h,r[1]=u,c=c||Shader.getQuadShader(this.gl);var d=Mesh$1.getScreenQuad(this.gl);this.bind(0),c.uniforms({u_texture:0,u_position:t,u_color:s,u_size:r,u_viewport:gl.viewport_data.subarray(2,4),u_transform:o}),_&&c.uniforms(_),c.draw(d,gl.TRIANGLES)})})();const Oe=class Jt{constructor(t,r,s,a){if(a=a||global$1.gl,this.gl=a,this._context_id=a.context_id,t&&t.constructor!==Array)throw"FBO textures must be an Array";this.handler=null,this.width=-1,this.height=-1,this.color_textures=[],this.depth_texture=null,this.stencil=!!s,this._stencil_enabled=!1,this._num_binded_textures=0,(t&&t.length||r)&&this.setTextures(t,r),this._old_fbo_handler=null,this._old_viewport=new Float32Array(4),this.order=null}setTextures(t,r,s){if(r&&r.constructor===GL$1.Texture){if(r.format!==GL$1.DEPTH_COMPONENT&&r.format!==GL$1.DEPTH_STENCIL&&r.format!==GL$1.DEPTH_COMPONENT16&&r.format!==GL$1.DEPTH_COMPONENT24&&r.format!==GL$1.DEPTH_COMPONENT32F)throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT, gl.DEPTH_STENCIL or gl.DEPTH_COMPONENT16/24/32F (only in webgl2)";if(r.type!=GL$1.UNSIGNED_SHORT&&r.type!=GL$1.UNSIGNED_INT&&r.type!=GL$1.UNSIGNED_INT_24_8_WEBGL&&r.type!=GL$1.FLOAT)throw"FBO Depth texture must be of type: gl.UNSIGNED_SHORT, gl.UNSIGNED_INT, gl.UNSIGNED_INT_24_8_WEBGL"}var a=this.depth_texture==r;if(a&&t){if(t.constructor!==Array)throw"FBO: color_textures parameter must be an array containing all the textures to be binded in the color";if(t.length==this.color_textures.length){for(var l=0;l<t.length;++l)if(t[l]!=this.color_textures[l]){a=!1;break}}else a=!1}if(this._stencil_enabled!==this.stencil&&(a=!1),!a){if(this.color_textures.length=t?t.length:0,t)for(var l=0;l<t.length;++l)this.color_textures[l]=t[l];this.depth_texture=r,this.update(s)}}update(t){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING),this.handler||(this.handler=gl.createFramebuffer());var r=-1,s=-1,a=null,l=this.color_textures,h=this.depth_texture;if(l&&l.length)for(var u=0;u<l.length;u++){var c=l[u];if(c.constructor!==GL$1.Texture)throw"FBO can only bind instances of GL.Texture";if(r==-1)r=c.width;else if(r!=c.width)throw"Cannot bind textures with different dimensions";if(s==-1)s=c.height;else if(s!=c.height)throw"Cannot bind textures with different dimensions";if(a==null)a=c.type;else if(a!=c.type)throw"Cannot bind textures to a FBO with different pixel formats";if(c.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO"}else r=h.width,s=h.height;this.width=r,this.height=s,gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);var _=gl.extensions.WEBGL_draw_buffers;if(gl.webgl_version==1&&!_&&l&&l.length>1)throw"Rendering to several textures not supported by your browser";var d=gl.webgl_version==1?gl.FRAMEBUFFER:gl.DRAW_FRAMEBUFFER;if(gl.framebufferRenderbuffer(d,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,null),gl.framebufferRenderbuffer(d,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,null),h&&h.constructor===GL$1.Texture){if(gl.webgl_version==1&&!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";this.stencil&&h.format!==gl.DEPTH_STENCIL&&console.warn("Stencil cannot be enabled if there is a depth texture with a DEPTH_STENCIL format"),h.format==gl.DEPTH_STENCIL?gl.framebufferTexture2D(d,gl.DEPTH_STENCIL_ATTACHMENT,gl.TEXTURE_2D,h.handler,0):gl.framebufferTexture2D(d,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,h.handler,0)}else{var f=null;h&&h.constructor===WebGLRenderbuffer&&h.width==r&&h.height==s?f=this._depth_renderbuffer=h:(f=this._depth_renderbuffer=this._depth_renderbuffer||gl.createRenderbuffer(),f.width=r,f.height=s),gl.bindRenderbuffer(gl.RENDERBUFFER,f),this.stencil?(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,r,s),gl.framebufferRenderbuffer(d,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,f)):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,r,s),gl.framebufferRenderbuffer(d,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,f))}if(l&&l.length){this.order=[];for(var u=0;u<l.length;u++){var c=l[u];gl.framebufferTexture2D(d,gl.COLOR_ATTACHMENT0+u,gl.TEXTURE_2D,c.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+u)}}else{var m=this._color_renderbuffer=this._color_renderbuffer||gl.createRenderbuffer();m.width=r,m.height=s,gl.bindRenderbuffer(gl.RENDERBUFFER,m),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,r,s),gl.framebufferRenderbuffer(d,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,m)}for(var b=l?l.length:0,u=b;u<this._num_binded_textures;++u)gl.framebufferTexture2D(d,gl.COLOR_ATTACHMENT0+u,gl.TEXTURE_2D,null,0);this._num_binded_textures=b,this._stencil_enabled=this.stencil,l&&l.length>1&&(_?_.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order));var T=gl.checkFramebufferStatus(d);if(T!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+T;gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),t||gl.bindFramebuffer(d,this._old_fbo_handler)}bind(t){if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data),t?this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING):this._old_fbo_handler=null,this._old_fbo_handler!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);for(var r=0;r<this.color_textures.length;++r)this.color_textures[r]._in_current_fbo=!0;this.depth_texture&&(this.depth_texture._in_current_fbo=!0),gl.viewport(0,0,this.width,this.height),Jt.current=this}unbind(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler),this._old_fbo_handler=null,gl.setViewport(this._old_viewport);for(var t=0;t<this.color_textures.length;++t)this.color_textures[t]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1),Jt.current=null}switchTo(t){t._old_fbo_handler=this._old_fbo_handler,t._old_viewport.set(this._old_viewport),gl.bindFramebuffer(gl.FRAMEBUFFER,t.handler),this._old_fbo_handler=null,gl.viewport(0,0,this.width,this.height);for(var r=0;r<this.color_textures.length;++r)this.color_textures[r]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);for(var r=0;r<t.color_textures.length;++r)t.color_textures[r]._in_current_fbo=!0;t.depth_texture&&(t.depth_texture._in_current_fbo=!0),Jt.current=t}delete(){gl.deleteFramebuffer(this.handler),this.handler=null}static testSupport(t,r){var s=t+":"+r;if(Jt.supported[s]!=null)return Jt.supported[s];var a=new GL$1.Texture(1,1,{format:r,type:t});try{var l=new GL$1.FBO([a])}catch{return console.warn("This browser WEBGL implementation doesn't support this FBO format: "+GL$1.reverse[t]+" "+GL$1.reverse[r]),Jt.supported[s]=!1}return Jt.supported[s]=!0,!0}toSingle(){if(!(this.color_textures.length<2)){var t=gl.extensions.WEBGL_draw_buffers;t?t.drawBuffersWEBGL([this.order[0]]):gl.drawBuffers([this.order[0]])}}toMulti(){if(!(this.color_textures.length<2)){var t=gl.extensions.WEBGL_draw_buffers;t?t.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}}clearSecondary(t){if(!(!this.order||this.order.length<2)){for(var r=gl.extensions.WEBGL_draw_buffers,s=[gl.NONE],a=1;a<this.order.length;++a)s.push(this.order[a]);r?r.drawBuffersWEBGL(s):gl.drawBuffers(s),gl.clearColor(t[0],t[1],t[2],t[3]),gl.clear(gl.COLOR_BUFFER_BIT),r?r.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order)}}};g(Oe,"supported",{});let FBO=Oe;GL$1.FBO=FBO;const Y=class ee{constructor(t,r,s){if(GL$1.debug&&console.log("GL.Shader created"),!t||!r)throw"GL.Shader source code parameter missing";this._context_id=global$1.gl.context_id;var a=this.gl=global$1.gl,l=ee.expandMacros(s),h=t.constructor===String?ee.injectCode(l,t,a):t,u=r.constructor===String?ee.injectCode(l,r,a):r;this.program=a.createProgram();var c=t.constructor===String?GL$1.Shader.compileSource(a.VERTEX_SHADER,h):t,_=r.constructor===String?GL$1.Shader.compileSource(a.FRAGMENT_SHADER,u):r;if(a.attachShader(this.program,c,a),a.attachShader(this.program,_,a),a.linkProgram(this.program),!a.getProgramParameter(this.program,a.LINK_STATUS))throw"link error: "+a.getProgramInfoLog(this.program);this.vs_shader=c,this.fs_shader=_,this.attributes={},this.uniformInfo={},this.samplers={},this.extractShaderInfo()}static expandMacros(t){var r="";if(t)for(var s in t)r+="#define "+s+" "+(t[s]?t[s]:"")+`
`;return r}injectCode(t,r,s){var a=r.indexOf(`
`),l=s?"#define WEBGL"+s.webgl_version+`
`:"",h=r.substr(0,a).trim();return h.indexOf("#version")==-1?l+t+r:h+`
`+l+t+r.substr(a)}compileSource(t,r,s,a){if(s=s||global$1.gl,a=a||s.createShader(t),s.shaderSource(a,r),s.compileShader(a),!s.getShaderParameter(a,s.COMPILE_STATUS))throw(t==s.VERTEX_SHADER?"Vertex":"Fragment")+" shader compile error: "+s.getShaderInfoLog(a);return a}static parseError(t,r,s){if(!t)return null;var a=t.split(" "),l=a[5].split(":");return{type:a[0],line_number:parseInt(l[1]),line_pos:parseInt(l[0]),line_code:(a[0]=="Fragment"?s:r).split(`
`)[parseInt(l[1])],err:t}}updateShader(t,r,s){var a=this.gl||global$1.gl,l=ee.expandMacros(s);this.program?(a.detachShader(this.program,this.vs_shader),a.detachShader(this.program,this.fs_shader)):this.program=a.createProgram();var l=ee.expandMacros(s),h=t.constructor===String?ee.injectCode(l,t,a):t,u=r.constructor===String?ee.injectCode(l,r,a):r,c=t.constructor===String?GL$1.Shader.compileSource(a.VERTEX_SHADER,h):t,_=r.constructor===String?GL$1.Shader.compileSource(a.FRAGMENT_SHADER,u):r;if(a.attachShader(this.program,c,a),a.attachShader(this.program,_,a),a.linkProgram(this.program),!a.getProgramParameter(this.program,a.LINK_STATUS))throw"link error: "+a.getProgramInfoLog(this.program);this.vs_shader=c,this.fs_shader=_,this.attributes={},this.uniformInfo={},this.samplers={},this.extractShaderInfo()}extractShaderInfo(){for(var t=this.gl,r=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS),s=0;s<r;++s){var a=t.getActiveUniform(this.program,s);if(!a)break;var l=a.name,h=l.indexOf("[");if(h!=-1){var u=l.indexOf("].");u==-1&&(l=l.substr(0,h))}(a.type==t.SAMPLER_2D||a.type==t.SAMPLER_CUBE||a.type==GL$1.SAMPLER_3D)&&(this.samplers[l]=a.type);var c=ee.getUniformFunc(a),_=!1;(a.type==t.FLOAT_MAT2||a.type==t.FLOAT_MAT3||a.type==t.FLOAT_MAT4)&&(_=!0);var d=GL$1.TYPE_LENGTH[a.type]||1;this.uniformInfo[l]={type:a.type,func:c,size:a.size,type_length:d,is_matrix:_,loc:t.getUniformLocation(this.program,l),data:new Float32Array(d*a.size)}}for(var s=0,r=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);s<r;++s){var a=t.getActiveAttrib(this.program,s);if(!a)break;var c=ee.getUniformFunc(a),d=GL$1.TYPE_LENGTH[a.type]||1;this.uniformInfo[a.name]={type:a.type,func:c,type_length:d,size:a.size,loc:null},this.attributes[a.name]=t.getAttribLocation(this.program,a.name)}}hasUniform(t){return this.uniformInfo[t]}hasAttribute(t){return this.attributes[t]}static getUniformFunc(t){var r=null;switch(t.type){case GL$1.FLOAT:t.size==1?r=gl.uniform1f:r=gl.uniform1fv;break;case GL$1.FLOAT_MAT2:r=gl.uniformMatrix2fv;break;case GL$1.FLOAT_MAT3:r=gl.uniformMatrix3fv;break;case GL$1.FLOAT_MAT4:r=gl.uniformMatrix4fv;break;case GL$1.FLOAT_VEC2:r=gl.uniform2fv;break;case GL$1.FLOAT_VEC3:r=gl.uniform3fv;break;case GL$1.FLOAT_VEC4:r=gl.uniform4fv;break;case GL$1.UNSIGNED_INT:case GL$1.INT:t.size==1?r=gl.uniform1i:r=gl.uniform1iv;break;case GL$1.INT_VEC2:r=gl.uniform2iv;break;case GL$1.INT_VEC3:r=gl.uniform3iv;break;case GL$1.INT_VEC4:r=gl.uniform4iv;break;case GL$1.SAMPLER_2D:case GL$1.SAMPLER_3D:case GL$1.SAMPLER_CUBE:r=gl.uniform1i;break;default:r=gl.uniform1f;break}return r}static fromURL(t,r,s){var a=`
				precision highp float;
				attribute vec3 a_vertex;
				attribute mat4 u_mvp;
				void main() { 
					gl_Position = u_mvp * vec4(a_vertex,1.0); 
				}
			`,l=`
				precision highp float;
				void main() {
					gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
				}
				`,h=new GL$1.Shader(a,l);h.ready=!1;var u=null,c=null;HttpRequest(t,null,function(d){u=d,c&&_()}),HttpRequest(r,null,function(d){c=d,u&&_()});function _(){var d=new GL$1.Shader(u,c);for(var f in d)h[f]=d[f];h.ready=!0}return h}bind(){var t=this.gl;t.useProgram(this.program),t._current_shader=this}getLocation(t){var r=this.uniformInfo[t];return r?this.uniformInfo[t].loc:null}uniforms(t){var r=this.gl;r.useProgram(this.program),r._current_shader=this;for(var s in t){var a=this.uniformInfo[s];a&&this._setUniform(s,t[s])}return this}uniformsArray(t){var r=this.gl;r.useProgram(this.program),r._current_shader=this;for(var s=0,a=t.length;s<a;++s){var l=t[s];for(var h in l)this._setUniform(h,l[h])}return this}setUniform(t,r){this.gl._current_shader!=this&&this.bind();var s=this.uniformInfo[t];s&&s.loc!==null&&r!=null&&(r.constructor===Array&&(s.data.set(r),r=s.data),s.is_matrix?s.func.call(this.gl,s.loc,!1,r):s.func.call(this.gl,s.loc,r))}_setUniform(t,r){var s=this.uniformInfo[t];s&&s.loc!==null&&r!=null&&(r.constructor===Array&&(s.data.set(r),r=s.data),s.is_matrix?s.func.call(this.gl,s.loc,!1,r):s.func.call(this.gl,s.loc,r))}draw(t,r,s){s=s===void 0?r==gl.LINES?"lines":"triangles":s,this.drawBuffers(t.vertexBuffers,s?t.indexBuffers[s]:null,arguments.length<2?gl.TRIANGLES:r)}drawRange(t,r,s,a,l){l=l===void 0?r==gl.LINES?"lines":"triangles":l,this.drawBuffers(t.vertexBuffers,l?t.indexBuffers[l]:null,r,s,a)}drawBuffers(t,r,s,a,l){if(l!=0){var h=this.gl;h.useProgram(this.program);var u=0,c=temp_attribs_array;c.set(temp_attribs_array_zero);for(var _ in t){var d=t[_],f=d.attribute||_,m=this.attributes[f];m==null||!d.buffer||(c[m]=1,h.bindBuffer(h.ARRAY_BUFFER,d.buffer),h.enableVertexAttribArray(m),h.vertexAttribPointer(m,d.buffer.spacing,d.buffer.gl_type,!1,0,0),u=d.buffer.length/d.buffer.spacing)}var b=0;a>0&&(b=a),r&&(u=r.buffer.length-b),l>0&&l<u&&(u=l);var T=r&&r.data?r.data.constructor.BYTES_PER_ELEMENT:1;b*=T;for(var f in this.attributes){var m=this.attributes[f];c[m]||h.disableVertexAttribArray(this.attributes[f])}return u&&(!r||r.buffer)&&(r?(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,r.buffer),h.drawElements(s,u,r.buffer.gl_type,b),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null)):h.drawArrays(s,b,u)),this}}drawInstanced(t,r,s,a,l,h,u){if(h!==0){var c=this.gl;if(c.webgl_version==1&&!c.extensions.ANGLE_instanced_arrays)throw"instancing not supported";c.useProgram(this.program);var _=0,d=temp_attribs_array;d.set(temp_attribs_array_zero);var f=t.vertexBuffers;for(var m in f){var b=f[m],T=b.attribute||m,L=this.attributes[T];L==null||!b.buffer||(d[L]=1,c.bindBuffer(c.ARRAY_BUFFER,b.buffer),c.enableVertexAttribArray(L),c.vertexAttribPointer(L,b.buffer.spacing,b.buffer.gl_type,!1,0,0),_=b.buffer.length/b.buffer.spacing)}var G=null;s&&(s.constructor===GL$1.Buffer?G=s:G=t.getIndexBuffer(s));var I=0;l>0&&(I=l),G&&(_=G.buffer.length-I),h>0&&h<_&&(_=h);var O=G&&G.data?G.data.constructor.BYTES_PER_ELEMENT:1;I*=O;for(var T in this.attributes){var L=this.attributes[T];d[L]||c.disableVertexAttribArray(this.attributes[T])}var E=c.extensions.ANGLE_instanced_arrays,D=0,N=0;for(var C in a){var R=a[C];D=R.length;var S=this.attributes[C];if(S==null)return;var P=0,M=0;R.constructor===Array?(P=R[0].constructor===Number?1:R[0].length,M=P*R.length):(P=this.uniformInfo[C].type_length,M=R.length,D=M/P);var A=ee._instancing_arrays[N];if((!A||A.data.length<M)&&(A=ee._instancing_arrays[N]={data:new Float32Array(M),buffer:c.createBuffer()}),A.uniform=C,A.element_size=P,R.constructor===Array)for(var B=0;B<R.length;++B)A.data.set(R[B],B*P);else A.data.set(R);if(c.bindBuffer(c.ARRAY_BUFFER,A.buffer),c.bufferData(c.ARRAY_BUFFER,A.data,c.STREAM_DRAW),P==16)for(var $=0;$<4;++$)c.enableVertexAttribArray(S+$),c.vertexAttribPointer(S+$,4,c.FLOAT,!1,64,$*4*4),E?E.vertexAttribDivisorANGLE(S+$,1):c.vertexAttribDivisor(S+$,1);else c.enableVertexAttribArray(S),c.vertexAttribPointer(S,P,c.FLOAT,!1,P*4,0),E?E.vertexAttribDivisorANGLE(S,1):c.vertexAttribDivisor(S,1);N+=1}u&&(D=u),E?G?(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,G.buffer),E.drawElementsInstancedANGLE(r,_,G.buffer.gl_type,I,D),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null)):E.drawArraysInstancedANGLE(r,I,_,D):G?(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,G.buffer),c.drawElementsInstanced(r,_,G.buffer.gl_type,I,D),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null)):c.drawArraysInstanced(r,I,_,D);for(var H=0;H<N;++H){var F=ee._instancing_arrays[H],S=this.attributes[F.uniform],P=F.element_size;if(P==16)for(var $=0;$<4;++$)c.disableVertexAttribArray(S+$),E?E.vertexAttribDivisorANGLE(S+$,0):c.vertexAttribDivisor(S+$,0);else c.enableVertexAttribArray(S),E?E.vertexAttribDivisorANGLE(S,0):c.vertexAttribDivisor(S,0)}return this}}static expandImports(t,r){r=r||ee.files;var s={};if(!r)throw"Shader.files not initialized, assign files there";var a=function(l){var h=l.split('"'),u=h[1];if(s[u])return"//already imported: "+u+`
`;var c=r[u];return s[u]=!0,c?c+`
`:"//import code not found: "+u+`
`};return t.replace(/#import\s+\"([a-zA-Z0-9_\.]+)\"\s*\n/g,a)}static dumpErrorToConsole(t,r,s){console.error(t),t.msg;var a=null;t.indexOf("Fragment")!=-1?a=s:a=r;var l=a.split(`
`);for(var h in l)l[h]=h+"| "+l[h];console.groupCollapsed("Shader code"),console.log(l.join(`
`)),console.groupEnd()}static convertTo100(t,r){}static convertTo300(t,r){}static validateValue(t,r){if(t==null)return!1;switch(r.type){case GL$1.INT:case GL$1.FLOAT:case GL$1.SAMPLER_2D:case GL$1.SAMPLER_CUBE:return isNumber(t);case GL$1.INT_VEC2:case GL$1.FLOAT_VEC2:return t.length===2;case GL$1.INT_VEC3:case GL$1.FLOAT_VEC3:return t.length===3;case GL$1.INT_VEC4:case GL$1.FLOAT_VEC4:case GL$1.FLOAT_MAT2:return t.length===4;case GL$1.FLOAT_MAT3:return t.length===8;case GL$1.FLOAT_MAT4:return t.length===16}return!0}static createFX(t,r,s){t=GL$1.Shader.removeComments(t,!0);var a={FX_CODE:t,FX_UNIFORMS:r||""};return s?(s.updateShader(GL$1.Shader.SCREEN_VERTEX_SHADER,GL$1.Shader.SCREEN_FRAGMENT_FX,a),s):new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,GL$1.Shader.SCREEN_FRAGMENT_FX,a)}static replaceCodeUsingContext(t,r){return t.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(s){return s=s.replace(/[\{\}]/g,""),r[s]||""})}static removeComments(t,r){if(!t)return"";for(var s=/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(\/\/.*)/g,t=t.replace(s,""),a=t.split(`
`),l=[],h=0;h<a.length;++h){var u=a[h],c=u.indexOf("//");c!=-1&&(u=a[h].substr(0,c)),u=u.trim(),u.length&&l.push(u)}return l.join(r?"":`
`)}toViewport(t){var r=GL$1.Mesh.getScreenQuad();t&&this.uniforms(t),this.draw(r)}static getScreenShader(t){t=t||global$1.gl;var r=t.shaders[":screen"];return r||(r=t.shaders[":screen"]=new GL$1.Shader(ee.SCREEN_VERTEX_SHADER,ee.SCREEN_FRAGMENT_SHADER),r.uniforms({u_texture:0}))}static getFlatScreenShader(t){t=t||global$1.gl;var r=t.shaders[":flat_screen"];return r||(r=t.shaders[":flat_screen"]=new GL$1.Shader(ee.SCREEN_VERTEX_SHADER,ee.FLAT_FRAGMENT_SHADER),r.uniforms({u_color:[1,1,1,1]}))}static getColoredScreenShader(t){t=t||global$1.gl;var r=t.shaders[":colored_screen"];return r||(r=t.shaders[":colored_screen"]=new GL$1.Shader(ee.SCREEN_VERTEX_SHADER,ee.SCREEN_COLORED_FRAGMENT_SHADER),r.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)}))}static getQuadShader(t){t=t||global$1.gl;var r=t.shaders[":quad"];return r||(t.shaders[":quad"]=new GL$1.Shader(ee.QUAD_VERTEX_SHADER,ee.QUAD_FRAGMENT_SHADER))}static getPartialQuadShader(t){t=t||global$1.gl;var r=t.shaders[":quad2"];return r||(t.shaders[":quad2"]=new GL$1.Shader(ee.QUAD_VERTEX_SHADER,ee.QUAD2_FRAGMENT_SHADER))}getBlendShader(t){t=t||global$1.gl;var r=t.shaders[":blend"];return r||(t.shaders[":blend"]=new GL$1.Shader(ee.SCREEN_VERTEX_SHADER,ee.BLEND_FRAGMENT_SHADER))}getBlurShader(t){t=t||global$1.gl;var r=t.shaders[":blur"];if(r)return r;var r=new GL$1.Shader(ee.SCREEN_VERTEX_SHADER,`
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform vec2 u_offset;
				uniform float u_intensity;
				void main() {
				vec4 sum = vec4(0.0);
				sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;
				sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;
				sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;
				sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;
				sum += texture2D(u_texture, v_coord) * 0.16/0.98;
				sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;
				sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;
				sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;
				sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;
				gl_FragColor = u_intensity * sum;
				}
				`);return t.shaders[":blur"]=r}static getCopyDepthShader(t){t=t||global$1.gl;var r=t.shaders[":copy_depth"];if(r)return r;var r=new GL$1.Shader(ee.SCREEN_VERTEX_SHADER,`
				#extension GL_EXT_frag_depth : enable
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				void main() {
				gl_FragDepthEXT = texture2D( u_texture, v_coord ).x;
				gl_FragColor = vec4(1.0);
				}
				`);return t.shaders[":copy_depth"]=r}getCubemapShowShader(t){t=t||global$1.gl;var r=t.shaders[":show_cubemap"];if(r)return r;var r=new GL$1.Shader(ee.DEFAULT_VERTEX_SHADER,`
				precision highp float;
				varying vec3 v_normal;
				uniform samplerCube u_texture;
				void main() {
				gl_FragColor = textureCube( u_texture, v_normal );
				}
				`);return r.uniforms({u_texture:0}),t.shaders[":show_cubemap"]=r}static getPolarToCubemapShader(t){t=t||global$1.gl;var r=t.shaders[":polar_to_cubemap"];if(r)return r;var r=new GL$1.Shader(ee.SCREEN_VERTEX_SHADER,`
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform mat3 u_rotation;
				void main() {
					vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );
					vec3 dir = normalize( vec3( uv - vec2(0.5), 0.5 ));
					dir = u_rotation * dir;
					float u = atan(dir.x,dir.z) / 6.28318531;
					float v = (asin(dir.y) / 1.57079633) * 0.5 + 0.5;
					u = mod(u,1.0);
					v = mod(v,1.0);
				gl_FragColor = texture2D( u_texture, vec2(u,v) );
				}
				`);return t.shaders[":polar_to_cubemap"]=r}getCubemapCopyShader(t){t=t||global$1.gl;var r=t.shaders[":copy_cubemap"];if(r)return r;var r=new GL$1.Shader(ee.SCREEN_VERTEX_SHADER,`
				precision highp float;
				varying vec2 v_coord;
				uniform samplerCube u_texture;
				uniform mat3 u_rotation;
				void main() {
					vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );
					vec3 dir = vec3( uv - vec2(0.5), 0.5 );
					dir = u_rotation * dir;
				gl_FragColor = textureCube( u_texture, dir );
				}
				`);return t.shaders[":copy_cubemap"]=r}static getCubemapBlurShader(t){t=t||global$1.gl;var r=t.shaders[":blur_cubemap"];if(r)return r;var r=new GL$1.Shader(ee.SCREEN_VERTEX_SHADER,`
				#ifndef NUM_SAMPLES
					#define NUM_SAMPLES 4
				#endif
				
				precision highp float;
				varying vec2 v_coord;
				uniform samplerCube u_texture;
				uniform mat3 u_rotation;
				uniform vec2 u_offset;
				uniform float u_intensity;
				void main() {
					vec4 sum = vec4(0.0);
					vec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);
					vec3 dir = vec3(0.0);
					vec4 color = vec4(0.0);
					for( int x = -2; x <= 2; x++ )
					{
						for( int y = -2; y <= 2; y++ )
						{
							dir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;
							dir.z = 0.5;
							dir = u_rotation * dir;
							color = textureCube( u_texture, dir );
							color.xyz = color.xyz * color.xyz;/*linearize*/
							sum += color;
						}
					}
					sum /= 25.0;
				gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;
				}
				`);return t.shaders[":blur_cubemap"]=r}static getFXAAShader(t){t=t||global$1.gl;var r=t.shaders[":fxaa"];if(r)return r;var r=new GL$1.Shader(ee.SCREEN_VERTEX_SHADER,`
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				`+ee.FXAA_FUNC+`
				
				void main() {
				gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;
				}
				`),s=vec2.fromValues(t.viewport_data[2],t.viewport_data[3]),a=vec2.fromValues(1/t.viewport_data[2],1/t.viewport_data[3]);return r.setup=function(){s[0]=t.viewport_data[2],s[1]=t.viewport_data[3],a[0]=1/t.viewport_data[2],a[1]=1/t.viewport_data[3],this.uniforms({u_viewportSize:s,u_iViewportSize:a})},t.shaders[":fxaa"]=r}getFlatShader(t){t=t||global$1.gl;var r=t.shaders[":flat"];if(r)return r;var r=new GL$1.Shader(ee.FLAT_VERTEX_SHADER,ee.FLAT_FRAGMENT_SHADER);return r.uniforms({u_color:[1,1,1,1]}),t.shaders[":flat"]=r}};g(Y,"_temp_uniform",new Float32Array(16)),g(Y,"_instancing_arrays",[]),g(Y,"DEFAULT_VERTEX_SHADER",`
				precision highp float;
				attribute vec3 a_vertex;
				attribute vec3 a_normal;
				attribute vec2 a_coord;
				varying vec3 v_position;
				varying vec3 v_normal;
				varying vec2 v_coord;
				uniform mat4 u_model;
				uniform mat4 u_mvp;
				void main() {
					v_position = (u_model * vec4(a_vertex,1.0)).xyz;
					v_normal = (u_model * vec4(a_normal,0.0)).xyz;
					v_coord = a_coord;
					gl_Position = u_mvp * vec4(a_vertex,1.0);
				}
				`),g(Y,"SCREEN_VERTEX_SHADER",`
				precision highp float;
				attribute vec3 a_vertex;
				attribute vec2 a_coord;
				varying vec2 v_coord;
				void main() { 
					v_coord = a_coord; 
					gl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); 
				}
				`),g(Y,"SCREEN_FRAGMENT_SHADER",`
				precision highp float;
				uniform sampler2D u_texture;
				varying vec2 v_coord;
				void main() {
					gl_FragColor = texture2D(u_texture, v_coord);
				}
				`),g(Y,"SCREEN_FRAGMENT_FX",`
				precision highp float;
				uniform sampler2D u_texture;
				varying vec2 v_coord;
				#ifdef FX_UNIFORMS
					FX_UNIFORMS
				#endif
				void main() {
					vec2 uv = v_coord;
					vec4 color = texture2D(u_texture, uv);
					#ifdef FX_CODE
						FX_CODE ;
					#endif
					gl_FragColor = color;
				}
				`),g(Y,"SCREEN_COLORED_FRAGMENT_SHADER",`
				precision highp float;
				uniform sampler2D u_texture;
				uniform vec4 u_color;
				varying vec2 v_coord;
				void main() {
					gl_FragColor = u_color * texture2D(u_texture, v_coord);
				}
				`),g(Y,"BLEND_FRAGMENT_SHADER",`
				precision highp float;
				uniform sampler2D u_texture;
				uniform sampler2D u_texture2;
				uniform float u_factor;
				varying vec2 v_coord;
				void main() {
					gl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);
				}
				`),g(Y,"QUAD_VERTEX_SHADER",`
				precision highp float;
				attribute vec3 a_vertex;
				attribute vec2 a_coord;
				varying vec2 v_coord;
				uniform vec2 u_position;
				uniform vec2 u_size;
				uniform vec2 u_viewport;
				uniform mat3 u_transform;
				void main() { 
					vec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);
					v_coord = a_coord; 
					pos = u_transform * pos;
					pos.z = 0.0;
					//normalize
					pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
					pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
					gl_Position = vec4(pos, 1.0); 
				}
				`),g(Y,"QUAD_FRAGMENT_SHADER",`
				precision highp float;
				uniform sampler2D u_texture;
				uniform vec4 u_color;
				varying vec2 v_coord;
				void main() {
					gl_FragColor = u_color * texture2D(u_texture, v_coord);
				}
				`),g(Y,"QUAD2_FRAGMENT_SHADER",`
				precision highp float;
				uniform sampler2D u_texture;
				uniform vec4 u_color;
				uniform vec4 u_texture_area;
				varying vec2 v_coord;
				void main() {
					vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );
					gl_FragColor = u_color * texture2D(u_texture, uv);
				}
				`),g(Y,"PRIMITIVE2D_VERTEX_SHADER",`
				precision highp float;
				attribute vec3 a_vertex;
				uniform vec2 u_viewport;
				uniform mat3 u_transform;
				void main() { 
					vec3 pos = a_vertex;
					pos = u_transform * pos;
					pos.z = 0.0;
					//normalize
					pos.x = (2.0 * pos.x / u_viewport.x) - 1.0;
					pos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);
					gl_Position = vec4(pos, 1.0); 
				}
				`),g(Y,"FLAT_VERTEX_SHADER",`
				precision highp float;
				attribute vec3 a_vertex;
				uniform mat4 u_mvp;
				void main() { 
					gl_Position = u_mvp * vec4(a_vertex,1.0); 
				}
				`),g(Y,"FLAT_FRAGMENT_SHADER",`
				precision highp float;
				uniform vec4 u_color;
				void main() {
					gl_FragColor = u_color;
				}
				`),g(Y,"SCREEN_FLAT_FRAGMENT_SHADER",Y.FLAT_FRAGMENT_SHADER),g(Y,"FXAA_FUNC",`
		uniform vec2 u_viewportSize;
		uniform vec2 u_iViewportSize;
		#define FXAA_REDUCE_MIN   (1.0/ 128.0)
		#define FXAA_REDUCE_MUL   (1.0 / 8.0)
		#define FXAA_SPAN_MAX     8.0
		
		/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */
		vec4 applyFXAA(sampler2D tex, vec2 fragCoord)
		{
			vec4 color = vec4(0.0);
			/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/
			vec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;
			vec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;
			vec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;
			vec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;
			vec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;
			vec3 luma = vec3(0.299, 0.587, 0.114);
			float lumaNW = dot(rgbNW, luma);
			float lumaNE = dot(rgbNE, luma);
			float lumaSW = dot(rgbSW, luma);
			float lumaSE = dot(rgbSE, luma);
			float lumaM  = dot(rgbM,  luma);
			float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
			float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));
			
			vec2 dir;
			dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
			dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));
			
			float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
			
			float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
			dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;
			
			vec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + 
				texture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);
			vec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + 
				texture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);
			
			return vec4(rgbA,1.0);
			float lumaB = dot(rgbB, luma);
			if ((lumaB < lumaMin) || (lumaB > lumaMax))
				color = vec4(rgbA, 1.0);
			else
				color = vec4(rgbB, 1.0);
			return color;
		}
	`);let Shader=Y;GL$1.Shader=Shader;var temp_attribs_array=new Uint8Array(16),temp_attribs_array_zero=new Uint8Array(16),LEvent=global$1.LEvent=GL$1.LEvent={bind:function(o,t,r,s){if(!o)throw"cannot bind event to null";if(!r)throw"cannot bind to null callback";if(o.constructor===String)throw"cannot bind event to a string";var a=o.__levents;a||(Object.defineProperty(o,"__levents",{value:{},enumerable:!1}),a=o.__levents),a.hasOwnProperty(t)?a[t].push([r,s]):a[t]=[[r,s]],o.onLEventBinded&&o.onLEventBinded(t,r,s)},unbind:function(o,t,r,s){if(!o)throw"cannot unbind event to null";if(!r)throw"cannot unbind from null callback";if(o.constructor===String)throw"cannot bind event to a string";var a=o.__levents;if(a&&a.hasOwnProperty(t)){for(var l=0,h=a[t].length;l<h;++l){var u=a[t][l];if(u[0]===r&&u[1]===s){a[t].splice(l,1);break}}a[t].length==0&&delete a[t],o.onLEventUnbinded&&o.onLEventUnbinded(t,r,s)}},unbindAll:function(o,t,r){if(!o)throw"cannot unbind events in null";var s=o.__levents;if(s){if(o.onLEventUnbindAll&&o.onLEventUnbindAll(t,r),!t){delete o.__levents;return}for(var a in s)for(var l=s[a],h=l.length-1;h>=0;--h)l[h][1]!=t||r&&r!==l[h][0]||l.splice(h,1)}},unbindAllEvent:function(o,t){if(!o)throw"cannot unbind events in null";var r=o.__levents;r&&(delete r[t],o.onLEventUnbindAll&&o.onLEventUnbindAll(t,target_instance,callback))},isBind:function(o,t,r,s){if(!o)throw"LEvent cannot have null as instance";var a=o.__levents;if(a){if(!a.hasOwnProperty(t))return!1;for(var l=0,h=a[t].length;l<h;++l){var u=a[t][l];if(u[0]===r&&u[1]===s)return!0}return!1}},hasBind:function(o,t){if(!o)throw"LEvent cannot have null as instance";var r=o.__levents;return!(!r||!r.hasOwnProperty(t)||!r[t].length)},hasBindTo:function(o,t){if(!o)throw"LEvent cannot have null as instance";var r=o.__levents;if(!r)return!1;for(var s in r)for(var a=r[s],l=0;l<a.length;++l)if(a[l][1]===t)return!0;return!1},trigger:function(o,t,r,s,a){if(!o)throw"cannot trigger event from null";if(o.constructor===String)throw"cannot bind event to a string";var l=o.__levents;if(!l||!l.hasOwnProperty(t))return!1;var h=l[t];if(s)for(var u=h.length-1;u>=0;--u){var c=h[u];if(a){if(c&&c[0].apply(c[1],r)===!0)return!0}else if(c&&c[0].call(c[1],t,r)===!0)return!0}else for(var u=0,_=h.length;u<_;++u){var c=h[u];if(a){if(c&&c[0].apply(c[1],r)===!0)return!0}else if(c&&c[0].call(c[1],t,r)===!0)return!0}return!1},triggerArray:function(o,t,r,s,a){for(var l=!1,h=0,u=o.length;h<u;++h){var c=o[h];if(!c)throw"cannot trigger event from null";if(c.constructor===String)throw"cannot bind event to a string";var _=c.__levents;if(!(!_||!_.hasOwnProperty(t)))if(s)for(var d=_[t].length-1;d>=0;--d){var f=_[t][d];if(a){if(f[0].apply(f[1],r)===!0){l=!0;break}}else if(f[0].call(f[1],t,r)===!0){l=!0;break}}else for(var d=0,m=_[t].length;d<m;++d){var f=_[t][d];if(a){if(f[0].apply(f[1],r)===!0){l=!0;break}}else if(f[0].call(f[1],t,r)===!0){l=!0;break}}}return l},extendObject:function(o){o.bind=function(t,r,s){return LEvent.bind(this,t,r,s)},o.trigger=function(t,r){return LEvent.trigger(this,t,r)},o.unbind=function(t,r,s){return LEvent.unbind(this,t,r,instance)},o.unbindAll=function(t,r){return LEvent.unbindAll(this,t,r)}},extendClass:function(o){this.extendObject(o.prototype)}};global$1.CLIP_INSIDE=GL$1.CLIP_INSIDE=0,global$1.CLIP_OUTSIDE=GL$1.CLIP_OUTSIDE=1,global$1.CLIP_OVERLAP=GL$1.CLIP_OVERLAP=2,global$1.geo={createPlane:function(o,t){return new Float32Array([t[0],t[1],t[2],-vec3.dot(o,t)])},distancePointToPlane:function(o,t){return(vec3.dot(o,t)+t[3])/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},distance2PointToPlane:function(o,t){return(vec3.dot(o,t)+t[3])/(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},projectPointOnLine:function(o,t,r,s){s=s||vec3.create();var a=vec3.fromValues(o[0]-t[0],o[1]-t[1],o[2]-t[2]),l=vec3.fromValues(r[0]-t[0],r[1]-t[1],r[2]-t[2]),h=vec3.dot(a,l)/vec3.dot(l,l);return s[0]=t[0]+h[0]*l[0],s[1]=t[1]+h[1]*l[1],s[2]=t[2]+h[2]*l[2],s},project2DPointOnLine:function(o,t,r,s){s=s||vec2.create();var a=vec2.fromValues(o[0]-t[0],o[1]-t[1]),l=vec2.fromValues(r[0]-t[0],r[1]-t[1]),h=vec2.dot(a,l)/vec2.dot(l,l);return s[0]=t[0]+h[0]*l[0],s[1]=t[1]+h[1]*l[1],s},projectPointOnPlane:function(o,t,r,s){s=s||vec3.create();var a=vec3.subtract(vec3.create(),o,t),l=vec3.dot(a,r);return vec3.subtract(s,o,vec3.scale(vec3.create(),r,l))},reflectPointInPlane:function(o,t,r){var s=-1*(t[0]*r[0]+t[1]*r[1]+t[2]*r[2]),a=-(s+r[0]*o[0]+r[1]*o[1]+r[2]*o[2])/(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);return vec3.fromValues(o[0]+a*r[0]*2,o[1]+a*r[1]*2,o[2]+a*r[2]*2)},testRayPlane:function(o,t,r,s,a){var l=vec3.dot(r,s),h=l-vec3.dot(s,o),u=vec3.dot(s,t);if(Math.abs(u)<EPSILON)return!1;var c=h/u;return c<0?!1:(a&&vec3.add(a,o,vec3.scale(a,t,c)),!0)},testSegmentPlane:(function(){var o=vec3.create();return function(t,r,s,a,l){var h=vec3.dot(s,a),u=h-vec3.dot(a,t),c=vec3.sub(o,r,t),_=vec3.dot(a,c);if(Math.abs(_)<EPSILON)return!1;var d=u/_;return d<0||d>1?!1:(l&&vec3.add(l,t,vec3.scale(l,c,d)),!0)}})(),testRaySphere:(function(){var o=vec3.create();return function(t,r,s,a,l,h){var u=vec3.subtract(o,t,s),c=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],_=2*u[0]*r[0]+2*u[1]*r[1]+2*u[2]*r[2],d=u[0]*u[0]+u[1]*u[1]+u[2]*u[2]-a*a,f=_*_-4*c*d;if(f<0)return!1;if(l){var m=Math.sqrt(f),b=1/(2*c),T=(-_+m)*b,L=(-_-m)*b,G=T<L?T:L;if(h!==void 0&&G>h)return!1;vec3.add(l,t,vec3.scale(l,r,G))}return!0}})(),testRayCylinder:function(o,t,r,s,a,l){var h=vec3.clone(o),u=vec3.add(vec3.create(),o,vec3.scale(vec3.create(),t,1e5)),c=0,_=vec3.subtract(vec3.create(),s,r),d=vec3.subtract(vec3.create(),h,r),f=vec3.subtract(vec3.create(),u,h),m=vec3.dot(d,_),b=vec3.dot(f,_),T=vec3.dot(_,_);if(m<0&&m+b<0||m>T&&m+b>T)return!1;var L=vec3.dot(f,f),G=vec3.dot(d,f),I=T*L-b*b,O=vec3.dot(d,d)-a*a,E=T*O-m*m;if(Math.abs(I)<EPSILON)return E>0?!1:(m<0?c=-G/L:m>T?c=(b-G)/L:c=0,l&&vec3.add(l,h,vec3.scale(l,f,c)),!0);var D=T*G-b*m,N=D*D-I*E;return N<0||(c=(-D-Math.sqrt(N))/I,c<0||c>1)?!1:m+c*b<0?b<=0?!1:(c=-m/b,l&&vec3.add(l,h,vec3.scale(l,f,c)),O+2*c*(G+c*L)<=0):m+c*b>T?b>=0?!1:(c=(T-m)/b,l&&vec3.add(l,h,vec3.scale(l,f,c)),O+T-2*m+c*(2*(G-b)+c*L)<=0):(l&&vec3.add(l,h,vec3.scale(l,f,c)),!0)},testRayBox:(function(){var o=new Float32Array(3),t=new Float32Array(3),r=new Float32Array(3);return function(s,a,l,h,u,c){c=c||Number.MAX_VALUE;var _=!0,d=0,f;for(o.fill(0),r.fill(0),t.fill(0),d=0;d<3;++d)s[d]<l[d]?(o[d]=1,t[d]=l[d],_=!1):s[d]>h[d]?(o[d]=0,t[d]=h[d],_=!1):o[d]=2;if(_)return u&&vec3.copy(u,s),!0;for(d=0;d<3;++d)o[d]!=2&&a[d]!=0?r[d]=(t[d]-s[d])/a[d]:r[d]=-1;for(f=0,d=1;d<3;d++)r[f]<r[d]&&(f=d);if(r[f]<0||r[f]>c)return!1;for(d=0;d<3;++d)if(f!=d){var m=s[d]+r[f]*a[d];if(m<l[d]||m>h[d])return!1;u&&(u[d]=m)}else u&&(u[d]=t[d]);return!0}})(),testRayBBox:(function(){var o=mat4.create(),t=vec3.create(),r=vec3.create();return function(s,a,l,h,u,c,_){if(!s||!a||!l)throw"parameters missing";h&&(mat4.invert(o,h),vec3.add(t,s,a),s=vec3.transformMat4(r,s,o),vec3.transformMat4(t,t,o),vec3.sub(t,t,s),a=vec3.normalize(t,t));var d=this.testRayBox(s,a,l.subarray(6,9),l.subarray(9,12),u,c);return!_&&h&&u&&vec3.transformMat4(u,u,h),d}})(),testPointBBox:function(o,t){return!(o[0]<t[6]||o[0]>t[9]||o[1]<t[7]||o[0]>t[10]||o[2]<t[8]||o[0]>t[11])},testBBoxBBox:function(o,t){var r=Math.abs(t[0]-o[0]);if(r>o[3]+t[3])return!1;var s=Math.abs(t[1]-o[1]);if(s>o[4]+t[4])return!1;var a=Math.abs(t[2]-o[2]);if(a>o[5]+t[5])return!1;var l=BBox.getMin(t);if(geo.testPointBBox(l,o)){var h=BBox.getMax(t);if(geo.testPointBBox(h,o))return!0}return!0},testSphereBBox:function(o,t,r){for(var s,a=0,l=BBox.getMin(r),h=BBox.getMax(r),u=0;u<3;++u)o[u]<l[u]?(s=o[u]-l[u],a+=s*s):o[u]>h[u]&&(s=o[u]-h[u],a+=s*s);var c=t*t;return a<=c},closestPointBetweenLines:function(o,t,r,s,a,l){var h=vec3.subtract(vec3.create(),t,o),u=vec3.subtract(vec3.create(),s,r),c=vec3.subtract(vec3.create(),o,r),_=vec3.dot(h,h),d=vec3.dot(h,u),f=vec3.dot(u,u),m=vec3.dot(h,c),b=vec3.dot(u,c),T=_*f-d*d,L,G;T<EPSILON?(L=0,G=d>f?m/d:b/f):(L=(d*b-f*m)/T,G=(_*b-d*m)/T),a&&vec3.add(a,o,vec3.scale(vec3.create(),h,L)),l&&vec3.add(l,r,vec3.scale(vec3.create(),u,G));var I=vec3.add(vec3.create(),c,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),h,L),vec3.scale(vec3.create(),u,G)));return vec3.length(I)},extractPlanes:function(o,r){var r=r||new Float32Array(24);return r.set([o[3]-o[0],o[7]-o[4],o[11]-o[8],o[15]-o[12]],0),s(0),r.set([o[3]+o[0],o[7]+o[4],o[11]+o[8],o[15]+o[12]],4),s(4),r.set([o[3]+o[1],o[7]+o[5],o[11]+o[9],o[15]+o[13]],8),s(8),r.set([o[3]-o[1],o[7]-o[5],o[11]-o[9],o[15]-o[13]],12),s(12),r.set([o[3]-o[2],o[7]-o[6],o[11]-o[10],o[15]-o[14]],16),s(16),r.set([o[3]+o[2],o[7]+o[6],o[11]+o[10],o[15]+o[14]],20),s(20),r;function s(a){var l=r.subarray(a,a+3),h=vec3.length(l);h!==0&&(h=1/h,r[a]*=h,r[a+1]*=h,r[a+2]*=h,r[a+3]*=h)}},frustumTestBox:function(o,t){var r=0,s=0;return r=planeBoxOverlap(o.subarray(0,4),t),r==CLIP_OUTSIDE||(s+=r,r=planeBoxOverlap(o.subarray(4,8),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(o.subarray(8,12),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(o.subarray(12,16),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(o.subarray(16,20),t),r==CLIP_OUTSIDE)||(s+=r,r=planeBoxOverlap(o.subarray(20,24),t),r==CLIP_OUTSIDE)?CLIP_OUTSIDE:(s+=r,s==0?CLIP_INSIDE:CLIP_OVERLAP)},frustumTestSphere:function(o,t,r){var s,a=!1;return s=distanceToPlane(o.subarray(0,4),t),s<-r||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(o.subarray(4,8),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(o.subarray(8,12),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(o.subarray(12,16),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(o.subarray(16,20),t),s<-r)||(s>=-r&&s<=r&&(a=!0),s=distanceToPlane(o.subarray(20,24),t),s<-r)?CLIP_OUTSIDE:(s>=-r&&s<=r&&(a=!0),a?CLIP_OVERLAP:CLIP_INSIDE)},testPoint2DInPolygon:function(o,t){for(var r=!1,s=-1,a=o.length,l=a-1;++s<a;l=s)(o[s][1]<=t[1]&&t[1]<o[l][1]||o[l][1]<=t[1]&&t[1]<o[s][1])&&t[0]<(o[l][0]-o[s][0])*(t[1]-o[s][1])/(o[l][1]-o[s][1])+o[s][0]&&(r=!r);return r}},global$1.BBox=GL$1.BBox={center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:[vec3.fromValues(1,1,1),vec3.fromValues(1,1,-1),vec3.fromValues(1,-1,1),vec3.fromValues(1,-1,-1),vec3.fromValues(-1,1,1),vec3.fromValues(-1,1,-1),vec3.fromValues(-1,-1,1),vec3.fromValues(-1,-1,-1)],create:function(){return new Float32Array(13)},clone:function(o){return new Float32Array(o)},copy:function(o,t){return o.set(t),o},fromPoint:function(o){var t=this.create();return t.set(o,0),t.set(o,6),t.set(o,9),t},fromMinMax:function(o,t){var r=this.create();return this.setMinMax(r,o,t),r},fromCenterHalfsize:function(o,t){var r=this.create();return this.setCenterHalfsize(r,o,t),r},fromPoints:function(o){var t=this.create();return this.setFromPoints(t,o),t},setFromPoints:function(o,t){var r=o.subarray(6,9),s=o.subarray(9,12);r[0]=t[0],r[1]=t[1],r[2]=t[2],s.set(r);for(var a=3,l=t.length;a<l;a+=3){var h=t[a],u=t[a+1],c=t[a+2];h<r[0]?r[0]=h:h>s[0]&&(s[0]=h),u<r[1]?r[1]=u:u>s[1]&&(s[1]=u),c<r[2]?r[2]=c:c>s[2]&&(s[2]=c)}return o[0]=(r[0]+s[0])*.5,o[1]=(r[1]+s[1])*.5,o[2]=(r[2]+s[2])*.5,o[3]=s[0]-o[0],o[4]=s[1]-o[1],o[5]=s[2]-o[2],o[12]=Math.sqrt(o[3]*o[3]+o[4]*o[4]+o[5]*o[5]),o},setMinMax:function(o,t,r){o[6]=t[0],o[7]=t[1],o[8]=t[2],o[9]=r[0],o[10]=r[1],o[11]=r[2];var s=o.subarray(3,6);return vec3.sub(s,r,t),vec3.scale(s,s,.5),o[0]=r[0]-s[0],o[1]=r[1]-s[1],o[2]=r[2]-s[2],o[12]=vec3.length(o.subarray(3,6)),o},setCenterHalfsize:function(o,t,r,s){return o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=r[0],o[4]=r[1],o[5]=r[2],o[6]=o[0]-o[3],o[7]=o[1]-o[4],o[8]=o[2]-o[5],o[9]=o[0]+o[3],o[10]=o[1]+o[4],o[11]=o[2]+o[5],s?o[12]=s:o[12]=vec3.length(r),o},transformMat4:(function(){for(var o=0,t=0,r=0,s=new Float32Array(24),a=[],l=0;l<24;l+=3)a.push(s.subarray(l,l+3));return function(h,u,c){var _=u[0],d=u[1],f=u[2];o=u[3],t=u[4],r=u[5];for(var m=this.corners,b=0;b<8;++b){var T=m[b],L=a[b];L[0]=o*T[0]+_,L[1]=t*T[1]+d,L[2]=r*T[2]+f,mat4.multiplyVec3(L,c,L)}return this.setFromPoints(h,s)}})(),getCorners:function(o,t){var r=o,s=o.subarray(3,6),a=null;t?(t.set(this.corners),a=t):a=new Float32Array(this.corners);for(var l=0;l<8;++l){var h=a.subarray(l*3,l*3+3);vec3.multiply(h,s,h),vec3.add(h,h,r)}return a},merge:function(o,t,r){var s=o.subarray(6,9),a=o.subarray(9,12);return vec3.min(s,t.subarray(6,9),r.subarray(6,9)),vec3.max(a,t.subarray(9,12),r.subarray(9,12)),BBox.setMinMax(o,s,a)},extendToPoint:function(o,t){t[0]<o[6]?o[6]=t[0]:t[0]>o[9]&&(o[9]=t[0]),t[1]<o[7]?o[7]=t[1]:t[1]>o[10]&&(o[10]=t[1]),t[2]<o[8]?o[8]=t[2]:t[2]>o[11]&&(o[11]=t[2]);var r=o.subarray(6,9),s=o.subarray(9,12),a=vec3.add(o.subarray(0,3),r,s);return vec3.scale(a,a,.5),vec3.subtract(o.subarray(3,6),s,a),o[12]=vec3.length(o.subarray(3,6)),o},clampPoint:function(o,t,r){o[0]=Math.clamp(r[0],t[0]-t[3],t[0]+t[3]),o[1]=Math.clamp(r[1],t[1]-t[4],t[1]+t[4]),o[2]=Math.clamp(r[2],t[2]-t[5],t[2]+t[5])},isPointInside:function(o,t){return!(o[0]-o[3]>t[0]||o[1]-o[4]>t[1]||o[2]-o[5]>t[2]||o[0]+o[3]<t[0]||o[1]+o[4]<t[1]||o[2]+o[5]<t[2])},getCenter:function(o){return o.subarray(0,3)},getHalfsize:function(o){return o.subarray(3,6)},getMin:function(o){return o.subarray(6,9)},getMax:function(o){return o.subarray(9,12)},getRadius:function(o){return o[12]}},global$1.distanceToPlane=GL$1.distanceToPlane=function o(t,r){return vec3.dot(t,r)+t[3]},global$1.planeBoxOverlap=GL$1.planeBoxOverlap=function o(t,r){var s=t,a=t[3],l=r,h=r,u=Math.abs(h[3]*s[0])+Math.abs(h[4]*s[1])+Math.abs(h[5]*s[2]),c=vec3.dot(s,l)+a;return c<=-u?CLIP_OUTSIDE:c<=u?CLIP_OVERLAP:CLIP_INSIDE};const ne=class Ot{constructor(t){this.root=null,this.total_depth=0,this.total_nodes=0,t&&(this.buildFromMesh(t),this.total_nodes=this.trim()),this.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]]}buildFromMesh(t){this.total_depth=0,this.total_nodes=0;var r=t.getBuffer("vertices").data,s=t.getIndexBuffer("triangles");s&&(s=s.data);var a=this.computeAABB(r);this.root=a,this.total_nodes=1,this.total_triangles=s?s.length/3:r.length/9,this.max_node_triangles=this.total_triangles*Ot.MAX_NODE_TRIANGLES_RATIO;var l=vec3.create();if(vec3.scale(l,a.size,Ot.OCTREE_MARGIN_RATIO),l[0]<Ot.OCTREE_MIN_MARGIN&&(l[0]=Ot.OCTREE_MIN_MARGIN),l[1]<Ot.OCTREE_MIN_MARGIN&&(l[1]=Ot.OCTREE_MIN_MARGIN),l[2]<Ot.OCTREE_MIN_MARGIN&&(l[2]=Ot.OCTREE_MIN_MARGIN),vec3.sub(a.min,a.min,l),vec3.add(a.max,a.max,l),a.faces=[],a.inside=0,s)for(var h=0;h<s.length;h+=3){var u=new Float32Array([r[s[h]*3],r[s[h]*3+1],r[s[h]*3+2],r[s[h+1]*3],r[s[h+1]*3+1],r[s[h+1]*3+2],r[s[h+2]*3],r[s[h+2]*3+1],r[s[h+2]*3+2],h/3]);this.addToNode(u,a,0)}else for(var h=0;h<r.length;h+=9){var u=new Float32Array(10);u.set(r.subarray(h,h+9)),u[9]=h/9,this.addToNode(u,a,0)}return a}addToNode(t,r,s){if(r.inside+=1,r.c){var a=this.computeAABB(t),l=!1;for(var h in r.c){var u=r.c[h];if(Ot.isInsideAABB(a,u)){this.addToNode(t,u,s+1),l=!0;break}}l||(r.faces==null&&(r.faces=[]),r.faces.push(t))}else if(r.faces==null&&(r.faces=[]),r.faces.push(t),r.faces.length>this.max_node_triangles&&s<Ot.MAX_OCTREE_DEPTH){this.splitNode(r),this.total_depth<s+1&&(this.total_depth=s+1);var c=r.faces.concat();r.faces=null;for(var h in c){var t=c[h],a=this.computeAABB(t),l=!1;for(var _ in r.c){var u=r.c[_];if(Ot.isInsideAABB(a,u)){this.addToNode(t,u,s+1),l=!0;break}}l||(r.faces==null&&(r.faces=[]),r.faces.push(t))}}}splitNode(t){t.c=[];var r=[(t.max[0]-t.min[0])*.5,(t.max[1]-t.min[1])*.5,(t.max[2]-t.min[2])*.5];for(var s in this.octree_pos_ref){var a=this.octree_pos_ref[s],l={};this.total_nodes+=1,l.min=[t.min[0]+r[0]*a[0],t.min[1]+r[1]*a[1],t.min[2]+r[2]*a[2]],l.max=[l.min[0]+r[0],l.min[1]+r[1],l.min[2]+r[2]],l.faces=null,l.inside=0,t.c.push(l)}}computeAABB(t){for(var r=new Float32Array([t[0],t[1],t[2]]),s=new Float32Array([t[0],t[1],t[2]]),a=0;a<t.length;a+=3)for(var l=0;l<3;l++)r[l]>t[a+l]&&(r[l]=t[a+l]),s[l]<t[a+l]&&(s[l]=t[a+l]);return{min:r,max:s,size:vec3.sub(vec3.create(),s,r)}}trim(t){if(t=t||this.root,!t.c)return 1;for(var r=1,s=[],a=t.c,l=0;l<a.length;++l)a[l].inside&&(s.push(a[l]),r+=this.trim(a[l]));return t.c=s,r}testSphere(t,r){if(t=vec3.clone(t),!this.root)throw"Error: octree not build";var s=r*r;return Ot.testSphereBox(t,s,vec3.clone(this.root.min),vec3.clone(this.root.max))?Ot.testSphereInNode(this.root,t,s):!1}static isInsideAABB(t,r){return!(t.min[0]<r.min[0]||t.min[1]<r.min[1]||t.min[2]<r.min[2]||t.max[0]>r.max[0]||t.max[1]>r.max[1]||t.max[2]>r.max[2])}};g(ne,"MAX_NODE_TRIANGLES_RATIO",.1),g(ne,"MAX_OCTREE_DEPTH",8),g(ne,"OCTREE_MARGIN_RATIO",.01),g(ne,"OCTREE_MIN_MARGIN",.1);let Octree=ne;Octree.testRayInNode=function(o,t,r,s){var a=null,l=null;if(o.faces)for(var h=0,u=o.faces.length;h<u;++h){var c=o.faces[h];a=Octree.hitTestTriangle(t,r,c.subarray(0,3),c.subarray(3,6),c.subarray(6,9),s),a!=null&&(a.face=c,l?l.mergeWith(a):l=a)}var _=vec3.create(),d=vec3.create(),f;if(o.c)for(var h=0;h<o.c.length;++h)f=o.c[h],_.set(f.min),d.set(f.max),a=Octree.hitTestBox(t,r,_,d),a!=null&&(l&&a.t>l.t||(a=Octree.testRayInNode(f,t,r,s),a!=null&&(l?l.mergeWith(a):l=a)));return l},Octree.testSphereInNode=function(o,t,r){if(o.faces)for(var s=0,a=o.faces.length;s<a;++s){var l=o.faces[s];if(Octree.testSphereTriangle(t,r,l.subarray(0,3),l.subarray(3,6),l.subarray(6,9)))return!0}var h=vec3.create(),u=vec3.create(),c;if(o.c){for(var s=0;s<o.c.length;++s)if(c=o.c[s],h.set(c.min),u.set(c.max),!!Octree.testSphereBox(t,r,h,u)&&Octree.testSphereInNode(c,t,r))return!0}return!1},Octree.hitTestBox=(function(){var o=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create(),l=vec3.create(),h=1e-6,u=vec3.fromValues(h,h,h);return function(c,_,d,f){if(vec3.subtract(o,d,c),vec3.subtract(t,f,c),vec3.maxValue(o)<0&&vec3.minValue(t)>0)return new HitTest(0,c,_);r[0]=1/_[0],r[1]=1/_[1],r[2]=1/_[2],vec3.multiply(o,o,r),vec3.multiply(t,t,r),vec3.min(s,o,t),vec3.max(a,o,t);var m=vec3.maxValue(s),b=vec3.minValue(a);if(m>0&&m<b){var T=vec3.add(vec3.create(),vec3.scale(l,_,m),c);return vec3.add(d,d,u),vec3.subtract(d,d,u),new HitTest(m,T,vec3.fromValues((T[0]>f[0])-(T[0]<d[0]),(T[1]>f[1])-(T[1]<d[1]),(T[2]>f[2])-(T[2]<d[2])))}return null}})(),Octree.hitTestTriangle=(function(){var o=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create();return function(a,l,h,u,c,_){vec3.subtract(o,u,h),vec3.subtract(t,c,h);var d=vec3.cross(vec3.create(),o,t);if(vec3.normalize(d,d),!_&&vec3.dot(d,l)>0)return null;var f=vec3.dot(d,vec3.subtract(s,h,a))/vec3.dot(d,l);if(f>0){var m=vec3.scale(vec3.create(),l,f);vec3.add(m,m,a),vec3.subtract(r,m,h);var b=vec3.dot(t,t),T=vec3.dot(t,o),L=vec3.dot(t,r),G=vec3.dot(o,o),I=vec3.dot(o,r),O=b*G-T*T,E=(G*L-T*I)/O,D=(b*I-T*L)/O;if(E>=0&&D>=0&&E+D<=1)return new HitTest(f,m,d)}return null}})(),Octree.testSphereTriangle=(function(){var o=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create(),a=vec3.create(),l=vec3.create(),h=vec3.create(),u=vec3.create();return function(c,_,d,f,m){vec3.sub(o,d,c),vec3.sub(t,f,c),vec3.sub(r,m,c),vec3.sub(s,t,o),vec3.sub(a,r,o),vec3.cross(u,s,a);var b=vec3.dot(o,u),T=vec3.dot(u,u),L=b*b>_*T,G=vec3.dot(o,o),I=vec3.dot(o,t),O=vec3.dot(o,r),E=vec3.dot(t,t),D=vec3.dot(t,r),N=vec3.dot(r,r),C=G>_&I>G&O>G,R=E>_&I>E&D>E,S=N>_&O>N&D>N,P=I-G,M=D-E,A=O-N;vec3.sub(l,r,t),vec3.sub(h,o,r);var B=vec3.dot(s,s),$=vec3.dot(l,l),H=vec3.dot(h,h),F=vec3.scale(vec3.create(),o,B);vec3.sub(F,F,vec3.scale(vec3.create(),s,P));var W=vec3.scale(vec3.create(),t,$);vec3.sub(W,W,vec3.scale(vec3.create(),l,M));var z=vec3.scale(vec3.create(),r,H);vec3.sub(z,z,vec3.scale(vec3.create(),h,A));var U=vec3.scale(vec3.create(),r,B);U=vec3.sub(U,U,F);var V=vec3.scale(vec3.create(),o,$);V=vec3.sub(V,V,W);var X=vec3.scale(vec3.create(),t,H);X=vec3.sub(X,X,z);var J=vec3.dot(F,F)>_*B*B&vec3.dot(F,U)>0,pe=vec3.dot(W,W)>_*$*$&vec3.dot(W,V)>0,q=vec3.dot(z,z)>_*H*H&vec3.dot(z,X)>0,Z=L|C|R|S|J|pe|q;return!Z}})(),Octree.testSphereBox=function(o,t,r,s){for(var a,l=0,h=0;h<3;++h)o[h]<r[h]?(a=o[h]-r[h],l+=a*a):o[h]>s[h]&&(a=o[h]-s[h],l+=a*a);return l<=t},Octree.prototype.testRay=(function(){var o=vec3.create(),t=vec3.create(),r=vec3.create(),s=vec3.create();return function(a,l,h,u,c){if(!this.root)throw"Error: octree not build";o.set(a),t.set(l),r.set(this.root.min),s.set(this.root.max);var _=Octree.hitTestBox(o,t,r,s);if(!_)return null;var _=Octree.testRayInNode(this.root,o,t,c);if(_!=null){var d=vec3.scale(vec3.create(),l,_.t);return vec3.add(d,d,a),_.pos=d,_}return null}})(),GL$1.Octree=Octree;class HitTest{constructor(t,r,s){this.t=arguments.length?t:Number.MAX_VALUE,this.hit=r,this.normal=s,this.face=null}mergeWidth(t){t.t>0&&t.t<this.t&&(this.t=t.t,this.hit=t.hit,this.normal=t.normal,this.face=t.face)}}GL$1.HitTest=HitTest;class Ray{constructor(t,r){this.origin=vec3.create(),this.direction=vec3.create(),this.collision_point=vec3.create(),t&&this.origin.set(t),r&&this.direction.set(r)}testPlane(t,r){return geo.testRayPlane(this.origin,this.direction,t,r,this.collision_point)}testSphere(t,r,s){return geo.testRaySphere(this.origin,this.direction,t,r,this.collision_point,s)}}GL$1.Ray=Ray;class Raytracer{constructor(t,r){this.viewport=vec4.create(),this.ray00=vec3.create(),this.ray10=vec3.create(),this.ray01=vec3.create(),this.ray11=vec3.create(),this.eye=vec3.create(),this.setup(t,r)}setup(t,r){r=r||gl.viewport_data,this.viewport.set(r);var s=r[0],a=s+r[2],l=r[1],h=l+r[3];vec3.set(this.ray00,s,l,1),vec3.set(this.ray10,a,l,1),vec3.set(this.ray01,s,h,1),vec3.set(this.ray11,a,h,1),vec3.unproject(this.ray00,this.ray00,t,r),vec3.unproject(this.ray10,this.ray10,t,r),vec3.unproject(this.ray01,this.ray01,t,r),vec3.unproject(this.ray11,this.ray11,t,r);var u=this.eye;vec3.unproject(u,u,t,r),vec3.subtract(this.ray00,this.ray00,u),vec3.subtract(this.ray10,this.ray10,u),vec3.subtract(this.ray01,this.ray01,u),vec3.subtract(this.ray11,this.ray11,u)}static hitTestBox(t,r,s,a,l){var h=new Float32Array(30);if(l){var u=mat4.invert(_hittest_inv,l);t=mat4.multiplyVec3(h.subarray(3,6),u,t),r=mat4.rotateVec3(h.subarray(6,9),u,r)}var c=vec3.subtract(h.subarray(9,12),s,t);vec3.divide(c,c,r);var _=vec3.subtract(h.subarray(12,15),a,t);vec3.divide(_,_,r);var d=vec3.min(h.subarray(15,18),c,_),f=vec3.max(h.subarray(18,21),c,_),m=vec3.maxValue(d),b=vec3.minValue(f);if(m>0&&m<=b){var T=1e-6,L=vec3.scale(h.subarray(21,24),r,m);return vec3.add(L,t,L),vec3.addValue(h.subarray(24,27),s,T),vec3.subValue(h.subarray(27,30),a,T),new HitTest(m,L,vec3.fromValues((L[0]>a[0])-(L[0]<s[0]),(L[1]>a[1])-(L[1]<s[1]),(L[2]>a[2])-(L[2]<s[2])))}return null}static hitTestSphere(t,r,s,a){var l=vec3.subtract(vec3.create(),t,s),h=vec3.dot(r,r),u=2*vec3.dot(r,l),c=vec3.dot(l,l)-a*a,_=u*u-4*h*c;if(_>0){var d=(-u-Math.sqrt(_))/(2*h),f=vec3.add(vec3.create(),t,vec3.scale(vec3.create(),r,d));return new HitTest(d,f,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),f,s),1/a))}return null}static hitTestTriangle(t,r,s,a,l){var h=vec3.subtract(vec3.create(),a,s),u=vec3.subtract(vec3.create(),l,s),c=vec3.cross(vec3.create(),h,u);vec3.normalize(c,c);var _=vec3.dot(c,vec3.subtract(vec3.create(),s,t))/vec3.dot(c,r);if(_>0){var d=vec3.add(vec3.create(),t,vec3.scale(vec3.create(),r,_)),f=vec3.subtract(vec3.create(),d,s),m=vec3.dot(u,u),b=vec3.dot(u,h),T=vec3.dot(u,f),L=vec3.dot(h,h),G=vec3.dot(h,f),I=m*L-b*b,O=(L*T-b*G)/I,E=(m*G-b*T)/I;if(O>=0&&E>=0&&O+E<=1)return new HitTest(_,d,c)}return null}}GL$1.Raytracer=Raytracer;var _hittest_inv=mat4.create();Raytracer.prototype.getRayForPixel=(function(){var o=vec3.create(),t=vec3.create();return function(r,s,a){return a=a||vec3.create(),r=(r-this.viewport[0])/this.viewport[2],s=1-(s-this.viewport[1])/this.viewport[3],vec3.lerp(o,this.ray00,this.ray10,r),vec3.lerp(t,this.ray01,this.ray11,r),vec3.lerp(a,o,t,s),vec3.normalize(a,a)}})(),LiteGraph.LGraphCanvas.link_type_colors.Texture="#987";const DEG2RAD=.0174532925,ie=class qt{constructor(){this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",filter:!0},this.size=[qt.image_preview_size,qt.image_preview_size]}static getTexturesContainer(){return gl$1.textures}static loadTexture(t,r){r=r||{};var s=t;s.substr(0,7)=="http://"&&LiteGraph.proxy&&(s=LiteGraph.proxy+s.substr(7));var a=qt.getTexturesContainer(),l=a[t]=GL$1.Texture.fromURL(s,r);return l}static getTexture(t){var r=this.getTexturesContainer();if(!r)throw new Error("Cannot load texture, container of textures not found");var s=r[t];return!s&&t&&t[0]!=":"?this.loadTexture(t):s}static getTargetTexture(t,r,s){if(!t)throw new Error("LGraphTexture.getTargetTexture expects a reference texture");var a=null;switch(s){case qt.LOW:a=gl$1.UNSIGNED_BYTE;break;case qt.HIGH:a=gl$1.HIGH_PRECISION_FORMAT;break;case qt.REUSE:return t;default:a=t?t.type:gl$1.UNSIGNED_BYTE;break}return(!r||r.width!=t.width||r.height!=t.height||r.type!=a||r.format!=t.format)&&(r=new GL$1.Texture(t.width,t.height,{type:a,format:t.format,filter:gl$1.LINEAR})),r}static getTextureType(t,r){var s=r?r.type:gl$1.UNSIGNED_BYTE;switch(t){case qt.HIGH:s=gl$1.HIGH_PRECISION_FORMAT;break;case qt.LOW:s=gl$1.UNSIGNED_BYTE;break}return s}static getWhiteTexture(){if(this._white_texture)return this._white_texture;var t=this._white_texture=GL$1.Texture.fromMemory(1,1,[255,255,255,255],{format:gl$1.RGBA,wrap:gl$1.REPEAT,filter:gl$1.NEAREST});return t}static getNoiseTexture(){if(this._noise_texture)return this._noise_texture;for(var t=new Uint8Array(512*512*4),r=0;r<512*512*4;++r)t[r]=Math.random()*255;var s=GL$1.Texture.fromMemory(512,512,t,{format:gl$1.RGBA,wrap:gl$1.REPEAT,filter:gl$1.NEAREST});return this._noise_texture=s,s}onDropFile(t,r,s){if(!t)this._drop_texture=null,this.properties.name="";else{var a=null;if(typeof t=="string")a=GL$1.Texture.fromURL(t);else if(r.toLowerCase().indexOf(".dds")!=-1)a=GL$1.Texture.fromDDSInMemory(t);else{var l=new Blob([s]),h=URL.createObjectURL(l);a=GL$1.Texture.fromURL(h)}this._drop_texture=a,this.properties.name=r}}getExtraMenuOptions(){var t=this;if(this._drop_texture)return[{content:"Clear",callback:function(){t._drop_texture=null,t.properties.name=""}}]}onExecute(){var t=null;if(this.isOutputConnected(1)&&(t=this.getInputData(0)),!t&&this._drop_texture&&(t=this._drop_texture),!t&&this.properties.name&&(t=qt.getTexture(this.properties.name)),!t){this.setOutputData(0,null),this.setOutputData(1,"");return}this._last_tex=t,this.properties.filter===!1?t.setParameter(gl$1.TEXTURE_MAG_FILTER,gl$1.NEAREST):t.setParameter(gl$1.TEXTURE_MAG_FILTER,gl$1.LINEAR),this.setOutputData(0,t),this.setOutputData(1,t.fullpath||t.filename);for(var r=2;r<this.outputs.length;r++){var s=this.outputs[r];if(s){var a=null;s.name=="width"?a=t.width:s.name=="height"?a=t.height:s.name=="aspect"&&(a=t.width/t.height),this.setOutputData(r,a)}}}onResourceRenamed(t,r){this.properties.name==t&&(this.properties.name=r)}onDrawBackground(t){if(!(this.flags.collapsed||this.size[1]<=20)){if(this._drop_texture&&t.webgl){t.drawImage(this._drop_texture,0,0,this.size[0],this.size[1]);return}if(this._last_preview_tex!=this._last_tex)if(t.webgl)this._canvas=this._last_tex;else{var r=qt.generateLowResTexturePreview(this._last_tex);if(!r)return;this._last_preview_tex=this._last_tex,this._canvas=GL$1.cloneCanvas(r)}this._canvas&&(t.save(),t.webgl||(t.translate(0,this.size[1]),t.scale(1,-1)),t.drawImage(this._canvas,0,0,this.size[0],this.size[1]),t.restore())}}static generateLowResTexturePreview(t){if(!t)return null;var r=qt.image_preview_size,s=t;if(t.format==gl$1.DEPTH_COMPONENT)return null;(t.width>r||t.height>r)&&(s=this._preview_temp_tex,this._preview_temp_tex||(s=new GL$1.Texture(r,r,{minFilter:gl$1.NEAREST}),this._preview_temp_tex=s),t.copyTo(s),t=s);var a=this._preview_canvas;return a||(a=GL$1.createCanvas(r,r),this._preview_canvas=a),s&&s.toCanvas(a),a}getResources(t){return this.properties.name&&(t[this.properties.name]=GL$1.Texture),t}onGetInputs(){return[["in","Texture"]]}onGetOutputs(){return[["width","number"],["height","number"],["aspect","number"]]}static replaceCode(t,r){return t.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(s){return s=s.replace(/[\{\}]/g,""),r[s]||""})}};g(ie,"title","Texture"),g(ie,"desc","Texture"),g(ie,"widgets_info",{name:{widget:"texture"},filter:{widget:"checkbox"}}),g(ie,"loadTextureCallback",null),g(ie,"image_preview_size",256),g(ie,"UNDEFINED",0),g(ie,"PASS_THROUGH",1),g(ie,"COPY",2),g(ie,"LOW",3),g(ie,"HIGH",4),g(ie,"REUSE",5),g(ie,"DEFAULT",2),g(ie,"MODE_VALUES",{undefined:ie.UNDEFINED,"pass through":ie.PASS_THROUGH,copy:ie.COPY,low:ie.LOW,high:ie.HIGH,reuse:ie.REUSE,default:ie.DEFAULT});let LGraphTexture=ie;LiteGraph.registerNodeType("texture/texture",LGraphTexture);const yt=class tr{constructor(){this.addInput("Texture","Texture"),this.properties={flipY:!1},this.size=[LGraphTexture.image_preview_size,LGraphTexture.image_preview_size]}onDrawBackground(t){if(!this.flags.collapsed&&!(!t.webgl&&!tr.allow_preview)){var r=this.getInputData(0);if(r){var s=null;!r.handle&&t.webgl?s=r:s=LGraphTexture.generateLowResTexturePreview(r),t.save(),this.properties.flipY&&(t.translate(0,this.size[1]),t.scale(1,-1)),t.drawImage(s,0,0,this.size[0],this.size[1]),t.restore()}}}};g(yt,"title","Preview"),g(yt,"desc","Show a texture in the graph canvas"),g(yt,"allow_preview",!1);let LGraphTexturePreview=yt;LiteGraph.registerNodeType("texture/preview",LGraphTexturePreview);class LGraphTextureSave{constructor(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",generate_mipmaps:!1}}getPreviewTexture(){return this._texture}onExecute(){var t=this.getInputData(0);if(t){if(this.properties.generate_mipmaps&&(t.bind(0),t.setParameter(gl$1.TEXTURE_MIN_FILTER,gl$1.LINEAR_MIPMAP_LINEAR),gl$1.generateMipmap(t.texture_type),t.unbind(0)),this.properties.name)if(LGraphTexture.storeTexture)LGraphTexture.storeTexture(this.properties.name,t);else{var r=LGraphTexture.getTexturesContainer();r[this.properties.name]=t}this._texture=t,this.setOutputData(0,t),this.setOutputData(1,this.properties.name)}}}g(LGraphTextureSave,"title","Save"),g(LGraphTextureSave,"desc","Save a texture in the repository"),LiteGraph.registerNodeType("texture/save",LGraphTextureSave);const Ge=class di{constructor(){this.addInput("Texture","Texture"),this.addInput("TextureB","Texture"),this.addInput("value","number"),this.addOutput("Texture","Texture"),this.help="<p>pixelcode must be vec3, uvcode must be vec2, is optional</p>        <p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture <strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time <strong>value:</strong> input value</p><p>For multiline you must type: result = ...</p>",this.properties={value:1,pixelcode:"color + colorB * value",uvcode:"",precision:LGraphTexture.DEFAULT},this.has_error=!1}getExtraMenuOptions(){var t=this,r=t.properties.show?"Hide Texture":"Show Texture";return[{content:r,callback:function(){t.properties.show=!t.properties.show}}]}onPropertyChanged(){this.has_error=!1}onDrawBackground(t){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._tex&&this._tex.gl==t&&(t.save(),t.drawImage(this._tex,0,0,this.size[0],this.size[1]),t.restore())}onExecute(){var t=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===LGraphTexture.PASS_THROUGH){this.setOutputData(0,t);return}var r=this.getInputData(1);if(!(!this.properties.uvcode&&!this.properties.pixelcode)){var s=512,a=512;t?(s=t.width,a=t.height):r&&(s=r.width,a=r.height),r||(r=GL$1.Texture.getWhiteTexture());var l=LGraphTexture.getTextureType(this.properties.precision,t);!t&&!this._tex?this._tex=new GL$1.Texture(s,a,{type:l,format:gl$1.RGBA,filter:gl$1.LINEAR}):this._tex=LGraphTexture.getTargetTexture(t||this._tex,this._tex,this.properties.precision);var h="";this.properties.uvcode&&(h="uv = "+this.properties.uvcode,this.properties.uvcode.indexOf(";")!=-1&&(h=this.properties.uvcode));var u="";this.properties.pixelcode&&(u="result = "+this.properties.pixelcode,this.properties.pixelcode.indexOf(";")!=-1&&(u=this.properties.pixelcode));var c=this._shader;if(!this.has_error&&(!c||this._shader_code!=h+"|"+u)){var _=LGraphTexture.replaceCode(di.pixel_shader,{UV_CODE:h,PIXEL_CODE:u});try{c=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,_),this.boxcolor="#00FF00"}catch(m){GL$1.Shader.dumpErrorToConsole(m,Shader.SCREEN_VERTEX_SHADER,_),this.boxcolor="#FF0000",this.has_error=!0;return}this._shader=c,this._shader_code=h+"|"+u}if(this._shader){var d=this.getInputData(2);d!=null?this.properties.value=d:d=parseFloat(this.properties.value);var f=this.graph.getTime();this._tex.drawTo(function(){gl$1.disable(gl$1.DEPTH_TEST),gl$1.disable(gl$1.CULL_FACE),gl$1.disable(gl$1.BLEND),t&&t.bind(0),r&&r.bind(1);var m=Mesh.getScreenQuad();c.uniforms({u_texture:0,u_textureB:1,value:d,texSize:[s,a,1/s,1/a],time:f}).draw(m)}),this.setOutputData(0,this._tex)}}}}static registerPreset(t,r){di.presets[t]=r}onInspect(t){var r=this;t.addCombo("Presets","",{values:Object.keys(di.presets),callback:function(s){var a=di.presets[s];a&&(r.setProperty("pixelcode",a),r.title=s,t.refresh())}})}};g(Ge,"widgets_info",{uvcode:{widget:"code"},pixelcode:{widget:"code"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(Ge,"title","Operation"),g(Ge,"desc","Texture shader operation"),g(Ge,"presets",{}),g(Ge,"pixel_shader",`
        precision highp float;
    
        uniform sampler2D u_texture;
        uniform sampler2D u_textureB;
        varying vec2 v_coord;
        uniform vec4 texSize;
        uniform float time;
        uniform float value;
    
        void main() {
            vec2 uv = v_coord;
            {{UV_CODE}};
            vec4 color4 = texture2D(u_texture, uv);
            vec3 color = color4.rgb;
            vec4 color4B = texture2D(u_textureB, uv);
            vec3 colorB = color4B.rgb;
            vec3 result = color;
            float alpha = 1.0;
            {{PIXEL_CODE}};
            gl_FragColor = vec4(result, alpha);
        }
    `);let LGraphTextureOperation=Ge;LGraphTextureOperation.registerPreset("",""),LGraphTextureOperation.registerPreset("bypass","color"),LGraphTextureOperation.registerPreset("add","color + colorB * value"),LGraphTextureOperation.registerPreset("substract","(color - colorB) * value"),LGraphTextureOperation.registerPreset("mate","mix( color, colorB, color4B.a * value)"),LGraphTextureOperation.registerPreset("invert","vec3(1.0) - color"),LGraphTextureOperation.registerPreset("multiply","color * colorB * value"),LGraphTextureOperation.registerPreset("divide","(color / colorB) / value"),LGraphTextureOperation.registerPreset("difference","abs(color - colorB) * value"),LGraphTextureOperation.registerPreset("max","max(color, colorB) * value"),LGraphTextureOperation.registerPreset("min","min(color, colorB) * value"),LGraphTextureOperation.registerPreset("displace","texture2D(u_texture, uv + (colorB.xy - vec2(0.5)) * value).xyz"),LGraphTextureOperation.registerPreset("grayscale","vec3(color.x + color.y + color.z) * value / 3.0"),LGraphTextureOperation.registerPreset("saturation","mix( vec3(color.x + color.y + color.z) / 3.0, color, value )"),LGraphTextureOperation.registerPreset("normalmap",`
    float z0 = texture2D(u_texture, uv + vec2(-texSize.z, -texSize.w) ).x;
    float z1 = texture2D(u_texture, uv + vec2(0.0, -texSize.w) ).x;
    float z2 = texture2D(u_texture, uv + vec2(texSize.z, -texSize.w) ).x;
    float z3 = texture2D(u_texture, uv + vec2(-texSize.z, 0.0) ).x;
    float z4 = color.x;
    float z5 = texture2D(u_texture, uv + vec2(texSize.z, 0.0) ).x;
    float z6 = texture2D(u_texture, uv + vec2(-texSize.z, texSize.w) ).x;
    float z7 = texture2D(u_texture, uv + vec2(0.0, texSize.w) ).x;
    float z8 = texture2D(u_texture, uv + vec2(texSize.z, texSize.w) ).x;
    vec3 normal = vec3( z2 + 2.0*z4 + z7 - z0 - 2.0*z3 - z5, z5 + 2.0*z6 + z7 -z0 - 2.0*z1 - z2, 1.0 );
    normal.xy *= value;
    result.xyz = normalize(normal) * 0.5 + vec3(0.5);
`),LGraphTextureOperation.registerPreset("threshold","vec3(color.x > colorB.x * value ? 1.0 : 0.0,color.y > colorB.y * value ? 1.0 : 0.0,color.z > colorB.z * value ? 1.0 : 0.0)"),LiteGraph.registerNodeType("texture/operation",LGraphTextureOperation);const ht=class ir{constructor(){this.addOutput("out","Texture"),this.properties={code:"",u_value:1,u_color:[1,1,1,1],width:512,height:512,precision:LGraphTexture.DEFAULT},this.properties.code=ir.pixel_shader,this._uniforms={u_value:1,u_color:vec4.create(),in_texture:0,texSize:vec4.create(),time:0}}onPropertyChanged(t,r){if(t=="code"){var s=this.getShader();if(s){var a=s.uniformInfo;if(this.inputs){var l={};for(let _=0;_<this.inputs.length;++_){let d=this.getInputInfo(_);if(d){if(a[d.name]&&!l[d.name]){l[d.name]=!0;continue}this.removeInput(_),_--}}}for(let _ in a){let d=s.uniformInfo[_];if(d.loc!==null&&_!="time"){var h="number";if(this._shader.samplers[_])h="texture";else switch(d.size){case 1:h="number";break;case 2:h="vec2";break;case 3:h="vec3";break;case 4:h="vec4";break;case 9:h="mat3";break;case 16:h="mat4";break;default:continue}var u=this.findInputSlot(_);if(u==-1){this.addInput(_,h);continue}var c=this.getInputInfo(u);if(!c)this.addInput(_,h);else{if(c.type==h)continue;this.removeInput(u,h),this.addInput(_,h)}}}}}}getShader(){if(this._shader&&this._shader_code==this.properties.code)return this._shader;if(this._shader_code=this.properties.code,this._shader=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,this.properties.code),this._shader)this.boxcolor="green";else return this.boxcolor="red",null;return this._shader}onExecute(){if(this.isOutputConnected(0)){var t=this.getShader();if(t){var r=0,s=null;if(this.inputs)for(var a=0;a<this.inputs.length;++a){var l=this.getInputInfo(a),h=this.getInputData(a);h!=null&&(h.constructor===GL$1.Texture&&(h.bind(r),s||(s=h),h=r,r++),t.setUniform(l.name,h))}var u=this._uniforms,c=LGraphTexture.getTextureType(this.properties.precision,s),_=this.properties.width|0,d=this.properties.height|0;_==0&&(_=s?s.width:gl$1.canvas.width),d==0&&(d=s?s.height:gl$1.canvas.height),u.texSize[0]=_,u.texSize[1]=d,u.texSize[2]=1/_,u.texSize[3]=1/d,u.time=this.graph.getTime(),u.u_value=this.properties.u_value,u.u_color.set(this.properties.u_color),(!this._tex||this._tex.type!=c||this._tex.width!=_||this._tex.height!=d)&&(this._tex=new GL$1.Texture(_,d,{type:c,format:gl$1.RGBA,filter:gl$1.LINEAR}));var f=this._tex;f.drawTo(function(){t.uniforms(u).draw(GL$1.Mesh.getScreenQuad())}),this.setOutputData(0,this._tex)}}}};g(ht,"title","Shader"),g(ht,"desc","Texture shader"),g(ht,"widgets_info",{code:{type:"code",lang:"glsl"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(ht,"pixel_shader",`
        precision highp float;
    
        varying vec2 v_coord;
        uniform float time; // time in seconds
        uniform vec4 texSize; // tex resolution
        uniform float u_value;
        uniform vec4 u_color;
    
        void main() {
            vec2 uv = v_coord;
            vec3 color = vec3(0.0);
            // Your custom code here
            color.xy = uv;
    
            gl_FragColor = vec4(color, 1.0);
        }
    `);let LGraphTextureShader=ht;LiteGraph.registerNodeType("texture/shader",LGraphTextureShader);const lt=class rr{constructor(){this.addInput("in","Texture"),this.addInput("scale","vec2"),this.addInput("offset","vec2"),this.addOutput("out","Texture"),this.properties={offset:vec2.fromValues(0,0),scale:vec2.fromValues(1,1),precision:LGraphTexture.DEFAULT}}onExecute(){var t=this.getInputData(0);if(!(!this.isOutputConnected(0)||!t)){if(this.properties.precision===LGraphTexture.PASS_THROUGH){this.setOutputData(0,t);return}var r=t.width,s=t.height,a=this.precision===LGraphTexture.LOW?gl$1.UNSIGNED_BYTE:gl$1.HIGH_PRECISION_FORMAT;this.precision===LGraphTexture.DEFAULT&&(a=t.type),(!this._tex||this._tex.width!=r||this._tex.height!=s||this._tex.type!=a)&&(this._tex=new GL$1.Texture(r,s,{type:a,format:gl$1.RGBA,filter:gl$1.LINEAR}));var l=this._shader;l||(l=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,rr.pixel_shader));var h=this.getInputData(1);h?(this.properties.scale[0]=h[0],this.properties.scale[1]=h[1]):h=this.properties.scale;var u=this.getInputData(2);u?(this.properties.offset[0]=u[0],this.properties.offset[1]=u[1]):u=this.properties.offset,this._tex.drawTo(function(){gl$1.disable(gl$1.DEPTH_TEST),gl$1.disable(gl$1.CULL_FACE),gl$1.disable(gl$1.BLEND),t.bind(0);var c=Mesh.getScreenQuad();l.uniforms({u_texture:0,u_scale:h,u_offset:u}).draw(c)}),this.setOutputData(0,this._tex)}}};g(lt,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(lt,"title","Scale/Offset"),g(lt,"desc","Applies an scaling and offseting"),g(lt,"pixel_shader",`
        precision highp float;
    
        uniform sampler2D u_texture;
        uniform sampler2D u_textureB;
        varying vec2 v_coord;
        uniform vec2 u_scale;
        uniform vec2 u_offset;
    
        void main() {
            vec2 uv = v_coord;
            uv = uv / u_scale - u_offset;
            gl_FragColor = texture2D(u_texture, uv);
        }
    `);let LGraphTextureScaleOffset=lt;LiteGraph.registerNodeType("texture/scaleOffset",LGraphTextureScaleOffset);const bt=class sr{constructor(){g(this,"pixel_shader",`
        precision highp float;
    
        uniform sampler2D u_texture;
        uniform sampler2D u_textureB;
        varying vec2 v_coord;
        uniform float u_factor;
        uniform vec2 u_scale;
        uniform vec2 u_offset;
    
        void main() {
            vec2 uv = v_coord;
            uv += (texture2D(u_textureB, uv).rg - vec2(0.5)) * u_factor * u_scale + u_offset;
            gl_FragColor = texture2D(u_texture, uv);
        }
    `),this.addInput("in","Texture"),this.addInput("warp","Texture"),this.addInput("factor","number"),this.addOutput("out","Texture"),this.properties={factor:.01,scale:[1,1],offset:[0,0],precision:LGraphTexture.DEFAULT},this._uniforms={u_texture:0,u_textureB:1,u_factor:1,u_scale:vec2.create(),u_offset:vec2.create()}}onExecute(){var t=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===LGraphTexture.PASS_THROUGH){this.setOutputData(0,t);return}var r=this.getInputData(1),s=512,a=512;t?(s=t.width,a=t.height):r&&(s=r.width,a=r.height),!t&&!this._tex?this._tex=new GL$1.Texture(s,a,{type:this.precision===LGraphTexture.LOW?gl$1.UNSIGNED_BYTE:gl$1.HIGH_PRECISION_FORMAT,format:gl$1.RGBA,filter:gl$1.LINEAR}):this._tex=LGraphTexture.getTargetTexture(t||this._tex,this._tex,this.properties.precision);var l=this._shader;l||(l=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,sr.pixel_shader));var h=this.getInputData(2);h!=null?this.properties.factor=h:h=parseFloat(this.properties.factor);var u=this._uniforms;u.u_factor=h,u.u_scale.set(this.properties.scale),u.u_offset.set(this.properties.offset),this._tex.drawTo(function(){gl$1.disable(gl$1.DEPTH_TEST),gl$1.disable(gl$1.CULL_FACE),gl$1.disable(gl$1.BLEND),t&&t.bind(0),r&&r.bind(1);var c=Mesh.getScreenQuad();l.uniforms(u).draw(c)}),this.setOutputData(0,this._tex)}}};g(bt,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(bt,"title","Warp"),g(bt,"desc","Texture warp operation");let LGraphTextureWarp=bt;LiteGraph.registerNodeType("texture/warp",LGraphTextureWarp);const ue=class Kt{constructor(){this.addInput("Texture","Texture"),this.properties={additive:!1,antialiasing:!1,filter:!0,disable_alpha:!1,gamma:1,viewport:[0,0,1,1]},this.size[0]=130}onDrawBackground(t){if(!(this.flags.collapsed||this.size[1]<=40)){var r=this.getInputData(0);r&&t.drawImage(t==gl$1?r:gl$1.canvas,10,30,this.size[0]-20,this.size[1]-40)}}onExecute(){var t=this.getInputData(0);if(t){this.properties.disable_alpha?gl$1.disable(gl$1.BLEND):(gl$1.enable(gl$1.BLEND),this.properties.additive?gl$1.blendFunc(gl$1.SRC_ALPHA,gl$1.ONE):gl$1.blendFunc(gl$1.SRC_ALPHA,gl$1.ONE_MINUS_SRC_ALPHA)),gl$1.disable(gl$1.DEPTH_TEST);var r=this.properties.gamma||1;this.isInputConnected(1)&&(r=this.getInputData(1)),t.setParameter(gl$1.TEXTURE_MAG_FILTER,this.properties.filter?gl$1.LINEAR:gl$1.NEAREST);var s=Kt._prev_viewport;s.set(gl$1.viewport_data);var a=this.properties.viewport;if(gl$1.viewport(s[0]+s[2]*a[0],s[1]+s[3]*a[1],s[2]*a[2],s[3]*a[3]),this.properties.antialiasing){Kt._shader||(Kt._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,Kt.aa_pixel_shader));var l=Mesh.getScreenQuad();t.bind(0),Kt._shader.uniforms({u_texture:0,uViewportSize:[t.width,t.height],u_igamma:1/r,inverseVP:[1/t.width,1/t.height]}).draw(l)}else r!=1?(Kt._gamma_shader||(Kt._gamma_shader=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,Kt.gamma_pixel_shader)),t.toViewport(Kt._gamma_shader,{u_texture:0,u_igamma:1/r})):t.toViewport();gl$1.viewport(s[0],s[1],s[2],s[3])}}onGetInputs(){return[["gamma","number"]]}};g(ue,"title","to Viewport"),g(ue,"desc","Texture to viewport"),g(ue,"_prev_viewport",new Float32Array(4)),g(ue,"aa_pixel_shader",`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 uViewportSize;
        uniform vec2 inverseVP;
        uniform float u_igamma;
        #define FXAA_REDUCE_MIN   (1.0/128.0)
        #define FXAA_REDUCE_MUL   (1.0/8.0)
        #define FXAA_SPAN_MAX     8.0
    
        vec4 applyFXAA(sampler2D tex, vec2 fragCoord) {
            vec4 color = vec4(0.0);
            vec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;
            vec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;
            vec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;
            vec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;
            vec3 rgbM  = texture2D(tex, fragCoord * inverseVP).xyz;
            vec3 luma = vec3(0.299, 0.587, 0.114);
            
            // Rest of the FXAA algorithm
            
            return color;
        }
    
        void main() {
            gl_FragColor = applyFXAA(u_texture, v_coord * uViewportSize);
        }
    `),g(ue,"gamma_pixel_shader",`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform float u_igamma;
    
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            color.xyz = pow(color.xyz, vec3(u_igamma));
            gl_FragColor = color;
        }
    `);let LGraphTextureToViewport=ue;LiteGraph.registerNodeType("texture/toviewport",LGraphTextureToViewport);class LGraphTextureCopy{constructor(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:0,generate_mipmaps:!1,precision:LGraphTexture.DEFAULT}}onExecute(){var t=this.getInputData(0);if(!(!t&&!this._temp_texture)&&this.isOutputConnected(0)){if(t){var r=t.width,s=t.height;this.properties.size!=0&&(r=this.properties.size,s=this.properties.size);var a=this._temp_texture,l=t.type;if(this.properties.precision===LGraphTexture.LOW?l=gl$1.UNSIGNED_BYTE:this.properties.precision===LGraphTexture.HIGH&&(l=gl$1.HIGH_PRECISION_FORMAT),!a||a.width!=r||a.height!=s||a.type!=l){var h=gl$1.LINEAR;this.properties.generate_mipmaps&&GL$1.isPowerOfTwo(r)&&GL$1.isPowerOfTwo(s)&&(h=gl$1.LINEAR_MIPMAP_LINEAR),this._temp_texture=new GL$1.Texture(r,s,{type:l,format:gl$1.RGBA,minFilter:h,magFilter:gl$1.LINEAR})}t.copyTo(this._temp_texture),this.properties.generate_mipmaps&&(this._temp_texture.bind(0),gl$1.generateMipmap(this._temp_texture.texture_type),this._temp_texture.unbind(0))}this.setOutputData(0,this._temp_texture)}}}g(LGraphTextureCopy,"title","Copy"),g(LGraphTextureCopy,"desc","Copy Texture"),g(LGraphTextureCopy,"widgets_info",{size:{widget:"combo",values:[0,32,64,128,256,512,1024,2048]},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),LiteGraph.registerNodeType("texture/copy",LGraphTextureCopy);const He=class Ri{constructor(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={iterations:1,generate_mipmaps:!1,precision:LGraphTexture.DEFAULT}}onExecute(){var t=this.getInputData(0);if(!(!t&&!this._temp_texture)&&this.isOutputConnected(0)&&!(!t||t.texture_type!==GL$1.TEXTURE_2D)){if(this.properties.iterations<1){this.setOutputData(0,t);return}var r=Ri._shader;r||(Ri._shader=r=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,Ri.pixel_shader));var s=t.width|0,a=t.height|0,l=t.type;this.properties.precision===LGraphTexture.LOW?l=gl$1.UNSIGNED_BYTE:this.properties.precision===LGraphTexture.HIGH&&(l=gl$1.HIGH_PRECISION_FORMAT);var h=this.properties.iterations||1,u=t,c=null,_=[],d={type:l,format:t.format},f=vec2.create(),m={u_offset:f};this._texture&&GL$1.Texture.releaseTemporary(this._texture);for(let b=0;b<h&&(f[0]=1/s,f[1]=1/a,s=s>>1||0,a=a>>1||0,c=GL$1.Texture.getTemporary(s,a,d),_.push(c),u.setParameter(GL$1.TEXTURE_MAG_FILTER,GL$1.NEAREST),u.copyTo(c,r,m),!(s==1&&a==1));++b)u=c;this._texture=_.pop();for(let b=0;b<_.length;++b)GL$1.Texture.releaseTemporary(_[b]);this.properties.generate_mipmaps&&(this._texture.bind(0),gl$1.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}}};g(He,"title","Downsample"),g(He,"desc","Downsample Texture"),g(He,"widgets_info",{iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(He,"pixel_shader",`
        precision highp float;
        uniform sampler2D u_texture;
        uniform vec2 u_offset;
        varying vec2 v_coord;
    
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            color += texture2D(u_texture, v_coord + vec2(u_offset.x, 0.0));
            color += texture2D(u_texture, v_coord + vec2(0.0, u_offset.y));
            color += texture2D(u_texture, v_coord + u_offset);
            gl_FragColor = color * 0.25;
        }
    `);let LGraphTextureDownsample=He;LiteGraph.registerNodeType("texture/downsample",LGraphTextureDownsample);class LGraphTextureResize{constructor(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:[512,512],generate_mipmaps:!1,precision:LGraphTexture.DEFAULT}}onExecute(){var t=this.getInputData(0);if(!(!t&&!this._temp_texture)&&this.isOutputConnected(0)&&!(!t||t.texture_type!==GL$1.TEXTURE_2D)){var r=this.properties.size[0]|0,s=this.properties.size[1]|0;r==0&&(r=t.width),s==0&&(s=t.height);var a=t.type;this.properties.precision===LGraphTexture.LOW?a=gl$1.UNSIGNED_BYTE:this.properties.precision===LGraphTexture.HIGH&&(a=gl$1.HIGH_PRECISION_FORMAT),(!this._texture||this._texture.width!=r||this._texture.height!=s||this._texture.type!=a)&&(this._texture=new GL$1.Texture(r,s,{type:a})),t.copyTo(this._texture),this.properties.generate_mipmaps&&(this._texture.bind(0),gl$1.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}}}g(LGraphTextureResize,"title","Resize"),g(LGraphTextureResize,"desc","Resize Texture"),g(LGraphTextureResize,"widgets_info",{iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),LiteGraph.registerNodeType("texture/resize",LGraphTextureResize);const De=class li{constructor(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("avg","vec4"),this.addOutput("lum","number"),this.properties={use_previous_frame:!0,high_quality:!1},this._uniforms={u_texture:0,u_mipmap_offset:0},this._luminance=new Float32Array(4)}onExecute(){this.properties.use_previous_frame||this.updateAverage();var t=this._luminance;this.setOutputData(0,this._temp_texture),this.setOutputData(1,t),this.setOutputData(2,(t[0]+t[1]+t[2])/3)}onPreRenderExecute(){this.updateAverage()}updateAverage(){var t=this.getInputData(0);if(t&&!(!this.isOutputConnected(0)&&!this.isOutputConnected(1)&&!this.isOutputConnected(2))){if(!li._shader){li._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,li.pixel_shader);for(var r=new Float32Array(16),s=0;s<r.length;++s)r[s]=Math.random();li._shader.uniforms({u_samples_a:r.subarray(0,16),u_samples_b:r.subarray(16,32)})}var a=this._temp_texture,l=gl$1.UNSIGNED_BYTE;t.type!=l&&(l=gl$1.FLOAT),(!a||a.type!=l)&&(this._temp_texture=new GL$1.Texture(1,1,{type:l,format:gl$1.RGBA,filter:gl$1.NEAREST})),this._uniforms.u_mipmap_offset=0,this.properties.high_quality&&((!this._temp_pot2_texture||this._temp_pot2_texture.type!=l)&&(this._temp_pot2_texture=new GL$1.Texture(512,512,{type:l,format:gl$1.RGBA,minFilter:gl$1.LINEAR_MIPMAP_LINEAR,magFilter:gl$1.LINEAR})),t.copyTo(this._temp_pot2_texture),t=this._temp_pot2_texture,t.bind(0),gl$1.generateMipmap(GL$1.TEXTURE_2D),this._uniforms.u_mipmap_offset=9);var h=li._shader,u=this._uniforms;if(u.u_mipmap_offset=this.properties.mipmap_offset,gl$1.disable(gl$1.DEPTH_TEST),gl$1.disable(gl$1.BLEND),this._temp_texture.drawTo(function(){t.toViewport(h,u)}),this.isOutputConnected(1)||this.isOutputConnected(2)){var c=this._temp_texture.getPixels();if(c){var _=this._luminance;l=this._temp_texture.type,_.set(c),l==gl$1.UNSIGNED_BYTE?vec4.scale(_,_,1/255):l==GL$1.HALF_FLOAT||l==GL$1.HALF_FLOAT_OES}}}}};g(De,"title","Average"),g(De,"desc",`Compute a partial average (32 random samples) of a texture and stores it as a 1x1 pixel texture.
 If high_quality is true, then it generates the mipmaps first and reads from the lower one.`),g(De,"pixel_shader",`
        precision highp float;
        uniform mat4 u_samples_a;
        uniform mat4 u_samples_b;
        uniform sampler2D u_texture;
        uniform float u_mipmap_offset;
        varying vec2 v_coord;
    
        void main() {
            vec4 color = vec4(0.0);
            
            // Random average
            for (int i = 0; i < 4; ++i) {
                for (int j = 0; j < 4; ++j) {
                    color += texture2D(u_texture, vec2(u_samples_a[i][j], u_samples_b[i][j]), u_mipmap_offset);
                    color += texture2D(u_texture, vec2(1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j]), u_mipmap_offset);
                }
            }
            
            gl_FragColor = color * 0.03125;
        }
    `);let LGraphTextureAverage=De;LiteGraph.registerNodeType("texture/average",LGraphTextureAverage);const Ve=class gi{constructor(){this.addInput("in","Texture"),this.addInput("factor","Number"),this.addOutput("out","Texture"),this.properties={factor:.5},this._uniforms={u_texture:0,u_textureB:1,u_factor:this.properties.factor}}onExecute(){var t=this.getInputData(0);if(!(!t||!this.isOutputConnected(0))){gi._shader||(gi._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,gi.pixel_shader));var r=this._temp_texture;if(!r||r.type!=t.type||r.width!=t.width||r.height!=t.height){var s={type:t.type,format:gl$1.RGBA,filter:gl$1.NEAREST};this._temp_texture=new GL$1.Texture(t.width,t.height,s),this._temp_texture2=new GL$1.Texture(t.width,t.height,s),t.copyTo(this._temp_texture2)}var a=this._temp_texture,l=this._temp_texture2,h=gi._shader,u=this._uniforms;u.u_factor=1-this.getInputOrProperty("factor"),gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST),a.drawTo(function(){l.bind(1),t.toViewport(h,u)}),this.setOutputData(0,a),this._temp_texture=l,this._temp_texture2=a}}};g(Ve,"title","Smooth"),g(Ve,"desc","Smooth texture over time"),g(Ve,"pixel_shader",`precision highp float;
    precision highp float;
    uniform sampler2D u_texture;
    uniform sampler2D u_textureB;
    uniform float u_factor;
    varying vec2 v_coord;
    
    void main() {
        gl_FragColor = mix( texture2D( u_texture, v_coord ), texture2D( u_textureB, v_coord ), u_factor );
    }
    `);let LGraphTextureTemporalSmooth=Ve;LiteGraph.registerNodeType("texture/temporal_smooth",LGraphTextureTemporalSmooth);const de=class Zt{constructor(){this.addInput("in","Texture"),this.addOutput("avg","Texture"),this.addOutput("array","Texture"),this.properties={samples:64,frames_interval:1},this._uniforms={u_texture:0,u_textureB:1,u_samples:this.properties.samples,u_isamples:1/this.properties.samples},this.frame=0}getPreviewTexture(){return this._temp_texture2}onExecute(){var t=this.getInputData(0);if(!(!t||!this.isOutputConnected(0))){Zt._shader||(Zt._shader_copy=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,Zt.pixel_shader_copy),Zt._shader_avg=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,Zt.pixel_shader_avg));var r=clamp(this.properties.samples,0,64),s=this.frame,a=this.properties.frames_interval;if(a==0||s%a==0){var l=this._temp_texture;if(!l||l.type!=t.type||l.width!=r){var h={type:t.type,format:gl$1.RGBA,filter:gl$1.NEAREST};this._temp_texture=new GL$1.Texture(r,1,h),this._temp_texture2=new GL$1.Texture(r,1,h),this._temp_texture_out=new GL$1.Texture(1,1,h)}var u=this._temp_texture,c=this._temp_texture2,_=Zt._shader_copy,d=Zt._shader_avg,f=this._uniforms;f.u_samples=r,f.u_isamples=1/r,gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST),u.drawTo(function(){c.bind(1),t.toViewport(_,f)}),this._temp_texture_out.drawTo(function(){u.toViewport(d,f)}),this.setOutputData(0,this._temp_texture_out),this._temp_texture=c,this._temp_texture2=u}else this.setOutputData(0,this._temp_texture_out);this.setOutputData(1,this._temp_texture2),this.frame++}}};g(de,"title","Lineal Avg Smooth"),g(de,"desc","Smooth texture linearly over time"),g(de,"@samples",{type:"number",min:1,max:64,step:1,precision:1}),g(de,"pixel_shader_copy",`precision highp float;
    precision highp float;
    uniform sampler2D u_texture;
    uniform sampler2D u_textureB;
    uniform float u_isamples;
    varying vec2 v_coord;
    
    void main() {
        if( v_coord.x <= u_isamples )
            gl_FragColor = texture2D( u_texture, vec2(0.5) );
        else
            gl_FragColor = texture2D( u_textureB, v_coord - vec2(u_isamples,0.0) );
    }
    `),g(de,"pixel_shader_avg",`precision highp float;
    precision highp float;
    uniform sampler2D u_texture;
    uniform int u_samples;
    uniform float u_isamples;
    varying vec2 v_coord;
    
    void main() {
        vec4 color = vec4(0.0);
        for(int i = 0; i < 64; ++i)
        {
            color += texture2D( u_texture, vec2( float(i)*u_isamples,0.0) );
            if(i == (u_samples - 1))
                break;
        }
        gl_FragColor = color * u_isamples;
    }
    `);let LGraphTextureLinearAvgSmooth=de;LiteGraph.registerNodeType("texture/linear_avg_smooth",LGraphTextureLinearAvgSmooth);class LGraphImageToTexture{constructor(){this.addInput("Image","image"),this.addOutput("","Texture"),this.properties={}}onExecute(){var t,r=this.getInputData(0);if(r){var s=r.videoWidth||r.width,a=r.videoHeight||r.height;if(r.gltexture){this.setOutputData(0,r.gltexture);return}var l=this._temp_texture;(!l||l.width!=s||l.height!=a)&&(this._temp_texture=new GL$1.Texture(s,a,{format:gl$1.RGBA,filter:gl$1.LINEAR}));try{this._temp_texture.uploadImage(r)}catch(h){(t=console.error)==null||t.call(console,"image comes from an unsafe location, cannot be uploaded to webgl: "+h);return}this.setOutputData(0,this._temp_texture)}}}g(LGraphImageToTexture,"title","Image to Texture"),g(LGraphImageToTexture,"desc","Uploads an image to the GPU"),LiteGraph.registerNodeType("texture/imageToTexture",LGraphImageToTexture);const Se=class _i{constructor(){this.addInput("Texture","Texture"),this.addInput("LUT","Texture"),this.addInput("Intensity","number"),this.addOutput("","Texture"),this.properties={enabled:!0,intensity:1,precision:LGraphTexture.DEFAULT,texture:null},_i._shader||(_i._shader=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,_i.pixel_shader))}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision===LGraphTexture.PASS_THROUGH||this.properties.enabled===!1){this.setOutputData(0,t);return}if(t){var r=this.getInputData(1);if(r||(r=LGraphTexture.getTexture(this.properties.texture)),!r){this.setOutputData(0,t);return}r.bind(0),gl$1.texParameteri(gl$1.TEXTURE_2D,gl$1.TEXTURE_MIN_FILTER,gl$1.LINEAR),gl$1.texParameteri(gl$1.TEXTURE_2D,gl$1.TEXTURE_WRAP_S,gl$1.CLAMP_TO_EDGE),gl$1.texParameteri(gl$1.TEXTURE_2D,gl$1.TEXTURE_WRAP_T,gl$1.CLAMP_TO_EDGE),gl$1.bindTexture(gl$1.TEXTURE_2D,null);var s=this.properties.intensity;this.isInputConnected(2)&&(this.properties.intensity=s=this.getInputData(2)),this._tex=LGraphTexture.getTargetTexture(t,this._tex,this.properties.precision),this._tex.drawTo(function(){r.bind(1),t.toViewport(_i._shader,{u_texture:0,u_textureB:1,u_amount:s})}),this.setOutputData(0,this._tex)}}}};g(Se,"widgets_info",{texture:{widget:"texture"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(Se,"title","LUT"),g(Se,"desc","Apply LUT to Texture"),g(Se,"pixel_shader",`precision highp float;
    precision highp float;
    varying vec2 v_coord;
    uniform sampler2D u_texture;
    uniform sampler2D u_textureB;
    uniform float u_amount;
    
    void main() {
            lowp vec4 textureColor = clamp( texture2D(u_texture, v_coord), vec4(0.0), vec4(1.0) );
            mediump float blueColor = textureColor.b * 63.0;
            mediump vec2 quad1;
            quad1.y = floor(floor(blueColor) / 8.0);
            quad1.x = floor(blueColor) - (quad1.y * 8.0);
            mediump vec2 quad2;
            quad2.y = floor(ceil(blueColor) / 8.0);
            quad2.x = ceil(blueColor) - (quad2.y * 8.0);
            highp vec2 texPos1;
            texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);
            texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));
            highp vec2 texPos2;
            texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);
            texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));
            lowp vec4 newColor1 = texture2D(u_textureB, texPos1);
            lowp vec4 newColor2 = texture2D(u_textureB, texPos2);
            lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));
            gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);
    }
    `);let LGraphTextureLUT=Se;LiteGraph.registerNodeType("texture/LUT",LGraphTextureLUT);const Ce=class vi{constructor(){this.addInput("Texture","Texture"),this.addInput("Atlas","Texture"),this.addOutput("","Texture"),this.properties={enabled:!0,num_row_symbols:4,symbol_size:16,brightness:1,colorize:!1,filter:!1,invert:!1,precision:LGraphTexture.DEFAULT,generate_mipmaps:!1,texture:null},vi._shader||(vi._shader=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,vi.pixel_shader)),this._uniforms={u_texture:0,u_textureB:1,u_row_simbols:4,u_simbol_size:16,u_res:vec2.create()}}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision===LGraphTexture.PASS_THROUGH||this.properties.enabled===!1){this.setOutputData(0,t);return}if(t){var r=this.getInputData(1);if(r||(r=LGraphTexture.getTexture(this.properties.texture)),!r){this.setOutputData(0,t);return}r.bind(0),gl$1.texParameteri(gl$1.TEXTURE_2D,gl$1.TEXTURE_MAG_FILTER,this.properties.filter?gl$1.LINEAR:gl$1.NEAREST),gl$1.texParameteri(gl$1.TEXTURE_2D,gl$1.TEXTURE_MIN_FILTER,this.properties.filter?gl$1.LINEAR:gl$1.NEAREST),gl$1.texParameteri(gl$1.TEXTURE_2D,gl$1.TEXTURE_WRAP_S,gl$1.CLAMP_TO_EDGE),gl$1.texParameteri(gl$1.TEXTURE_2D,gl$1.TEXTURE_WRAP_T,gl$1.CLAMP_TO_EDGE),gl$1.bindTexture(gl$1.TEXTURE_2D,null);var s=this._uniforms;s.u_row_simbols=Math.floor(this.properties.num_row_symbols),s.u_symbol_size=this.properties.symbol_size,s.u_brightness=this.properties.brightness,s.u_invert=this.properties.invert?1:0,s.u_colorize=this.properties.colorize?1:0,this._tex=LGraphTexture.getTargetTexture(t,this._tex,this.properties.precision),s.u_res[0]=this._tex.width,s.u_res[1]=this._tex.height,this._tex.bind(0),gl$1.texParameteri(gl$1.TEXTURE_2D,gl$1.TEXTURE_MAG_FILTER,gl$1.NEAREST),gl$1.texParameteri(gl$1.TEXTURE_2D,gl$1.TEXTURE_MIN_FILTER,gl$1.NEAREST),this._tex.drawTo(function(){r.bind(1),t.toViewport(vi._shader,s)}),this.properties.generate_mipmaps&&(this._tex.bind(0),gl$1.generateMipmap(this._tex.texture_type),this._tex.unbind(0)),this.setOutputData(0,this._tex)}}}};g(Ce,"widgets_info",{texture:{widget:"texture"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(Ce,"title","Encode"),g(Ce,"desc","Apply a texture atlas to encode a texture"),g(Ce,"pixel_shader",`precision highp float;
    precision highp float;
    varying vec2 v_coord;
    uniform sampler2D u_texture;
    uniform sampler2D u_textureB;
    uniform float u_row_simbols;
    uniform float u_symbol_size;
    uniform float u_brightness;
    uniform float u_invert;
    uniform float u_colorize;
    uniform vec2 u_res;
    
    void main() {
        vec2 total_symbols = u_res / u_symbol_size;
        vec2 uv = floor(v_coord * total_symbols) / total_symbols; //pixelate 
        vec2 local_uv = mod(v_coord * u_res, u_symbol_size) / u_symbol_size;
        lowp vec4 textureColor = texture2D(u_texture, uv );
        float lum = clamp(u_brightness * (textureColor.x + textureColor.y + textureColor.z)/3.0,0.0,1.0);
        if( u_invert == 1.0 ) lum = 1.0 - lum;
        float index = floor( lum * (u_row_simbols * u_row_simbols - 1.0));
        float col = mod( index, u_row_simbols );
        float row = u_row_simbols - floor( index / u_row_simbols ) - 1.0;
        vec2 simbol_uv = ( vec2( col, row ) + local_uv ) / u_row_simbols;
        vec4 color = texture2D( u_textureB, simbol_uv );
        if(u_colorize == 1.0)
            color *= textureColor;
        gl_FragColor = color;
    }
    `);let LGraphTextureEncode=Ce;LiteGraph.registerNodeType("texture/encode",LGraphTextureEncode);const Xe=class fi{constructor(){this.addInput("Texture","Texture"),this.addOutput("R","Texture"),this.addOutput("G","Texture"),this.addOutput("B","Texture"),this.addOutput("A","Texture"),fi._shader||(fi._shader=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,fi.pixel_shader))}onExecute(){var t=this.getInputData(0);if(t){this._channels||(this._channels=Array(4));var r=gl$1.RGB,s=0;for(let u=0;u<4;u++)this.isOutputConnected(u)?((!this._channels[u]||this._channels[u].width!=t.width||this._channels[u].height!=t.height||this._channels[u].type!=t.type||this._channels[u].format!=r)&&(this._channels[u]=new GL$1.Texture(t.width,t.height,{type:t.type,format:r,filter:gl$1.LINEAR})),s++):this._channels[u]=null;if(s){gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST);var a=Mesh.getScreenQuad(),l=fi._shader,h=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];for(let u=0;u<4;u++)this._channels[u]&&(this._channels[u].drawTo(function(){t.bind(0),l.uniforms({u_texture:0,u_mask:h[u]}).draw(a)}),this.setOutputData(u,this._channels[u]))}}}};g(Xe,"title","Texture to Channels"),g(Xe,"desc","Split texture channels"),g(Xe,"pixel_shader",`precision highp float;
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec4 u_mask;
        
        void main() {
            gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );
        }
        `);let LGraphTextureChannels=Xe;LiteGraph.registerNodeType("texture/textureChannels",LGraphTextureChannels);const Ne=class mi{constructor(){this.addInput("R","Texture"),this.addInput("G","Texture"),this.addInput("B","Texture"),this.addInput("A","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:LGraphTexture.DEFAULT,R:1,G:1,B:1,A:1},this._color=vec4.create(),this._uniforms={u_textureR:0,u_textureG:1,u_textureB:2,u_textureA:3,u_color:this._color}}onExecute(){var t=LGraphTexture.getWhiteTexture(),r=this.getInputData(0)||t,s=this.getInputData(1)||t,a=this.getInputData(2)||t,l=this.getInputData(3)||t;gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST);var h=Mesh.getScreenQuad();mi._shader||(mi._shader=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,mi.pixel_shader));var u=mi._shader,c=Math.max(r.width,s.width,a.width,l.width),_=Math.max(r.height,s.height,a.height,l.height),d=this.properties.precision==LGraphTexture.HIGH?LGraphTexture.HIGH_PRECISION_FORMAT:gl$1.UNSIGNED_BYTE;(!this._texture||this._texture.width!=c||this._texture.height!=_||this._texture.type!=d)&&(this._texture=new GL$1.Texture(c,_,{type:d,format:gl$1.RGBA,filter:gl$1.LINEAR}));var f=this._color;f[0]=this.properties.R,f[1]=this.properties.G,f[2]=this.properties.B,f[3]=this.properties.A;var m=this._uniforms;this._texture.drawTo(function(){r.bind(0),s.bind(1),a.bind(2),l.bind(3),u.uniforms(m).draw(h)}),this.setOutputData(0,this._texture)}};g(Ne,"title","Channels to Texture"),g(Ne,"desc","Split texture channels"),g(Ne,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(Ne,"pixel_shader",`precision highp float;
    precision highp float;
    varying vec2 v_coord;
    uniform sampler2D u_textureR;
    uniform sampler2D u_textureG;
    uniform sampler2D u_textureB;
    uniform sampler2D u_textureA;
    uniform vec4 u_color;
    
    void main() {
        gl_FragColor = u_color * vec4(                 texture2D(u_textureR, v_coord).r,                texture2D(u_textureG, v_coord).r,                texture2D(u_textureB, v_coord).r,                texture2D(u_textureA, v_coord).r);
    }
    `);let LGraphChannelsTexture=Ne;LiteGraph.registerNodeType("texture/channelsTexture",LGraphChannelsTexture);class LGraphTextureColor{constructor(){this.addOutput("Texture","Texture"),this._tex_color=vec4.create(),this.properties={color:vec4.create(),precision:LGraphTexture.DEFAULT}}onDrawBackground(t){var r=this.properties.color;t.fillStyle="rgb("+Math.floor(clamp(r[0],0,1)*255)+","+Math.floor(clamp(r[1],0,1)*255)+","+Math.floor(clamp(r[2],0,1)*255)+")",this.flags.collapsed?this.boxcolor=t.fillStyle:t.fillRect(0,0,this.size[0],this.size[1])}onExecute(){var t=this.properties.precision==LGraphTexture.HIGH?LGraphTexture.HIGH_PRECISION_FORMAT:gl$1.UNSIGNED_BYTE;(!this._tex||this._tex.type!=t)&&(this._tex=new GL$1.Texture(1,1,{format:gl$1.RGBA,type:t,minFilter:gl$1.NEAREST}));var r=this.properties.color;if(this.inputs)for(var s=0;s<this.inputs.length;s++){var a=this.inputs[s],l=this.getInputData(s);if(l!==void 0)switch(a.name){case"RGB":case"RGBA":r.set(l);break;case"R":r[0]=l;break;case"G":r[1]=l;break;case"B":r[2]=l;break;case"A":r[3]=l;break}}vec4.sqrDist(this._tex_color,r)>.001&&(this._tex_color.set(r),this._tex.fill(r)),this.setOutputData(0,this._tex)}onGetInputs(){return[["RGB","vec3"],["RGBA","vec4"],["R","number"],["G","number"],["B","number"],["A","number"]]}}g(LGraphTextureColor,"title","Color"),g(LGraphTextureColor,"desc","Generates a 1x1 texture with a constant color"),g(LGraphTextureColor,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),LiteGraph.registerNodeType("texture/color",LGraphTextureColor);const ye=class xi{constructor(){this.addInput("A","color"),this.addInput("B","color"),this.addOutput("Texture","Texture"),this.properties={angle:0,scale:1,A:[0,0,0],B:[1,1,1],texture_size:32},xi._shader||(xi._shader=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,xi.pixel_shader)),this._uniforms={u_angle:0,u_colorA:vec3.create(),u_colorB:vec3.create()}}onExecute(){gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST);var t=GL$1.Mesh.getScreenQuad(),r=xi._shader,s=this.getInputData(0);s||(s=this.properties.A);var a=this.getInputData(1);a||(a=this.properties.B);for(var l=2;l<this.inputs.length;l++){var h=this.inputs[l],u=this.getInputData(l);u!==void 0&&(this.properties[h.name]=u)}var c=this._uniforms;this._uniforms.u_angle=this.properties.angle*DEG2RAD,this._uniforms.u_scale=this.properties.scale,vec3.copy(c.u_colorA,s),vec3.copy(c.u_colorB,a);var _=parseInt(this.properties.texture_size);(!this._tex||this._tex.width!=_)&&(this._tex=new GL$1.Texture(_,_,{format:gl$1.RGB,filter:gl$1.LINEAR})),this._tex.drawTo(function(){r.uniforms(c).draw(t)}),this.setOutputData(0,this._tex)}onGetInputs(){return[["angle","number"],["scale","number"]]}};g(ye,"title","Gradient"),g(ye,"desc","Generates a gradient"),g(ye,"@A",{type:"color"}),g(ye,"@B",{type:"color"}),g(ye,"@texture_size",{type:"enum",values:[32,64,128,256,512]}),g(ye,"pixel_shader",`precision highp float;
        precision highp float;
        varying vec2 v_coord;
        uniform float u_angle;
        uniform float u_scale;
        uniform vec3 u_colorA;
        uniform vec3 u_colorB;
        
        vec2 rotate(vec2 v, float angle)
        {
            vec2 result;
            float _cos = cos(angle);
            float _sin = sin(angle);
            result.x = v.x * _cos - v.y * _sin;
            result.y = v.x * _sin + v.y * _cos;
            return result;
        }
        void main() {
            float f = (rotate(u_scale * (v_coord - vec2(0.5)), u_angle) + vec2(0.5)).x;
            vec3 color = mix(u_colorA,u_colorB,clamp(f,0.0,1.0));
            gl_FragColor = vec4(color,1.0);
        }
        `);let LGraphTextureGradient=ye;LiteGraph.registerNodeType("texture/gradient",LGraphTextureGradient);const be=class oi{constructor(){this.addInput("A","Texture"),this.addInput("B","Texture"),this.addInput("Mixer","Texture"),this.addOutput("Texture","Texture"),this.properties={factor:.5,size_from_biggest:!0,invert:!1,precision:LGraphTexture.DEFAULT},this._uniforms={u_textureA:0,u_textureB:1,u_textureMix:2,u_mix:vec4.create()}}onExecute(){var t=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===LGraphTexture.PASS_THROUGH){this.setOutputData(0,t);return}var r=this.getInputData(1);if(!(!t||!r)){var s=this.getInputData(2),a=this.getInputData(3);this._tex=LGraphTexture.getTargetTexture(this.properties.size_from_biggest&&r.width>t.width?r:t,this._tex,this.properties.precision),gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST);var l=Mesh.getScreenQuad(),h=null,u=this._uniforms;if(s)h=oi._shader_tex,h||(h=oi._shader_tex=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,oi.pixel_shader,{MIX_TEX:""}));else{h=oi._shader_factor,h||(h=oi._shader_factor=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,oi.pixel_shader));var c=a==null?this.properties.factor:a;u.u_mix.set([c,c,c,c])}var _=this.properties.invert;this._tex.drawTo(function(){t.bind(_?1:0),r.bind(_?0:1),s&&s.bind(2),h.uniforms(u).draw(l)}),this.setOutputData(0,this._tex)}}}onGetInputs(){return[["factor","number"]]}};g(be,"title","Mix"),g(be,"desc","Generates a texture mixing two textures"),g(be,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(be,"pixel_shader",`precision highp float;
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_textureA;
        uniform sampler2D u_textureB;
        #ifdef MIX_TEX
            uniform sampler2D u_textureMix;
        #else
            uniform vec4 u_mix;
        #endif
        
        void main() {
            #ifdef MIX_TEX
                vec4 f = texture2D(u_textureMix, v_coord);
            #else
                vec4 f = u_mix;
            #endif
            gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), f );
        }
        `);let LGraphTextureMix=be;LiteGraph.registerNodeType("texture/mix",LGraphTextureMix);const Re=class yi{constructor(){this.addInput("Tex.","Texture"),this.addOutput("Edges","Texture"),this.properties={invert:!0,threshold:!1,factor:1,precision:LGraphTexture.DEFAULT},yi._shader||(yi._shader=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,yi.pixel_shader))}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision===LGraphTexture.PASS_THROUGH){this.setOutputData(0,t);return}if(t){this._tex=LGraphTexture.getTargetTexture(t,this._tex,this.properties.precision),gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST);var r=Mesh.getScreenQuad(),s=yi._shader,a=this.properties.invert,l=this.properties.factor,h=this.properties.threshold?1:0;this._tex.drawTo(function(){t.bind(0),s.uniforms({u_texture:0,u_isize:[1/t.width,1/t.height],u_factor:l,u_threshold:h,u_invert:a?1:0}).draw(r)}),this.setOutputData(0,this._tex)}}}};g(Re,"title","Edges"),g(Re,"desc","Detects edges"),g(Re,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(Re,"pixel_shader",`precision highp float;
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_isize;
        uniform int u_invert;
        uniform float u_factor;
        uniform float u_threshold;
        
        void main() {
            vec4 center = texture2D(u_texture, v_coord);
            vec4 up = texture2D(u_texture, v_coord + u_isize * vec2(0.0,1.0) );
            vec4 down = texture2D(u_texture, v_coord + u_isize * vec2(0.0,-1.0) );
            vec4 left = texture2D(u_texture, v_coord + u_isize * vec2(1.0,0.0) );
            vec4 right = texture2D(u_texture, v_coord + u_isize * vec2(-1.0,0.0) );
            vec4 diff = abs(center - up) + abs(center - down) + abs(center - left) + abs(center - right);
            diff *= u_factor;
            if(u_invert == 1)
                diff.xyz = vec3(1.0) - diff.xyz;
            if( u_threshold == 0.0 )
                gl_FragColor = vec4( diff.xyz, center.a );
            else
                gl_FragColor = vec4( diff.x > 0.5 ? 1.0 : 0.0, diff.y > 0.5 ? 1.0 : 0.0, diff.z > 0.5 ? 1.0 : 0.0, center.a );
        }
        `);let LGraphTextureEdges=Re;LiteGraph.registerNodeType("texture/edges",LGraphTextureEdges);const Te=class ei{constructor(){this.addInput("Texture","Texture"),this.addInput("Distance","number"),this.addInput("Range","number"),this.addOutput("Texture","Texture"),this.properties={distance:100,range:50,only_depth:!1,high_precision:!1},this._uniforms={u_texture:0,u_distance:100,u_range:50,u_camera_planes:null}}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(t){var r=gl$1.UNSIGNED_BYTE;this.properties.high_precision&&(r=gl$1.half_float_ext?gl$1.HALF_FLOAT_OES:gl$1.FLOAT),(!this._temp_texture||this._temp_texture.type!=r||this._temp_texture.width!=t.width||this._temp_texture.height!=t.height)&&(this._temp_texture=new GL$1.Texture(t.width,t.height,{type:r,format:gl$1.RGBA,filter:gl$1.LINEAR}));var s=this._uniforms,a=this.properties.distance;this.isInputConnected(1)&&(a=this.getInputData(1),this.properties.distance=a);var l=this.properties.range;this.isInputConnected(2)&&(l=this.getInputData(2),this.properties.range=l),s.u_distance=a,s.u_range=l,gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST);var h=Mesh.getScreenQuad();ei._shader||(ei._shader=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,ei.pixel_shader),ei._shader_onlydepth=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,ei.pixel_shader,{ONLY_DEPTH:""}));var u=this.properties.only_depth?ei._shader_onlydepth:ei._shader,c=null;t.near_far_planes?c=t.near_far_planes:window.LS&&LS.Renderer._main_camera?c=LS.Renderer._main_camera._uniforms.u_camera_planes:c=[.1,1e3],s.u_camera_planes=c,this._temp_texture.drawTo(function(){t.bind(0),u.uniforms(s).draw(h)}),this._temp_texture.near_far_planes=c,this.setOutputData(0,this._temp_texture)}}}};g(Te,"title","Depth Range"),g(Te,"desc","Generates a texture with a depth range"),g(Te,"pixel_shader",`precision highp float;
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_camera_planes;
        uniform float u_distance;
        uniform float u_range;
        
        float LinearDepth()
        {
            float zNear = u_camera_planes.x;
            float zFar = u_camera_planes.y;
            float depth = texture2D(u_texture, v_coord).x;
            depth = depth * 2.0 - 1.0;
            return zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));
        }
        
        void main() {
            float depth = LinearDepth();
            #ifdef ONLY_DEPTH
                gl_FragColor = vec4(depth);
            #else
                float diff = abs(depth * u_camera_planes.y - u_distance);
                float dof = 1.0;
                if(diff <= u_range)
                    dof = diff / u_range;
                gl_FragColor = vec4(dof);
            #endif
        }
    `);let LGraphTextureDepthRange=Te;LiteGraph.registerNodeType("texture/depth_range",LGraphTextureDepthRange);const Me=class bi{constructor(){this.addInput("Texture","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:LGraphTexture.DEFAULT,invert:!1},this._uniforms={u_texture:0,u_camera_planes:null,u_ires:vec2.create()}}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(!(!t||t.format!=gl$1.DEPTH_COMPONENT&&t.format!=gl$1.DEPTH_STENCIL)){var r=this.properties.precision==LGraphTexture.HIGH?gl$1.HIGH_PRECISION_FORMAT:gl$1.UNSIGNED_BYTE;(!this._temp_texture||this._temp_texture.type!=r||this._temp_texture.width!=t.width||this._temp_texture.height!=t.height)&&(this._temp_texture=new GL$1.Texture(t.width,t.height,{type:r,format:gl$1.RGB,filter:gl$1.LINEAR}));var s=this._uniforms;s.u_invert=this.properties.invert?1:0,gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST);var a=Mesh.getScreenQuad();bi._shader||(bi._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,bi.pixel_shader));var l=bi._shader,h=null;t.near_far_planes?h=t.near_far_planes:window.LS&&LS.Renderer._main_camera?h=LS.Renderer._main_camera._uniforms.u_camera_planes:h=[.1,1e3],s.u_camera_planes=h,s.u_ires.set([0,0]),this._temp_texture.drawTo(function(){t.bind(0),l.uniforms(s).draw(a)}),this._temp_texture.near_far_planes=h,this.setOutputData(0,this._temp_texture)}}}};g(Me,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(Me,"title","Linear Depth"),g(Me,"desc","Creates a color texture with linear depth"),g(Me,"pixel_shader",`precision highp float;
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_camera_planes;
        uniform int u_invert;
        uniform vec2 u_ires;
        
        void main() {
            float zNear = u_camera_planes.x;
            float zFar = u_camera_planes.y;
            float depth = texture2D(u_texture, v_coord + u_ires*0.5).x * 2.0 - 1.0;
            float f = zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));
            if( u_invert == 1 )
                f = 1.0 - f;
            gl_FragColor = vec4(vec3(f),1.0);
        }
        `);let LGraphTextureLinearDepth=Me;LiteGraph.registerNodeType("texture/linear_depth",LGraphTextureLinearDepth);const ct=class ar{constructor(){this.addInput("Texture","Texture"),this.addInput("Iterations","number"),this.addInput("Intensity","number"),this.addOutput("Blurred","Texture"),this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1],precision:LGraphTexture.DEFAULT}}onExecute(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var r=this._final_texture;(!r||r.width!=t.width||r.height!=t.height||r.type!=t.type)&&(r=this._final_texture=new GL$1.Texture(t.width,t.height,{type:t.type,format:gl$1.RGBA,filter:gl$1.LINEAR}));var s=this.properties.iterations;if(this.isInputConnected(1)&&(s=this.getInputData(1),this.properties.iterations=s),s=Math.min(Math.floor(s),ar.max_iterations),s==0){this.setOutputData(0,t);return}var a=this.properties.intensity;this.isInputConnected(2)&&(a=this.getInputData(2),this.properties.intensity=a);var l=LiteGraph.camera_aspect;!l&&window.gl!==void 0&&(l=gl$1.canvas.height/gl$1.canvas.width),l||(l=1),l=this.properties.preserve_aspect?l:1;var h=this.properties.scale||[1,1];t.applyBlur(l*h[0],h[1],a,r);for(var u=1;u<s;++u)r.applyBlur(l*h[0]*(u+1),h[1]*(u+1),a);this.setOutputData(0,r)}}};g(ct,"title","Blur"),g(ct,"desc","Blur a texture"),g(ct,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(ct,"max_iterations",20);let LGraphTextureBlur=ct;LiteGraph.registerNodeType("texture/blur",LGraphTextureBlur);const oe=class jt{constructor(){this.intensity=.5,this.persistence=.6,this.iterations=8,this.threshold=.8,this.scale=1,this.dirt_texture=null,this.dirt_factor=.5,this._textures=[],this._uniforms={u_intensity:1,u_texture:0,u_glow_texture:1,u_threshold:0,u_texel_size:vec2.create()}}applyFX(t,r,s,a){var l=t.width,h=t.height,u={format:t.format,type:t.type,minFilter:GL$1.LINEAR,magFilter:GL$1.LINEAR,wrap:gl$1.CLAMP_TO_EDGE},c=this._uniforms,_=this._textures,d=jt._cut_shader;d||(d=jt._cut_shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,jt.cut_pixel_shader)),gl$1.disable(gl$1.DEPTH_TEST),gl$1.disable(gl$1.BLEND),c.u_threshold=this.threshold;var f=_[0]=GL$1.Texture.getTemporary(l,h,u);t.blit(f,d.uniforms(c));var m=f,b=this.iterations;b=clamp(b,1,16)|0;var T=c.u_texel_size,L=this.intensity;c.u_intensity=1,c.u_delta=this.scale,d=jt._shader,d||(d=jt._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,jt.scale_pixel_shader));for(var G=1;G<b&&(l=l>>1,(h|0)>1&&(h=h>>1),!(l<2));G++)f=_[G]=GL$1.Texture.getTemporary(l,h,u),T[0]=1/m.width,T[1]=1/m.height,m.blit(f,d.uniforms(c)),m=f;for(a&&(T[0]=1/m.width,T[1]=1/m.height,c.u_intensity=L,c.u_delta=1,m.blit(a,d.uniforms(c))),gl$1.enable(gl$1.BLEND),gl$1.blendFunc(gl$1.ONE,gl$1.ONE),c.u_intensity=this.persistence,c.u_delta=.5,G-=2;G>=0;G--)f=_[G],_[G]=null,T[0]=1/m.width,T[1]=1/m.height,m.blit(f,d.uniforms(c)),GL$1.Texture.releaseTemporary(m),m=f;if(gl$1.disable(gl$1.BLEND),s&&m.blit(s),r){var I=r,O=this.dirt_texture,E=this.dirt_factor;c.u_intensity=L,d=O?jt._dirt_final_shader:jt._final_shader,d||(O?d=jt._dirt_final_shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,jt.final_pixel_shader,{USE_DIRT:""}):d=jt._final_shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,jt.final_pixel_shader)),I.drawTo(function(){t.bind(0),m.bind(1),O&&(d.setUniform("u_dirt_factor",E),d.setUniform("u_dirt_texture",O.bind(2))),d.toViewport(c)})}GL$1.Texture.releaseTemporary(m)}};g(oe,"cut_pixel_shader",`precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform float u_threshold;
        void main() {
            gl_FragColor = max( texture2D( u_texture, v_coord ) - vec4( u_threshold ), vec4(0.0) );
        }`),g(oe,"scale_pixel_shader",`precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_texel_size;
        uniform float u_delta;
        uniform float u_intensity;
        
        vec4 sampleBox(vec2 uv) {
            vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;
            vec4 s = texture2D( u_texture, uv + o.xy ) + texture2D( u_texture, uv + o.zy) + texture2D( u_texture, uv + o.xw) + texture2D( u_texture, uv + o.zw);
            return s * 0.25;
        }
        void main() {
            gl_FragColor = u_intensity * sampleBox( v_coord );
        }`),g(oe,"final_pixel_shader",`precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform sampler2D u_glow_texture;
        #ifdef USE_DIRT
            uniform sampler2D u_dirt_texture;
        #endif
        uniform vec2 u_texel_size;
        uniform float u_delta;
        uniform float u_intensity;
        uniform float u_dirt_factor;
        
        vec4 sampleBox(vec2 uv) {
            vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;
            vec4 s = texture2D( u_glow_texture, uv + o.xy ) + texture2D( u_glow_texture, uv + o.zy) + texture2D( u_glow_texture, uv + o.xw) + texture2D( u_glow_texture, uv + o.zw);
            return s * 0.25;
        }
        void main() {
            vec4 glow = sampleBox( v_coord );
            #ifdef USE_DIRT
                glow = mix( glow, glow * texture2D( u_dirt_texture, v_coord ), u_dirt_factor );
            #endif
            gl_FragColor = texture2D( u_texture, v_coord ) + u_intensity * glow;
        }`);let FXGlow=oe;class LGraphTextureGlow{constructor(){this.addInput("in","Texture"),this.addInput("dirt","Texture"),this.addOutput("out","Texture"),this.addOutput("glow","Texture"),this.properties={enabled:!0,intensity:1,persistence:.99,iterations:16,threshold:0,scale:1,dirt_factor:.5,precision:LGraphTexture.DEFAULT},this.fx=new FXGlow}onGetInputs(){return[["enabled","boolean"],["threshold","number"],["intensity","number"],["persistence","number"],["iterations","number"],["dirt_factor","number"]]}onGetOutputs(){return[["average","Texture"]]}onExecute(){var t=this.getInputData(0);if(t&&this.isAnyOutputConnected()){if(this.properties.precision===LGraphTexture.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,t);return}var r=this.fx;r.threshold=this.getInputOrProperty("threshold"),r.iterations=this.getInputOrProperty("iterations"),r.intensity=this.getInputOrProperty("intensity"),r.persistence=this.getInputOrProperty("persistence"),r.dirt_texture=this.getInputData(1),r.dirt_factor=this.getInputOrProperty("dirt_factor"),r.scale=this.properties.scale;var s=LGraphTexture.getTextureType(this.properties.precision,t),a=null;this.isOutputConnected(2)&&(a=this._average_texture,(!a||a.type!=t.type||a.format!=t.format)&&(a=this._average_texture=new GL$1.Texture(1,1,{type:t.type,format:t.format,filter:gl$1.LINEAR})));var l=null;this.isOutputConnected(1)&&(l=this._glow_texture,(!l||l.width!=t.width||l.height!=t.height||l.type!=s||l.format!=t.format)&&(l=this._glow_texture=new GL$1.Texture(t.width,t.height,{type:s,format:t.format,filter:gl$1.LINEAR})));var h=null;this.isOutputConnected(0)&&(h=this._final_texture,(!h||h.width!=t.width||h.height!=t.height||h.type!=s||h.format!=t.format)&&(h=this._final_texture=new GL$1.Texture(t.width,t.height,{type:s,format:t.format,filter:gl$1.LINEAR}))),r.applyFX(t,h,l,a),this.isOutputConnected(0)&&this.setOutputData(0,h),this.isOutputConnected(1)&&this.setOutputData(1,a),this.isOutputConnected(2)&&this.setOutputData(2,l)}}}g(LGraphTextureGlow,"title","Glow"),g(LGraphTextureGlow,"desc","Filters a texture giving it a glow effect"),g(LGraphTextureGlow,"widgets_info",{iterations:{type:"number",min:0,max:16,step:1,precision:0},threshold:{type:"number",min:0,max:10,step:.01,precision:2},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),LiteGraph.registerNodeType("texture/glow",LGraphTextureGlow);const Le=class hi{constructor(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={intensity:1,radius:5}}onExecute(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var r=this._temp_texture;(!r||r.width!=t.width||r.height!=t.height||r.type!=t.type)&&(this._temp_texture=new GL$1.Texture(t.width,t.height,{type:t.type,format:gl$1.RGBA,filter:gl$1.LINEAR}));var s=this.properties.radius;if(s=Math.min(Math.floor(s),hi.max_radius),s==0){this.setOutputData(0,t);return}var a=this.properties.intensity,l=LiteGraph.camera_aspect;!l&&window.gl!==void 0&&(l=gl$1.canvas.height/gl$1.canvas.width),l||(l=1),l=this.properties.preserve_aspect?l:1,hi._shaders[s]||(hi._shaders[s]=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,hi.pixel_shader,{RADIUS:s.toFixed(0)}));var h=hi._shaders[s],u=GL$1.Mesh.getScreenQuad();t.bind(0),this._temp_texture.drawTo(function(){h.uniforms({u_texture:0,u_intensity:a,u_resolution:[t.width,t.height],u_iResolution:[1/t.width,1/t.height]}).draw(u)}),this.setOutputData(0,this._temp_texture)}}};g(Le,"title","Kuwahara Filter"),g(Le,"desc","Filters a texture giving an artistic oil canvas painting"),g(Le,"max_radius",10),g(Le,"_shaders",[]),g(Le,"pixel_shader",`
    precision highp float;
    varying vec2 v_coord;
    uniform sampler2D u_texture;
    uniform float u_intensity;
    uniform vec2 u_resolution;
    uniform vec2 u_iResolution;
    #ifndef RADIUS
    #define RADIUS 7
    #endif
    void main() {
    
    const int radius = RADIUS;
    vec2 fragCoord = v_coord;
    vec2 src_size = u_iResolution;
    vec2 uv = v_coord;
    float n = float((radius + 1) * (radius + 1));
    int i;
    int j;
    vec3 m0 = vec3(0.0); vec3 m1 = vec3(0.0); vec3 m2 = vec3(0.0); vec3 m3 = vec3(0.0);
    vec3 s0 = vec3(0.0); vec3 s1 = vec3(0.0); vec3 s2 = vec3(0.0); vec3 s3 = vec3(0.0);
    vec3 c;
    
    for (int j = -radius; j <= 0; ++j)  {
        for (int i = -radius; i <= 0; ++i)  {
            c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
            m0 += c;
            s0 += c * c;
        }
    }
    
    for (int j = -radius; j <= 0; ++j)  {
        for (int i = 0; i <= radius; ++i)  {
            c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
            m1 += c;
            s1 += c * c;
        }
    }
    
    for (int j = 0; j <= radius; ++j)  {
        for (int i = 0; i <= radius; ++i)  {
            c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
            m2 += c;
            s2 += c * c;
        }
    }
    
    for (int j = 0; j <= radius; ++j)  {
        for (int i = -radius; i <= 0; ++i)  {
            c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
            m3 += c;
            s3 += c * c;
        }
    }
    
    float min_sigma2 = 1e+2;
    m0 /= n;
    s0 = abs(s0 / n - m0 * m0);
    
    float sigma2 = s0.r + s0.g + s0.b;
    if (sigma2 < min_sigma2) {
        min_sigma2 = sigma2;
        gl_FragColor = vec4(m0, 1.0);
    }
    
    m1 /= n;
    s1 = abs(s1 / n - m1 * m1);
    
    sigma2 = s1.r + s1.g + s1.b;
    if (sigma2 < min_sigma2) {
        min_sigma2 = sigma2;
        gl_FragColor = vec4(m1, 1.0);
    }
    
    m2 /= n;
    s2 = abs(s2 / n - m2 * m2);
    
    sigma2 = s2.r + s2.g + s2.b;
    if (sigma2 < min_sigma2) {
        min_sigma2 = sigma2;
        gl_FragColor = vec4(m2, 1.0);
    }
    
    m3 /= n;
    s3 = abs(s3 / n - m3 * m3);
    
    sigma2 = s3.r + s3.g + s3.b;
    if (sigma2 < min_sigma2) {
        min_sigma2 = sigma2;
        gl_FragColor = vec4(m3, 1.0);
    }
    }
    `);let LGraphTextureKuwaharaFilter=Le;LiteGraph.registerNodeType("texture/kuwahara",LGraphTextureKuwaharaFilter);const Ae=class Ti{constructor(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={sigma:1.4,k:1.6,p:21.7,epsilon:79,phi:.017}}onExecute(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var r=this._temp_texture;(!r||r.width!=t.width||r.height!=t.height||r.type!=t.type)&&(this._temp_texture=new GL$1.Texture(t.width,t.height,{type:t.type,format:gl$1.RGBA,filter:gl$1.LINEAR})),Ti._xdog_shader||(Ti._xdog_shader=new GL$1.Shader(Shader.SCREEN_VERTEX_SHADER,Ti.xdog_pixel_shader));var s=Ti._xdog_shader,a=GL$1.Mesh.getScreenQuad(),l=this.properties.sigma,h=this.properties.k,u=this.properties.p,c=this.properties.epsilon,_=this.properties.phi;t.bind(0),this._temp_texture.drawTo(function(){s.uniforms({src:0,sigma:l,k:h,p:u,epsilon:c,phi:_,cvsWidth:t.width,cvsHeight:t.height}).draw(a)}),this.setOutputData(0,this._temp_texture)}}};g(Ae,"title","XDoG Filter"),g(Ae,"desc","Filters a texture giving an artistic ink style"),g(Ae,"max_radius",10),g(Ae,"_shaders",[]),g(Ae,"xdog_pixel_shader",`
    precision highp float;
    uniform sampler2D src;

    uniform float cvsHeight;
    uniform float cvsWidth;

    uniform float sigma;
    uniform float k;
    uniform float p;
    uniform float epsilon;
    uniform float phi;
    varying vec2 v_coord;

    float cosh(float val)
    {
    float tmp = exp(val);
    float cosH = (tmp + 1.0 / tmp) / 2.0;
    return cosH;
    }

    float tanh(float val)
    {
    float tmp = exp(val);
    float tanH = (tmp - 1.0 / tmp) / (tmp + 1.0 / tmp);
    return tanH;
    }

    float sinh(float val)
    {
    float tmp = exp(val);
    float sinH = (tmp - 1.0 / tmp) / 2.0;
    return sinH;
    }

    void main(void){
    vec3 destColor = vec3(0.0);
    float tFrag = 1.0 / cvsHeight;
    float sFrag = 1.0 / cvsWidth;
    vec2 Frag = vec2(sFrag,tFrag);
    vec2 uv = gl_FragCoord.st;
    float twoSigmaESquared = 2.0 * sigma * sigma;
    float twoSigmaRSquared = twoSigmaESquared * k * k;
    int halfWidth = int(ceil( 1.0 * sigma * k ));

    const int MAX_NUM_ITERATION = 99999;
    vec2 sum = vec2(0.0);
    vec2 norm = vec2(0.0);

    for(int cnt=0;cnt<MAX_NUM_ITERATION;cnt++){
        if(cnt > (2*halfWidth+1)*(2*halfWidth+1)){break;}
        int i = int(cnt / (2*halfWidth+1)) - halfWidth;
        int j = cnt - halfWidth - int(cnt / (2*halfWidth+1)) * (2*halfWidth+1);

        float d = length(vec2(i,j));
        vec2 kernel = vec2( exp( -d * d / twoSigmaESquared ), 
                            exp( -d * d / twoSigmaRSquared ));

        vec2 L = texture2D(src, (uv + vec2(i,j)) * Frag).xx;

        norm += kernel;
        sum += kernel * L;
    }

    sum /= norm;

    float H = 100.0 * ((1.0 + p) * sum.x - p * sum.y);
    float edge = ( H > epsilon )? 1.0 : 1.0 + tanh( phi * (H - epsilon));
    destColor = vec3(edge);
    gl_FragColor = vec4(destColor, 1.0);
    }`);let LGraphTextureXDoGFilter=Ae;LiteGraph.registerNodeType("texture/xDoG",LGraphTextureXDoGFilter);const Ze=class Mi{constructor(){this.addOutput("Webcam","Texture"),this.properties={texture_name:"",facingMode:"user"},this.boxcolor="black",this.version=0}openStream(){if(!navigator.getUserMedia)return;this._waiting_confirmation=!0;var t={audio:!1,video:{facingMode:this.properties.facingMode}};navigator.mediaDevices.getUserMedia(t).then(this.streamReady.bind(this)).catch(s);var r=this;function s(a){var l;Mi.is_webcam_open=!1,(l=console.log)==null||l.call(console,"Webcam rejected",a),r._webcam_stream=!1,r.boxcolor="red",r.trigger("stream_error")}}closeStream(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var r=0;r<t.length;++r)t[r].stop();Mi.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}}streamReady(t){this._webcam_stream=t,this.boxcolor="green";var r=this._video;r||(r=document.createElement("video"),r.autoplay=!0,r.srcObject=t,this._video=r,r.onloadedmetadata=function(s){var a;Mi.is_webcam_open=!0,(a=console.log)==null||a.call(console,s)}),this.trigger("stream_ready",r)}onPropertyChanged(t,r){t=="facingMode"&&(this.properties.facingMode=r,this.closeStream(),this.openStream())}onRemoved(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var r=0;r<t.length;++r)t[r].stop();this._webcam_stream=null,this._video=null}}onDrawBackground(t){this.flags.collapsed||this.size[1]<=20||this._video&&(t.save(),t.webgl?this._video_texture&&t.drawImage(this._video_texture,0,0,this.size[0],this.size[1]):t.drawImage(this._video,0,0,this.size[0],this.size[1]),t.restore())}onExecute(){if(this._webcam_stream==null&&!this._waiting_confirmation&&this.openStream(),!(!this._video||!this._video.videoWidth)){var t=this._video.videoWidth,r=this._video.videoHeight,s=this._video_texture;if((!s||s.width!=t||s.height!=r)&&(this._video_texture=new GL$1.Texture(t,r,{format:gl$1.RGB,filter:gl$1.LINEAR})),this._video_texture.uploadImage(this._video),this._video_texture.version=++this.version,this.properties.texture_name){var a=LGraphTexture.getTexturesContainer();a[this.properties.texture_name]=this._video_texture}this.setOutputData(0,this._video_texture);for(var l=1;l<this.outputs.length;++l)if(this.outputs[l])switch(this.outputs[l].name){case"width":this.setOutputData(l,this._video.videoWidth);break;case"height":this.setOutputData(l,this._video.videoHeight);break}}}onGetOutputs(){return[["width","number"],["height","number"],["stream_ready",LiteGraph.EVENT],["stream_closed",LiteGraph.EVENT],["stream_error",LiteGraph.EVENT]]}};g(Ze,"title","Webcam"),g(Ze,"desc","Webcam texture"),g(Ze,"is_webcam_open",!1);let LGraphTextureWebcam=Ze;LiteGraph.registerNodeType("texture/webcam",LGraphTextureWebcam);const We=class Fi{constructor(){this.addInput("in","Texture"),this.addInput("f","number"),this.addOutput("out","Texture"),this.properties={enabled:!0,factor:1,precision:LGraphTexture.LOW},this._uniforms={u_texture:0,u_factor:1}}onGetInputs(){return[["enabled","boolean"]]}onExecute(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){if(this.properties.precision===LGraphTexture.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,t);return}var r=this._temp_texture;(!r||r.width!=t.width||r.height!=t.height||r.type!=t.type)&&(r=this._temp_texture=new GL$1.Texture(t.width,t.height,{type:t.type,format:gl$1.RGBA,filter:gl$1.LINEAR}));var s=Fi._shader;s||(s=Fi._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,Fi.pixel_shader));var a=this.getInputData(1);a==null&&(a=this.properties.factor);var l=this._uniforms;l.u_factor=a,gl$1.disable(gl$1.DEPTH_TEST),r.drawTo(function(){t.bind(0),s.uniforms(l).draw(GL$1.Mesh.getScreenQuad())}),this.setOutputData(0,r)}}};g(We,"title","Lens FX"),g(We,"desc","distortion and chromatic aberration"),g(We,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(We,"pixel_shader",`precision highp float;
    varying vec2 v_coord;
    uniform sampler2D u_texture;
    uniform float u_factor;
    vec2 barrelDistortion(vec2 coord, float amt) {
        vec2 cc = coord - 0.5;
        float dist = dot(cc, cc);
        return coord + cc * dist * amt;
    }
    
    float sat( float t )
    {
        return clamp( t, 0.0, 1.0 );
    }
    
    float linterp( float t ) {
        return sat( 1.0 - abs( 2.0*t - 1.0 ) );
    }
    
    float remap( float t, float a, float b ) {
        return sat( (t - a) / (b - a) );
    }
    
    vec4 spectrum_offset( float t ) {
        vec4 ret;
        float lo = step(t,0.5);
        float hi = 1.0-lo;
        float w = linterp( remap( t, 1.0/6.0, 5.0/6.0 ) );
        ret = vec4(lo,1.0,hi, 1.) * vec4(1.0-w, w, 1.0-w, 1.);
    
        return pow( ret, vec4(1.0/2.2) );
    }
    
    const float max_distort = 2.2;
    const int num_iter = 12;
    const float reci_num_iter_f = 1.0 / float(num_iter);
    
    void main()
    {	
        vec2 uv=v_coord;
        vec4 sumcol = vec4(0.0);
        vec4 sumw = vec4(0.0);	
        for ( int i=0; i<num_iter;++i )
        {
            float t = float(i) * reci_num_iter_f;
            vec4 w = spectrum_offset( t );
            sumw += w;
            sumcol += w * texture2D( u_texture, barrelDistortion(uv, .6 * max_distort*t * u_factor ) );
        }
        gl_FragColor = sumcol / sumw;
    }`);let LGraphLensFX=We;LiteGraph.registerNodeType("texture/lensfx",LGraphLensFX);class LGraphTextureFromData{constructor(){this.addInput("in",""),this.properties={precision:LGraphTexture.LOW,width:0,height:0,channels:1},this.addOutput("out","Texture")}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(t){var r=this.properties.channels,s=this.properties.width,a=this.properties.height;(!s||!a)&&(s=Math.floor(t.length/r),a=1);var l=gl$1.RGBA;r==3?l=gl$1.RGB:r==1&&(l=gl$1.LUMINANCE);var h=this._temp_texture,u=LGraphTexture.getTextureType(this.properties.precision);(!h||h.width!=s||h.height!=a||h.type!=u)&&(h=this._temp_texture=new GL$1.Texture(s,a,{type:u,format:l,filter:gl$1.LINEAR})),h.uploadData(t),this.setOutputData(0,h)}}}}g(LGraphTextureFromData,"title","Data->Tex"),g(LGraphTextureFromData,"desc","Generates or applies a curve to a texture"),g(LGraphTextureFromData,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),LiteGraph.registerNodeType("texture/fromdata",LGraphTextureFromData);const me=class ti{constructor(){g(this,"pixel_shader",`precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform sampler2D u_curve;
        uniform float u_range;
        
        void main() {
            vec4 color = texture2D( u_texture, v_coord ) * u_range;
            color.x = texture2D( u_curve, vec2( color.x, 0.5 ) ).x;
            color.y = texture2D( u_curve, vec2( color.y, 0.5 ) ).y;
            color.z = texture2D( u_curve, vec2( color.z, 0.5 ) ).z;
            //color.w = texture2D( u_curve, vec2( color.w, 0.5 ) ).w;
            gl_FragColor = color;
        }`),this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={precision:LGraphTexture.LOW,split_channels:!1},this._values=new Uint8Array(256*4),this._values.fill(255),this._curve_texture=null,this._uniforms={u_texture:0,u_curve:1,u_range:1},this._must_update=!0,this._points={RGB:[[0,0],[1,1]],R:[[0,0],[1,1]],G:[[0,0],[1,1]],B:[[0,0],[1,1]]},this.curve_editor=null,this.addWidget("toggle","Split Channels",!1,"split_channels"),this.addWidget("combo","Channel","RGB",{values:["RGB","R","G","B"]}),this.curve_offset=68,this.size=[240,160]}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputData(0),r=this._temp_texture;if(!t){(this._must_update||!this._curve_texture)&&this.updateCurve(),this.setOutputData(0,this._curve_texture);return}var s=LGraphTexture.getTextureType(this.properties.precision,t);(!r||r.type!=s||r.width!=t.width||r.height!=t.height||r.format!=t.format)&&(r=this._temp_texture=new GL$1.Texture(t.width,t.height,{type:s,format:t.format,filter:gl$1.LINEAR}));var a=ti._shader;a||(a=ti._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,ti.pixel_shader)),(this._must_update||!this._curve_texture)&&this.updateCurve();var l=this._uniforms,h=this._curve_texture;r.drawTo(function(){gl$1.disable(gl$1.DEPTH_TEST),t.bind(0),h.bind(1),a.uniforms(l).draw(GL$1.Mesh.getScreenQuad())}),this.setOutputData(0,r)}}sampleCurve(t,r){if(r||(r=this._points.RGB),!!r){for(var s=0;s<r.length-1;++s){var a=r[s],l=r[s+1];if(!(l[0]<t)){var h=l[0]-a[0];if(Math.abs(h)<1e-5)return a[1];var u=(t-a[0])/h;return a[1]*(1-u)+l[1]*u}}return 0}}updateCurve(){for(var t=this._values,r=t.length/4,s=this.properties.split_channels,a=0;a<r;++a){if(s)t[a*4]=clamp(this.sampleCurve(a/r,this._points.R)*255,0,255),t[a*4+1]=clamp(this.sampleCurve(a/r,this._points.G)*255,0,255),t[a*4+2]=clamp(this.sampleCurve(a/r,this._points.B)*255,0,255);else{var l=this.sampleCurve(a/r);t[a*4]=t[a*4+1]=t[a*4+2]=clamp(l*255,0,255)}t[a*4+3]=255}this._curve_texture||(this._curve_texture=new GL$1.Texture(256,1,{format:gl$1.RGBA,magFilter:gl$1.LINEAR,wrap:gl$1.CLAMP_TO_EDGE})),this._curve_texture.uploadData(t,null,!0)}onSerialize(t){var r={};for(var s in this._points)r[s]=this._points[s].concat();t.curves=r}onConfigure(t){this._points=t.curves,this.curve_editor&&(curve_editor.points=this._points),this._must_update=!0}onMouseDown(t,r,s){if(this.curve_editor){var a=this.curve_editor.onMouseDown([r[0],r[1]-this.curve_offset],s);return a&&this.captureInput(!0),a}}onMouseMove(t,r,s){if(this.curve_editor)return this.curve_editor.onMouseMove([r[0],r[1]-this.curve_offset],s)}onMouseUp(t,r,s){if(this.curve_editor)return this.curve_editor.onMouseUp([r[0],r[1]-this.curve_offset],s);this.captureInput(!1)}onDrawBackground(t,r){if(!this.flags.collapsed){this.curve_editor||(this.curve_editor=new LiteGraph.CurveEditor(this._points.R)),t.save(),t.translate(0,this.curve_offset);var s=this.widgets[1].value;this.properties.split_channels?(s=="RGB"&&(this.widgets[1].value=s="R",this.widgets[1].disabled=!1),this.curve_editor.points=this._points.R,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],r,"#111",ti.channel_line_colors.R,!0),t.globalCompositeOperation="lighten",this.curve_editor.points=this._points.G,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],r,null,ti.channel_line_colors.G,!0),this.curve_editor.points=this._points.B,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],r,null,ti.channel_line_colors.B,!0),t.globalCompositeOperation="source-over"):(this.widgets[1].value=s="RGB",this.widgets[1].disabled=!0),this.curve_editor.points=this._points[s],this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],r,this.properties.split_channels?null:"#111",ti.channel_line_colors[s]),t.restore()}}};g(me,"title","Curve"),g(me,"desc","Generates or applies a curve to a texture"),g(me,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(me,"channel_line_colors",{RGB:"#666",R:"#F33",G:"#3F3",B:"#33F"});let LGraphTextureCurve=me;LiteGraph.registerNodeType("texture/curve",LGraphTextureCurve);const qe=class Pi{constructor(){this.addInput("in","Texture"),this.addInput("exp","number"),this.addOutput("out","Texture"),this.properties={exposition:1,precision:LGraphTexture.LOW},this._uniforms={u_texture:0,u_exposition:1}}onExecute(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var r=this._temp_texture;(!r||r.width!=t.width||r.height!=t.height||r.type!=t.type)&&(r=this._temp_texture=new GL$1.Texture(t.width,t.height,{type:t.type,format:gl$1.RGBA,filter:gl$1.LINEAR}));var s=Pi._shader;s||(s=Pi._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,Pi.pixel_shader)),this.properties.exposition;var a=this.getInputData(1);a!=null&&(this.properties.exposition=a);var l=this._uniforms;r.drawTo(function(){gl$1.disable(gl$1.DEPTH_TEST),t.bind(0),s.uniforms(l).draw(GL$1.Mesh.getScreenQuad())}),this.setOutputData(0,r)}}};g(qe,"title","Exposition"),g(qe,"desc","Controls texture exposition"),g(qe,"widgets_info",{exposition:{widget:"slider",min:0,max:3},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(qe,"pixel_shader",`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform float u_exposition;
    
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            gl_FragColor = vec4(color.xyz * u_exposition, color.a);
        }
    `);let LGraphExposition=qe;LiteGraph.registerNodeType("texture/exposition",LGraphExposition);const xe=class ni{constructor(){this.addInput("in","Texture"),this.addInput("avg","number,Texture"),this.addOutput("out","Texture"),this.properties={enabled:!0,scale:1,gamma:1,average_lum:1,lum_white:1,precision:LGraphTexture.LOW},this._uniforms={u_texture:0,u_lumwhite2:1,u_igamma:1,u_scale:1,u_average_lum:1}}onGetInputs(){return[["enabled","boolean"]]}onExecute(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){if(this.properties.precision===LGraphTexture.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,t);return}var r=this._temp_texture;(!r||r.width!=t.width||r.height!=t.height||r.type!=t.type)&&(r=this._temp_texture=new GL$1.Texture(t.width,t.height,{type:t.type,format:gl$1.RGBA,filter:gl$1.LINEAR}));var s=this.getInputData(1);s==null&&(s=this.properties.average_lum);var a=this._uniforms,l=null;s.constructor===Number?(this.properties.average_lum=s,a.u_average_lum=this.properties.average_lum,l=ni._shader,l||(l=ni._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,ni.pixel_shader))):s.constructor===GL$1.Texture&&(a.u_average_texture=s.bind(1),l=ni._shader_texture,l||(l=ni._shader_texture=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,ni.pixel_shader,{AVG_TEXTURE:""}))),a.u_lumwhite2=this.properties.lum_white*this.properties.lum_white,a.u_scale=this.properties.scale,a.u_igamma=1/this.properties.gamma,gl$1.disable(gl$1.DEPTH_TEST),r.drawTo(function(){t.bind(0),l.uniforms(a).draw(GL$1.Mesh.getScreenQuad())}),this.setOutputData(0,this._temp_texture)}}};g(xe,"title","Tone Mapping"),g(xe,"desc","Applies Tone Mapping to convert from high to low"),g(xe,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(xe,"pixel_shader",`precision highp float;
    varying vec2 v_coord;
    uniform sampler2D u_texture;
    uniform float u_scale;
    #ifdef AVG_TEXTURE
        uniform sampler2D u_average_texture;
    #else
        uniform float u_average_lum;
    #endif
    uniform float u_lumwhite2;
    uniform float u_igamma;
    vec3 RGB2xyY (vec3 rgb)
    {
            const mat3 RGB2XYZ = mat3(0.4124, 0.3576, 0.1805,
                                    0.2126, 0.7152, 0.0722,
                                    0.0193, 0.1192, 0.9505);
        vec3 XYZ = RGB2XYZ * rgb;
        
        float f = (XYZ.x + XYZ.y + XYZ.z);
        return vec3(XYZ.x / f,
                    XYZ.y / f,
                    XYZ.y);
    }
    
    void main() {
        vec4 color = texture2D( u_texture, v_coord );
        vec3 rgb = color.xyz;
        float average_lum = 0.0;
        #ifdef AVG_TEXTURE
            vec3 pixel = texture2D(u_average_texture,vec2(0.5)).xyz;
            average_lum = (pixel.x + pixel.y + pixel.z) / 3.0;
        #else
            average_lum = u_average_lum;
        #endif
        //Ld - this part of the code is the same for both versions
        float lum = dot(rgb, vec3(0.2126, 0.7152, 0.0722));
        float L = (u_scale / average_lum) * lum;
        float Ld = (L * (1.0 + L / u_lumwhite2)) / (1.0 + L);
        //first
        //vec3 xyY = RGB2xyY(rgb);
        //xyY.z *= Ld;
        //rgb = xyYtoRGB(xyY);
        //second
        rgb = (rgb / lum) * Ld;
        rgb = max(rgb,vec3(0.001));
        rgb = pow( rgb, vec3( u_igamma ) );
        gl_FragColor = vec4( rgb, color.a );
    }`);let LGraphToneMapping=xe;LiteGraph.registerNodeType("texture/tonemapping",LGraphToneMapping);const Ye=class ki{constructor(){this.addOutput("out","Texture"),this.properties={width:512,height:512,seed:0,persistence:.1,octaves:8,scale:1,offset:[0,0],amplitude:1,precision:LGraphTexture.DEFAULT},this._key=0,this._texture=null,this._uniforms={u_persistence:.1,u_seed:0,u_offset:vec2.create(),u_scale:1,u_viewport:vec2.create()}}onGetInputs(){return[["seed","number"],["persistence","number"],["octaves","number"],["scale","number"],["amplitude","number"],["offset","vec2"]]}onExecute(){if(this.isOutputConnected(0)){var t=this.properties.width|0,r=this.properties.height|0;t==0&&(t=gl$1.viewport_data[2]),r==0&&(r=gl$1.viewport_data[3]);var s=LGraphTexture.getTextureType(this.properties.precision),a=this._texture;(!a||a.width!=t||a.height!=r||a.type!=s)&&(a=this._texture=new GL$1.Texture(t,r,{type:s,format:gl$1.RGB,filter:gl$1.LINEAR}));var l=this.getInputOrProperty("persistence"),h=this.getInputOrProperty("octaves"),u=this.getInputOrProperty("offset"),c=this.getInputOrProperty("scale"),_=this.getInputOrProperty("amplitude"),d=this.getInputOrProperty("seed"),f=""+t+r+s+l+h+c+d+u[0]+u[1]+_;if(f==this._key){this.setOutputData(0,a);return}this._key=f;var m=this._uniforms;m.u_persistence=l,m.u_octaves=h,m.u_offset.set(u),m.u_scale=c,m.u_amplitude=_,m.u_seed=d*128,m.u_viewport[0]=t,m.u_viewport[1]=r;var b=ki._shader;b||(b=ki._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,ki.pixel_shader)),gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST),a.drawTo(function(){b.uniforms(m).draw(GL$1.Mesh.getScreenQuad())}),this.setOutputData(0,a)}}};g(Ye,"title","Perlin"),g(Ye,"desc","Generates a perlin noise texture"),g(Ye,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1},octaves:{type:"number",precision:0,step:1,min:1,max:50}}),g(Ye,"pixel_shader",`precision highp float;
        varying vec2 v_coord;
        uniform vec2 u_offset;
        uniform float u_scale;
        uniform float u_persistence;
        uniform int u_octaves;
        uniform float u_amplitude;
        uniform vec2 u_viewport;
        uniform float u_seed;
        #define M_PI 3.14159265358979323846
        
        float rand(vec2 c){	return fract(sin(dot(c.xy ,vec2( 12.9898 + u_seed,78.233 + u_seed))) * 43758.5453); }
        
        float noise(vec2 p, float freq ){
            float unit = u_viewport.x/freq;
            vec2 ij = floor(p/unit);
            vec2 xy = mod(p,unit)/unit;
            //xy = 3.*xy*xy-2.*xy*xy*xy;
            xy = .5*(1.-cos(M_PI*xy));
            float a = rand((ij+vec2(0.,0.)));
            float b = rand((ij+vec2(1.,0.)));
            float c = rand((ij+vec2(0.,1.)));
            float d = rand((ij+vec2(1.,1.)));
            float x1 = mix(a, b, xy.x);
            float x2 = mix(c, d, xy.x);
            return mix(x1, x2, xy.y);
        }
        
        float pNoise(vec2 p, int res){
            float persistance = u_persistence;
            float n = 0.;
            float normK = 0.;
            float f = 4.;
            float amp = 1.0;
            int iCount = 0;
            for (int i = 0; i<50; i++){
                n+=amp*noise(p, f);
                f*=2.;
                normK+=amp;
                amp*=persistance;
                if (iCount >= res)
                    break;
                iCount++;
            }
            float nf = n/normK;
            return nf*nf*nf*nf;
        }
        void main() {
            vec2 uv = v_coord * u_scale * u_viewport + u_offset * u_scale;
            vec4 color = vec4( pNoise( uv, u_octaves ) * u_amplitude );
            gl_FragColor = color;
        }`);let LGraphTexturePerlin=Ye;LiteGraph.registerNodeType("texture/perlin",LGraphTexturePerlin);const et=class or{constructor(){this.addInput("v"),this.addOutput("out","Texture"),this.properties={code:or.default_code,width:512,height:512,clear:!0,precision:LGraphTexture.DEFAULT,use_html_canvas:!1},this._func=null,this._temp_texture=null,this.compileCode()}onPropertyChanged(t,r){t=="code"&&this.compileCode(r)}compileCode(t){var r,s;if(this._func=null,!!LiteGraph.allow_scripts)try{this._func=new Function("canvas","ctx","time","script","v",t),this.boxcolor="#00FF00"}catch(a){this.boxcolor="#FF0000",(r=console.error)==null||r.call(console,"Error parsing script"),(s=console.error)==null||s.call(console,a)}}onExecute(){var t=this._func;!t||!this.isOutputConnected(0)||this.executeDraw(t)}executeDraw(t){var r,s,a=this.properties.width||gl$1.canvas.width,l=this.properties.height||gl$1.canvas.height,h=this._temp_texture,u=LGraphTexture.getTextureType(this.properties.precision);(!h||h.width!=a||h.height!=l||h.type!=u)&&(h=this._temp_texture=new GL$1.Texture(a,l,{format:gl$1.RGBA,filter:gl$1.LINEAR,type:u}));var c=this.getInputData(0),_=this.properties,d=this,f=this.graph.getTime(),m=gl$1,b=gl$1.canvas;if((this.properties.use_html_canvas||!enableWebGLCanvas)&&(this._canvas?(b=this._canvas,m=this._ctx):(b=this._canvas=GL$1.createCanvas(a.height),m=this._ctx=b.getContext("2d")),b.width=a,b.height=l),m==gl$1)h.drawTo(function(){var T,L;gl$1.start2D(),_.clear&&(gl$1.clearColor(0,0,0,0),gl$1.clear(gl$1.COLOR_BUFFER_BIT));try{t.draw?t.draw.call(d,b,m,f,t,c):t.call(d,b,m,f,t,c),d.boxcolor="#00FF00"}catch(G){d.boxcolor="#FF0000",(T=console.error)==null||T.call(console,"Error executing script"),(L=console.error)==null||L.call(console,G)}gl$1.finish2D()});else{_.clear&&m.clearRect(0,0,b.width,b.height);try{t.draw?t.draw.call(this,b,m,f,t,c):t.call(this,b,m,f,t,c),this.boxcolor="#00FF00"}catch(T){this.boxcolor="#FF0000",(r=console.error)==null||r.call(console,"Error executing script"),(s=console.error)==null||s.call(console,T)}h.uploadImage(b)}this.setOutputData(0,h)}};g(et,"title","Canvas2D"),g(et,"desc","Executes Canvas2D code inside a texture or the viewport."),g(et,"help","Set width and height to 0 to match viewport size."),g(et,"default_code",`//vars: canvas,ctx,time
ctx.fillStyle='red';
ctx.fillRect(0,0,50,50);
`),g(et,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES},code:{type:"code"},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1}});let LGraphTextureCanvas2D=et;LiteGraph.registerNodeType("texture/canvas2D",LGraphTextureCanvas2D);const je=class Bi{constructor(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={key_color:vec3.fromValues(0,1,0),threshold:.8,slope:.2,precision:LGraphTexture.DEFAULT}}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision===LGraphTexture.PASS_THROUGH){this.setOutputData(0,t);return}if(t){this._tex=LGraphTexture.getTargetTexture(t,this._tex,this.properties.precision),gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST),this._uniforms||(this._uniforms={u_texture:0,u_key_color:this.properties.key_color,u_threshold:1,u_slope:1});var r=this._uniforms,s=Mesh.getScreenQuad(),a=Bi._shader;a||(a=Bi._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,Bi.pixel_shader)),r.u_key_color=this.properties.key_color,r.u_threshold=this.properties.threshold,r.u_slope=this.properties.slope,this._tex.drawTo(function(){t.bind(0),a.uniforms(r).draw(s)}),this.setOutputData(0,this._tex)}}}};g(je,"title","Matte"),g(je,"desc","Extracts background"),g(je,"widgets_info",{key_color:{widget:"color"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(je,"pixel_shader",`precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec3 u_key_color;
        uniform float u_threshold;
        uniform float u_slope;
        
        void main() {
            vec3 color = texture2D( u_texture, v_coord ).xyz;
            float diff = length( normalize(color) - normalize(u_key_color) );
            float edge = u_threshold * (1.0 - u_slope);
            float alpha = smoothstep( edge, u_threshold, diff);
            gl_FragColor = vec4( color, alpha );
        }`);let LGraphTextureMatte=je;LiteGraph.registerNodeType("texture/matte",LGraphTextureMatte);class LGraphCubemapToTexture2D{constructor(){this.addInput("in","texture"),this.addInput("yaw","number"),this.addOutput("out","texture"),this.properties={yaw:0}}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(!(!t||t.texture_type!=GL$1.TEXTURE_CUBE_MAP)){this._last_tex&&(this._last_tex.height!=t.height||this._last_tex.type!=t.type)&&(this._last_tex=null);var r=this.getInputOrProperty("yaw");this._last_tex=GL$1.Texture.cubemapToTexture2D(t,t.height,this._last_tex,!0,r),this.setOutputData(0,this._last_tex)}}}}g(LGraphCubemapToTexture2D,"title","CubemapToTexture2D"),g(LGraphCubemapToTexture2D,"desc","Transforms a CUBEMAP texture into a TEXTURE2D in Polar Representation"),LiteGraph.registerNodeType("texture/cubemapToTexture2D",LGraphCubemapToTexture2D);var SHADERNODES_COLOR="#345",LGShaders=LiteGraph.Shaders={};LGShaders.GLSL_types=["float","vec2","vec3","vec4","mat3","mat4","sampler2D","samplerCube"];var GLSL_types_const=LGShaders.GLSL_types_const=["float","vec2","vec3","vec4"],GLSL_functions_desc={radians:"T radians(T degrees)",degrees:"T degrees(T radians)",sin:"T sin(T angle)",cos:"T cos(T angle)",tan:"T tan(T angle)",asin:"T asin(T x)",acos:"T acos(T x)",atan:"T atan(T x)",atan2:"T atan(T x,T y)",pow:"T pow(T x,T y)",exp:"T exp(T x)",log:"T log(T x)",exp2:"T exp2(T x)",log2:"T log2(T x)",sqrt:"T sqrt(T x)",inversesqrt:"T inversesqrt(T x)",abs:"T abs(T x)",sign:"T sign(T x)",floor:"T floor(T x)",round:"T round(T x)",ceil:"T ceil(T x)",fract:"T fract(T x)",mod:"T mod(T x,T y)",min:"T min(T x,T y)",max:"T max(T x,T y)",clamp:"T clamp(T x,T minVal = 0.0,T maxVal = 1.0)",mix:"T mix(T x,T y,T a)",step:"T step(T edge, T edge2, T x)",smoothstep:"T smoothstep(T edge, T edge2, T x)",length:"float length(T x)",distance:"float distance(T p0, T p1)",normalize:"T normalize(T x)",dot:"float dot(T x,T y)",cross:"vec3 cross(vec3 x,vec3 y)",reflect:"vec3 reflect(vec3 V,vec3 N)",refract:"vec3 refract(vec3 V,vec3 N, float IOR)"},GLSL_functions={},GLSL_functions_name=[];parseGLSLDescriptions(),LGShaders.ALL_TYPES="float,vec2,vec3,vec4";function parseGLSLDescriptions(){GLSL_functions_name.length=0;for(var o in GLSL_functions_desc){var t=GLSL_functions_desc[o],r=t.indexOf(" "),s=t.substr(0,r),a=t.indexOf("(",r),l=t.substr(r,a-r).trim(),h=t.substr(a+1,t.length-a-2).split(",");for(var u in h){var c=h[u].split(" ").filter(function(_){return _});h[u]={type:c[0].trim(),name:c[1].trim()},c[2]=="="&&(h[u].value=c[3].trim())}GLSL_functions[o]={return_type:s,func:l,params:h},GLSL_functions_name.push(l)}}function registerShaderNode(o,t){t.color=SHADERNODES_COLOR,t.filter="shader",t.prototype.clearDestination=function(){this.shader_destination={}},t.prototype.propagateDestination=function(r){if(this.shader_destination[r]=!0,this.inputs)for(var s=0;s<this.inputs.length;++s){var a=this.getInputNode(s);a&&a.propagateDestination(r)}},t.prototype.onPropertyChanged||(t.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++}),LiteGraph.registerNodeType("shader::"+o,t)}function getShaderNodeVarName(o,t){return"VAR_"+(t||"TEMP")+"_"+o.id}function getInputLinkID(o,t){if(!o.inputs)return null;var r=o.getInputLink(t);if(!r)return null;var s=o.graph.getNodeById(r.origin_id);return s?s.getOutputVarName?s.getOutputVarName(r.origin_slot):"link_"+s.id+"_"+r.origin_slot:null}function getOutputLinkID(o,t){return o.isOutputConnected(t)?"link_"+o.id+"_"+t:null}LGShaders.registerShaderNode=registerShaderNode,LGShaders.getInputLinkID=getInputLinkID,LGShaders.getOutputLinkID=getOutputLinkID,LGShaders.getShaderNodeVarName=getShaderNodeVarName,LGShaders.parseGLSLDescriptions=parseGLSLDescriptions;function valueToGLSL(o,t,r){var s=5;if(r!=null&&(s=r),!t)if(o.constructor===Number)t="float";else if(o.length)switch(o.length){case 2:t="vec2";break;case 3:t="vec3";break;case 4:t="vec4";break;case 9:t="mat3";break;case 16:t="mat4";break;default:throw new Error("unknown type for glsl value size")}else throw new Error("unknown type for glsl value: "+o.constructor);switch(t){case"float":return o.toFixed(s);case"vec2":return`vec2(${o[0].toFixed(s)},${o[1].toFixed(s)})`;case"color3":case"vec3":return`vec3(${o[0].toFixed(s)},${o[1].toFixed(s)},${o[2].toFixed(s)})`;case"color4":case"vec4":return`vec4(${o[0].toFixed(s)},${o[1].toFixed(s)},${o[2].toFixed(s)},${o[3].toFixed(s)})`;case"mat3":return"mat3(1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0)";case"mat4":return"mat4(1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0)";default:throw t}}var varToTypeGLSL=LiteGraph.varToTypeGLSL=function o(t,r,s){if(r==s)return t;if(t==null)switch(s){case"float":return"0.0";case"vec2":return"vec2(0.0)";case"vec3":return"vec3(0.0)";case"vec4":return"vec4(0.0,0.0,0.0,1.0)";default:return null}if(!s)throw new Error("error: no output type specified");if(s=="float")switch(r){case"vec2":case"vec3":case"vec4":return t+".x";default:return"0.0"}else if(s=="vec2")switch(r){case"float":return"vec2("+t+")";case"vec3":case"vec4":return t+".xy";default:return"vec2(0.0)"}else if(s=="vec3")switch(r){case"float":return"vec3("+t+")";case"vec2":return"vec3("+t+",0.0)";case"vec4":return t+".xyz";default:return"vec3(0.0)"}else if(s=="vec4")switch(r){case"float":return"vec4("+t+")";case"vec2":return"vec4("+t+",0.0,1.0)";case"vec3":return"vec4("+t+",1.0)";default:return"vec4(0.0,0.0,0.0,1.0)"}throw new Error("type cannot be converted")},convertVarToGLSLType=LiteGraph.convertVarToGLSLType=function o(t,r,s){if(r==s)return t;if(r=="float")return s+"("+t+")";if(s=="vec2")return"vec2("+t+".xy)";if(s=="vec3"){if(r=="vec2")return"vec3("+t+",0.0)";if(r=="vec4")return"vec4("+t+".xyz)"}if(s=="vec4"){if(r=="vec2")return"vec4("+t+",0.0,0.0)";if(s=="vec3")return"vec4("+t+",1.0)"}return null};class LGShaderContext{constructor(){this.vs_template="",this.fs_template="",this.buffer_names={uvs:"v_coord"},this.extra={},this._functions={},this._uniforms={},this._codeparts={},this._uniform_value=null}clear(){this._uniforms={},this._functions={},this._codeparts={},this._uniform_value=null,this.extra={}}addUniform(t,r,s){this._uniforms[t]=r,s!=null&&(this._uniform_value||(this._uniform_value={}),this._uniform_value[t]=s)}addFunction(t,r){this._functions[t]=r}addCode(t,r,s){s=s||{"":""};for(var a in s){var l=a?a+"_"+t:t;this._codeparts[l]?this._codeparts[l]+=r+`
`:this._codeparts[l]=r+`
`}}computeCodeBlocks(t,r){this.clear();var s=t.findNodesByType("shader::output/vertex");s=s&&s.length?s[0]:null;var a=t.findNodesByType("shader::output/fragcolor");if(a=a&&a.length?a[0]:null,!a)return null;t.sendEventToAllNodes("clearDestination"),s&&s.propagateDestination("vs"),a&&a.propagateDestination("fs"),t.sendEventToAllNodes("onGetCode",this);var l="";for(let c in this._uniforms)l+="uniform "+this._uniforms[c]+" "+c+`;
`;if(r)for(let c in r)l+="uniform "+r[c]+" "+c+`;
`;var h="";for(let c in this._functions)h+="//"+c+`
`+this._functions[c]+`
`;var u=this._codeparts;return u.uniforms=l,u.functions=h,u}computeShaderCode(t){var r=this.computeCodeBlocks(t),s=GL$1.Shader.replaceCodeUsingContext(this.vs_template,r),a=GL$1.Shader.replaceCodeUsingContext(this.fs_template,r);return{vs_code:s,fs_code:a}}computeShader(t,r){var s,a,l,h,u=this.computeShaderCode(t);if((s=console.log)==null||s.call(console,u.vs_code,u.fs_code),!LiteGraph.catch_exceptions)return this._shader_error=!0,r?r.updateShader(u.vs_code,u.fs_code):r=new GL$1.Shader(u.vs_code,u.fs_code),this._shader_error=!1,r;try{return r?r.updateShader(u.vs_code,u.fs_code):r=new GL$1.Shader(u.vs_code,u.fs_code),this._shader_error=!1,r}catch(c){return this._shader_error||((a=console.error)==null||a.call(console,c),c.indexOf("Fragment shader")!=-1?(l=console.log)==null||l.call(console,u.fs_code.split(`
`).map(function(_,d){return d+".- "+_}).join(`
`)):(h=console.log)==null||h.call(console,u.vs_code)),this._shader_error=!0,null}}getShader(t){if(this._shader&&this._shader._version==t._version)return this._shader;var r=this.computeShader(t,this._shader);return r?(this._shader=r,r._version=t._version,r):null}fillUniforms(t,r){if(this._uniform_value)for(var s in this._uniform_value){var a=this._uniform_value[s];a!=null&&(a.constructor===Function?t[s]=a.call(this,r):a.constructor===GL$1.Texture||(t[s]=a))}}}const Fe=class nr{constructor(){this.subgraph=new LiteGraph.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.filter="shader",this.addInput("in","texture"),this.addOutput("out","texture"),this.properties={width:0,height:0,alpha:!1,precision:typeof LGraphTexture!="undefined"?LGraphTexture.DEFAULT:2};var t=this.subgraph.findNodesByType("shader::input/uniform")[0];t.pos=[200,300];var r=LiteGraph.createNode("shader::texture/sampler2D");r.pos=[400,300],this.subgraph.add(r);var s=LiteGraph.createNode("shader::output/fragcolor");s.pos=[600,300],this.subgraph.add(s),t.connect(0,r),r.connect(0,s),this.size=[180,60],this.redraw_on_mouse=!0,this._uniforms={},this._shader=null,this._context=new LGShaderContext,this._context.vs_template=`#define VERTEX
`+GL$1.Shader.SCREEN_VERTEX_SHADER,this._context.fs_template=nr.template}onSerialize(t){t.subgraph=this.subgraph.serialize()}onConfigure(t){this.subgraph.configure(t.subgraph)}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputData(0);t&&t.constructor!=GL$1.Texture&&(t=null);var r=this.properties.width|0,s=this.properties.height|0;r==0&&(r=t?t.width:gl$1.viewport_data[2]),s==0&&(s=t?t.height:gl$1.viewport_data[3]);var a=LGraphTexture.getTextureType(this.properties.precision,t),l=this._texture;(!l||l.width!=r||l.height!=s||l.type!=a)&&(l=this._texture=new GL$1.Texture(r,s,{type:a,format:this.alpha?gl$1.RGBA:gl$1.RGB,filter:gl$1.LINEAR}));var h=this.getShader(this.subgraph);if(h){var u=this._uniforms;this._context.fillUniforms(u);var c=0;if(this.inputs)for(var _=0;_<this.inputs.length;++_){var d=this.inputs[_],f=this.getInputData(_);d.type=="texture"&&(f||(f=GL$1.Texture.getWhiteTexture()),f=f.bind(c++)),f!=null&&(u["u_"+d.name]=f)}var m=GL$1.Mesh.getScreenQuad();gl$1.disable(gl$1.DEPTH_TEST),gl$1.disable(gl$1.BLEND),l.drawTo(function(){h.uniforms(u),h.draw(m)}),this.setOutputData(0,l)}}}onInputAdded(t){var r=LiteGraph.createNode("shader::input/uniform");r.setProperty("name",t.name),r.setProperty("type",t.type),this.subgraph.add(r)}onInputRemoved(t,r){for(var s=this.subgraph.findNodesByType("shader::input/uniform"),a=0;a<s.length;++a){var l=s[a];l.properties.name==r.name&&this.subgraph.remove(l)}}computeSize(){var t=this.inputs?this.inputs.length:0,r=this.outputs?this.outputs.length:0;return[200,Math.max(t,r)*LiteGraph.NODE_SLOT_HEIGHT+LiteGraph.NODE_TITLE_HEIGHT+10]}getShader(){var t=this._context.getShader(this.subgraph);return t?this.boxcolor=null:this.boxcolor="red",t}onDrawBackground(t,r,s,a){if(!this.flags.collapsed){var l=this.getOutputData(0),h=this.inputs?this.inputs.length*LiteGraph.NODE_SLOT_HEIGHT:0;l&&t==l.gl&&this.size[1]>h+LiteGraph.NODE_TITLE_HEIGHT&&t.drawImage(l,10,u,this.size[0]-20,this.size[1]-h-LiteGraph.NODE_TITLE_HEIGHT);var u=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,c=LiteGraph.isInsideRectangle(a[0],a[1],this.pos[0],this.pos[1]+u,this.size[0],LiteGraph.NODE_TITLE_HEIGHT);t.fillStyle=c?"#555":"#222",t.beginPath(),this._shape==LiteGraph.BOX_SHAPE?t.rect(0,u,this.size[0]+1,LiteGraph.NODE_TITLE_HEIGHT):t.roundRect(0,u,this.size[0]+1,LiteGraph.NODE_TITLE_HEIGHT,0,8),t.fill(),t.textAlign="center",t.font="24px Arial",t.fillStyle=c?"#DDD":"#999",t.fillText("+",this.size[0]*.5,u+24)}}onMouseDown(t,r,s){var a=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5;r[1]>a&&s.showSubgraphPropertiesDialog(this)}getExtraMenuOptions(){var t=this,r=[{content:"Print Code",callback:function(){var s,a=t._context.computeShaderCode();(s=console.log)==null||s.call(console,a.vs_code,a.fs_code)}}];return r}};g(Fe,"template",`
        #define FRAGMENT
        precision highp float;
        varying vec2 v_coord;
        {{varying}}
        {{uniforms}}
        {{functions}}
        {{fs_functions}}
        void main() {
    
            vec2 uv = v_coord;
            vec4 fragcolor = vec4(0.0);
            vec4 fragcolor1 = vec4(0.0);
            {{fs_code}}
            gl_FragColor = fragcolor;
        }
    `),g(Fe,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(Fe,"title","ShaderGraph"),g(Fe,"desc","Builds a shader using a graph"),g(Fe,"input_node_type","input/uniform"),g(Fe,"output_node_type","output/fragcolor"),g(Fe,"title_color",SHADERNODES_COLOR);let LGraphShaderGraph=Fe;LiteGraph.registerNodeType("texture/shaderGraph",LGraphShaderGraph);class LGraphShaderUniform{constructor(){this.addOutput("out",""),this.properties={name:"",type:""}}getTitle(){return this.properties.name&&this.flags.collapsed?this.properties.type+" "+this.properties.name:"Uniform"}onPropertyChanged(){this.outputs[0].name=this.properties.type+" "+this.properties.name}onGetCode(t){if(this.shader_destination){var r=this.properties.type;if(!r){if(!t.onGetPropertyInfo)return;var s=t.onGetPropertyInfo(this.property.name);if(!s)return;r=s.type}r=="number"?r="float":r=="texture"&&(r="sampler2D"),LGShaders.GLSL_types.indexOf(r)!=-1&&(t.addUniform("u_"+this.properties.name,r),this.setOutputData(0,r))}}getOutputVarName(){return"u_"+this.properties.name}}g(LGraphShaderUniform,"title","Uniform"),g(LGraphShaderUniform,"desc","Input data for the shader"),registerShaderNode("input/uniform",LGraphShaderUniform);class LGraphShaderAttribute{constructor(){this.addOutput("out","vec2"),this.properties={name:"coord",type:"vec2"}}getTitle(){return"att. "+this.properties.name}onGetCode(t){if(this.shader_destination){var r=this.properties.type;!r||LGShaders.GLSL_types.indexOf(r)==-1||(r=="number"&&(r="float"),this.properties.name!="coord"&&t.addCode("varying"," varying "+r+" v_"+this.properties.name+";"),this.setOutputData(0,r))}}getOutputVarName(){return"v_"+this.properties.name}}g(LGraphShaderAttribute,"title","Attribute"),g(LGraphShaderAttribute,"desc","Input data from mesh attribute"),registerShaderNode("input/attribute",LGraphShaderAttribute);class LGraphShaderSampler2D{constructor(){this.addInput("tex","sampler2D"),this.addInput("uv","vec2"),this.addOutput("rgba","vec4"),this.addOutput("rgb","vec3")}onGetCode(t){if(this.shader_destination){var r=getInputLinkID(this,0),s=getShaderNodeVarName(this),a="vec4 "+s+` = vec4(0.0);
`;if(r){var l=getInputLinkID(this,1)||t.buffer_names.uvs;a+=s+" = texture2D("+r+","+l+`);
`}var h=getOutputLinkID(this,0);h&&(a+="vec4 "+getOutputLinkID(this,0)+" = "+s+`;
`);var u=getOutputLinkID(this,1);u&&(a+="vec3 "+getOutputLinkID(this,1)+" = "+s+`.xyz;
`),t.addCode("code",a,this.shader_destination),this.setOutputData(0,"vec4"),this.setOutputData(1,"vec3")}}}g(LGraphShaderSampler2D,"title","Sampler2D"),g(LGraphShaderSampler2D,"desc","Reads a pixel from a texture"),registerShaderNode("texture/sampler2D",LGraphShaderSampler2D);class LGraphShaderConstant{constructor(){this.addOutput("","float"),this.properties={type:"float",value:0},this.addWidget("combo","type","float",null,{values:GLSL_types_const,property:"type"}),this.updateWidgets()}getTitle(){return this.flags.collapsed?valueToGLSL(this.properties.value,this.properties.type,2):"Const"}onPropertyChanged(t,r){t=="type"&&(this.outputs[0].type!=r&&(this.disconnectOutput(0),this.outputs[0].type=r),this.widgets.length=1,this.updateWidgets()),t=="value"&&(r.length?(this.widgets[1].value=r[1],r.length>2&&(this.widgets[2].value=r[2]),r.length>3&&(this.widgets[3].value=r[3])):this.widgets[1].value=r)}updateWidgets(t){var r,s=this;t=this.properties.value;var a={step:.01};switch(this.properties.type){case"float":this.properties.value=0,this.addWidget("number","v",0,{step:.01,property:"value"});break;case"vec2":this.properties.value=t&&t.length==2?[t[0],t[1]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(l){s.properties.value[0]=l},a),this.addWidget("number","y",this.properties.value[1],function(l){s.properties.value[1]=l},a);break;case"vec3":this.properties.value=t&&t.length==3?[t[0],t[1],t[2]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(l){s.properties.value[0]=l},a),this.addWidget("number","y",this.properties.value[1],function(l){s.properties.value[1]=l},a),this.addWidget("number","z",this.properties.value[2],function(l){s.properties.value[2]=l},a);break;case"vec4":this.properties.value=t&&t.length==4?[t[0],t[1],t[2],t[3]]:[0,0,0,0],this.addWidget("number","x",this.properties.value[0],function(l){s.properties.value[0]=l},a),this.addWidget("number","y",this.properties.value[1],function(l){s.properties.value[1]=l},a),this.addWidget("number","z",this.properties.value[2],function(l){s.properties.value[2]=l},a),this.addWidget("number","w",this.properties.value[3],function(l){s.properties.value[3]=l},a);break;default:(r=console.error)==null||r.call(console,"unknown type for constant")}}onGetCode(t){if(this.shader_destination){var r=valueToGLSL(this.properties.value,this.properties.type),s=getOutputLinkID(this,0);if(s){var a="	"+this.properties.type+" "+s+" = "+r+";";t.addCode("code",a,this.shader_destination),this.setOutputData(0,this.properties.type)}}}}g(LGraphShaderConstant,"title","const"),registerShaderNode("const/const",LGraphShaderConstant);const tt=class Ei{constructor(){this.addInput("xy","vec2"),this.addInput("x","float"),this.addInput("y","float"),this.addOutput("xy","vec2"),this.addOutput("x","float"),this.addOutput("y","float"),this.properties={x:0,y:0}}onPropertyChanged(){this.graph&&this.graph._version++}onGetCode(t){if(this.shader_destination){var r=this.properties,s=getShaderNodeVarName(this),a="	vec2 "+s+" = "+valueToGLSL([r.x,r.y])+`;
`;for(let c=0;c<Ei.varmodes.length;++c){let _=Ei.varmodes[c];var l=getInputLinkID(this,c);l&&(a+="	"+s+"."+_+" = "+l+`;
`)}for(let c=0;c<Ei.varmodes.length;++c){let _=Ei.varmodes[c];var h=getOutputLinkID(this,c);if(h){var u=GLSL_types_const[_.length-1];a+="	"+u+" "+h+" = "+s+"."+_+`;
`,this.setOutputData(c,u)}}t.addCode("code",a,this.shader_destination)}}};g(tt,"title","vec2"),g(tt,"varmodes",["xy","x","y"]);let LGraphShaderVec2=tt;registerShaderNode("const/vec2",LGraphShaderVec2);const rt=class Li{constructor(){this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("xy","vec2"),this.addInput("xz","vec2"),this.addInput("yz","vec2"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("xz","vec2"),this.addOutput("yz","vec2"),this.properties={x:0,y:0,z:0}}onPropertyChanged(){this.graph&&this.graph._version++}onGetCode(t){if(this.shader_destination){var r=this.properties,s=getShaderNodeVarName(this),a="vec3 "+s+" = "+valueToGLSL([r.x,r.y,r.z])+`;
`;for(let h=0;h<Li.varmodes.length;++h){let u=Li.varmodes[h],c=getInputLinkID(this,h);c&&(a+="	"+s+"."+u+" = "+c+`;
`)}for(let h=0;h<Li.varmodes.length;++h){let u=Li.varmodes[h],c=getOutputLinkID(this,h);if(c){var l=GLSL_types_const[u.length-1];a+="	"+l+" "+c+" = "+s+"."+u+`;
`,this.setOutputData(h,l)}}t.addCode("code",a,this.shader_destination)}}};g(rt,"title","vec3"),g(rt,"varmodes",["xyz","x","y","z","xy","xz","yz"]);let LGraphShaderVec3=rt;registerShaderNode("const/vec3",LGraphShaderVec3);const it=class Gi{constructor(){this.addInput("xyzw","vec4"),this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("w","float"),this.addInput("xy","vec2"),this.addInput("yz","vec2"),this.addInput("zw","vec2"),this.addOutput("xyzw","vec4"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("yz","vec2"),this.addOutput("zw","vec2"),this.properties={x:0,y:0,z:0,w:0}}onPropertyChanged(){this.graph&&this.graph._version++}onGetCode(t){if(this.shader_destination){var r=this.properties,s=getShaderNodeVarName(this),a="vec4 "+s+" = "+valueToGLSL([r.x,r.y,r.z,r.w])+`;
`;for(let h=0;h<Gi.varmodes.length;++h){let u=Gi.varmodes[h],c=getInputLinkID(this,h);c&&(a+="	"+s+"."+u+" = "+c+`;
`)}for(let h=0;h<Gi.varmodes.length;++h){let u=Gi.varmodes[h],c=getOutputLinkID(this,h);if(c){var l=GLSL_types_const[u.length-1];a+="	"+l+" "+c+" = "+s+"."+u+`;
`,this.setOutputData(h,l)}}t.addCode("code",a,this.shader_destination)}}};g(it,"title","vec4"),g(it,"varmodes",["xyzw","xyz","x","y","z","w","xy","yz","zw"]);let LGraphShaderVec4=it;registerShaderNode("const/vec4",LGraphShaderVec4);class LGraphShaderFragColor{constructor(){this.addInput("color",LGShaders.ALL_TYPES),this.block_delete=!0}onGetCode(t){var r=getInputLinkID(this,0);if(r){var s=this.getInputData(0),a=varToTypeGLSL(r,s,"vec4");t.addCode("fs_code","fragcolor = "+a+";")}}}g(LGraphShaderFragColor,"title","FragColor"),g(LGraphShaderFragColor,"desc","Pixel final color"),registerShaderNode("output/fragcolor",LGraphShaderFragColor);const Lt=class lr{constructor(){this.addInput("A",LGShaders.ALL_TYPES),this.addInput("B",LGShaders.ALL_TYPES),this.addOutput("out",""),this.properties={operation:"*"},this.addWidget("combo","op.",this.properties.operation,{property:"operation",values:lr.operations})}getTitle(){return this.flags.collapsed?"A"+this.properties.operation+"B":"Operation"}onGetCode(t){if(this.shader_destination&&this.isOutputConnected(0)){var r=[];for(let _=0;_<3;++_)r.push({name:getInputLinkID(this,_),type:this.getInputData(_)||"float"});var s=getOutputLinkID(this,0);if(s){var a=r[0].type,l=a,h=this.properties.operation,u=[];for(let _=0;_<2;++_){var c=r[_].name;c==null&&(c=p.value!=null?p.value:"(1.0)",r[_].type="float"),r[_].type!=a&&(r[_].type=="float"&&(h=="*"||h=="/")||(c=convertVarToGLSLType(c,r[_].type,a))),u.push(c)}t.addCode("code",l+" "+s+" = "+u[0]+h+u[1]+";",this.shader_destination),this.setOutputData(0,l)}}}};g(Lt,"title","Operation"),g(Lt,"operations",["+","-","*","/"]);let LGraphShaderOperation=Lt;registerShaderNode("math/operation",LGraphShaderOperation);class LGraphShaderFunc{constructor(){this.addInput("A",LGShaders.ALL_TYPES),this.addInput("B",LGShaders.ALL_TYPES),this.addOutput("out",""),this.properties={func:"floor"},this._current="floor",this.addWidget("combo","func",this.properties.func,{property:"func",values:GLSL_functions_name})}onPropertyChanged(t,r){if(this.graph&&this.graph._version++,t=="func"){var s=GLSL_functions[r];if(!s)return;for(let l=s.params.length;l<this.inputs.length;++l)this.removeInput(l);for(let l=0;l<s.params.length;++l){var a=s.params[l];this.inputs[l]?this.inputs[l].name=a.name+(a.value?" ("+a.value+")":""):this.addInput(a.name,LGShaders.ALL_TYPES)}}}getTitle(){return this.flags.collapsed?this.properties.func:"Func"}onGetCode(t){if(this.shader_destination&&this.isOutputConnected(0)){var r=[];for(let d=0;d<3;++d)r.push({name:getInputLinkID(this,d),type:this.getInputData(d)||"float"});var s=getOutputLinkID(this,0);if(s){var a=GLSL_functions[this.properties.func];if(a){var l=r[0].type,h=a.return_type;h=="T"&&(h=l);var u=[];for(let d=0;d<a.params.length;++d){var c=a.params[d],_=r[d].name;_==null&&(_=c.value!=null?c.value:"(1.0)",r[d].type="float"),(c.type=="T"&&r[d].type!=l||c.type!="T"&&r[d].type!=l)&&(_=convertVarToGLSLType(_,r[d].type,l)),u.push(_)}t.addFunction("round",`float round(float v){ return floor(v+0.5); }
vec2 round(vec2 v){ return floor(v+vec2(0.5));}
vec3 round(vec3 v){ return floor(v+vec3(0.5));}
vec4 round(vec4 v){ return floor(v+vec4(0.5)); }
`),t.addCode("code",h+" "+s+" = "+a.func+"("+u.join(",")+");",this.shader_destination),this.setOutputData(0,h)}}}}}g(LGraphShaderFunc,"title","Func"),registerShaderNode("math/func",LGraphShaderFunc);class LGraphShaderSnippet{constructor(){this.addInput("A",LGShaders.ALL_TYPES),this.addInput("B",LGShaders.ALL_TYPES),this.addOutput("C","vec4"),this.properties={code:"C = A+B",type:"vec4"},this.addWidget("text","code",this.properties.code,{property:"code"}),this.addWidget("combo","type",this.properties.type,{values:["float","vec2","vec3","vec4"],property:"type"})}onPropertyChanged(t,r){this.graph&&this.graph._version++,t=="type"&&this.outputs[0].type!=r&&(this.disconnectOutput(0),this.outputs[0].type=r)}getTitle(){return this.flags.collapsed?this.properties.code:"Snippet"}onGetCode(t){if(!(!this.shader_destination||!this.isOutputConnected(0))){var r=getInputLinkID(this,0);r||(r="1.0");var s=getInputLinkID(this,1);s||(s="1.0");var a=getOutputLinkID(this,0);if(a){var l=this.getInputData(0)||"float",h=this.getInputData(1)||"float",u=this.properties.type;if(l=="T"||h=="T")return null;var c="funcSnippet"+this.id,_=`
`+u+" "+c+"( "+l+" A, "+h+` B) {
`;_+="	"+u+" C = "+u+`(0.0);
`,_+="	"+this.properties.code+`;
`,_+=`	return C;
}
`,t.addCode("functions",_,this.shader_destination),t.addCode("code",u+" "+a+" = "+c+"("+r+","+s+");",this.shader_destination),this.setOutputData(0,u)}}}}g(LGraphShaderSnippet,"title","Snippet"),registerShaderNode("utils/snippet",LGraphShaderSnippet);class LGraphShaderRand{constructor(){this.addOutput("out","float")}onGetCode(t){if(!(!this.shader_destination||!this.isOutputConnected(0))){var r=getOutputLinkID(this,0);t.addUniform("u_rand"+this.id,"float",function(){return Math.random()}),t.addCode("code","float "+r+" = u_rand"+this.id+";",this.shader_destination),this.setOutputData(0,"float")}}}g(LGraphShaderRand,"title","Rand"),registerShaderNode("input/rand",LGraphShaderRand);const pt=class Yi{constructor(){this.addInput("out",LGShaders.ALL_TYPES),this.addInput("scale","float"),this.addOutput("out","float"),this.properties={type:"noise",scale:1},this.addWidget("combo","type",this.properties.type,{property:"type",values:Yi.NOISE_TYPES}),this.addWidget("number","scale",this.properties.scale,{property:"scale"})}onGetCode(t){if(!(!this.shader_destination||!this.isOutputConnected(0))){var r=getInputLinkID(this,0),s=getOutputLinkID(this,0),a=this.getInputData(0);r||(a="vec2",r=t.buffer_names.uvs),t.addFunction("noise",Yi.shader_functions),t.addUniform("u_noise_scale"+this.id,"float",this.properties.scale),a=="float"?t.addCode("code","float "+s+" = snoise( vec2("+r+") * u_noise_scale"+this.id+");",this.shader_destination):a=="vec2"||a=="vec3"?t.addCode("code","float "+s+" = snoise("+r+" * u_noise_scale"+this.id+");",this.shader_destination):a=="vec4"&&t.addCode("code","float "+s+" = snoise("+r+".xyz * u_noise_scale"+this.id+");",this.shader_destination),this.setOutputData(0,"float")}}};g(pt,"NOISE_TYPES",["noise","rand"]),g(pt,"title","noise"),g(pt,"shader_functions",`
        vec3 permute(vec3 x) { return mod(((x * 34.0) + 1.0) * x, 289.0); }

        float snoise(vec2 v) {
            const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
            vec2 i = floor(v + dot(v, C.yy));
            vec2 x0 = v - i + dot(i, C.xx);
            vec2 i1;
            i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
            vec4 x12 = x0.xyxy + C.xxzz;
            x12.xy -= i1;
            i = mod(i, 289.0);
            vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
            vec3 m = max(0.5 - vec3(dot(x0, x0), dot(x12.xy, x12.xy), dot(x12.zw, x12.zw)), 0.0);
            m = m * m ;
            m = m * m ;
            vec3 x = 2.0 * fract(p * C.www) - 1.0;
            vec3 h = abs(x) - 0.5;
            vec3 ox = floor(x + 0.5);
            vec3 a0 = x - ox;
            m *= 1.79284291400159 - 0.85373472095314 * (a0 * a0 + h * h);
            vec3 g;
            g.x = a0.x  * x0.x + h.x  * x0.y;
            g.yz = a0.yz * x12.xz + h.yz * x12.yw;
            return 130.0 * dot(m, g);
        }

        vec4 permute(vec4 x) { return mod(((x * 34.0) + 1.0) * x, 289.0); }

        vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }

        float snoise(vec3 v) {
            const vec2 C = vec2(1.0/6.0, 1.0/3.0);
            const vec4 D = vec4(0.0, 0.5, 1.0, 2.0);

            vec3 i  = floor(v + dot(v, C.yyy));
            vec3 x0 = v - i + dot(i, C.xxx);

            vec3 g = step(x0.yzx, x0.xyz);
            vec3 l = 1.0 - g;
            vec3 i1 = min(g.xyz, l.zxy);
            vec3 i2 = max(g.xyz, l.zxy);

            vec3 x1 = x0 - i1 + 1.0 * C.xxx;
            vec3 x2 = x0 - i2 + 2.0 * C.xxx;
            vec3 x3 = x0 - 1.0 + 3.0 * C.xxx;

            i = mod(i, 289.0);
            vec4 p = permute(permute(permute(i.z + vec4(0.0, i1.z, i2.z, 1.0)) + i.y + vec4(0.0, i1.y, i2.y, 1.0)) + i.x + vec4(0.0, i1.x, i2.x, 1.0));

            float n_ = 1.0 / 7.0;
            vec3 ns = n_ * D.wyz - D.xzx;

            vec4 j = p - 49.0 * floor(p * ns.z * ns.z);

            vec4 x_ = floor(j * ns.z);
            vec4 y_ = floor(j - 7.0 * x_);
            
            vec4 x = x_ * ns.x + ns.yyyy;
            vec4 y = y_ * ns.x + ns.yyyy;
            vec4 h = 1.0 - abs(x) - abs(y);
            
            vec4 b0 = vec4(x.xy, y.xy);
            vec4 b1 = vec4(x.zw, y.zw);
            
            vec4 s0 = floor(b0) * 2.0 + 1.0;
            vec4 s1 = floor(b1) * 2.0 + 1.0;
            vec4 sh = -step(h, vec4(0.0));
            
            vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy;
            vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww;
            
            vec3 p0 = vec3(a0.xy, h.x);
            vec3 p1 = vec3(a0.zw, h.y);
            vec3 p2 = vec3(a1.xy, h.z);
            vec3 p3 = vec3(a1.zw, h.w);
            
            vec4 norm = taylorInvSqrt(vec4(dot(p0, p0), dot(p1, p1), dot(p2, p2), dot(p3, p3)));
            p0 *= norm.x;
            p1 *= norm.y;
            p2 *= norm.z;
            p3 *= norm.w;
            
            vec4 m = max(0.6 - vec4(dot(x0, x0), dot(x1, x1), dot(x2, x2), dot(x3, x3)), 0.0);
            m = m * m;
            
            return 42.0 * dot(m * m, vec4(dot(p0, x0), dot(p1, x1), dot(p2, x2), dot(p3, x3)));
        }

        vec3 hash3(vec2 p) {
            vec3 q = vec3(dot(p, vec2(127.1, 311.7)),
                        dot(p, vec2(269.5, 183.3)),
                        dot(p, vec2(419.2, 371.9)));
            return fract(sin(q) * 43758.5453);
        }

        vec4 hash4(vec3 p) {
            vec4 q = vec4(dot(p, vec3(127.1, 311.7, 257.3)),
                        dot(p, vec3(269.5, 183.3, 335.1)),
                        dot(p, vec3(314.5, 235.1, 467.3)),
                        dot(p, vec3(419.2, 371.9, 114.9)));
            return fract(sin(q) * 43758.5453);
        }

        float iqnoise(in vec2 x, float u, float v) {
            vec2 p = floor(x);
            vec2 f = fract(x);
            
            float k = 1.0 + 63.0 * pow(1.0 - v, 4.0);
            
            float va = 0.0;
            float wt = 0.0;
            for (int j = -2; j <= 2; j++)
                for (int i = -2; i <= 2; i++) {
                    vec2 g = vec2(float(i), float(j));
                    vec3 o = hash3(p + g) * vec3(u, u, 1.0);
                    vec2 r = g - f + o.xy;
                    float d = dot(r, r);
                    float ww = pow(1.0 - smoothstep(0.0, 1.414, sqrt(d)), k);
                    va += o.z * ww;
                    wt += ww;
                }
            
            return va / wt;
        }
    `);let LGraphShaderNoise=pt;registerShaderNode("math/noise",LGraphShaderNoise);class LGraphShaderTime{constructor(){this.addOutput("out","float")}onGetCode(t){if(!(!this.shader_destination||!this.isOutputConnected(0))){var r=getOutputLinkID(this,0);t.addUniform("u_time"+this.id,"float",function(){return getTime()*.001}),t.addCode("code","float "+r+" = u_time"+this.id+";",this.shader_destination),this.setOutputData(0,"float")}}}g(LGraphShaderTime,"title","Time"),registerShaderNode("input/time",LGraphShaderTime);const dt=class hr{constructor(){this.addInput("in","T"),this.addOutput("out","float")}onGetCode(t){if(!(!this.shader_destination||!this.isOutputConnected(0))){var r=getInputLinkID(this,0),s="float",a=getOutputLinkID(this,0),l=this.getInputData(0);r=varToTypeGLSL(r,l,"float"),t.addFunction("dither8x8",hr.dither_func),t.addCode("code",s+" "+a+" = dither8x8("+r+");",this.shader_destination),this.setOutputData(0,s)}}};g(dt,"title","Dither"),g(dt,"dither_values",[.515625,.140625,.640625,.046875,.546875,.171875,.671875,.765625,.265625,.890625,.390625,.796875,.296875,.921875,.421875,.203125,.703125,.078125,.578125,.234375,.734375,.109375,.609375,.953125,.453125,.828125,.328125,.984375,.484375,.859375,.359375,.0625,.5625,.1875,.6875,.03125,.53125,.15625,.65625,.8125,.3125,.9375,.4375,.78125,.28125,.90625,.40625,.25,.75,.125,.625,.21875,.71875,.09375,.59375,1.0001,.5,.875,.375,.96875,.46875,.84375,.34375]),g(dt,"dither_func",`
        float dither8x8(float brightness) {
            vec2 position = vec2(0.0);
            #ifdef FRAGMENT
            position = gl_FragCoord.xy;
            #endif
            int x = int(mod(position.x, 8.0));
            int y = int(mod(position.y, 8.0));
            int index = x + y * 8;
            float limit = 0.0;
            if (x < 8) {
                if (index == 0) limit = 0.015625;
                // Add more conditions or code here if needed
                // Example: if (condition) { ... }
            }
            ${dt.dither_values.map((o,t)=>`else if (index == ${t+1}) limit = ${o};`).join(`
`)}
            return brightness < limit ? 0.0 : 1.0;
        }
    `);let LGraphShaderDither=dt;registerShaderNode("math/dither",LGraphShaderDither);class LGraphShaderRemap{constructor(){this.addInput("",LGShaders.ALL_TYPES),this.addOutput("",""),this.properties={min_value:0,max_value:1,min_value2:0,max_value2:1},this.addWidget("number","min",0,{step:.1,property:"min_value"}),this.addWidget("number","max",1,{step:.1,property:"max_value"}),this.addWidget("number","min2",0,{step:.1,property:"min_value2"}),this.addWidget("number","max2",1,{step:.1,property:"max_value2"})}onPropertyChanged(){this.graph&&this.graph._version++}onConnectionsChange(){var t=this.getInputDataType(0);this.outputs[0].type=t||"T"}onGetCode(t){var r;if(!(!this.shader_destination||!this.isOutputConnected(0))){var s=getInputLinkID(this,0),a=getOutputLinkID(this,0);if(!(!s&&!a)){var l=this.getInputDataType(0);if(this.outputs[0].type=l,l=="T"){(r=console.warn)==null||r.call(console,"node type is T and cannot be resolved");return}if(!s){t.addCode("code","	"+l+" "+a+" = "+l+`(0.0);
`);return}var h=valueToGLSL(this.properties.min_value),u=valueToGLSL(this.properties.max_value),c=valueToGLSL(this.properties.min_value2),_=valueToGLSL(this.properties.max_value2);t.addCode("code",`${l} ${a} = ( (${s} - ${h}) / (${u} - ${h}) ) * (${_} - ${c}) + ${c};`,this.shader_destination),this.setOutputData(0,l)}}}}g(LGraphShaderRemap,"title","Remap"),registerShaderNode("math/remap",LGraphShaderRemap);function generateGeometryId(){return Math.random()*1e5|0}const j=class nt{constructor(){this.addInput("obj",""),this.addInput("radius","number"),this.addOutput("out","geometry"),this.addOutput("points","[vec3]"),this.properties={radius:1,num_points:4096,generate_normals:!0,regular:!1,mode:nt.SPHERE,force_update:!1},this.points=new Float32Array(this.properties.num_points*3),this.normals=new Float32Array(this.properties.num_points*3),this.must_update=!0,this.version=0;var t=this;this.addWidget("button","update",null,function(){t.must_update=!0}),this.geometry={vertices:null,_id:generateGeometryId()},this._old_obj=null,this._last_radius=null}onPropertyChanged(t,r){this.must_update=!0}onExecute(){var t=this.getInputData(0);(t!=this._old_obj||t&&t._version!=this._old_obj_version)&&(this._old_obj=t,this.must_update=!0);var r=this.getInputData(1);r==null&&(r=this.properties.radius),this._last_radius!=r&&(this._last_radius=r,this.must_update=!0),(this.must_update||this.properties.force_update)&&(this.must_update=!1,this.updatePoints()),this.geometry.vertices=this.points,this.geometry.normals=this.normals,this.geometry._version=this.version,this.setOutputData(0,this.geometry)}updatePoints(){var t=this.properties.num_points|0;t<1&&(t=1),(!this.points||this.points.length!=t*3)&&(this.points=new Float32Array(t*3)),this.properties.generate_normals?(!this.normals||this.normals.length!=this.points.length)&&(this.normals=new Float32Array(this.points.length)):this.normals=null;var r=this._last_radius||this.properties.radius,s=this.properties.mode,a=this.getInputData(0);this._old_obj_version=a?a._version:null,this.points=nt.generatePoints(r,t,s,this.points,this.normals,this.properties.regular,a),this.version++}static generatePoints(t,r,s,a,l,h,u){var c,_=r*3;(!a||a.length!=_)&&(a=new Float32Array(_));var d=new Float32Array(3),f=new Float32Array([0,1,0]);if(h){if(s==nt.RECTANGLE){let m=Math.floor(Math.sqrt(r));for(let b=0;b<m;++b)for(let T=0;T<m;++T){let L=b*3+T*3*m;a[L]=(b/m-.5)*t*2,a[L+1]=0,a[L+2]=(T/m-.5)*t*2}if(a=new Float32Array(a.subarray(0,m*m*3)),l)for(let b=0;b<l.length;b+=3)l.set(f,b)}else if(s==nt.SPHERE){let m=Math.floor(Math.sqrt(r));for(let b=0;b<m;++b)for(let T=0;T<m;++T){let L=b*3+T*3*m;GL.polarToCartesian(d,b/m*2*Math.PI,(T/m-.5)*2*Math.PI,t),a[L]=d[0],a[L+1]=d[1],a[L+2]=d[2]}a=new Float32Array(a.subarray(0,m*m*3)),l&&nt.generateSphericalNormals(a,l)}else if(s==nt.CIRCLE){for(let m=0;m<_;m+=3){let b=2*Math.PI*(m/_);a[m]=Math.cos(b)*t,a[m+1]=0,a[m+2]=Math.sin(b)*t}if(l)for(let m=0;m<l.length;m+=3)l.set(f,m)}}else if(s==nt.RECTANGLE){for(let m=0;m<_;m+=3)a[m]=(Math.random()-.5)*t*2,a[m+1]=0,a[m+2]=(Math.random()-.5)*t*2;if(l)for(let m=0;m<l.length;m+=3)l.set(f,m)}else if(s==nt.CUBE){for(let m=0;m<_;m+=3)a[m]=(Math.random()-.5)*t*2,a[m+1]=(Math.random()-.5)*t*2,a[m+2]=(Math.random()-.5)*t*2;if(l)for(let m=0;m<l.length;m+=3)l.set(f,m)}else s==nt.SPHERE?(nt.generateSphere(a,_,t),l&&nt.generateSphericalNormals(a,l)):s==nt.HEMISPHERE?(nt.generateHemisphere(a,_,t),l&&nt.generateSphericalNormals(a,l)):s==nt.CIRCLE?(nt.generateInsideCircle(a,_,t),l&&nt.generateSphericalNormals(a,l)):s==nt.INSIDE_SPHERE?(nt.generateInsideSphere(a,_,t),l&&nt.generateSphericalNormals(a,l)):s==nt.OBJECT?nt.generateFromObject(a,l,_,u,!1):s==nt.OBJECT_UNIFORMLY?nt.generateFromObject(a,l,_,u,!0):s==nt.OBJECT_INSIDE?nt.generateFromInsideObject(a,_,u):(c=console.warn)==null||c.call(console,"wrong mode in LGraphPoints3D");return a}static generateSphericalNormals(t,r){for(var s=new Float32Array(3),a=0;a<r.length;a+=3)s[0]=t[a],s[1]=t[a+1],s[2]=t[a+2],vec3.normalize(s,s),r.set(s,a)}static generateSphere(t,r,s){for(var a=0;a<r;a+=3){var l=Math.random(),h=Math.random(),u=2*Math.cos(2*Math.PI*l)*Math.sqrt(h*(1-h)),c=1-2*h,_=2*Math.sin(2*Math.PI*l)*Math.sqrt(h*(1-h));t[a]=u*s,t[a+1]=c*s,t[a+2]=_*s}}static generateHemisphere(t,r,s){for(var a=0;a<r;a+=3){var l=Math.random(),h=Math.random(),u=Math.cos(2*Math.PI*l)*Math.sqrt(1-h*h),c=h,_=Math.sin(2*Math.PI*l)*Math.sqrt(1-h*h);t[a]=u*s,t[a+1]=c*s,t[a+2]=_*s}}static generateInsideCircle(t,r,s){for(var a=0;a<r;a+=3){var l=Math.random(),h=Math.random(),u=Math.cos(2*Math.PI*l)*Math.sqrt(1-h*h),c=Math.sin(2*Math.PI*l)*Math.sqrt(1-h*h);t[a]=u*s,t[a+1]=0,t[a+2]=c*s}}static generateInsideSphere(t,r,s){for(var a=0;a<r;a+=3){var l=Math.random(),h=Math.random(),u=l*2*Math.PI,c=Math.acos(2*h-1),_=Math.cbrt(Math.random())*s,d=Math.sin(u),f=Math.cos(u),m=Math.sin(c),b=Math.cos(c);t[a]=_*m*f,t[a+1]=_*m*d,t[a+2]=_*b}}static generateFromObject(t,r,s,a,l){if(!a)return;var h=null,u=null,c=null,_=null;function d(F,W){var z=F.length,U=0,V=0,X=z;if(z==0)return-1;if(z==1)return 0;for(;X>=U;){V=(X+U)*.5|0;var J=F[V];if(J==W)return V;if(U==X-1)return U;J<W?U=V:X=V}return V}if(a.constructor===GL.Mesh&&(h=a.vertexBuffers.vertices.data,u=a.vertexBuffers.normals?a.vertexBuffers.normals.data:null,c=a.indexBuffers.indices?a.indexBuffers.indices.data:null,c||(c=a.indexBuffers.triangles?a.indexBuffers.triangles.data:null)),!h)return null;var f=c?c.length/3:h.length/9,m=0;if(l){_=new Float32Array(f);for(let F=0;F<f;++F){c?(C=c[F*3]*3,R=c[F*3+1]*3,S=c[F*3+2]*3):(C=F*9,R=F*9+3,S=F*9+6);var b=h.subarray(C,C+3),T=h.subarray(R,R+3),L=h.subarray(S,S+3),G=vec3.distance(b,T),I=vec3.distance(T,L),O=vec3.distance(L,b),E=(G+I+O)/2;m+=Math.sqrt(E*(E-G)*(E-I)*(E-O)),_[F]=m}for(let F=0;F<f;++F)_[F]/=m}for(let F=0;F<s;F+=3){var D=Math.random(),N=l?d(_,D):Math.floor(D*f),C=0,R=0,S=0;c?(C=c[N*3]*3,R=c[N*3+1]*3,S=c[N*3+2]*3):(C=N*9,R=N*9+3,S=N*9+6);var E=Math.random(),P=Math.random(),M=Math.sqrt(E),A=1-M,B=M*(1-P),$=P*M;if(t[F]=A*h[C]+B*h[R]+$*h[S],t[F+1]=A*h[C+1]+B*h[R+1]+$*h[S+1],t[F+2]=A*h[C+2]+B*h[R+2]+$*h[S+2],r&&u){r[F]=A*u[C]+B*u[R]+$*u[S],r[F+1]=A*u[C+1]+B*u[R+1]+$*u[S+1],r[F+2]=A*u[C+2]+B*u[R+2]+$*u[S+2];var H=r.subarray(F,F+3);vec3.normalize(H,H)}}}static generateFromInsideObject(t,r,s){if(!(!s||s.constructor!==GL.Mesh)){var a=s.getBoundingBox();s.octree||(s.octree=new GL.Octree(s));for(var l=s.octree,h=vec3.create(),u=vec3.fromValues(1,0,0),c=vec3.create(),_=0,d=0;_<r&&d<t.length*10;){d+=1;var f=vec3.random(c);f[0]=(f[0]*2-1)*a[3]+a[0],f[1]=(f[1]*2-1)*a[4]+a[1],f[2]=(f[2]*2-1)*a[5]+a[2],h.set(f);var m=l.testRay(h,u,0,1e4,!0,GL.Octree.ALL);!m||m.length%2==0||(t.set(f,_),_+=3)}}}};g(j,"RECTANGLE",1),g(j,"CIRCLE",2),g(j,"CUBE",10),g(j,"SPHERE",11),g(j,"HEMISPHERE",12),g(j,"INSIDE_SPHERE",13),g(j,"OBJECT",20),g(j,"OBJECT_UNIFORMLY",21),g(j,"OBJECT_INSIDE",22),g(j,"MODE_VALUES",{rectangle:j.RECTANGLE,circle:j.CIRCLE,cube:j.CUBE,sphere:j.SPHERE,hemisphere:j.HEMISPHERE,inside_sphere:j.INSIDE_SPHERE,object:j.OBJECT,object_uniformly:j.OBJECT_UNIFORMLY,object_inside:j.OBJECT_INSIDE}),g(j,"widgets_info",{mode:{widget:"combo",values:j.MODE_VALUES}}),g(j,"title","list of points"),g(j,"desc","returns an array of points");let LGraphPoints3D=j;LiteGraph.registerNodeType("geometry/points3D",LGraphPoints3D);const he=class ui{constructor(){this.addInput("points","geometry"),this.addOutput("instances","[mat4]"),this.properties={mode:1,autoupdate:!0},this.must_update=!0,this.matrices=[],this.first_time=!0}onExecute(){var t=this.getInputData(0);if(!t){this.setOutputData(0,null);return}if(this.isOutputConnected(0)){var r=t._version!=this._version||t._id!=this._geometry_id;(r&&this.properties.autoupdate||this.first_time)&&(this.first_time=!1,this.updateInstances(t)),this.setOutputData(0,this.matrices)}}updateInstances(t){var r=t.vertices;if(!r)return null;var s=t.normals,a=this.matrices,l=r.length/3;a.length!=l&&(a.length=l);for(var h=mat4.create(),u=vec3.create(),c=vec3.fromValues(0,1,0),_=vec3.fromValues(0,0,-1),d=quat.create(),f=vec3.create(),m=vec3.create(),b=vec3.create(),T=0;T<r.length;T+=3){var L=T/3,G=a[L];G||(G=a[L]=mat4.create()),G.set(h);var I=r.subarray(T,T+3);switch(this.properties.mode){case ui.NORMAL:if(mat4.setTranslation(G,I),s){var O=s.subarray(T,T+3);b.set(O),vec3.normalize(b,b),vec3.cross(m,_,b),vec3.normalize(m,m),vec3.cross(f,m,b),vec3.normalize(f,f),G.set(m,0),G.set(b,4),G.set(f,8),mat4.setTranslation(G,I)}break;case ui.VERTICAL:mat4.setTranslation(G,I);break;case ui.SPHERICAL:f.set(I),vec3.normalize(f,f),vec3.cross(m,c,f),vec3.normalize(m,m),vec3.cross(b,f,m),vec3.normalize(b,b),G.set(m,0),G.set(b,4),G.set(f,8),mat4.setTranslation(G,I);break;case ui.RANDOM:u[0]=Math.random()*2-1,u[1]=Math.random()*2-1,u[2]=Math.random()*2-1,vec3.normalize(u,u),quat.setAxisAngle(d,u,Math.random()*2*Math.PI),mat4.fromQuat(G,d),mat4.setTranslation(G,I);break;case ui.RANDOM_VERTICAL:quat.setAxisAngle(d,c,Math.random()*2*Math.PI),mat4.fromQuat(G,d),mat4.setTranslation(G,I);break}}this._version=t._version,this._geometry_id=t._id}};g(he,"NORMAL",0),g(he,"VERTICAL",1),g(he,"SPHERICAL",2),g(he,"RANDOM",3),g(he,"RANDOM_VERTICAL",4),g(he,"modes",{normal:0,vertical:1,spherical:2,random:3,random_vertical:4}),g(he,"widgets_info",{mode:{widget:"combo",values:he.modes}}),g(he,"title","points to inst");let LGraphPointsToInstances=he;LiteGraph.registerNodeType("geometry/points_to_instances",LGraphPointsToInstances);class LGraphGeometryTransform{constructor(){this.addInput("in","geometry,[mat4]"),this.addInput("mat4","mat4"),this.addOutput("out","geometry"),this.properties={},this.geometry={type:"triangles",vertices:null,_id:generateGeometryId(),_version:0},this._last_geometry_id=-1,this._last_version=-1,this._last_key="",this.must_update=!0}onExecute(){var t=this.getInputData(0),r=this.getInputData(1);if(t){if(t.constructor===Array){if(t.length==0||(this.outputs[0].type="[mat4]",!this.isOutputConnected(0)))return;if(!r){this.setOutputData(0,t);return}this._output||(this._output=new Array),this._output.length!=t.length&&(this._output.length=t.length);for(var s=0;s<t.length;++s){var a=this._output[s];a||(a=this._output[s]=mat4.create()),mat4.multiply(a,t[s],r)}this.setOutputData(0,this._output);return}if(!(!t.vertices||!t.vertices.length)){var l=t;if(this.outputs[0].type="geometry",!!this.isOutputConnected(0)){if(!r){this.setOutputData(0,l);return}var h=Array.from(r).join(",");(this.must_update||l._id!=this._last_geometry_id||l._version!=this._last_version||h!=this._last_key)&&(this.updateGeometry(l,r),this._last_key=h,this._last_version=l._version,this._last_geometry_id=l._id,this.must_update=!1),this.setOutputData(0,this.geometry)}}}}updateGeometry(t,r){var s=t.vertices,a=this.geometry.vertices;(!a||a.length!=s.length)&&(a=this.geometry.vertices=new Float32Array(s.length));var l=vec3.create();for(let _=0,d=a.length;_<d;_+=3)l[0]=s[_],l[1]=s[_+1],l[2]=s[_+2],mat4.multiplyVec3(l,r,l),a[_]=l[0],a[_+1]=l[1],a[_+2]=l[2];if(t.normals){(!this.geometry.normals||this.geometry.normals.length!=t.normals.length)&&(this.geometry.normals=new Float32Array(t.normals.length));var h=this.geometry.normals,u=mat4.invert(mat4.create(),r);u&&mat4.transpose(u,u);var c=t.normals;for(let _=0,d=h.length;_<d;_+=3)l[0]=c[_],l[1]=c[_+1],l[2]=c[_+2],mat4.multiplyVec3(l,u,l),h[_]=l[0],h[_+1]=l[1],h[_+2]=l[2]}this.geometry.type=t.type,this.geometry._version++}}g(LGraphGeometryTransform,"title","Transform"),LiteGraph.registerNodeType("geometry/transform",LGraphGeometryTransform);class LGraphGeometryPolygon{constructor(){this.addInput("sides","number"),this.addInput("radius","number"),this.addOutput("out","geometry"),this.properties={sides:6,radius:1,uvs:!1},this.geometry={type:"line_loop",vertices:null,_id:generateGeometryId()},this.geometry_id=-1,this.version=-1,this.must_update=!0,this.last_info={sides:-1,radius:-1}}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputOrProperty("sides"),r=this.getInputOrProperty("radius");t=Math.max(3,t)|0,(this.last_info.sides!=t||this.last_info.radius!=r)&&this.updateGeometry(t,r),this.setOutputData(0,this.geometry)}}updateGeometry(t,r){var s=3*t,a=this.geometry.vertices;(!a||a.length!=s)&&(a=this.geometry.vertices=new Float32Array(3*t));var l=Math.PI*2/t,h=this.properties.uvs;h&&(uvs=this.geometry.coords=new Float32Array(3*t));for(var u=0;u<t;++u){var c=l*-u,_=Math.cos(c)*r,d=0,f=Math.sin(c)*r;a[u*3]=_,a[u*3+1]=d,a[u*3+2]=f}this.geometry._id=++this.geometry_id,this.geometry._version=++this.version,this.last_info.sides=t,this.last_info.radius=r}}g(LGraphGeometryPolygon,"title","Polygon"),LiteGraph.registerNodeType("geometry/polygon",LGraphGeometryPolygon);class LGraphGeometryExtrude{constructor(){this.addInput("","geometry"),this.addOutput("","geometry"),this.properties={top_cap:!0,bottom_cap:!0,offset:[0,100,0]},this.version=-1,this._last_geo_version=-1,this._must_update=!0}onPropertyChanged(t,r){this._must_update=!0}onExecute(){var t=this.getInputData(0);!t||!this.isOutputConnected(0)||((t.version!=this._last_geo_version||this._must_update)&&(this._geo=this.extrudeGeometry(t,this._geo),this._geo&&(this._geo.version=this.version++),this._must_update=!1),this.setOutputData(0,this._geo))}extrudeGeometry(t){var r=t.vertices,s=r.length/3,a=vec3.create(),l=vec3.create(),h=vec3.create(),u=vec3.create(),c=new Float32Array(this.properties.offset);if(t.type=="line_loop")for(var _=new Float32Array(s*6*3),d=0,f=0,m=r.length;f<m;f+=3)a[0]=r[f],a[1]=r[f+1],a[2]=r[f+2],f+3<m?(l[0]=r[f+3],l[1]=r[f+4],l[2]=r[f+5]):(l[0]=r[0],l[1]=r[1],l[2]=r[2]),vec3.add(h,a,c),vec3.add(u,l,c),_.set(a,d),d+=3,_.set(l,d),d+=3,_.set(h,d),d+=3,_.set(l,d),d+=3,_.set(u,d),d+=3,_.set(h,d),d+=3;var b={_id:generateGeometryId(),type:"triangles",vertices:_};return b}}g(LGraphGeometryExtrude,"title","extrude"),LiteGraph.registerNodeType("geometry/extrude",LGraphGeometryExtrude);class LGraphGeometryEval{constructor(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={code:"V[1] += 0.01 * Math.sin(I + T*0.001);",execute_every_frame:!1},this.geometry=null,this.geometry_id=-1,this.version=-1,this.must_update=!0,this.vertices=null,this.func=null}onConfigure(){this.compileCode()}compileCode(){if(this.properties.code)try{this.func=new Function("V","I","T",this.properties.code),this.boxcolor="#AFA",this.must_update=!0}catch{this.boxcolor="red"}}onPropertyChanged(t,r){t=="code"&&(this.properties.code=r,this.compileCode())}onExecute(){var t=this.getInputData(0);if(t){if(!this.func){this.setOutputData(0,t);return}if(this.geometry_id!=t._id||this.version!=t._version||this.must_update||this.properties.execute_every_frame){this.must_update=!1,this.geometry_id=t._id,this.properties.execute_every_frame?this.version++:this.version=t._version;var r=this.func,s=getTime();this.geometry||(this.geometry={});for(let h in t)t[h]!=null&&(t[h].constructor==Float32Array?this.geometry[h]=new Float32Array(t[h]):this.geometry[h]=t[h]);this.geometry._id=t._id,this.properties.execute_every_frame?this.geometry._version=this.version:this.geometry._version=t._version+1;var a=vec3.create(),l=this.vertices;!l||this.vertices.length!=t.vertices.length?l=this.vertices=new Float32Array(t.vertices):l.set(t.vertices);for(let h=0;h<l.length;h+=3)a[0]=l[h],a[1]=l[h+1],a[2]=l[h+2],r(a,h/3,s),l[h]=a[0],l[h+1]=a[1],l[h+2]=a[2];this.geometry.vertices=l}this.setOutputData(0,this.geometry)}}}g(LGraphGeometryEval,"title","geoeval"),g(LGraphGeometryEval,"desc","eval code"),g(LGraphGeometryEval,"widgets_info",{code:{widget:"code"}}),LiteGraph.registerNodeType("geometry/eval",LGraphGeometryEval);class LGraphConnectPoints{constructor(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={min_dist:.4,max_dist:.5,max_connections:0,probability:1},this.geometry_id=-1,this.version=-1,this.my_version=1,this.must_update=!0}onPropertyChanged(t,r){this.must_update=!0}onExecute(){var t=this.getInputData(0);if(t){if(this.geometry_id!=t._id||this.version!=t._version||this.must_update){this.must_update=!1,this.geometry_id=t._id,this.version=t._version,this.geometry={};for(let I in t)this.geometry[I]=t[I];this.geometry._id=generateGeometryId(),this.geometry._version=this.my_version++;var r=t.vertices,s=r.length,a=this.properties.min_dist,l=this.properties.max_dist,h=this.properties.probability,u=this.properties.max_connections,c=[];for(let I=0;I<s;I+=3){var _=r[I],d=r[I+1],f=r[I+2],m=0;for(let O=I+3;O<s;O+=3){var b=r[O],T=r[O+1],L=r[O+2],G=Math.sqrt((_-b)*(_-b)+(d-T)*(d-T)+(f-L)*(f-L));if(!(G>l||G<a||h<1&&h<Math.random())&&(c.push(I/3,O/3),m+=1,u&&m>u))break}}this.geometry.indices=this.indices=new Uint32Array(c)}this.indices&&this.indices.length?(this.geometry.indices=this.indices,this.setOutputData(0,this.geometry)):this.setOutputData(0,null)}}}if(g(LGraphConnectPoints,"title","connect points"),g(LGraphConnectPoints,"desc","adds indices between near points"),LiteGraph.registerNodeType("geometry/connectPoints",LGraphConnectPoints),typeof GL!="undefined"){class o{constructor(){this.addInput("mesh","mesh"),this.addOutput("out","geometry"),this.geometry={},this.last_mesh=null}onExecute(){var c=this.getInputData(0);if(c){if(c!=this.last_mesh){this.last_mesh=c;for(i in c.vertexBuffers){var _=c.vertexBuffers[i];this.geometry[i]=_.data}c.indexBuffers.triangles&&(this.geometry.indices=c.indexBuffers.triangles.data),this.geometry._id=generateGeometryId(),this.geometry._version=0}this.setOutputData(0,this.geometry),this.geometry&&this.setOutputData(1,this.geometry.vertices)}}}g(o,"title","to geometry"),g(o,"desc","converts a mesh to geometry"),LiteGraph.registerNodeType("geometry/toGeometry",o);class t{constructor(){this.addInput("in","geometry"),this.addOutput("mesh","mesh"),this.properties={},this.version=-1,this.mesh=null}updateMesh(c){this.mesh||(this.mesh=new GL.Mesh);for(let L in c)if(L[0]!="_"){var _=c[L],d=GL.Mesh.common_buffers[L];if(!(!d&&L!="indices")){var f=d?d.spacing:3,m=this.mesh.vertexBuffers[L];!m||m.data.length!=_.length?m=new GL.Buffer(L=="indices"?GL.ELEMENT_ARRAY_BUFFER:GL.ARRAY_BUFFER,_,f,GL.DYNAMIC_DRAW):(m.data.set(_),m.upload(GL.DYNAMIC_DRAW)),this.mesh.addBuffer(L,m)}}if(this.mesh.vertexBuffers.normals&&this.mesh.vertexBuffers.normals.data.length!=this.mesh.vertexBuffers.vertices.data.length){var b=new Float32Array([0,1,0]),T=new Float32Array(this.mesh.vertexBuffers.vertices.data.length);for(let L=0;L<T.length;L+=3)T.set(b,L);m=new GL.Buffer(GL.ARRAY_BUFFER,T,3),this.mesh.addBuffer("normals",m)}return this.mesh.updateBoundingBox(),this.geometry_id=this.mesh.id=c._id,this.version=this.mesh.version=c._version,this.mesh}onExecute(){var c=this.getInputData(0);c&&((this.version!=c._version||this.geometry_id!=c._id)&&this.updateMesh(c),this.setOutputData(0,this.mesh))}}g(t,"title","Geo to Mesh"),LiteGraph.registerNodeType("geometry/toMesh",t);const r=class{constructor(){this.addInput("mesh","mesh"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,primitive:GL.TRIANGLES,additive:!1,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.model_matrix=mat4.create(),this.uniforms={u_color:this.color,u_model:this.model_matrix}}onExecute(){var c;if(this.properties.enabled){var _=this.getInputData(0);if(_){(c=console.warn)==null||c.call(console,"cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph");return}}}};g(r,"title","Render Mesh"),g(r,"desc","renders a mesh flat"),g(r,"PRIMITIVE_VALUES",{points:GL.POINTS,lines:GL.LINES,line_loop:GL.LINE_LOOP,line_strip:GL.LINE_STRIP,triangles:GL.TRIANGLES,triangle_fan:GL.TRIANGLE_FAN,triangle_strip:GL.TRIANGLE_STRIP}),g(r,"widgets_info",{primitive:{widget:"combo",values:r.PRIMITIVE_VALUES},color:{widget:"color"}});let s=r;LiteGraph.registerNodeType("geometry/render_mesh",s);const a=class{constructor(){this.addInput("size","number"),this.addOutput("out","mesh"),this.properties={type:1,size:1,subdivisions:32},this.version=Math.random()*1e5|0,this.last_info={type:-1,size:-1,subdivisions:-1}}onExecute(){if(this.isOutputConnected(0)){var c=this.getInputOrProperty("size");(this.last_info.type!=this.properties.type||this.last_info.size!=c||this.last_info.subdivisions!=this.properties.subdivisions)&&this.updateMesh(this.properties.type,c,this.properties.subdivisions),this.setOutputData(0,this._mesh)}}updateMesh(c,_,d){switch(d=Math.max(0,d)|0,c){case 1:this._mesh=GL.Mesh.cube({size:_,normals:!0,coords:!0});break;case 2:this._mesh=GL.Mesh.plane({size:_,xz:!0,detail:d,normals:!0,coords:!0});break;case 3:this._mesh=GL.Mesh.cylinder({size:_,subdivisions:d,normals:!0,coords:!0});break;case 4:this._mesh=GL.Mesh.sphere({size:_,long:d,lat:d,normals:!0,coords:!0});break;case 5:this._mesh=GL.Mesh.circle({size:_,slices:d,normals:!0,coords:!0});break;case 6:this._mesh=GL.Mesh.sphere({size:_,long:d,lat:d,normals:!0,coords:!0,hemi:!0});break;case 7:this._mesh=GL.Mesh.icosahedron({size:_,subdivisions:d});break;case 8:this._mesh=GL.Mesh.cone({radius:_,height:_,subdivisions:d});break;case 9:this._mesh=GL.Mesh.plane({size:_,xz:!1,detail:d,normals:!0,coords:!0});break}this.last_info.type=c,this.last_info.size=_,this.last_info.subdivisions=d,this._mesh.version=this.version++}};g(a,"title","Primitive"),g(a,"VALID",{CUBE:1,PLANE:2,CYLINDER:3,SPHERE:4,CIRCLE:5,HEMISPHERE:6,ICOSAHEDRON:7,CONE:8,QUAD:9}),g(a,"widgets_info",{type:{widget:"combo",values:a.VALID}});let l=a;LiteGraph.registerNodeType("geometry/mesh_primitive",l);class h{constructor(){this.addInput("in","geometry"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,point_size:.1,fixed_size:!1,additive:!0,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.uniforms={u_point_size:1,u_perspective:1,u_point_perspective:1,u_color:this.color},this.geometry_id=-1,this.version=-1,this.mesh=null}updateMesh(c){!this.buffer||!this.buffer.data||this.buffer.data.length!=c.vertices.length?this.buffer=new GL.Buffer(GL.ARRAY_BUFFER,c.vertices,3,GL.DYNAMIC_DRAW):(this.buffer.data.set(c.vertices),this.buffer.upload(GL.DYNAMIC_DRAW)),this.mesh||(this.mesh=new GL.Mesh),this.mesh.addBuffer("vertices",this.buffer),this.geometry_id=this.mesh.id=c._id,this.version=this.mesh.version=c._version}onExecute(){var c;if(this.properties.enabled){var _=this.getInputData(0);if(_){(this.version!=_._version||this.geometry_id!=_._id)&&this.updateMesh(_);{(c=console.warn)==null||c.call(console,"cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph");return}}}}}g(h,"title","renderPoints"),g(h,"desc","render points with a texture"),g(h,"widgets_info",{color:{widget:"color"}}),g(h,"vertex_shader_code",`
            precision mediump float;
            attribute vec3 a_vertex;
            varying vec3 v_vertex;
            attribute vec3 a_normal;
            varying vec3 v_normal;
            #ifdef USE_COLOR
                attribute vec4 a_color;
                varying vec4 v_color;
            #endif
            attribute vec2 a_coord;
            varying vec2 v_coord;
            #ifdef USE_SIZE
                attribute float a_extra;
            #endif
            #ifdef USE_INSTANCING
                attribute mat4 u_model;
            #else
                uniform mat4 u_model;
            #endif
            uniform mat4 u_viewprojection;
            uniform float u_point_size;
            uniform float u_perspective;
            uniform float u_point_perspective;
            float computePointSize(float radius, float w)
            {
                if(radius < 0.0)
                    return -radius;
                return u_perspective * radius / w;
            }
            void main() {
                v_coord = a_coord;
                #ifdef USE_COLOR
                    v_color = a_color;
                #endif
                v_vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;
                v_normal = ( u_model * vec4( a_normal, 0.0 )).xyz;
                gl_Position = u_viewprojection * vec4(v_vertex,1.0);
                gl_PointSize = u_point_size;
                #ifdef USE_SIZE
                    gl_PointSize = a_extra;
                #endif
                if(u_point_perspective != 0.0)
                    gl_PointSize = computePointSize( gl_PointSize, gl_Position.w );
            }
        `),g(h,"fragment_shader_code",`
            precision mediump float;
            uniform vec4 u_color;
            #ifdef USE_COLOR
                varying vec4 v_color;
            #endif
            varying vec2 v_coord;
            uniform sampler2D u_texture;
            void main() {
                vec4 color = u_color;
                #ifdef USE_TEXTURED_POINTS
                    color *= texture2D(u_texture, gl_PointCoord.xy);
                #else
                    #ifdef USE_TEXTURE
                        color *= texture2D(u_texture, v_coord);
                        if(color.a < 0.1)
                            discard;
                    #endif
                    #ifdef USE_POINTS
                        float dist = length( gl_PointCoord.xy - vec2(0.5) );
                        if( dist > 0.45 )
                            discard;
                    #endif
                #endif
                #ifdef USE_COLOR
                    color *= v_color;
                #endif
                gl_FragColor = color;
            }
        `),LiteGraph.registerNodeType("geometry/render_points",h)}const Ie=class pi{constructor(){this.addInput("Texture","Texture"),this.addInput("Aberration","number"),this.addInput("Distortion","number"),this.addInput("Blur","number"),this.addOutput("Texture","Texture"),this.properties={aberration:1,distortion:1,blur:1,precision:LGraphTexture.DEFAULT},pi._shader||(pi._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,pi.pixel_shader),pi._texture=new GL$1.Texture(3,1,{format:gl$1.RGB,wrap:gl$1.CLAMP_TO_EDGE,magFilter:gl$1.LINEAR,minFilter:gl$1.LINEAR,pixel_data:[255,0,0,0,255,0,0,0,255]}))}onExecute(){var t=this.getInputData(0);if(this.properties.precision===LGraphTexture.PASS_THROUGH){this.setOutputData(0,t);return}if(t){this._tex=LGraphTexture.getTargetTexture(t,this._tex,this.properties.precision);var r=this.properties.aberration;this.isInputConnected(1)&&(r=this.getInputData(1),this.properties.aberration=r);var s=this.properties.distortion;this.isInputConnected(2)&&(s=this.getInputData(2),this.properties.distortion=s);var a=this.properties.blur;this.isInputConnected(3)&&(a=this.getInputData(3),this.properties.blur=a),gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST);var l=Mesh.getScreenQuad(),h=pi._shader;this._tex.drawTo(function(){t.bind(0),h.uniforms({u_texture:0,u_aberration:r,u_distortion:s,u_blur:a}).draw(l)}),this.setOutputData(0,this._tex)}}};g(Ie,"title","Lens"),g(Ie,"desc","Camera Lens distortion"),g(Ie,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(Ie,"pixel_shader",`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_camera_planes;
        uniform float u_aberration;
        uniform float u_distortion;
        uniform float u_blur;
        
        void main() {
            vec2 coord = v_coord;
            float dist = distance(vec2(0.5), coord);
            vec2 dist_coord = coord - vec2(0.5);
            float percent = 1.0 + ((0.5 - dist) / 0.5) * u_distortion;
            dist_coord *= percent;
            coord = dist_coord + vec2(0.5);
            vec4 color = texture2D(u_texture, coord, u_blur * dist);
            color.r = texture2D(u_texture, vec2(0.5) + dist_coord * (1.0 + 0.01 * u_aberration), u_blur * dist).r;
            color.b = texture2D(u_texture, vec2(0.5) + dist_coord * (1.0 - 0.01 * u_aberration), u_blur * dist).b;
            gl_FragColor = color;
        }
    `);let LGraphFXLens=Ie;LiteGraph.registerNodeType("fx/lens",LGraphFXLens);const ce=class ii{constructor(){this.addInput("Texture","Texture"),this.addInput("Blurred","Texture"),this.addInput("Mask","Texture"),this.addInput("Threshold","number"),this.addOutput("Texture","Texture"),this.properties={shape:"",size:10,alpha:1,threshold:1,high_precision:!1}}onExecute(){var t=this.getInputData(0),r=this.getInputData(1),s=this.getInputData(2);if(!t||!s||!this.properties.shape){this.setOutputData(0,t);return}r||(r=t);var a=LGraphTexture.getTexture(this.properties.shape);if(a){var l=this.properties.threshold;this.isInputConnected(3)&&(l=this.getInputData(3),this.properties.threshold=l);var h=gl$1.UNSIGNED_BYTE;this.properties.high_precision&&(h=gl$1.half_float_ext?gl$1.HALF_FLOAT_OES:gl$1.FLOAT),(!this._temp_texture||this._temp_texture.type!=h||this._temp_texture.width!=t.width||this._temp_texture.height!=t.height)&&(this._temp_texture=new GL$1.Texture(t.width,t.height,{type:h,format:gl$1.RGBA,filter:gl$1.LINEAR}));var u=ii._first_shader;u||(u=ii._first_shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,ii._first_pixel_shader));var c=ii._second_shader;c||(c=ii._second_shader=new GL$1.Shader(ii._second_vertex_shader,ii._second_pixel_shader));var _=this._points_mesh;(!_||_._width!=t.width||_._height!=t.height||_._spacing!=2)&&(_=this.createPointsMesh(t.width,t.height,2));var d=Mesh.getScreenQuad(),f=this.properties.size,m=this.properties.alpha;gl$1.disable(gl$1.DEPTH_TEST),gl$1.disable(gl$1.BLEND),this._temp_texture.drawTo(function(){t.bind(0),r.bind(1),s.bind(2),u.uniforms({u_texture:0,u_texture_blur:1,u_mask:2,u_texsize:[t.width,t.height]}).draw(d)}),this._temp_texture.drawTo(function(){gl$1.enable(gl$1.BLEND),gl$1.blendFunc(gl$1.ONE,gl$1.ONE),t.bind(0),a.bind(3),c.uniforms({u_texture:0,u_mask:2,u_shape:3,u_alpha:m,u_threshold:l,u_pointSize:f,u_itexsize:[1/t.width,1/t.height]}).draw(_,gl$1.POINTS)}),this.setOutputData(0,this._temp_texture)}}createPointsMesh(t,r,s){for(var a=Math.round(t/s),l=Math.round(r/s),h=new Float32Array(a*l*2),u=-1,c=2/t*s,_=2/r*s,d=0;d<l;++d){for(var f=-1,m=0;m<a;++m){var b=d*a*2+m*2;h[b]=f,h[b+1]=u,f+=c}u+=_}return this._points_mesh=GL$1.Mesh.load({vertices2D:h}),this._points_mesh._width=t,this._points_mesh._height=r,this._points_mesh._spacing=s,this._points_mesh}};g(ce,"title","Bokeh"),g(ce,"desc","applies an Bokeh effect"),g(ce,"widgets_info",{shape:{widget:"texture"}}),g(ce,"_first_pixel_shader",`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform sampler2D u_texture_blur;
        uniform sampler2D u_mask;

        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            vec4 blurred_color = texture2D(u_texture_blur, v_coord);
            float mask = texture2D(u_mask, v_coord).x;
            gl_FragColor = mix(color, blurred_color, mask);
        }
    `),g(ce,"_second_vertex_shader",`
        precision highp float;
        attribute vec2 a_vertex2D;
        varying vec4 v_color;
        uniform sampler2D u_texture;
        uniform sampler2D u_mask;
        uniform vec2 u_itexsize;
        uniform float u_pointSize;
        uniform float u_threshold;
        
        void main() {
            vec2 coord = a_vertex2D * 0.5 + 0.5;
            v_color = texture2D(u_texture, coord);
            v_color += texture2D(u_texture, coord + vec2(u_itexsize.x, 0.0));
            v_color += texture2D(u_texture, coord + vec2(0.0, u_itexsize.y));
            v_color += texture2D(u_texture, coord + u_itexsize);
            v_color *= 0.25;
            float mask = texture2D(u_mask, coord).x;
            float luminance = length(v_color) * mask;
            // luminance /= (u_pointSize * u_pointSize) * 0.01;
            luminance -= u_threshold;
            if (luminance < 0.0) {
                gl_Position.x = -100.0;
                return;
            }
            gl_PointSize = u_pointSize;
            gl_Position = vec4(a_vertex2D, 0.0, 1.0);
        }
    `),g(ce,"_second_pixel_shader",`
        precision highp float;
        varying vec4 v_color;
        uniform sampler2D u_shape;
        uniform float u_alpha;
        
        void main() {
            vec4 color = texture2D(u_shape, gl_PointCoord);
            color *= v_color * u_alpha;
            gl_FragColor = color;
        }
    `);let LGraphFXBokeh=ce;LiteGraph.registerNodeType("fx/bokeh",LGraphFXBokeh);const fe=class Ui{constructor(){this.addInput("Texture","Texture"),this.addInput("value1","number"),this.addInput("value2","number"),this.addOutput("Texture","Texture"),this.properties={fx:"halftone",value1:1,value2:1,precision:LGraphTexture.DEFAULT}}onExecute(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision===LGraphTexture.PASS_THROUGH){this.setOutputData(0,t);return}if(t){this._tex=LGraphTexture.getTargetTexture(t,this._tex,this.properties.precision);var r=this.properties.value1;this.isInputConnected(1)&&(r=this.getInputData(1),this.properties.value1=r);var s=this.properties.value2;this.isInputConnected(2)&&(s=this.getInputData(2),this.properties.value2=s);var a=this.properties.fx,l=Ui.shaders[a];if(!l){var h=Ui["pixel_shader_"+a];if(!h)return;l=Ui.shaders[a]=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,h)}gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST);var u=Mesh.getScreenQuad(),c=LS?LS.Renderer._current_camera:null,_;c?_=[LS.Renderer._current_camera.near,LS.Renderer._current_camera.far]:_=[1,100];var d=null;a=="noise"&&(d=LGraphTexture.getNoiseTexture()),this._tex.drawTo(function(){t.bind(0),a=="noise"&&d.bind(1),l.uniforms({u_texture:0,u_noise:1,u_size:[t.width,t.height],u_rand:[Math.random(),Math.random()],u_value1:r,u_value2:s,u_camera_planes:_}).draw(u)}),this.setOutputData(0,this._tex)}}}};g(fe,"title","FX"),g(fe,"desc","applies an FX from a list"),g(fe,"widgets_info",{fx:{widget:"combo",values:["halftone","pixelate","lowpalette","noise","gamma"]},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(fe,"shaders",{}),g(fe,"pixel_shader_halftone",`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_camera_planes;
        uniform vec2 u_size;
        uniform float u_value1;
        uniform float u_value2;
        
        float pattern() {
            float s = sin(u_value1 * 3.1415), c = cos(u_value1 * 3.1415);
            vec2 tex = v_coord * u_size.xy;
            vec2 point = vec2(
                c * tex.x - s * tex.y ,
                s * tex.x + c * tex.y
            ) * u_value2;
            return (sin(point.x) * sin(point.y)) * 4.0;
        }
        
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            float average = (color.r + color.g + color.b) / 3.0;
            gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);
        }
    `),g(fe,"pixel_shader_pixelate",`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_camera_planes;
        uniform vec2 u_size;
        uniform float u_value1;
        uniform float u_value2;
        
        void main() {
            vec2 coord = vec2(floor(v_coord.x * u_value1) / u_value1, floor(v_coord.y * u_value2) / u_value2);
            vec4 color = texture2D(u_texture, coord);
            gl_FragColor = color;
        }
    `),g(fe,"pixel_shader_lowpalette",`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform vec2 u_camera_planes;
        uniform vec2 u_size;
        uniform float u_value1;
        uniform float u_value2;
        
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            gl_FragColor = floor(color * u_value1) / u_value1;
        }
    `),g(fe,"pixel_shader_noise",`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform sampler2D u_noise;
        uniform vec2 u_size;
        uniform float u_value1;
        uniform float u_value2;
        uniform vec2 u_rand;
        
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            vec3 noise = texture2D(u_noise, v_coord * vec2(u_size.x / 512.0, u_size.y / 512.0) + u_rand).xyz - vec3(0.5);
            gl_FragColor = vec4(color.xyz + noise * u_value1, color.a);
        }
    `),g(fe,"pixel_shader_gamma",`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform float u_value1;
        
        void main() {
            vec4 color = texture2D(u_texture, v_coord);
            float gamma = 1.0 / u_value1;
            gl_FragColor = vec4(pow(color.xyz, vec3(gamma)), color.a);
        }
    `);let LGraphFXGeneric=fe;LiteGraph.registerNodeType("fx/generic",LGraphFXGeneric);const Pe=class wi{constructor(){this.addInput("Tex.","Texture"),this.addInput("intensity","number"),this.addOutput("Texture","Texture"),this.properties={intensity:1,invert:!1,precision:LGraphTexture.DEFAULT},wi._shader||(wi._shader=new GL$1.Shader(GL$1.Shader.SCREEN_VERTEX_SHADER,wi.pixel_shader))}onExecute(){var t=this.getInputData(0);if(this.properties.precision===LGraphTexture.PASS_THROUGH){this.setOutputData(0,t);return}if(t){this._tex=LGraphTexture.getTargetTexture(t,this._tex,this.properties.precision);var r=this.properties.intensity;this.isInputConnected(1)&&(r=this.getInputData(1),this.properties.intensity=r),gl$1.disable(gl$1.BLEND),gl$1.disable(gl$1.DEPTH_TEST);var s=Mesh.getScreenQuad(),a=wi._shader,l=this.properties.invert;this._tex.drawTo(function(){t.bind(0),a.uniforms({u_texture:0,u_intensity:r,u_isize:[1/t.width,1/t.height],u_invert:l?1:0}).draw(s)}),this.setOutputData(0,this._tex)}}};g(Pe,"title","Vigneting"),g(Pe,"desc","Vigneting"),g(Pe,"widgets_info",{precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}}),g(Pe,"pixel_shader",`
        precision highp float;
        varying vec2 v_coord;
        uniform sampler2D u_texture;
        uniform float u_intensity;
        uniform int u_invert;
        
        void main() {
            float luminance = 1.0 - length(v_coord - vec2(0.5)) * 1.414;
            vec4 color = texture2D(u_texture, v_coord);
            
            if (u_invert == 1) {
                luminance = 1.0 - luminance;
            }
            
            luminance = mix(1.0, luminance, u_intensity);
            gl_FragColor = vec4(luminance * color.xyz, color.a);
        }
    `);let LGraphFXVigneting=Pe;LiteGraph.registerNodeType("fx/vigneting",LGraphFXVigneting);var MIDI_COLOR="#243";const re=class Be{constructor(t){this.channel=0,this.cmd=0,this.data=new Uint32Array(3),t&&this.setup(t)}fromJSON(t){this.setup(t.data)}setup(t){var r=t;t.constructor===Object&&(r=t.data),this.data.set(r);var s=r[0];this.status=s;var a=s&240;s>=240?this.cmd=s:this.cmd=a,this.cmd==Be.NOTEON&&this.velocity==0&&(this.cmd=Be.NOTEOFF),this.cmd_str=Be.commands[this.cmd]||"",(a>=Be.NOTEON||a<=Be.NOTEOFF)&&(this.channel=s&15)}get velocity(){return this.cmd==Be.NOTEON?this.data[2]:-1}set velocity(t){this.data[2]=t}get note(){return this.cmd!=Be.NOTEON?-1:Be.toNoteString(this.data[1],!0)}set note(t){throw new Error("notes cannot be assigned this way, must modify the data[1]")}get octave(){if(this.cmd!=Be.NOTEON)return-1;var t=this.data[1]-24;return Math.floor(t/12+1)}set octave(t){throw new Error("octave cannot be assigned this way, must modify the data[1]")}getPitch(){return Math.pow(2,(this.data[1]-69)/12)*440}static computePitch(t){return Math.pow(2,(t-69)/12)*440}getCC(){return this.data[1]}getCCValue(){return this.data[2]}getPitchBend(){return this.data[1]+(this.data[2]<<7)-8192}static computePitchBend(t,r){return t+(r<<7)-8192}setCommandFromString(t){this.cmd=Be.computeCommandFromString(t)}static computeCommandFromString(t){if(!t)return 0;if(t&&t.constructor===Number)return t;switch(t=t.toUpperCase(),t){case"NOTE ON":case"NOTEON":return Be.NOTEON;case"NOTE OFF":case"NOTEOFF":return Be.NOTEON;case"KEY PRESSURE":case"KEYPRESSURE":return Be.KEYPRESSURE;case"CONTROLLER CHANGE":case"CONTROLLERCHANGE":case"CC":return Be.CONTROLLERCHANGE;case"PROGRAM CHANGE":case"PROGRAMCHANGE":case"PC":return Be.PROGRAMCHANGE;case"CHANNEL PRESSURE":case"CHANNELPRESSURE":return Be.CHANNELPRESSURE;case"PITCH BEND":case"PITCHBEND":return Be.PITCHBEND;case"TIME TICK":case"TIMETICK":return Be.TIMETICK;default:return Number(t)}}static toNoteString(t,r){t=Math.round(t);var s=t-21,a=Math.floor((t-24)/12+1);return s=s%12,s<0&&(s=12+s),Be.notes[s]+(r?"":a)}static NoteStringToPitch(t){t=t.toUpperCase();var r=t[0],s=4;t[1]=="#"?(r+="#",t.length>2&&(s=Number(t[2]))):t.length>1&&(s=Number(t[1]));var a=Be.note_to_index[r];return a==null?null:(s-1)*12+a+21}toString(){var t=""+this.channel+". ";switch(this.cmd){case Be.NOTEON:t+="NOTEON "+Be.toNoteString(this.data[1]);break;case Be.NOTEOFF:t+="NOTEOFF "+Be.toNoteString(this.data[1]);break;case Be.CONTROLLERCHANGE:t+="CC "+this.data[1]+" "+this.data[2];break;case Be.PROGRAMCHANGE:t+="PC "+this.data[1];break;case Be.PITCHBEND:t+="PITCHBEND "+this.getPitchBend();break;case Be.KEYPRESSURE:t+="KEYPRESS "+this.data[1];break}return t}toHexString(){return this.data.map(t=>t.toString(16)).join(" ")}toJSON(){return{data:[this.data[0],this.data[1],this.data[2]],object_class:"MIDIEvent"}}};g(re,"notes",["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"]),g(re,"note_to_index",{A:0,"A#":1,B:2,C:3,"C#":4,D:5,"D#":6,E:7,F:8,"F#":9,G:10,"G#":11}),g(re,"commands",{128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"}),g(re,"commands_short",{128:"NOTEOFF",144:"NOTEOFF",160:"KEYP",176:"CC",192:"PC",208:"CP",224:"PB",240:"SYS",242:"POS",243:"SELECT",246:"TUNEREQ",248:"TT",250:"START",251:"CONTINUE",252:"STOP",254:"SENS",255:"RESET"}),g(re,"commands_reversed",{});let MIDIEvent=re;MIDIEvent.NOTEOFF=128,MIDIEvent.NOTEON=144,MIDIEvent.KEYPRESSURE=160,MIDIEvent.CONTROLLERCHANGE=176,MIDIEvent.PROGRAMCHANGE=192,MIDIEvent.CHANNELPRESSURE=208,MIDIEvent.PITCHBEND=224,MIDIEvent.TIMETICK=248,LiteGraph.MIDIEvent=MIDIEvent;for(var i$1 in MIDIEvent.commands)MIDIEvent.commands_reversed[MIDIEvent.commands[i$1]]=i$1;const ft=class Ii{constructor(t,r){var s;if(!navigator.requestMIDIAccess){this.error="not suppoorted",r?r("Not supported"):(s=console.error)==null||s.call(console,"MIDI NOT SUPPORTED, enable by chrome://flags");return}this.on_ready=t,this.state={note:[],cc:[]},this.input_ports=null,this.input_ports_info=[],this.output_ports=null,this.output_ports_info=[],navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))}onMIDISuccess(t){var r,s;(r=console.log)==null||r.call(console,"MIDI ready!"),LiteGraph.debug&&((s=console.log)==null||s.call(console,t)),this.midi=t,this.updatePorts(),this.on_ready&&this.on_ready(this)}updatePorts(){var t,r,s=this.midi;this.input_ports=s.inputs,this.input_ports_info=[],this.output_ports=s.outputs,this.output_ports_info=[];for(var a=0,l=this.input_ports.values(),h=l.next();h&&h.done===!1;){let u=h.value;this.input_ports_info.push(u),LiteGraph.debug&&((t=console.log)==null||t.call(console,"Input port [type:'"+u.type+"'] id:'"+u.id+"' manufacturer:'"+u.manufacturer+"' name:'"+u.name+"' version:'"+u.version+"'")),a++,h=l.next()}for(this.num_input_ports=a,a=0,l=this.output_ports.values(),h=l.next();h&&h.done===!1;){let u=h.value;this.output_ports_info.push(u),LiteGraph.debug&&((r=console.log)==null||r.call(console,"Output port [type:'"+u.type+"'] id:'"+u.id+"' manufacturer:'"+u.manufacturer+"' name:'"+u.name+"' version:'"+u.version+"'")),a++,h=l.next()}this.num_output_ports=a}onMIDIFailure(t){var r;(r=console.error)==null||r.call(console,"Failed to get MIDI access - "+t)}openInputPort(t,r){var s,a=this.input_ports.get("input-"+t);if(!a)return!1;Ii.input=this;var l=this;return a.onmidimessage=function(h){var u=new MIDIEvent(h.data);l.updateState(u),r&&r(h.data,u),Ii.on_message&&Ii.on_message(h.data,u)},(s=console.log)==null||s.call(console,"port open: ",a),!0}updateState(t){switch(t.cmd){case MIDIEvent.NOTEON:this.state.note[t.value1|0]=t.value2;break;case MIDIEvent.NOTEOFF:this.state.note[t.value1|0]=0;break;case MIDIEvent.CONTROLLERCHANGE:this.state.cc[t.getCC()]=t.getCCValue();break}}sendMIDI(t,r){if(r){var s=this.output_ports_info[t];s&&(Ii.output=this,r.constructor===MIDIEvent?s.send(r.data):s.send(r))}}};g(ft,"input",null);let MIDIInterface=ft;MIDIInterface.MIDIEvent=MIDIEvent;class LGMIDIIn{constructor(){this.addOutput("on_midi",LiteGraph.EVENT),this.addOutput("out","midi"),this.properties={port:0},this._last_midi_event=null,this._current_midi_event=null,this.boxcolor="#AAA",this._last_time=0;var t=this;new MIDIInterface(function(r){t._midi=r,t._waiting&&t.onStart(),t._waiting=!1})}getPropertyInfo(t){if(this._midi&&t=="port"){for(var r={},s=0;s<this._midi.input_ports_info.length;++s){var a=this._midi.input_ports_info[s];r[s]=s+".- "+a.name+" version:"+a.version}return{type:"enum",values:r}}}onStart(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0}onMIDIEvent(t,r){this._last_midi_event=r,this.boxcolor="#AFA",this._last_time=LiteGraph.getTime(),this.trigger("on_midi",r),r.cmd==MIDIEvent.NOTEON?this.trigger("on_noteon",r):r.cmd==MIDIEvent.NOTEOFF?this.trigger("on_noteoff",r):r.cmd==MIDIEvent.CONTROLLERCHANGE?this.trigger("on_cc",r):r.cmd==MIDIEvent.PROGRAMCHANGE?this.trigger("on_pc",r):r.cmd==MIDIEvent.PITCHBEND&&this.trigger("on_pitchbend",r)}onDrawBackground(t){if(this.boxcolor="#AAA",!this.flags.collapsed&&this._last_midi_event){t.fillStyle="white";var r=LiteGraph.getTime(),s=1-Math.max(0,(r-this._last_time)*.001);if(s>0){var a=t.globalAlpha;t.globalAlpha*=s,t.font="12px Tahoma",t.fillText(this._last_midi_event.toString(),2,this.size[1]*.5+3),t.globalAlpha=a}}}onExecute(){if(this.outputs)for(var t=this._last_midi_event,r=0;r<this.outputs.length;++r){var s=this.outputs[r],a=null;switch(s.name){case"midi":a=this._midi;break;case"last_midi":a=t;break;default:continue}this.setOutputData(r,a)}}onGetOutputs(){return[["last_midi","midi"],["on_midi",LiteGraph.EVENT],["on_noteon",LiteGraph.EVENT],["on_noteoff",LiteGraph.EVENT],["on_cc",LiteGraph.EVENT],["on_pc",LiteGraph.EVENT],["on_pitchbend",LiteGraph.EVENT]]}}g(LGMIDIIn,"title","MIDI Input"),g(LGMIDIIn,"desc","Reads MIDI from a input port"),g(LGMIDIIn,"color",MIDI_COLOR),LGMIDIIn.MIDIInterface=MIDIInterface,LiteGraph.registerNodeType("midi/input",LGMIDIIn);const vt=class ur{constructor(){this.addInput("send",LiteGraph.EVENT),this.properties={port:0};var t=this;new MIDIInterface(function(r){t._midi=r,t.widget.options.values=t.getMIDIOutputs()}),this.widget=this.addWidget("combo","Device",this.properties.port,{property:"port",values:this.getMIDIOutputs.bind(this)}),this.size=[340,60]}onGetPropertyInfo(t){if(this._midi&&t=="port"){var r=this.getMIDIOutputs();return{type:"enum",values:r}}}getMIDIOutputs(){var t={};if(!this._midi)return ur.default_ports;if(this._midi.output_ports_info)for(var r=0;r<this._midi.output_ports_info.length;++r){var s=this._midi.output_ports_info[r];if(s){var a=r+".- "+s.name+" version:"+s.version;t[r]=a}}return t}onAction(t,r){this._midi&&(t=="send"&&this._midi.sendMIDI(this.properties.port,r),this.trigger("midi",r))}onGetInputs(){return[["send",LiteGraph.ACTION]]}onGetOutputs(){return[["on_midi",LiteGraph.EVENT]]}};g(vt,"title","MIDI Output"),g(vt,"desc","Sends MIDI to output channel"),g(vt,"color",MIDI_COLOR),g(vt,"default_ports",{0:"unknown"});let LGMIDIOut=vt;LGMIDIOut.MIDIInterface=MIDIInterface,LiteGraph.registerNodeType("midi/output",LGMIDIOut);class LGMIDIShow{constructor(){this.addInput("on_midi",LiteGraph.EVENT),this._str="",this.size=[200,40]}getTitle(){return this.flags.collapsed?this._str:this.title}onAction(t,r){r&&(r.constructor===MIDIEvent?this._str=r.toString():this._str="???")}onDrawForeground(t){!this._str||this.flags.collapsed||(t.font="30px Arial",t.fillText(this._str,10,this.size[1]*.8))}onGetInputs(){return[["in",LiteGraph.ACTION]]}onGetOutputs(){return[["on_midi",LiteGraph.EVENT]]}}g(LGMIDIShow,"title","MIDI Show"),g(LGMIDIShow,"desc","Shows MIDI in the graph"),g(LGMIDIShow,"color",MIDI_COLOR),LiteGraph.registerNodeType("midi/show",LGMIDIShow);class LGMIDIFilter{constructor(){this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1};var t=this;this._learning=!1,this.addWidget("button","Learn","",function(){t._learning=!0,t.boxcolor="#FA3"}),this.addInput("in",LiteGraph.EVENT),this.addOutput("on_midi",LiteGraph.EVENT),this.boxcolor="#AAA"}getTitle(){var t=null;return this.properties.cmd==-1?t="Nothing":t=MIDIEvent.commands_short[this.properties.cmd]||"Unknown",this.properties.min_value!=-1&&this.properties.max_value!=-1&&(t+=" "+(this.properties.min_value==this.properties.max_value?this.properties.max_value:this.properties.min_value+".."+this.properties.max_value)),"Filter: "+t}onPropertyChanged(t,r){if(t=="cmd"){var s=Number(r);isNaN(s)&&(s=MIDIEvent.commands[r]||0),this.properties.cmd=s}}onAction(t,r){if(!(!r||r.constructor!==MIDIEvent)){if(this._learning)this._learning=!1,this.boxcolor="#AAA",this.properties.channel=r.channel,this.properties.cmd=r.cmd,this.properties.min_value=this.properties.max_value=r.data[1];else if(this.properties.channel!=-1&&r.channel!=this.properties.channel||this.properties.cmd!=-1&&r.cmd!=this.properties.cmd||this.properties.min_value!=-1&&r.data[1]<this.properties.min_value||this.properties.max_value!=-1&&r.data[1]>this.properties.max_value)return;this.trigger("on_midi",r)}}}g(LGMIDIFilter,"title","MIDI Filter"),g(LGMIDIFilter,"desc","Filters MIDI messages"),g(LGMIDIFilter,"color",MIDI_COLOR),g(LGMIDIFilter,"@cmd",{type:"enum",title:"Command",values:MIDIEvent.commands_reversed}),LiteGraph.registerNodeType("midi/filter",LGMIDIFilter);class LGMIDIEvent{constructor(){this.properties={channel:0,cmd:144,value1:1,value2:1},this.addInput("send",LiteGraph.EVENT),this.addInput("assign",LiteGraph.EVENT),this.addOutput("on_midi",LiteGraph.EVENT),this.midi_event=new MIDIEvent,this.gate=!1}onAction(t,r){if(t=="assign"){this.properties.channel=r.channel,this.properties.cmd=r.cmd,this.properties.value1=r.data[1],this.properties.value2=r.data[2],r.cmd==MIDIEvent.NOTEON?this.gate=!0:r.cmd==MIDIEvent.NOTEOFF&&(this.gate=!1);return}r=this.midi_event,r.channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?r.setCommandFromString(this.properties.cmd):r.cmd=this.properties.cmd,r.data[0]=r.cmd|r.channel,r.data[1]=Number(this.properties.value1),r.data[2]=Number(this.properties.value2),this.trigger("on_midi",r)}onExecute(){var t=this.properties;if(this.inputs)for(let a=0;a<this.inputs.length;++a){var r=this.inputs[a];if(r.link==-1)continue;let l;switch(r.name){case"note":l=this.getInputData(a),l!=null&&(l.constructor===String&&(l=MIDIEvent.NoteStringToPitch(l)),this.properties.value1=(l|0)%255);break;case"cmd":l=this.getInputData(a),l!=null&&(this.properties.cmd=l);break;case"value1":l=this.getInputData(a),l!=null&&(this.properties.value1=LiteGraph.clamp(l|0,0,127));break;case"value2":l=this.getInputData(a),l!=null&&(this.properties.value2=LiteGraph.clamp(l|0,0,127));break}}if(this.outputs)for(let a=0;a<this.outputs.length;++a){var s=this.outputs[a];let l=null;switch(s.name){case"midi":l=new MIDIEvent,l.setup([t.cmd,t.value1,t.value2]),l.channel=t.channel;break;case"command":l=t.cmd;break;case"cc":l=t.value1;break;case"cc_value":l=t.value2;break;case"note":l=t.cmd==MIDIEvent.NOTEON||t.cmd==MIDIEvent.NOTEOFF?t.value1:null;break;case"velocity":l=t.cmd==MIDIEvent.NOTEON?t.value2:null;break;case"pitch":l=t.cmd==MIDIEvent.NOTEON?MIDIEvent.computePitch(t.value1):null;break;case"pitchbend":l=t.cmd==MIDIEvent.PITCHBEND?MIDIEvent.computePitchBend(t.value1,t.value2):null;break;case"gate":l=this.gate;break;default:continue}l!==null&&this.setOutputData(a,l)}}onPropertyChanged(t,r){t=="cmd"&&(this.properties.cmd=MIDIEvent.computeCommandFromString(r))}onGetInputs(){return[["cmd","number"],["note","number"],["value1","number"],["value2","number"]]}onGetOutputs(){return[["midi","midi"],["on_midi",LiteGraph.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["gate","bool"],["pitchbend","number"]]}}g(LGMIDIEvent,"title","MIDIEvent"),g(LGMIDIEvent,"desc","Create a MIDI Event"),g(LGMIDIEvent,"color",MIDI_COLOR),LiteGraph.registerNodeType("midi/event",LGMIDIEvent);class LGMIDICC{constructor(){this.properties={cc:1,value:0},this.addOutput("value","number")}onExecute(){MIDIInterface.input&&(this.properties.value=MIDIInterface.input.state.cc[this.properties.cc]),this.setOutputData(0,this.properties.value)}}g(LGMIDICC,"title","MIDICC"),g(LGMIDICC,"desc","gets a Controller Change"),g(LGMIDICC,"color",MIDI_COLOR),LiteGraph.registerNodeType("midi/cc",LGMIDICC);const st=class $i{constructor(){this.addInput("generate",LiteGraph.ACTION),this.addInput("scale","string"),this.addInput("octave","number"),this.addOutput("note",LiteGraph.EVENT),this.properties={notes:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#",octave:2,duration:.5,mode:"sequence"},this.notes_pitches=$i.processScale(this.properties.notes),this.sequence_index=0}static processScale(t){for(var r=t.split(","),s=0;s<r.length;++s){var a=r[s];a.length==2&&a[1]!="#"||a.length>2?r[s]=-LiteGraph.MIDIEvent.NoteStringToPitch(a):r[s]=MIDIEvent.note_to_index[a]||0}return r}onPropertyChanged(t,r){t=="notes"&&(this.notes_pitches=$i.processScale(r))}onExecute(){var t=this.getInputData(2);t!=null&&(this.properties.octave=t);var r=this.getInputData(1);r&&(this.notes_pitches=$i.processScale(r))}onAction(t,r){var s=0,a=this.notes_pitches.length,l=0;this.properties.mode=="sequence"?l=this.sequence_index=(this.sequence_index+1)%a:this.properties.mode=="random"&&(l=Math.floor(Math.random()*a));var h=this.notes_pitches[l];h>=0?s=h+(this.properties.octave-1)*12+33:s=-h,r=new MIDIEvent,r.setup([MIDIEvent.NOTEON,s,10]);var u=this.properties.duration||1;this.trigger("note",r),setTimeout(function(){var c=new MIDIEvent;c.setup([MIDIEvent.NOTEOFF,s,0]),this.trigger("note",c)}.bind(this),u*1e3)}};g(st,"title","MIDI Generator"),g(st,"desc","Generates a random MIDI note"),g(st,"color",MIDI_COLOR);let LGMIDIGenerator=st;LiteGraph.registerNodeType("midi/generator",LGMIDIGenerator);class LGMIDITranspose{constructor(){this.properties={amount:0},this.addInput("in",LiteGraph.ACTION),this.addInput("amount","number"),this.addOutput("out",LiteGraph.EVENT),this.midi_event=new MIDIEvent}onAction(t,r){!r||r.constructor!==MIDIEvent||(r.data[0]==MIDIEvent.NOTEON||r.data[0]==MIDIEvent.NOTEOFF?(this.midi_event=new MIDIEvent,this.midi_event.setup(r.data),this.midi_event.data[1]=Math.round(this.midi_event.data[1]+this.properties.amount),this.trigger("out",this.midi_event)):this.trigger("out",r))}onExecute(){var t=this.getInputData(1);t!=null&&(this.properties.amount=t)}}g(LGMIDITranspose,"title","MIDI Transpose"),g(LGMIDITranspose,"desc","Transpose a MIDI note"),g(LGMIDITranspose,"color",MIDI_COLOR),LiteGraph.registerNodeType("midi/transpose",LGMIDITranspose);class LGMIDIQuantize{constructor(){this.properties={scale:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#"},this.addInput("note",LiteGraph.ACTION),this.addInput("scale","string"),this.addOutput("out",LiteGraph.EVENT),this.valid_notes=new Array(12),this.offset_notes=new Array(12),this.processScale(this.properties.scale)}onPropertyChanged(t,r){t=="scale"&&this.processScale(r)}processScale(t){this._current_scale=t,this.notes_pitches=LGMIDIGenerator.processScale(t);for(let s=0;s<12;++s)this.valid_notes[s]=this.notes_pitches.indexOf(s)!=-1;for(let s=0;s<12;++s){if(this.valid_notes[s]){this.offset_notes[s]=0;continue}for(var r=1;r<12;++r){if(this.valid_notes[(s-r)%12]){this.offset_notes[s]=-r;break}if(this.valid_notes[(s+r)%12]){this.offset_notes[s]=r;break}}}}onAction(t,r){if(!(!r||r.constructor!==MIDIEvent))if(r.data[0]==MIDIEvent.NOTEON||r.data[0]==MIDIEvent.NOTEOFF){this.midi_event=new MIDIEvent,this.midi_event.setup(r.data);var s=r.note,a=MIDIEvent.note_to_index[s],l=this.offset_notes[a];this.midi_event.data[1]+=l,this.trigger("out",this.midi_event)}else this.trigger("out",r)}onExecute(){var t=this.getInputData(1);t!=null&&t!=this._current_scale&&this.processScale(t)}}g(LGMIDIQuantize,"title","MIDI Quantize Pitch"),g(LGMIDIQuantize,"desc","Transpose a MIDI note tp fit an scale"),g(LGMIDIQuantize,"color",MIDI_COLOR),LiteGraph.registerNodeType("midi/quantize",LGMIDIQuantize);class LGMIDIFromFile{constructor(){var t;this.properties={url:"",autoplay:!0},this.addInput("play",LiteGraph.ACTION),this.addInput("pause",LiteGraph.ACTION),this.addOutput("note",LiteGraph.EVENT),this._midi=null,this._current_time=0,this._playing=!1,typeof MidiParser=="undefined"&&((t=console.error)==null||t.call(console,"midi-parser.js not included, LGMidiPlay requires that library: https://raw.githubusercontent.com/colxi/midi-parser-js/master/src/main.js"),this.boxcolor="red")}onAction(t){t=="play"?this.play():t=="pause"&&(this._playing=!this._playing)}onPropertyChanged(t,r){t=="url"&&this.loadMIDIFile(r)}onExecute(){if(this._midi&&this._playing){this._current_time+=this.graph.elapsed_time;for(var t=this._current_time*100,r=0;r<this._midi.tracks;++r){var s=this._midi.track[r];s._last_pos||(s._last_pos=0,s._time=0);var a=s.event[s._last_pos];if(a&&s._time+a.deltaTime<=t&&(s._last_pos++,s._time+=a.deltaTime,a.data)){var l=a.type<<4+a.channel,h=new MIDIEvent;h.setup([l,a.data[0],a.data[1]]),this.trigger("note",h)}}}}play(){if(this._playing=!0,this._current_time=0,!!this._midi)for(var t=0;t<this._midi.tracks;++t){var r=this._midi.track[t];r._last_pos=0,r._time=0}}loadMIDIFile(t){LiteGraph.fetchFile(t,"arraybuffer",r=>{this.boxcolor="#AFA",this._midi=MidiParser.parse(new Uint8Array(r)),this.properties.autoplay&&this.play()},()=>{this.boxcolor="#FAA",this._midi=null})}onDropFile(t){this.properties.url="",this.loadMIDIFile(t)}}g(LGMIDIFromFile,"title","MIDI fromFile"),g(LGMIDIFromFile,"desc","Plays a MIDI file"),g(LGMIDIFromFile,"color",MIDI_COLOR),LiteGraph.registerNodeType("midi/fromFile",LGMIDIFromFile);class LGMIDIPlay{constructor(){var t;if(this.properties={volume:.5,duration:1},this.addInput("note",LiteGraph.ACTION),this.addInput("volume","number"),this.addInput("duration","number"),this.addOutput("note",LiteGraph.EVENT),typeof AudioSynth=="undefined")(t=console.error)==null||t.call(console,"Audiosynth.js not included, LGMidiPlay requires that library"),this.boxcolor="red";else{var r=this.synth=new AudioSynth;this.instrument=r.createInstrument("piano")}}onAction(t,r){if(!(!r||r.constructor!==MIDIEvent)){if(this.instrument&&r.data[0]==MIDIEvent.NOTEON){var s=r.note;if(!s||s=="undefined"||s.constructor!==String)return;this.instrument.play(s,r.octave,this.properties.duration,this.properties.volume)}this.trigger("note",r)}}onExecute(){var t=this.getInputData(1);t!=null&&(this.properties.volume=t);var r=this.getInputData(2);r!=null&&(this.properties.duration=r)}}g(LGMIDIPlay,"title","MIDI Play"),g(LGMIDIPlay,"desc","Plays a MIDI note"),g(LGMIDIPlay,"color",MIDI_COLOR),LiteGraph.registerNodeType("midi/play",LGMIDIPlay);const at=class Ki{constructor(){this.properties={num_octaves:2,start_octave:2},this.addInput("note",LiteGraph.ACTION),this.addInput("reset",LiteGraph.ACTION),this.addOutput("note",LiteGraph.EVENT),this.size=[400,100],this.keys=[],this._last_key=-1}onDrawForeground(t){if(!this.flags.collapsed){var r=this.properties.num_octaves*12;this.keys.length=r;var s=this.size[0]/(this.properties.num_octaves*7),a=this.size[1];t.globalAlpha=1;for(var l=0;l<2;l++)for(var h=0;h<r;++h){var u=Ki.keys[h%12];if(u.t==l){var c=Math.floor(h/12),_=c*7*s+u.x*s;l==0?t.fillStyle=this.keys[h]?"#CCC":"white":t.fillStyle=this.keys[h]?"#333":"black",t.fillRect(_+1,0,s*u.w-2,a*u.h)}}}}getKeyIndex(t){for(var r=this.size[0]/(this.properties.num_octaves*7),s=this.size[1],a=1;a>=0;a--)for(var l=0;l<this.keys.length;++l){var h=Ki.keys[l%12];if(h.t==a){var u=Math.floor(l/12),c=u*7*r+h.x*r,_=r*h.w,d=s*h.h;if(!(t[0]<c||t[0]>c+_||t[1]>d))return l}}return-1}onAction(t,r){if(t=="reset"){for(var s=0;s<this.keys.length;++s)this.keys[s]=!1;return}if(!(!r||r.constructor!==MIDIEvent)){var a=r,l=(this.properties.start_octave-1)*12+29,h=a.data[1]-l;h>=0&&h<this.keys.length&&(a.data[0]==MIDIEvent.NOTEON?this.keys[h]=!0:a.data[0]==MIDIEvent.NOTEOFF&&(this.keys[h]=!1)),this.trigger("note",a)}}onMouseDown(t,r){if(!(r[1]<0)){var s=this.getKeyIndex(r);this.keys[s]=!0,this._last_key=s;var a=(this.properties.start_octave-1)*12+29+s,l=new MIDIEvent;return l.setup([MIDIEvent.NOTEON,a,100]),this.trigger("note",l),!0}}onMouseMove(t,r){if(!(r[1]<0||this._last_key==-1)){this.setDirtyCanvas(!0);var s=this.getKeyIndex(r);if(this._last_key==s)return!0;this.keys[this._last_key]=!1;var a=(this.properties.start_octave-1)*12+29+this._last_key,l=new MIDIEvent;return l.setup([MIDIEvent.NOTEOFF,a,100]),this.trigger("note",l),this.keys[s]=!0,a=(this.properties.start_octave-1)*12+29+s,l=new MIDIEvent,l.setup([MIDIEvent.NOTEON,a,100]),this.trigger("note",l),this._last_key=s,!0}}onMouseUp(t,r){if(!(r[1]<0)){var s=this.getKeyIndex(r);this.keys[s]=!1,this._last_key=-1;var a=(this.properties.start_octave-1)*12+29+s,l=new MIDIEvent;return l.setup([MIDIEvent.NOTEOFF,a,100]),this.trigger("note",l),!0}}};g(at,"title","MIDI Keys"),g(at,"desc","Keyboard to play notes"),g(at,"color",MIDI_COLOR),g(at,"keys",[{x:0,w:1,h:1,t:0},{x:.75,w:.5,h:.6,t:1},{x:1,w:1,h:1,t:0},{x:1.75,w:.5,h:.6,t:1},{x:2,w:1,h:1,t:0},{x:2.75,w:.5,h:.6,t:1},{x:3,w:1,h:1,t:0},{x:4,w:1,h:1,t:0},{x:4.75,w:.5,h:.6,t:1},{x:5,w:1,h:1,t:0},{x:5.75,w:.5,h:.6,t:1},{x:6,w:1,h:1,t:0}]);let LGMIDIKeys=at;LiteGraph.registerNodeType("midi/keys",LGMIDIKeys);const le=class Wt{static getAudioContext(){var t;if(!this._audio_context){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return(t=console.error)==null||t.call(console,"AudioContext not supported by browser"),null;this._audio_context=new AudioContext,this._audio_context.onmessage=function(r){var s;(s=console.log)==null||s.call(console,"msg",r)},this._audio_context.onended=function(r){var s;(s=console.log)==null||s.call(console,"ended",r)},this._audio_context.oncomplete=function(r){var s;(s=console.log)==null||s.call(console,"complete",r)}}return this._audio_context}static connect(t,r){var s;try{t.connect(r)}catch(a){(s=console.warn)==null||s.call(console,"LGraphAudio:",a)}}static disconnect(t,r){var s;try{t.disconnect(r)}catch(a){(s=console.warn)==null||s.call(console,"LGraphAudio:",a)}}static changeAllAudiosConnections(t,r){if(t.inputs)for(let s=0;s<t.inputs.length;++s){let a=t.inputs[s],l=t.graph.links[a.link];if(!l)continue;let h=t.graph.getNodeById(l.origin_id),u=null;h.getAudioNodeInOutputSlot?u=h.getAudioNodeInOutputSlot(l.origin_slot):u=h.audionode;let c=null;t.getAudioNodeInInputSlot?c=t.getAudioNodeInInputSlot(s):c=t.audionode,r?Wt.connect(u,c):Wt.disconnect(u,c)}if(t.outputs)for(let s=0;s<t.outputs.length;++s){let a=t.outputs[s];for(let l=0;l<a.links.length;++l){let h=t.graph.links[a.links[l]];if(!h)continue;let u=null;t.getAudioNodeInOutputSlot?u=t.getAudioNodeInOutputSlot(s):u=t.audionode;let c=t.graph.getNodeById(h.target_id),_=null;c.getAudioNodeInInputSlot?_=c.getAudioNodeInInputSlot(h.target_slot):_=c.audionode,r?Wt.connect(u,_):Wt.disconnect(u,_)}}}static onConnectionsChange(t,r,s,a){if(t==LiteGraph.OUTPUT){var l=null;if(a&&(l=this.graph.getNodeById(a.target_id)),!!l){var h=null;this.getAudioNodeInOutputSlot?h=this.getAudioNodeInOutputSlot(r):h=this.audionode;var u=null;l.getAudioNodeInInputSlot?u=l.getAudioNodeInInputSlot(a.target_slot):u=l.audionode,s?Wt.connect(h,u):Wt.disconnect(h,u)}}}static createAudioNodeWrapper(t){var r=t.prototype.onPropertyChanged;t.prototype.onPropertyChanged=function(s,a){r&&r.call(this,s,a),this.audionode&&this.audionode[s]!==void 0&&(this.audionode[s].value!==void 0?this.audionode[s].value=a:this.audionode[s]=a)},t.prototype.onConnectionsChange=Wt.onConnectionsChange}static loadSound(t,r,s){if(Wt.cached_audios[t]&&t.includes("blob:")){r&&r(Wt.cached_audios[t]);return}Wt.onProcessAudioURL&&(t=Wt.onProcessAudioURL(t));var a=new XMLHttpRequest;a.open("GET",t,!0),a.responseType="arraybuffer";var l=Wt.getAudioContext();a.onload=function(){var u;(u=console.log)==null||u.call(console,"AudioSource loaded"),l.decodeAudioData(a.response,function(c){var _;(_=console.log)==null||_.call(console,"AudioSource decoded"),Wt.cached_audios[t]=c,r&&r(c)},h)},a.send();function h(u){var c;(c=console.log)==null||c.call(console,"Audio loading sample error:",u),s&&s(u)}return a}};g(le,"cached_audios",{});let LGAudio=le;class LGAudioSource{constructor(){this.properties={src:"",gain:.5,loop:!0,autoplay:!0,playbackRate:1},this._loading_audio=!1,this._audiobuffer=null,this._audionodes=[],this._last_sourcenode=null,this.addOutput("out","audio"),this.addInput("gain","number");var t=LGAudio.getAudioContext();this.audionode=t.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain,this.properties.src&&this.loadSound(this.properties.src)}onAdded(t){t.status===LiteGraph.LGraph.STATUS_RUNNING&&this.onStart()}onStart(){this._audiobuffer&&this.properties.autoplay&&this.playBuffer(this._audiobuffer)}onStop(){this.stopAllSounds()}onPause(){this.pauseAllSounds()}onUnpause(){this.unpauseAllSounds()}onRemoved(){this.stopAllSounds(),this._dropped_url&&URL.revokeObjectURL(this._url)}stopAllSounds(){for(var t=0;t<this._audionodes.length;++t)this._audionodes[t].started&&(this._audionodes[t].started=!1,this._audionodes[t].stop());this._audionodes.length=0}pauseAllSounds(){LGAudio.getAudioContext().suspend()}unpauseAllSounds(){LGAudio.getAudioContext().resume()}onExecute(){if(this.inputs)for(let t=0;t<this.inputs.length;++t){let r=this.inputs[t];if(r.link==null)continue;let s=this.getInputData(t);if(s!==void 0){if(r.name=="gain")this.audionode.gain.value=s;else if(r.name=="src")this.setProperty("src",s);else if(r.name=="playbackRate"){this.properties.playbackRate=s;for(let a=0;a<this._audionodes.length;++a)this._audionodes[a].playbackRate.value=s}}}if(this.outputs)for(let t=0;t<this.outputs.length;++t)this.outputs[t].name=="buffer"&&this._audiobuffer&&this.setOutputData(t,this._audiobuffer)}onAction(t){this._audiobuffer&&(t=="Play"?this.playBuffer(this._audiobuffer):t=="Stop"&&this.stopAllSounds())}onPropertyChanged(t,r){if(t=="src")this.loadSound(r);else if(t=="gain")this.audionode.gain.value=r;else if(t=="playbackRate")for(var s=0;s<this._audionodes.length;++s)this._audionodes[s].playbackRate.value=r}playBuffer(t){var r=this,s=LGAudio.getAudioContext(),a=s.createBufferSource();return this._last_sourcenode=a,a.graphnode=this,a.buffer=t,a.loop=this.properties.loop,a.playbackRate.value=this.properties.playbackRate,this._audionodes.push(a),a.connect(this.audionode),this._audionodes.push(a),this.trigger("start"),a.onended=function(){r.trigger("ended");var l=r._audionodes.indexOf(a);l!=-1&&r._audionodes.splice(l,1)},a.started||(a.started=!0,a.start()),a}loadSound(t){var r=this;this._request&&(this._request.abort(),this._request=null),this._audiobuffer=null,this._loading_audio=!1,t&&(this._request=LGAudio.loadSound(t,s=>{this.boxcolor=LiteGraph.NODE_DEFAULT_BOXCOLOR,r._audiobuffer=s,r._loading_audio=!1,r.graph&&r.graph.status===LiteGraph.LGraph.STATUS_RUNNING&&r.onStart()}),this._loading_audio=!0,this.boxcolor="#AA4")}onGetInputs(){return[["playbackRate","number"],["src","string"],["Play",LiteGraph.ACTION],["Stop",LiteGraph.ACTION]]}onGetOutputs(){return[["buffer","audiobuffer"],["start",LiteGraph.EVENT],["ended",LiteGraph.EVENT]]}onDropFile(t){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);var r=URL.createObjectURL(t);this.properties.src=r,this.loadSound(r),this._dropped_url=r}}g(LGAudioSource,"title","Source"),g(LGAudioSource,"desc","Plays an audio file"),g(LGAudioSource,"supported_extensions",["wav","ogg","mp3"]),g(LGAudioSource,"@src",{widget:"resource"}),LGAudioSource.prototype.onConnectionsChange=LGAudio.onConnectionsChange,LiteGraph.registerNodeType("audio/source",LGAudioSource);class LGAudioMediaSource{constructor(){this.properties={gain:.5},this._audionodes=[],this._media_stream=null,this.addOutput("out","audio"),this.addInput("gain","number");var t=LGAudio.getAudioContext();this.audionode=t.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain}onAdded(t){t.status===LiteGraph.LGraph.STATUS_RUNNING&&this.onStart()}onStart(){this._media_stream==null&&!this._waiting_confirmation&&this.openStream()}onStop(){this.audionode.gain.value=0}onPause(){this.audionode.gain.value=0}onUnpause(){this.audionode.gain.value=this.properties.gain}onRemoved(){if(this.audionode.gain.value=0,this.audiosource_node&&(this.audiosource_node.disconnect(this.audionode),this.audiosource_node=null),this._media_stream){var t=this._media_stream.getTracks();t.length&&t[0].stop()}}openStream(){var t;if(!navigator.mediaDevices){(t=console.log)==null||t.call(console,"getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.streamReady.bind(this)).catch(s);var r=this;function s(a){var l;(l=console.log)==null||l.call(console,"Media rejected",a),r._media_stream=!1,r.boxcolor="red"}}streamReady(t){this._media_stream=t,this.audiosource_node&&this.audiosource_node.disconnect(this.audionode);var r=LGAudio.getAudioContext();this.audiosource_node=r.createMediaStreamSource(t),this.audiosource_node.graphnode=this,this.audiosource_node.connect(this.audionode),this.boxcolor="white"}onExecute(){if(this._media_stream==null&&!this._waiting_confirmation&&this.openStream(),this.inputs)for(var t=0;t<this.inputs.length;++t){var r=this.inputs[t];if(r.link!=null){var s=this.getInputData(t);s!==void 0&&r.name=="gain"&&(this.audionode.gain.value=this.properties.gain=s)}}}onAction(t){t=="Play"?this.audionode.gain.value=this.properties.gain:t=="Stop"&&(this.audionode.gain.value=0)}onPropertyChanged(t,r){t=="gain"&&(this.audionode.gain.value=r)}onGetInputs(){return[["playbackRate","number"],["Play",LiteGraph.ACTION],["Stop",LiteGraph.ACTION]]}}g(LGAudioMediaSource,"title","MediaSource"),g(LGAudioMediaSource,"desc","Plays microphone"),LGAudioMediaSource.prototype.onConnectionsChange=LGAudio.onConnectionsChange,LiteGraph.registerNodeType("audio/media_source",LGAudioMediaSource);class LGAudioAnalyser{constructor(){this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,smoothingTimeConstant:.5};var t=LGAudio.getAudioContext();this.audionode=t.createAnalyser(),this.audionode.graphnode=this,this.audionode.fftSize=this.properties.fftSize,this.audionode.minDecibels=this.properties.minDecibels,this.audionode.maxDecibels=this.properties.maxDecibels,this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant,this.addInput("in","audio"),this.addOutput("freqs","array"),this.addOutput("samples","array"),this._freq_bin=null,this._time_bin=null}onPropertyChanged(t,r){this.audionode[t]=r}onExecute(){let t;this.isOutputConnected(0)&&(t=this.audionode.frequencyBinCount,(!this._freq_bin||this._freq_bin.length!=t)&&(this._freq_bin=new Uint8Array(t)),this.audionode.getByteFrequencyData(this._freq_bin),this.setOutputData(0,this._freq_bin)),this.isOutputConnected(1)&&(t=this.audionode.frequencyBinCount,(!this._time_bin||this._time_bin.length!=t)&&(this._time_bin=new Uint8Array(t)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin));for(var r=1;r<this.inputs.length;++r){var s=this.inputs[r];if(s.link!=null){var a=this.getInputData(r);a!==void 0&&(this.audionode[s.name].value=a)}}}onGetInputs(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]}onGetOutputs(){return[["freqs","array"],["samples","array"]]}}g(LGAudioAnalyser,"title","Analyser"),g(LGAudioAnalyser,"desc","Audio Analyser"),LiteGraph.registerNodeType("audio/analyser",LGAudioAnalyser);class LGAudioGain{constructor(){this.properties={gain:1},this.audionode=LGAudio.getAudioContext().createGain(),this.addInput("in","audio"),this.addInput("gain","number"),this.addOutput("out","audio")}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var r=this.inputs[t],s=this.getInputData(t);s!==void 0&&(this.audionode[r.name].value=s)}}}g(LGAudioGain,"title","Gain"),g(LGAudioGain,"desc","Audio gain"),LGAudio.createAudioNodeWrapper(LGAudioGain),LiteGraph.registerNodeType("audio/gain",LGAudioGain);class LGAudioConvolver{constructor(){this.properties={impulse_src:"",normalize:!0},this.audionode=LGAudio.getAudioContext().createConvolver(),this.addInput("in","audio"),this.addOutput("out","audio")}onRemove(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)}onPropertyChanged(t,r){t=="impulse_src"?this.loadImpulse(r):t=="normalize"&&(this.audionode.normalize=r)}onDropFile(t){this._dropped_url&&URL.revokeObjectURL(this._dropped_url),this._dropped_url=URL.createObjectURL(t),this.properties.impulse_src=this._dropped_url,this.loadImpulse(this._dropped_url)}loadImpulse(t){var r=this;if(this._request&&(this._request.abort(),this._request=null),this._impulse_buffer=null,this._loading_impulse=!1,!t)return;this._request=LGAudio.loadSound(t,s),this._loading_impulse=!0;function s(a){var l;r._impulse_buffer=a,r.audionode.buffer=a,(l=console.log)==null||l.call(console,"Impulse signal set"),r._loading_impulse=!1}}}g(LGAudioConvolver,"title","Convolver"),g(LGAudioConvolver,"desc","Convolves the signal (used for reverb)"),LGAudio.createAudioNodeWrapper(LGAudioConvolver),LiteGraph.registerNodeType("audio/convolver",LGAudioConvolver);class LGAudioDynamicsCompressor{constructor(){this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:.25},this.audionode=LGAudio.getAudioContext().createDynamicsCompressor(),this.addInput("in","audio"),this.addOutput("out","audio")}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var r=this.inputs[t];if(r.link!=null){var s=this.getInputData(t);s!==void 0&&(this.audionode[r.name].value=s)}}}onGetInputs(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]}}g(LGAudioDynamicsCompressor,"title","DynamicsCompressor"),g(LGAudioDynamicsCompressor,"desc","Dynamics Compressor"),LGAudio.createAudioNodeWrapper(LGAudioDynamicsCompressor),LiteGraph.registerNodeType("audio/dynamicsCompressor",LGAudioDynamicsCompressor);class LGAudioWaveShaper{constructor(){this.properties={},this.audionode=LGAudio.getAudioContext().createWaveShaper(),this.addInput("in","audio"),this.addInput("shape","waveshape"),this.addOutput("out","audio")}onExecute(){if(!(!this.inputs||!this.inputs.length)){var t=this.getInputData(1);t!==void 0&&(this.audionode.curve=t)}}setWaveShape(t){this.audionode.curve=t}}g(LGAudioWaveShaper,"title","WaveShaper"),g(LGAudioWaveShaper,"desc","Distortion using wave shape"),LGAudio.createAudioNodeWrapper(LGAudioWaveShaper);class LGAudioMixer{constructor(){this.properties={gain1:.5,gain2:.5},this.audionode=LGAudio.getAudioContext().createGain(),this.audionode1=LGAudio.getAudioContext().createGain(),this.audionode1.gain.value=this.properties.gain1,this.audionode2=LGAudio.getAudioContext().createGain(),this.audionode2.gain.value=this.properties.gain2,this.audionode1.connect(this.audionode),this.audionode2.connect(this.audionode),this.addInput("in1","audio"),this.addInput("in1 gain","number"),this.addInput("in2","audio"),this.addInput("in2 gain","number"),this.addOutput("out","audio")}getAudioNodeInInputSlot(t){if(t==0)return this.audionode1;if(t==2)return this.audionode2}onPropertyChanged(t,r){t=="gain1"?this.audionode1.gain.value=r:t=="gain2"&&(this.audionode2.gain.value=r)}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var r=this.inputs[t];if(!(r.link==null||r.type=="audio")){var s=this.getInputData(t);s!==void 0&&(t==1?this.audionode1.gain.value=s:t==3&&(this.audionode2.gain.value=s))}}}}g(LGAudioMixer,"title","Mixer"),g(LGAudioMixer,"desc","Audio mixer"),LGAudio.createAudioNodeWrapper(LGAudioMixer),LiteGraph.registerNodeType("audio/mixer",LGAudioMixer);class LGAudioADSR{constructor(){this.properties={A:.1,D:.1,S:.1,R:.1},this.audionode=LGAudio.getAudioContext().createGain(),this.audionode.gain.value=0,this.addInput("in","audio"),this.addInput("gate","boolean"),this.addOutput("out","audio"),this.gate=!1}onExecute(){var t=LGAudio.getAudioContext(),r=t.currentTime,s=this.audionode,a=s.gain,l=this.getInputData(1),h=this.getInputOrProperty("A"),u=this.getInputOrProperty("D"),c=this.getInputOrProperty("S"),_=this.getInputOrProperty("R");!this.gate&&l?(a.cancelScheduledValues(0),a.setValueAtTime(0,r),a.linearRampToValueAtTime(1,r+h),a.linearRampToValueAtTime(c,r+h+u)):this.gate&&!l&&(a.cancelScheduledValues(0),a.setValueAtTime(a.value,r),a.linearRampToValueAtTime(0,r+_)),this.gate=l}onGetInputs(){return[["A","number"],["D","number"],["S","number"],["R","number"]]}}g(LGAudioADSR,"title","ADSR"),g(LGAudioADSR,"desc","Audio envelope"),LGAudio.createAudioNodeWrapper(LGAudioADSR),LiteGraph.registerNodeType("audio/adsr",LGAudioADSR);class LGAudioDelay{constructor(){this.properties={delayTime:.5},this.audionode=LGAudio.getAudioContext().createDelay(10),this.audionode.delayTime.value=this.properties.delayTime,this.addInput("in","audio"),this.addInput("time","number"),this.addOutput("out","audio")}onExecute(){var t=this.getInputData(1);t!==void 0&&(this.audionode.delayTime.value=t)}}g(LGAudioDelay,"title","Delay"),g(LGAudioDelay,"desc","Audio delay"),LGAudio.createAudioNodeWrapper(LGAudioDelay),LiteGraph.registerNodeType("audio/delay",LGAudioDelay);class LGAudioBiquadFilter{constructor(){this.properties={frequency:350,detune:0,Q:1},this.addProperty("type","lowpass","enum",{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}),this.audionode=LGAudio.getAudioContext().createBiquadFilter(),this.addInput("in","audio"),this.addOutput("out","audio")}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=1;t<this.inputs.length;++t){var r=this.inputs[t];if(r.link!=null){var s=this.getInputData(t);s!==void 0&&(this.audionode[r.name].value=s)}}}onGetInputs(){return[["frequency","number"],["detune","number"],["Q","number"]]}}g(LGAudioBiquadFilter,"title","BiquadFilter"),g(LGAudioBiquadFilter,"desc","Audio filter"),LGAudio.createAudioNodeWrapper(LGAudioBiquadFilter),LiteGraph.registerNodeType("audio/biquadfilter",LGAudioBiquadFilter);class LGAudioOscillatorNode{constructor(){this.properties={frequency:440,detune:0,type:"sine"},this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]}),this.audionode=LGAudio.getAudioContext().createOscillator(),this.addOutput("out","audio")}onStart(){var t;if(!this.audionode.started){this.audionode.started=!0;try{this.audionode.start()}catch(r){(t=console.warn)==null||t.call(console,r)}}}onStop(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())}onPause(){this.onStop()}onUnpause(){this.onStart()}onExecute(){if(!(!this.inputs||!this.inputs.length))for(var t=0;t<this.inputs.length;++t){var r=this.inputs[t];if(r.link!=null){var s=this.getInputData(t);s!==void 0&&(this.audionode[r.name].value=s)}}}onGetInputs(){return[["frequency","number"],["detune","number"],["type","string"]]}}g(LGAudioOscillatorNode,"title","Oscillator"),g(LGAudioOscillatorNode,"desc","Oscillator"),LGAudio.createAudioNodeWrapper(LGAudioOscillatorNode),LiteGraph.registerNodeType("audio/oscillator",LGAudioOscillatorNode);class LGAudioVisualization{constructor(){this.properties={continuous:!0,mark:-1},this.addInput("data","array"),this.addInput("mark","number"),this.size=[300,200],this._last_buffer=null}onExecute(){this._last_buffer=this.getInputData(0);var t=this.getInputData(1);t!==void 0&&(this.properties.mark=t),this.setDirtyCanvas(!0,!1)}onDrawForeground(t){if(this._last_buffer){var r=this._last_buffer,s=r.length/this.size[0],a=this.size[1];t.fillStyle="black",t.fillRect(0,0,this.size[0],this.size[1]),t.strokeStyle="white",t.beginPath();var l=0;if(this.properties.continuous){t.moveTo(l,a);for(let c=0;c<r.length;c+=s)t.lineTo(l,a-r[c|0]/255*a),l++}else for(let c=0;c<r.length;c+=s)t.moveTo(l+.5,a),t.lineTo(l+.5,a-r[c|0]/255*a),l++;if(t.stroke(),this.properties.mark>=0){var h=LGAudio.getAudioContext().sampleRate,u=h/r.length;l=2*(this.properties.mark/u)/s,l>=this.size[0]&&(l=this.size[0]-1),t.strokeStyle="red",t.beginPath(),t.moveTo(l,a),t.lineTo(l,0),t.stroke()}}}}g(LGAudioVisualization,"title","Visualization"),g(LGAudioVisualization,"desc","Audio Visualization"),LiteGraph.registerNodeType("audio/visualization",LGAudioVisualization);class LGAudioBandSignal{constructor(){this.properties={band:440,amplitude:1},this.addInput("freqs","array"),this.addOutput("signal","number")}onExecute(){if(this._freqs=this.getInputData(0),!!this._freqs){var t=this.properties.band,r=this.getInputData(1);r!==void 0&&(t=r);var s=LGAudio.getAudioContext().sampleRate,a=s/this._freqs.length,l=2*(t/a);if(r=0,l<0&&(r=this._freqs[0]),l>=this._freqs.length)r=this._freqs[this._freqs.length-1];else{var h=l|0,u=this._freqs[h],c=this._freqs[h+1],_=l-h;r=u*(1-_)+c*_}this.setOutputData(0,r/255*this.properties.amplitude)}}onGetInputs(){return[["band","number"]]}}g(LGAudioBandSignal,"title","Signal"),g(LGAudioBandSignal,"desc","extract the signal of some frequency"),LiteGraph.registerNodeType("audio/signal",LGAudioBandSignal);const ve=class Yt{constructor(){g(this,"@code",{widget:"code",type:"code"});var t;if(!Yt.default_code){var r=Yt.default_function.toString(),s=r.indexOf("{")+1,a=r.lastIndexOf("}");Yt.default_code=r.substr(s,a-s)}this.properties={code:Yt.default_code};var l=LGAudio.getAudioContext();l.createScriptProcessor?this.audionode=l.createScriptProcessor(4096,1,1):((t=console.warn)==null||t.call(console,"ScriptProcessorNode deprecated"),this.audionode=l.createGain()),this.processCode(),Yt._bypass_function||(Yt._bypass_function=this.audionode.onaudioprocess),this.addInput("in","audio"),this.addOutput("out","audio")}onAdded(t){t.status==LiteGraph.LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)}onStart(){this.audionode.onaudioprocess=this._callback}onStop(){this.audionode.onaudioprocess=Yt._bypass_function}onPause(){this.audionode.onaudioprocess=Yt._bypass_function}onUnpause(){this.audionode.onaudioprocess=this._callback}onExecute(){}onRemoved(){this.audionode.onaudioprocess=Yt._bypass_function}processCode(){var t;try{var r=new Function("properties",this.properties.code);this._script=new r(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(s){(t=console.error)==null||t.call(console,"Error in onaudioprocess code",s),this._callback=Yt._bypass_function,this.audionode.onaudioprocess=this._callback}}onPropertyChanged(t,r){t=="code"&&(this.properties.code=r,this.processCode(),this.graph&&this.graph.status==LiteGraph.LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback))}static default_function(){this.onaudioprocess=function(t){for(var r=t.inputBuffer,s=t.outputBuffer,a=0;a<s.numberOfChannels;a++)for(var l=r.getChannelData(a),h=s.getChannelData(a),u=0;u<r.length;u++)h[u]=l[u]}}};g(ve,"title","Script"),g(ve,"desc","apply script to signal");let LGAudioScript=ve;LGAudio.createAudioNodeWrapper(LGAudioScript),LiteGraph.registerNodeType("audio/script",LGAudioScript);class LGAudioDestination{constructor(){this.audionode=LGAudio.getAudioContext().destination,this.addInput("in","audio")}}g(LGAudioDestination,"title","Destination"),g(LGAudioDestination,"desc","Audio output"),LiteGraph.registerNodeType("audio/destination",LGAudioDestination);class LGWebSocket{constructor(){this.size=[60,20],this.addInput("send",LiteGraph.ACTION),this.addOutput("received",LiteGraph.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"",room:"lgraph",only_send_changes:!0},this._ws=null,this._last_sent_data=[],this._last_received_data=[]}onPropertyChanged(t,r){t=="url"&&this.connectSocket()}onExecute(){if(!this._ws&&this.properties.url&&this.connectSocket(),!(!this._ws||this._ws.readyState!=WebSocket.OPEN)){var t=this.properties.room,r=this.properties.only_send_changes;for(let l=1;l<this.inputs.length;++l){var s=this.getInputData(l);if(s!=null){var a;try{a=JSON.stringify({type:0,room:t,channel:l,data:s})}catch{continue}r&&this._last_sent_data[l]==a||(this._last_sent_data[l]=a,this._ws.send(a))}}for(let l=1;l<this.outputs.length;++l)this.setOutputData(l,this._last_received_data[l]);this.boxcolor=="#AFA"&&(this.boxcolor="#6C6")}}connectSocket(){var t=this,r=this.properties.url;r.substr(0,2)!="ws"&&(r="ws://"+r),this._ws=new WebSocket(r),this._ws.onopen=function(){var s;(s=console.log)==null||s.call(console,"ready"),t.boxcolor="#6C6"},this._ws.onmessage=function(s){t.boxcolor="#AFA";var a=JSON.parse(s.data);if(!(a.room&&a.room!=t.properties.room))if(a.type==1)if(a.data.object_class&&LiteGraph[a.data.object_class]){var l=null;try{l=new LiteGraph[a.data.object_class](a.data),t.triggerSlot(0,l)}catch{return}}else t.triggerSlot(0,a.data);else t._last_received_data[a.channel||0]=a.data},this._ws.onerror=function(s){var a;(a=console.log)==null||a.call(console,"couldnt connect to websocket"),t.boxcolor="#E88"},this._ws.onclose=function(s){var a;(a=console.log)==null||a.call(console,"connection closed"),t.boxcolor="#000"}}send(t){!this._ws||this._ws.readyState!=WebSocket.OPEN||this._ws.send(JSON.stringify({type:1,msg:t}))}onAction(t,r){!this._ws||this._ws.readyState!=WebSocket.OPEN||this._ws.send({type:1,room:this.properties.room,action:t,data:r})}onGetInputs(){return[["in",0]]}onGetOutputs(){return[["out",0]]}}g(LGWebSocket,"title","WebSocket"),g(LGWebSocket,"desc","Send data through a websocket"),LiteGraph.registerNodeType("network/websocket",LGWebSocket);class HTTPRequestNode{constructor(){this.addInput("request",LiteGraph.ACTION),this.addInput("url","string"),this.addProperty("url",""),this.addOutput("ready",LiteGraph.EVENT),this.addOutput("data","string"),this.addWidget("button","Fetch",null,this.fetch.bind(this)),this._data=null,this._fetching=null}fetch(){var t=this.getInputOrProperty("url");if(t){this.boxcolor="#FF0";var r=this;this._fetching=fetch(t).then(s=>{if(!s.ok)this.boxcolor="#F00",r.trigger("error");else return this.boxcolor="#0F0",s.text()}).then(s=>{r._data=s,r._fetching=null,r.trigger("ready")})}}onAction(t){t=="request"&&this.fetch()}onExecute(){this.setOutputData(1,this._data)}onGetOutputs(){return[["error",LiteGraph.EVENT]]}}g(HTTPRequestNode,"title","HTTP Request"),g(HTTPRequestNode,"desc","Fetch data through HTTP"),LiteGraph.registerNodeType("network/httprequest",HTTPRequestNode);export{ContextMenu,DragAndScale,LGraph,LGraphCanvas,LGraphGroup,LGraphNode,LLink,LiteGraph};
